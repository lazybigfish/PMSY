# 任务完成趋势图功能实现记录

## 实现时间
2026-02-12

## 需求描述
在任务搜索栏和任务统计卡片之间，放一条横线的轴，上面有 15 个节点，每个节点上显示一天处理完成的任务，然后再很轴上方连成曲线，时间轴的第 14 节点永远显示当天的数据，前面都是历史曲线。

## 修改文件
- `src/pages/tasks/TaskList.tsx` - 任务列表主页面

## 实现内容

### 1. 数据计算逻辑

#### 生成日期范围
```typescript
const dateRange = useMemo(() => {
  const dates: Date[] = [];
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  for (let i = 14; i >= 0; i--) {
    const date = new Date(today);
    date.setDate(today.getDate() - i);
    dates.push(date);
  }
  return dates;
}, []);
```

#### 统计每天完成的任务数
```typescript
const dailyCompletedData = useMemo(() => {
  return dateRange.map(date => {
    const nextDay = new Date(date);
    nextDay.setDate(date.getDate() + 1);

    return tasks.filter(task => {
      if (task.status !== 'done' || !task.completed_at) return false;
      const completedAt = new Date(task.completed_at);
      return completedAt >= date && completedAt < nextDay;
    }).length;
  });
}, [tasks, dateRange]);
```

### 2. 趋势图数据点计算
```typescript
const trendDataPoints = useMemo(() => {
  const maxValue = Math.max(...dailyCompletedData, 1);
  const minValue = Math.min(...dailyCompletedData);
  const range = maxValue - minValue || 1;

  return dailyCompletedData.map((value, index) => {
    const x = (index / 14) * 100;  // 均匀分布在 0-100%
    const y = 20 + ((value - minValue) / range) * 60;  // 根据数值计算高度
    return { x, y, value, date: dateRange[index] };
  });
}, [dailyCompletedData, dateRange]);
```

### 3. 平滑曲线路径生成
```typescript
const smoothPath = useMemo(() => {
  if (trendDataPoints.length < 2) return '';

  const points = trendDataPoints.map(p => ({
    x: (p.x / 100) * 1000,
    y: 100 - p.y
  }));

  let path = `M ${points[0].x} ${points[0].y}`;

  for (let i = 1; i < points.length; i++) {
    const prev = points[i - 1];
    const curr = points[i];
    const cpx1 = prev.x + (curr.x - prev.x) / 2;
    const cpy1 = prev.y;
    const cpx2 = prev.x + (curr.x - prev.x) / 2;
    const cpy2 = curr.y;
    path += ` C ${cpx1} ${cpy1}, ${cpx2} ${cpy2}, ${curr.x} ${curr.y}`;
  }

  return path;
}, [trendDataPoints]);
```

### 4. 视觉效果

#### SVG 曲线图
- **曲线**：渐变色描边（从 indigo 到 violet）
- **填充区域**：渐变填充，从曲线下方到横线
- **节点**：15 个圆点均匀分布
- **横线**：底部基线

#### 节点样式
- **今天节点（第14个）**：实心圆点，主色调
- **历史节点**：空心圆点，灰色边框
- **数值标签**：显示在节点上方

#### 日期标签
- **今天**：显示"今天"，主色调
- **历史日期**：显示"月/日"格式

## 组件结构
```typescript
<div className="bg-white rounded-xl p-6 shadow-sm border border-dark-100">
  <h3 className="text-sm font-medium text-dark-700 mb-4">近15天任务完成趋势</h3>
  <div className="relative h-40">
    {/* SVG 曲线图 */}
    <svg className="w-full h-full" viewBox="0 0 1000 100" preserveAspectRatio="none">
      {/* 渐变定义 */}
      <defs>
        <linearGradient id="trendGradient" x1="0%" y1="0%" x2="100%" y2="0%">
          <stop offset="0%" stopColor="#6366f1" />
          <stop offset="100%" stopColor="#8b5cf6" />
        </linearGradient>
      </defs>
      {/* 填充区域 */}
      <path d={areaPath} fill="url(#areaGradient)" />
      {/* 曲线 */}
      <path d={smoothPath} fill="none" stroke="url(#trendGradient)" strokeWidth="3" />
    </svg>
    
    {/* 节点和数值 */}
    {trendDataPoints.map((point, index) => (
      <div key={index} style={{ left: `${point.x}%`, bottom: `${point.y}%` }}>
        <span>{point.value}</span>
        <div className="rounded-full" />
      </div>
    ))}
    
    {/* 横线 */}
    <div className="absolute bottom-0 left-0 right-0 h-px bg-dark-200" />
    
    {/* 日期标签 */}
    <div className="flex justify-between">
      {dateRange.map((date, index) => (
        <span key={index}>{index === 14 ? '今天' : formatDate(date)}</span>
      ))}
    </div>
  </div>
</div>
```

## 时间轴设计
- **节点数量**：15 个节点
- **时间范围**：从今天往前推 14 天
- **第 14 节点**：显示当天（今天）的数据，特殊标记
- **前面 13 个节点**：显示历史数据（过去 13 天）

## 数据展示
- **节点数据**：每天处理完成的任务数量
- **数据来源**：统计 `status = 'done'` 且 `completed_at` 存在的任务
- **统计方式**：按天分组，计算每天完成的任务数

## 验收结果
- [x] 显示15个节点，均匀分布在横线上
- [x] 第14节点显示当天数据，前面显示历史数据
- [x] 每个节点上方显示该天完成的任务数
- [x] 用平滑曲线连接各节点
- [x] 今天节点有特殊标记（实心圆点 + 主色调）
- [x] 类型检查通过

## 注意事项
- 曲线使用 SVG 绘制，支持响应式缩放
- 数据自动根据 `completed_at` 字段统计
- 如果没有完成任务，显示为 0
- 曲线高度根据数值自动调整比例
