# 点赞数显示异常修复记录

## 问题描述
水漫金山模块的帖子点赞数显示异常：用户点赞后，刷新页面点赞数仍然显示为 0。

## 问题原因

### 根本原因
**数据库表结构不完整！** 

`deploy/scripts/init-database-complete.sql` 中的 `forum_posts` 表定义缺少以下列：
- `like_count` - 点赞数
- `reply_count` - 回复数
- `is_essence` - 是否精华帖
- `last_reply_at` - 最后回复时间
- `last_reply_by` - 最后回复人
- `attachments` - 附件

同时，`forum_post_likes` 表也可能不存在。

### 次要原因
**RLS (Row Level Security) 策略限制**

在 `supabase/migrations/20260211000003_add_admin_policies.sql` 中，`forum_posts` 表的 UPDATE 策略只允许：
- 帖子的作者（`author_id = auth.uid()`）
- 管理员

但是，**点赞功能需要更新帖子的 `like_count` 字段**，而点赞的用户通常不是帖子的作者！这导致更新操作被 RLS 策略拒绝。

## 修复方案
使用数据库触发器自动维护 `like_count`，绕过 RLS 限制。

### 创建的迁移文件

### 1. 修复表结构
`supabase/migrations/20260212000002_add_like_count_column.sql`
- 创建 `forum_post_likes` 表（如果不存在）
- 添加 `like_count` 列到 `forum_posts` 表
- 添加其他缺失的列（`reply_count`, `is_essence`, `last_reply_at`, `last_reply_by`, `attachments`）

### 2. 创建触发器
`supabase/migrations/20260212000001_fix_like_count_trigger.sql`

### 触发器逻辑
1. 当 `forum_post_likes` 表插入新记录（点赞）时，对应帖子的 `like_count` + 1
2. 当 `forum_post_likes` 表删除记录（取消点赞）时，对应帖子的 `like_count` - 1
3. 触发器使用 `SECURITY DEFINER` 以数据库所有者权限执行，绕过 RLS 限制

### 前端代码调整
`src/pages/water/ForumTab.tsx`
- 简化 `handleLike` 函数
- 只需操作 `forum_post_likes` 表
- 触发器自动维护 `like_count`
- 使用乐观更新立即显示新数值

## 执行步骤

### 对于已部署的数据库
按顺序执行以下迁移文件：
1. `supabase/migrations/20260212000002_add_like_count_column.sql` - 添加缺失的列和表
2. `supabase/migrations/20260212000001_fix_like_count_trigger.sql` - 创建触发器

### 对于全新部署
直接运行更新后的部署脚本：
- `deploy/scripts/init-database-complete.sql` - 完整版
- `deploy/scripts/init-database.sql` - 简化版

无需重启前端服务，数据库更改即时生效。

## 验证方法
1. 进入"水底探宝"页面
2. 给帖子点赞
3. 刷新页面
4. 检查点赞数是否正确显示

## 相关文件

### 数据库迁移文件
- `supabase/migrations/20260212000002_add_like_count_column.sql` - 添加缺失的列和表
- `supabase/migrations/20260212000001_fix_like_count_trigger.sql` - 数据库触发器

### 前端文件
- `src/pages/water/ForumTab.tsx` - 帖子列表页点赞逻辑
- `src/pages/water/ForumPostDetailPage.tsx` - 帖子详情页点赞逻辑
- `src/components/LikeButton.tsx` - 点赞按钮组件

### 部署脚本（已更新）
- `deploy/scripts/init-database-complete.sql` - 完整版部署脚本
- `deploy/scripts/init-database.sql` - 简化版部署脚本

## 补充修复
发现帖子详情页和帖子列表页的点赞逻辑不一致：
- 帖子列表页：已移除手动更新 `like_count`
- 帖子详情页：仍然尝试手动更新 `like_count`（会被 RLS 拒绝）

已统一修复两个页面的逻辑，都只操作 `forum_post_likes` 表，让触发器自动维护 `like_count`。

## 修复时间
2026-02-12
