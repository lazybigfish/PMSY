# 统计卡片联动筛选功能实现记录

## 实现时间
2026-02-12

## 需求描述
任务中心上面的统计卡片有实际联动效果，点击总任务、我负责的、我参与的、已完成等，根据卡片上的信息去筛选下面列表展示的内容。

## 修改文件
- `src/pages/tasks/TaskList.tsx` - 任务列表主页面

## 实现内容

### 1. 状态管理

#### 添加激活卡片状态
```typescript
type ActiveStatCard =
  | 'all'           // 总任务
  | 'my_primary'    // 我负责的
  | 'my_participate'// 我参与的
  | 'done'          // 已完成
  | 'due_this_week' // 截止本周
  | 'due_this_month'// 截止本月
  | 'overdue'       // 超期未完成
  | null;           // 无激活

const [activeStatCard, setActiveStatCard] = useState<ActiveStatCard>(null);
```

### 2. 点击处理函数

```typescript
const handleStatCardClick = (cardType: ActiveStatCard) => {
  // 如果点击已激活的卡片，则取消筛选
  if (activeStatCard === cardType) {
    setActiveStatCard(null);
    setFilters({
      keyword: '',
      projectId: '',
      dateRange: { type: 'created', start: '', end: '' },
      statuses: [],
      priorities: []
    });
    return;
  }

  // 设置新的激活卡片
  setActiveStatCard(cardType);

  // 根据卡片类型设置筛选条件
  switch (cardType) {
    case 'all':
      // 重置所有筛选
      setFilters({...});
      break;
    case 'done':
      // 已完成
      setFilters({..., statuses: ['done']});
      break;
    case 'due_this_week':
      // 截止本周
      setFilters({..., dateRange: {type: 'due', start: '...', end: '...'}});
      break;
    // ... 其他卡片类型
  }
};
```

### 3. 卡片样式函数

```typescript
const getStatCardClass = (cardType: ActiveStatCard): string => {
  const baseClass = 'stat-card card-hover hover:-translate-y-0.5 hover:shadow-lg transition-all duration-200 ease-out cursor-pointer';
  const activeClass = activeStatCard === cardType
    ? 'ring-2 ring-primary-500 ring-offset-2 bg-primary-50/50'
    : '';

  return `${baseClass} ${activeClass}`;
};
```

### 4. 筛选逻辑增强

在 `filteredTasks` 的筛选逻辑中添加：

```typescript
// 统计卡片筛选 - 我负责的
if (activeStatCard === 'my_primary' && user) {
  const isPrimary = task.assignees?.some(a => a.user_id === user.id && a.is_primary);
  if (!isPrimary) return false;
}

// 统计卡片筛选 - 我参与的
if (activeStatCard === 'my_participate' && user) {
  const isParticipant = task.assignees?.some(a => a.user_id === user.id && !a.is_primary);
  if (!isParticipant) return false;
}
```

### 5. 卡片点击事件绑定

```typescript
{/* Total Tasks */}
<div
  onClick={() => handleStatCardClick('all')}
  className={getStatCardClass('all')}
>
  ...
</div>

{/* My Tasks */}
<div
  onClick={() => handleStatCardClick('my_primary')}
  className={getStatCardClass('my_primary')}
>
  ...
</div>

{/* 其他卡片类似... */}
```

## 统计卡片与筛选逻辑对应关系

| 统计卡片 | 筛选条件 |
|---------|---------|
| **总任务** | 重置所有筛选 |
| **我负责的** | 当前用户为主要负责人 (`is_primary = true`) |
| **我参与的** | 当前用户为参与人（非主要）(`is_primary = false`) |
| **已完成** | 状态为 `done` |
| **截止本周** | `due_date` 在本周内且 `status !== 'done'` |
| **截止本月** | `due_date` 在本月内且 `status !== 'done'` |
| **超期未完成** | `due_date < 今天` 且 `status !== 'done'` |

## 交互逻辑

### 点击行为
- 点击卡片 → 应用对应筛选条件
- 点击已激活卡片 → 取消筛选，显示全部
- 筛选栏同步更新显示当前筛选状态

### 视觉反馈
- 当前激活的卡片有蓝色边框高亮 (`ring-2 ring-primary-500`)
- 背景色变化 (`bg-primary-50/50`)
- 其他卡片保持默认样式

## 验收结果
- [x] 点击"总任务"卡片重置所有筛选
- [x] 点击"我负责的"筛选当前用户为主要负责人的任务
- [x] 点击"我参与的"筛选当前用户为参与人（非主要）的任务
- [x] 点击"已完成"筛选状态为 done 的任务
- [x] 点击"截止本周"筛选本周内到期的未完成任务
- [x] 点击"截止本月"筛选本月内到期的未完成任务
- [x] 点击"超期未完成"筛选已超期但未完成的任务
- [x] 点击已激活的卡片取消筛选
- [x] 当前激活的卡片有视觉高亮效果
- [x] 类型检查通过

## 注意事项
- "我负责的"和"我参与的"筛选需要在 `filteredTasks` 中单独处理
- 日期筛选使用 `dateRange` 筛选器
- 状态筛选使用 `statuses` 筛选器
- 激活状态会同步更新筛选栏的显示
