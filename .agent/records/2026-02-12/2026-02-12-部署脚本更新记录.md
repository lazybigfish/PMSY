# 部署脚本更新记录

## 更新日期
2026-02-12

## 更新原因
供应商验收记录功能新增了 `acceptance_type` 字段，需要确保全新部署时数据库迁移文件被正确执行。

## 更新内容

### 文件：`deploy/fresh-install/deploy.sh`

#### 1. 在线部署模式（模式1）
- 数据库初始化步骤从 3 步增加到 4 步
- 新增步骤 3：执行数据库迁移
- 自动遍历 `supabase/migrations/*.sql` 文件并执行
- 每个迁移文件执行时会显示文件名

#### 2. 半离线部署模式（模式2）
- 在数据库初始化后新增迁移执行逻辑
- 检查 `supabase/migrations` 目录是否存在
- 遍历并执行所有 `.sql` 迁移文件

#### 3. 完全离线部署模式（模式3）
- 离线部署脚本步骤从 5 步增加到 6 步
- 新增步骤 6：执行数据库迁移
- 确保离线包部署时也能执行所有迁移

### 迁移文件
新的数据库迁移文件已创建：
- `supabase/migrations/20260212000001_add_acceptance_type.sql`
- 为 `supplier_acceptances` 表添加 `acceptance_type` 字段
- 支持三种验收类型：initial（初验）、final（终验）、phase（阶段性验收）

## 部署脚本变更详情

### 在线部署模式 - 数据库初始化流程
```bash
echo "   [服务器] 初始化数据库..."
echo "     步骤 1/4: 创建 Supabase 角色..."
# ...

echo "     步骤 2/4: 执行数据库初始化脚本..."
# ...

echo "     步骤 3/4: 执行数据库迁移..."
if [ -d "supabase/migrations" ]; then
    echo "       找到 migrations 目录，执行迁移文件..."
    for migration in supabase/migrations/*.sql; do
        if [ -f "$migration" ]; then
            echo "       执行: $(basename $migration)"
            sudo docker-compose exec -T db psql -U postgres < "$migration"
        fi
    done
    echo "     ✅ 数据库迁移完成"
fi

echo "     步骤 4/4: 创建管理员用户..."
# ...
```

## 测试建议

1. 执行全新部署测试，验证迁移文件是否被正确执行
2. 检查数据库表结构：`\d supplier_acceptances`
3. 确认 `acceptance_type` 字段存在且有正确的约束

## 注意事项

- 部署脚本会按文件名顺序执行迁移文件
- 迁移文件命名应遵循时间戳格式：`YYYYMMDDhhmmss_description.sql`
- 如果迁移执行失败，会显示警告但继续部署流程
- 建议在生产环境部署前先在测试环境验证

## 相关文件

- `deploy/fresh-install/deploy.sh` - 全新部署脚本
- `supabase/migrations/20260212000001_add_acceptance_type.sql` - 新迁移文件
- `src/types/index.ts` - 类型定义更新
- `src/pages/projects/components/SupplierDetailModal.tsx` - 前端组件更新
