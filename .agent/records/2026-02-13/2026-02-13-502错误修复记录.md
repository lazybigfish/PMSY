# PMSY 502 Bad Gateway 错误修复记录

## 问题描述

部署成功后，使用控制台提示的 `admin@pmsy.com / admin123` 登录时，浏览器控制台报错：

```
Failed to load resource: the server responded with a status of 502 (Bad Gateway)
auth/v1/token?grant_type=password
```

## 根本原因

`502 Bad Gateway` 错误表示 Nginx 无法连接到后端服务（auth、rest、api）。经过分析，发现以下问题：

### 1. 服务启动顺序问题

auth 服务依赖 db 服务，在数据库初始化后 auth 服务会重启，但之前的部署脚本只等待 5 秒就继续执行，此时 auth 服务可能还未完全就绪。

### 2. 缺少服务健康检查

原来的部署代码：
```bash
sudo docker-compose restart auth
log_info "等待 5 秒..."
sleep 5
log_success "auth 服务重启完成"
```

这种方式只是固定等待 5 秒，没有真正检查服务是否就绪。

## 解决方案

将固定等待改为**健康检查轮询**，确保服务真正就绪后再继续：

```bash
# 等待 auth 服务健康检查通过
log_info "等待 auth 服务就绪（最多60秒）..."
for i in {1..12}; do
    if sudo docker-compose exec -T auth wget -qO- http://localhost:9999/health 2>/dev/null | grep -q "OK"; then
        log_success "auth 服务已就绪"
        break
    fi
    log_info "等待 auth 服务... (${i}/12)"
    sleep 5
done

# 同时等待 rest 服务
log_info "等待 rest 服务就绪..."
for i in {1..12}; do
    if sudo docker-compose exec -T rest wget -qO- http://localhost:3000/ 2>/dev/null | grep -q "PostgREST"; then
        log_success "rest 服务已就绪"
        break
    fi
    log_info "等待 rest 服务... (${i}/12)"
    sleep 5
done

log_success "核心服务已就绪"
```

## 修改范围

修改了 `deploy/fresh-install/deploy.sh` 中的三处：

### 1. 在线部署模式（模式1）
- 步骤 4/7: 重启 auth 服务后添加健康检查

### 2. 半离线部署模式（模式2）
- 步骤 4/7: 重启 auth 服务后添加健康检查

### 3. 完全离线部署模式（模式3）
- 重启 auth 服务后添加健康检查

## 健康检查机制

### auth 服务检查
```bash
wget -qO- http://localhost:9999/health | grep -q "OK"
```
- 访问 auth 服务的健康检查端点
- 检查返回内容是否包含 "OK"
- 最多等待 60 秒（12 次 × 5 秒）

### rest 服务检查
```bash
wget -qO- http://localhost:3000/ | grep -q "PostgREST"
```
- 访问 rest 服务的根路径
- 检查返回内容是否包含 "PostgREST"
- 最多等待 60 秒（12 次 × 5 秒）

## 修改后的输出示例

```
     步骤 4/7: 重启 auth 服务以应用 schema...
       ℹ️  重启 auth 服务...
       ℹ️  等待 auth 服务就绪（最多60秒）...
       ℹ️  等待 auth 服务... (1/12)
       ℹ️  等待 auth 服务... (2/12)
       ✅ auth 服务已就绪
       ℹ️  等待 rest 服务就绪...
       ✅ rest 服务已就绪
       ✅ 核心服务已就绪
```

## 优势

1. **确保服务就绪**: 不再依赖固定等待时间，而是真正检查服务状态
2. **防止 502 错误**: 确保 Nginx 代理时后端服务已完全启动
3. **可观测性**: 显示等待进度，让用户了解部署状态
4. **容错性**: 最多等待 60 秒，避免无限等待

## 相关文件

- `deploy/fresh-install/deploy.sh` - 部署脚本（已修复）

## 注意事项

1. 如果服务在 60 秒内未就绪，脚本会继续执行，但可能会遇到 502 错误
2. 可以通过 `sudo docker-compose logs auth` 查看 auth 服务日志排查问题
3. 确保服务器资源充足，服务启动不会太慢

## 总结

通过添加服务健康检查机制，确保 auth 和 rest 服务完全就绪后再继续部署流程，解决了 `502 Bad Gateway` 错误。现在部署后登录功能应该能正常工作。
