# PMSY SSH 远程执行日志实时显示修复记录

## 问题描述

执行全新部署脚本后，在初始化数据库阶段之前的日志都能正常输出到控制台，但是数据库初始化阶段的日志直接跳过了，直接显示"部署成功"。

## 根本原因

部署脚本使用 SSH heredoc 方式在服务器端执行远程脚本：

```bash
ssh "$DEPLOY_SERVER_USER@$DEPLOY_SERVER_IP" << REMOTE_SCRIPT
# 远程脚本内容...
REMOTE_SCRIPT
```

这种方式下，远程脚本的输出会被缓冲，不会**实时显示**在本地开发机的控制台上。只有当远程脚本完全执行完毕后，所有输出才会一次性返回，导致用户看不到中间的数据库初始化日志。

## 解决方案

添加 SSH `-t` 参数（强制伪终端分配），使远程命令的输出能够实时传输到本地控制台。

### 修改内容

将 SSH 命令从：
```bash
ssh "$DEPLOY_SERVER_USER@$DEPLOY_SERVER_IP" << REMOTE_SCRIPT
```

改为：
```bash
ssh -t "$DEPLOY_SERVER_USER@$DEPLOY_SERVER_IP" << REMOTE_SCRIPT
```

同时添加了提示信息，告知用户日志将实时显示：
```bash
echo -e "${CYAN}   提示: 后续日志将实时显示，可能需要几分钟时间...${NC}"
```

## 修改范围

修改了 `deploy/fresh-install/deploy.sh` 中的两处 SSH 远程执行：

### 1. 在线部署模式（模式1）
```bash
# 服务器端部署
echo -e "${YELLOW}   在服务器上执行部署...${NC}"
echo -e "${CYAN}   提示: 后续日志将实时显示，可能需要几分钟时间...${NC}"
echo ""
ssh -t "$DEPLOY_SERVER_USER@$DEPLOY_SERVER_IP" << REMOTE_SCRIPT
```

### 2. 半离线部署模式（模式2）
```bash
# 服务器端部署
echo -e "${YELLOW}   在服务器上执行部署...${NC}"
echo -e "${CYAN}   提示: 后续日志将实时显示，可能需要几分钟时间...${NC}"
echo ""
ssh -t "$DEPLOY_SERVER_USER@$DEPLOY_SERVER_IP" << REMOTE_SCRIPT
```

## 技术说明

### SSH -t 参数的作用

- `-t` 参数强制分配一个伪终端（pseudo-terminal）
- 伪终端使得远程命令的输出能够实时传输到本地
- 没有 `-t` 参数时，输出会被缓冲，直到命令执行完毕才返回

### 为什么需要实时显示

数据库初始化和迁移步骤可能需要几分钟时间，如果用户看不到实时日志：
1. 无法判断部署是否卡住
2. 无法了解当前执行到哪个步骤
3. 无法及时发现错误

## 修改后的输出示例

```
   在服务器上执行部署...
   提示: 后续日志将实时显示，可能需要几分钟时间...

   [服务器] 停止现有服务...
   [服务器] 清理数据...
   [服务器] 配置环境...
   [服务器] 创建目录...
   [服务器] 拉取镜像并启动...
   [服务器] 等待数据库...
   [服务器] 初始化数据库...

     步骤 1/7: 创建 Supabase 角色...
       ℹ️  创建 supabase_admin 角色...
       ✅ supabase_admin 角色创建成功
       ...

     步骤 6/7: 执行数据库迁移...
       ℹ️  发现 45 个迁移文件
       ℹ️  执行: 20250209000000_init_schema.sql
       ✅ 20250209000000_init_schema.sql 执行成功
       ...
       ✅ 数据库迁移完成: 45 成功, 0 失败

     步骤 7/7: 创建管理员用户...
       ✅ 管理员用户创建成功

   [服务器] ✅ 部署完成
```

## 相关文件

- `deploy/fresh-install/deploy.sh` - 部署脚本（已修复）

## 注意事项

1. `-t` 参数会强制分配伪终端，如果不需要交互式操作，也可以使用其他方式实现实时输出
2. 如果 SSH 连接中断，远程脚本可能会继续执行，但日志会停止显示
3. 建议保持网络连接稳定，以确保日志完整输出

## 总结

通过添加 SSH `-t` 参数，解决了远程脚本执行日志不实时显示的问题。现在用户可以实时看到服务器端的数据库初始化、迁移等操作的详细日志，便于监控部署进度和排查问题。
