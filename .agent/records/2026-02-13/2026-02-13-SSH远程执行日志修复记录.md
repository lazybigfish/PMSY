# PMSY SSH 远程执行日志输出修复记录

## 问题描述

执行全新部署脚本后，在初始化数据库阶段之前的日志都能正常输出到控制台，但是数据库初始化阶段的日志直接跳过了，直接显示"部署成功"。

## 根本原因分析

### 1. SSH heredoc 变量扩展问题

原来的 SSH 命令使用 heredoc 传递远程脚本：
```bash
ssh -t "$DEPLOY_SERVER_USER@$DEPLOY_SERVER_IP" << REMOTE_SCRIPT
set -e
cd $DEPLOY_REMOTE_DIR
# ... 远程脚本内容
REMOTE_SCRIPT
```

这种方式下：
- heredoc 中的 `$DEPLOY_REMOTE_DIR` 等变量会被**本地 shell 扩展**
- 如果变量值包含特殊字符，可能导致远程脚本执行异常
- 远程脚本可能提前退出或执行失败，但没有错误输出

### 2. 日志输出被缓冲

即使使用了 `-t` 参数，如果 heredoc 中的变量扩展出现问题，远程脚本可能根本没有正确执行，导致看起来"日志直接跳过"。

## 解决方案

### 修改 SSH 命令方式

将 heredoc 变量传递改为使用环境变量传递：

```bash
# 修改前
ssh -t "$DEPLOY_SERVER_USER@$DEPLOY_SERVER_IP" << REMOTE_SCRIPT
set -e
cd $DEPLOY_REMOTE_DIR
# ...
REMOTE_SCRIPT

# 修改后
ssh -t "$DEPLOY_SERVER_USER@$DEPLOY_SERVER_IP" "DEPLOY_REMOTE_DIR='$DEPLOY_REMOTE_DIR' DEPLOY_SERVER_IP='$DEPLOY_SERVER_IP' bash -s" << 'REMOTE_SCRIPT'
set -e
cd "$DEPLOY_REMOTE_DIR"
# ...
REMOTE_SCRIPT
```

### 关键改进

1. **使用单引号的 heredoc**: `<< 'REMOTE_SCRIPT'` 禁用本地变量扩展
2. **通过 SSH 命令传递环境变量**: `"DEPLOY_REMOTE_DIR='$DEPLOY_REMOTE_DIR' bash -s"`
3. **在远程脚本中使用引号**: `cd "$DEPLOY_REMOTE_DIR"` 防止路径中的空格问题

## 修改范围

修改了 `deploy/fresh-install/deploy.sh` 中的两处：

### 1. 在线部署模式（模式1）
```bash
# 使用环境变量传递参数，避免 heredoc 变量扩展问题
ssh -t "$DEPLOY_SERVER_USER@$DEPLOY_SERVER_IP" "DEPLOY_REMOTE_DIR='$DEPLOY_REMOTE_DIR' DEPLOY_SERVER_IP='$DEPLOY_SERVER_IP' bash -s" << 'REMOTE_SCRIPT'
set -e
cd "$DEPLOY_REMOTE_DIR"
# ...
REMOTE_SCRIPT
```

### 2. 半离线部署模式（模式2）
同样的修改方式。

## 技术说明

### 为什么使用 `bash -s`

- `bash -s` 告诉远程服务器从标准输入读取脚本
- 这样可以将脚本内容通过管道传递
- 同时可以在命令行设置环境变量

### 为什么 heredoc 使用单引号

- `<< 'REMOTE_SCRIPT'` 中的单引号禁用变量扩展
- 防止本地 shell 扩展 `$DEPLOY_REMOTE_DIR` 等变量
- 确保远程服务器使用传递的环境变量

### 变量传递流程

1. 本地 shell: `DEPLOY_REMOTE_DIR='/opt/pmsy'` 被设置
2. SSH 命令: 将变量作为环境变量传递给远程服务器
3. 远程服务器: `bash -s` 读取 heredoc 中的脚本
4. 远程脚本: 使用 `"$DEPLOY_REMOTE_DIR"` 访问环境变量

## 验证方法

重新执行部署脚本，观察以下日志是否正常输出：

```
   在服务器上执行部署...
   提示: 后续日志将实时显示，可能需要几分钟时间...

   [服务器] 停止现有服务...
   [服务器] 清理数据...
   [服务器] 配置环境...
   [服务器] 创建目录...
   [服务器] 拉取镜像并启动...
   [服务器] 等待数据库...
   [服务器] 初始化数据库...
     步骤 1/7: 创建 Supabase 角色...
       ℹ️  创建 supabase_admin 角色...
       ✅ supabase_admin 角色创建成功
     ...
```

## 相关文件

- `deploy/fresh-install/deploy.sh` - 部署脚本（已修复）

## 总结

通过将 heredoc 变量扩展改为环境变量传递，解决了 SSH 远程执行时日志输出异常的问题。现在数据库初始化等远程操作的日志可以正常实时显示在本地控制台。
