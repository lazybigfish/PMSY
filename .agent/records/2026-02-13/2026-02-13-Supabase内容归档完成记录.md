# Supabase 相关内容归档完成记录

## 归档时间
2026-02-13

## 归档原因
项目已从 Supabase 迁移到自托管 PostgreSQL + MinIO + Redis 架构

## 归档目录结构

```
.archive/supabase-backup/
├── ARCHIVE_INDEX.md              # 归档清单
├── config/                       # 配置文件
│   ├── nginx.conf
│   └── docker-compose.yml
├── scripts/                      # 脚本文件
│   └── dev/                      # 开发脚本
│       ├── check_users.js
│       ├── check_roles.ts
│       ├── generate-jwt.js
│       ├── seed_full_data.js
│       ├── test_root_login.ts
│       └── test_supabase_admin.ts
├── database/                     # 数据库相关
│   └── (从 supabase/ 目录复制)
├── docs/                         # 文档
│   ├── DEPLOY.md
│   ├── DEPLOY_CHECKLIST.md
│   ├── DATABASE_DIFF_REPORT.md
│   ├── 部署优化说明.md
│   └── 部署检查清单.md
├── frontend-src/                 # 前端源代码
│   ├── lib/
│   │   └── supabase.ts          # Supabase 客户端配置
│   └── context/
│       └── AuthContext.tsx      # 使用 Supabase 的认证上下文
├── api-src/                      # API 源代码
│   ├── lib/
│   │   └── supabase.ts
│   └── routes/
│       └── auth.ts
└── supabase/                     # 完整的 Supabase 目录
    ├── migrations/
    ├── functions/
    └── volumes/
```

## 已移除的 Supabase 依赖

### package.json (根目录)
- ❌ 移除: `@supabase/supabase-js`: `^2.95.3`

### api-new/package.json
- ❌ 移除: `@supabase/supabase-js`: `^2.39.0`

## 新增替代文件

### 1. 新的 API 客户端
**文件**: `src/lib/api.ts`
**说明**: 替代原有的 `src/lib/supabase.ts`，使用自研后端 API
**功能**:
- `api.auth` - 认证相关（登录、注册、退出、获取用户信息）
- `api.db` - 数据库操作（查询、插入、更新、删除）
- `api.storage` - 文件存储（上传、下载、删除）

### 2. 新的认证上下文
**文件**: `src/context/AuthContextNew.tsx`
**说明**: 替代原有的 `src/context/AuthContext.tsx`
**功能**:
- 使用新的 API 客户端
- 兼容原有的 `useAuth` hook 接口
- 支持 token 本地存储

## 前端迁移指南

### 1. 替换导入
```typescript
// 旧代码
import { supabase } from '../lib/supabase';

// 新代码
import { api } from '../lib/api';
```

### 2. 替换认证调用
```typescript
// 旧代码
const { data, error } = await supabase.auth.signInWithPassword({
  email,
  password,
});

// 新代码
const response = await api.auth.signIn(email, password);
```

### 3. 替换数据库调用
```typescript
// 旧代码
const { data, error } = await supabase
  .from('projects')
  .select('*')
  .eq('id', id)
  .single();

// 新代码
const data = await api.db
  .from('projects')
  .select('*')
  .eq('id', id)
  .single();
```

### 4. 替换文件存储调用
```typescript
// 旧代码
const { data, error } = await supabase.storage
  .from('files')
  .upload(path, file);

// 新代码
const data = await api.storage
  .from('files')
  .upload(path, file);
```

### 5. 替换 AuthContext
```typescript
// 在 App.tsx 或入口文件中
// 旧代码
import { AuthProvider } from './context/AuthContext';

// 新代码
import { AuthProvider } from './context/AuthContextNew';
```

## 环境变量变更

### 旧环境变量
```
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key
```

### 新环境变量
```
VITE_API_URL=http://localhost:3000
```

## 需要手动迁移的文件

以下文件仍然包含 Supabase 引用，需要逐步替换：

### 高优先级（核心功能）
- `src/pages/Login.tsx` - 登录页面
- `src/pages/Profile.tsx` - 用户资料页面
- `src/components/Layout.tsx` - 布局组件

### 中优先级（业务功能）
- `src/pages/Dashboard.tsx`
- `src/pages/projects/*.tsx`
- `src/pages/tasks/*.tsx`
- `src/pages/system/*.tsx`
- `src/pages/water/*.tsx`
- `src/pages/stakeholders/*.tsx`
- `src/pages/suppliers/*.tsx`
- `src/pages/analysis/*.tsx`

### 低优先级（测试文件）
- `src/pages/Login.test.tsx`
- `src/pages/projects/ProjectList.test.tsx`
- `src/pages/tasks/components/__tests__/TaskDetail.test.tsx`

## 替代方案对照表

| 原 Supabase 功能 | 新实现 | 文件位置 |
|----------------|--------|---------|
| Supabase Auth | 自研 JWT + bcrypt | `api-new/src/services/authService.ts` |
| Supabase Database | PostgreSQL + Knex | `api-new/src/services/dbService.ts` |
| Supabase Storage | MinIO | `api-new/src/services/storageService.ts` |
| Supabase RLS | 应用层权限控制 | `api-new/src/services/permissionService.ts` |

## 注意事项

1. **API 兼容性**: 新的 API 客户端尽量保持了与 Supabase 相似的接口，但仍有差异，需要测试验证
2. **错误处理**: 新的 API 错误格式可能与 Supabase 不同，需要更新错误处理逻辑
3. **实时功能**: 目前新 API 不支持 Supabase Realtime，如需实时功能需要额外实现 WebSocket
4. **数据类型**: 部分数据类型可能需要转换，特别是时间戳和 JSON 字段

## 恢复 Supabase

如需恢复 Supabase 相关功能，可从 `.archive/supabase-backup/` 目录复制文件回原位置，并重新安装依赖：

```bash
npm install @supabase/supabase-js
```
