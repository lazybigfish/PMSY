# PMSY Nginx 配置修复记录

## 问题描述

**日期**: 2026-02-13

**现象**: 执行全新部署脚本后，日志显示部署成功，但无法打开页面（http://43.136.69.250）

## 问题原因

**根本原因**: `config/nginx/nginx.conf` 配置与 `docker-compose.yml` 不匹配

项目已移除 Kong API 网关（见 [2026-02-13-移除Kong网关记录.md](./2026-02-13-移除Kong网关记录.md)），但 nginx.conf 仍然配置了代理到 Kong：

| 配置项 | 原配置（错误） | 实际服务 |
|--------|---------------|----------|
| Auth 代理 | `http://kong:8000/auth/` | 应直连 `http://auth:9999` |
| REST 代理 | `http://kong:8000/rest/` | 应直连 `http://rest:3000` |
| API 代理 | `http://kong:8000/api/` | 应直连 `http://api:3001` |

由于 docker-compose.yml 中已无 `supabase-kong` 服务，Nginx 无法找到上游服务，导致页面无法访问。

## 修复内容

### 修改文件: `config/nginx/nginx.conf`

#### 1. Auth 代理路径修复
```nginx
# 修改前
proxy_pass http://kong:8000/auth/;

# 修改后
proxy_pass http://auth:9999/;
```

#### 2. REST API 代理路径修复
```nginx
# 修改前
proxy_pass http://kong:8000/rest/;

# 修改后
proxy_pass http://rest:3000/;
```

#### 3. PMSY API 代理路径修复
```nginx
# 修改前
# API 代理到 Kong 网关（经过认证）
proxy_pass http://kong:8000/api/;

# 修改后
# API 代理到 PMSY 后端服务
proxy_pass http://api:3001/api/;
```

## 修复后的架构

```
用户请求 -> Nginx (80端口)
    ├── /auth/* -> auth:9999 (GoTrue认证服务)
    ├── /rest/* -> rest:3000 (PostgREST服务)
    ├── /api/*  -> api:3001 (PMSY后端API)
    └── /*      -> 前端静态文件 (dist/)
```

## 验证步骤

修复后需要重新部署或更新服务器配置：

### 方式1: 重新部署（推荐）
```bash
./deploy/fresh-install/deploy.sh
```

### 方式2: 仅更新 Nginx 配置（如果其他服务正常）
```bash
# 1. 复制修复后的 nginx.conf 到服务器
scp config/nginx/nginx.conf ubuntu@43.136.69.250:/opt/pmsy/

# 2. 重启 Nginx 容器
ssh ubuntu@43.136.69.250 "cd /opt/pmsy && sudo docker-compose restart nginx"

# 3. 检查 Nginx 日志
ssh ubuntu@43.136.69.250 "cd /opt/pmsy && sudo docker-compose logs nginx"
```

## 测试验证

修复后应能正常访问：

| 地址 | 预期结果 |
|------|----------|
| http://43.136.69.250 | 显示前端登录页面 |
| http://43.136.69.250/auth/v1/settings | 返回 GoTrue 配置 JSON |
| http://43.136.69.250/rest/v1/ | 返回 PostgREST 信息 |
| http://43.136.69.250:3000 | Supabase Studio 管理界面 |

## 相关文件

- `config/nginx/nginx.conf` - Nginx 反向代理配置
- `config/docker/docker-compose.yml` - Docker 服务配置
- `deploy/records/2026-02-13-移除Kong网关记录.md` - Kong 移除记录
- `deploy/records/2026-02-13-全新部署记录.md` - 部署记录

## 后续建议

1. **统一配置检查**: 在部署脚本中添加 nginx.conf 与 docker-compose.yml 的一致性检查
2. **文档同步**: 修改架构时，确保所有相关配置文件同步更新
3. **自动化测试**: 部署后添加健康检查，验证关键端点可访问
