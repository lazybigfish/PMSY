# PMSY 全新部署记录

## 部署信息

- **部署日期**: 2026-02-13
- **服务器 IP**: 43.136.69.250
- **服务器用户**: ubuntu
- **部署目录**: /opt/pmsy
- **部署模式**: 在线部署（服务器可联网拉取 Docker 镜像）

## 部署前准备

### 1. 确认服务器信息
- 服务器 IP: 43.136.69.250
- SSH 用户名: ubuntu
- 服务器可访问 Docker Hub

### 2. 配置文件检查
- 更新了 `config/env/.env.supabase` 中的配置
- 同步了 `config/env/.env.production` 中的 ANON_KEY
- 使用 `./deploy/scripts/generate-jwt-keys.sh` 重新生成了与 JWT_SECRET 匹配的 Key

## 部署过程

### 执行的步骤

1. **运行全新部署脚本**
   ```bash
   ./deploy/fresh-install/deploy.sh
   ```

2. **选择部署模式**
   - 选择模式 1: 在线部署

3. **配置确认**
   - 服务器 IP: 43.136.69.250
   - 服务器用户名: ubuntu
   - 部署目录: /opt/pmsy

4. **环境清理**
   - 停止了现有容器
   - 删除了现有数据卷
   - 清理了部署目录

5. **前端构建**
   - 使用 `config/env/.env.production` 构建前端
   - 构建成功

6. **上传到服务器**
   - 上传了 dist、api、deploy、supabase 等目录
   - 上传了 docker-compose.yml、nginx.conf 等配置文件

7. **服务器端部署**
   - 拉取了 Docker 镜像
   - 启动了所有服务

## 部署后修复

### 问题 1: uuid-ossp 扩展未创建
**症状**: 数据库迁移失败，提示 `function uuid_generate_v4() does not exist`

**解决**:
```bash
# 创建 supabase_admin 角色
ssh -t ubuntu@43.136.69.250 "cd /opt/pmsy && echo \"CREATE ROLE supabase_admin WITH LOGIN SUPERUSER PASSWORD 'admin';\" | sudo docker-compose exec -T db psql -U postgres"

# 创建 uuid-ossp 扩展
ssh -t ubuntu@43.136.69.250 "cd /opt/pmsy && echo 'CREATE EXTENSION IF NOT EXISTS \"uuid-ossp\";' | sudo docker-compose exec -T db psql -U postgres"
```

### 问题 2: PostgREST 数据库连接失败
**症状**: rest 服务不断重启，日志显示 `password authentication failed for user "postgres"`

**原因**: docker-compose.yml 中的 PGRST_DB_URI 密码与 .env 中的密码不匹配
- .env 中的密码: `Willyou2026`
- docker-compose.yml 中的密码: `Willyou%402026`（URL 编码后的 Willyou@2026）

**解决**:
```bash
ssh -t ubuntu@43.136.69.250 "cd /opt/pmsy && sed -i 's|Willyou%402026|Willyou2026|g' docker-compose.yml"
ssh -t ubuntu@43.136.69.250 "cd /opt/pmsy && sudo docker-compose up -d rest"
```

### 问题 3: auth schema 不存在
**症状**: auth 服务无法启动，提示 `schema "auth" does not exist`

**解决**:
```bash
ssh -t ubuntu@43.136.69.250 "cd /opt/pmsy && sudo docker-compose exec -T db psql -U postgres -c 'CREATE SCHEMA IF NOT EXISTS auth;'"
ssh -t ubuntu@43.136.69.250 "cd /opt/pmsy && sudo docker-compose exec -T db psql -U postgres -c 'GRANT ALL ON SCHEMA auth TO postgres;'"
ssh -t ubuntu@43.136.69.250 "cd /opt/pmsy && sudo docker-compose restart auth"
```

## 服务状态

部署完成后，所有服务正常运行：

| 服务名 | 状态 | 端口 |
|--------|------|------|
| pmsy-api | Up | 3001 |
| pmsy-nginx | Up | 80, 443 |
| supabase-auth | Up | 9999 |
| supabase-db | Up (healthy) | 5432 |
| supabase-kong | Up (healthy) | 8000 |
| supabase-meta | Up (healthy) | 8080 |
| supabase-rest | Up | 3000 |
| supabase-storage | Up | 5000 |
| supabase-studio | Up | 3000 |

## 访问地址

- **前端**: http://43.136.69.250
- **Studio**: http://43.136.69.250:3000
- **API**: http://43.136.69.250:8000

## 默认账号

| 服务 | 账号 | 密码 |
|------|------|------|
| Studio | admin | Willyou2026 |
| Root 用户 | admin@yourcompany.com | Willyou2026 |
| PMSY 管理员 | admin@pmsy.com | admin123 |

## 后续建议

1. **修改默认密码**: 生产环境必须修改所有默认密码
2. **配置防火墙**: 确保只开放必要的端口（80, 443, 3000, 8000）
3. **配置 SSL**: 建议使用 HTTPS
4. **定期备份**: 设置数据库自动备份

## 常用命令

```bash
# 查看服务状态
ssh ubuntu@43.136.69.250 "cd /opt/pmsy && sudo docker-compose ps"

# 查看日志
ssh ubuntu@43.136.69.250 "cd /opt/pmsy && sudo docker-compose logs -f"

# 重启服务
ssh ubuntu@43.136.69.250 "cd /opt/pmsy && sudo docker-compose restart"

# 进入数据库
ssh ubuntu@43.136.69.250 "cd /opt/pmsy && sudo docker-compose exec db psql -U postgres"
```

## 备注

- 部署过程中遇到的主要问题是数据库初始化和配置同步
- 建议在下次部署前确保 `config/env/.env.supabase` 和 `docker-compose.yml` 中的密码一致
- uuid-ossp 扩展和 auth schema 需要在数据库启动后手动创建
