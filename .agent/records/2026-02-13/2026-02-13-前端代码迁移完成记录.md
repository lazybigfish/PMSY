# 前端代码迁移完成记录

## 迁移时间
2026-02-13

## 迁移内容
将前端代码从 Supabase 客户端迁移到自研 API 客户端

## 已更新的文件

### 1. 核心文件

#### Login.tsx
- **旧导入**: `import { useAuth } from '../context/AuthContext';`
- **新导入**: `import { useAuth } from '../context/AuthContextNew';`
- **变更**: 使用新的认证上下文，保持原有登录逻辑

#### Profile.tsx
- **旧导入**: 
  ```typescript
  import { supabase } from '../lib/supabase';
  import { useAuth } from '../context/AuthContext';
  ```
- **新导入**:
  ```typescript
  import { api } from '../lib/api';
  import { useAuth } from '../context/AuthContextNew';
  ```
- **变更**:
  - 使用 `api.auth.updateUser()` 替代 `supabase.from('profiles').update()`
  - 使用 `api.auth.updatePassword()` 替代 `supabase.auth.updateUser()`
  - 添加 `refreshProfile()` 调用以刷新用户信息

#### Layout.tsx
- **旧导入**:
  ```typescript
  import { useAuth } from '../context/AuthContext';
  import { supabase } from '../lib/supabase';
  ```
- **新导入**:
  ```typescript
  import { useAuth } from '../context/AuthContextNew';
  import { api } from '../lib/api';
  ```
- **变更**:
  - 使用 `api.db.from('role_permissions')` 替代 `supabase.from('role_permissions')`
  - 保持权限获取逻辑不变

### 2. 新增文件

#### src/lib/api.ts
- 新的 API 客户端，替代 `src/lib/supabase.ts`
- 提供 `api.auth`, `api.db`, `api.storage` 三个主要模块
- 兼容 Supabase 风格的 API 调用

#### src/context/AuthContextNew.tsx
- 新的认证上下文，替代 `src/context/AuthContext.tsx`
- 使用新的 API 客户端
- 兼容原有的 `useAuth` hook 接口

### 3. 环境变量更新

#### .env
```bash
# 新配置
VITE_API_URL=http://43.136.69.250:3000

# 旧配置（已注释）
# VITE_SUPABASE_URL=http://43.136.69.250
# VITE_SUPABASE_ANON_KEY=...
```

## 迁移对照表

| 原 Supabase 代码 | 新 API 代码 |
|----------------|------------|
| `supabase.auth.signInWithPassword({ email, password })` | `api.auth.signIn(email, password)` |
| `supabase.auth.signUp({ email, password })` | `api.auth.signUp({ email, password })` |
| `supabase.auth.signOut()` | `api.auth.signOut()` |
| `supabase.auth.getUser()` | `api.auth.getUser()` |
| `supabase.auth.updateUser({ password })` | `api.auth.updatePassword(oldPassword, newPassword)` |
| `supabase.from('table').select('*').eq('id', id)` | `api.db.from('table').select('*').eq('id', id)` |
| `supabase.from('table').insert(data)` | `api.db.from('table').insert(data)` |
| `supabase.from('table').update(data).eq('id', id)` | `api.db.from('table').update(data).eq('id', id)` |
| `supabase.storage.from('bucket').upload(path, file)` | `api.storage.from('bucket').upload(path, file)` |

## 需要继续迁移的文件

以下文件仍使用 Supabase，需要逐步替换：

### 高优先级
- `src/pages/Dashboard.tsx`
- `src/pages/projects/ProjectList.tsx`
- `src/pages/projects/ProjectDetail.tsx`
- `src/pages/tasks/TaskList.tsx`
- `src/pages/tasks/TaskDetail.tsx`

### 中优先级
- `src/pages/stakeholders/*.tsx`
- `src/pages/analysis/*.tsx`
- `src/pages/water/*.tsx`
- `src/pages/files/*.tsx`
- `src/pages/system/*.tsx`

### 低优先级
- `src/components/*.tsx` (Notifications, etc.)
- `src/pages/Login.test.tsx`
- `src/pages/projects/ProjectList.test.tsx`

## 迁移步骤

1. **替换导入**
   ```typescript
   // 旧
   import { supabase } from '../lib/supabase';
   import { useAuth } from '../context/AuthContext';
   
   // 新
   import { api } from '../lib/api';
   import { useAuth } from '../context/AuthContextNew';
   ```

2. **替换 API 调用**
   - 将 `supabase.from('table')` 替换为 `api.db.from('table')`
   - 将 `supabase.auth.xxx` 替换为 `api.auth.xxx`
   - 将 `supabase.storage` 替换为 `api.storage`

3. **处理响应数据**
   - 新 API 直接返回数据，不需要 `.data` 解构
   - 错误处理使用 try-catch

4. **测试验证**
   - 确保功能正常
   - 检查错误处理

## 注意事项

1. **API 响应格式**: 新 API 的响应格式与 Supabase 略有不同，需要调整数据处理逻辑
2. **错误处理**: 错误格式可能不同，需要更新错误提示
3. **实时功能**: 新 API 暂不支持 Realtime，需要额外实现
4. **文件上传**: 文件上传使用 FormData，与 Supabase 不同

## 下一步

1. 继续迁移业务页面文件
2. 更新测试文件
3. 验证所有功能正常
4. 部署到测试环境
