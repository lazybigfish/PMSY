# 本地部署验证记录

## 部署时间
2026-02-13 23:08

## 部署环境
- **操作系统**: macOS
- **Node.js**: v24.13.0
- **npm**: 11.6.2
- **Docker**: 29.2.0

## 部署步骤

### 1. 配置环境变量 ✅
- 创建 `.env` 文件
- 配置数据库、Redis、MinIO、JWT 参数

### 2. 启动 Docker 服务 ✅
```bash
docker-compose up -d postgres redis minio
```
- PostgreSQL: 端口 5432
- Redis: 端口 6379
- MinIO: 端口 9000/9001

### 3. 数据库初始化 ✅
- 自动执行 16 个迁移文件
- 创建 52 张数据表
- 插入系统管理员账号

### 4. 安装依赖并启动 API ✅
```bash
npm install
npm run dev
```
- 服务启动在 http://localhost:3001

## 测试结果

### 健康检查
```bash
curl http://localhost:3001/health
```
**结果**: ✅ `{"status":"ok","database":true,"redis":true,"minio":true}`

### 用户注册
```bash
curl -X POST http://localhost:3001/auth/v1/signup \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"password123","full_name":"测试用户"}'
```
**结果**: ✅ 成功创建用户，返回 access_token 和 refresh_token

### 用户登录
```bash
curl -X POST "http://localhost:3001/auth/v1/token?grant_type=password" \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"password123"}'
```
**结果**: ✅ 登录成功，返回 JWT Token

### 获取用户信息
```bash
curl http://localhost:3001/auth/v1/user \
  -H "Authorization: Bearer <token>"
```
**结果**: ✅ 返回用户详情

### REST API 查询
```bash
curl "http://localhost:3001/rest/v1/profiles?select=id,email,full_name,role&limit=5" \
  -H "Authorization: Bearer <token>"
```
**结果**: ✅ 返回用户列表

## 服务状态

| 服务 | 状态 | 端口 | 访问地址 |
|------|------|------|----------|
| PostgreSQL | ✅ 运行中 | 5432 | localhost:5432 |
| Redis | ✅ 运行中 | 6379 | localhost:6379 |
| MinIO | ✅ 运行中 | 9000/9001 | localhost:9000 |
| API 服务 | ✅ 运行中 | 3001 | http://localhost:3001 |

## 已创建的用户

| 邮箱 | 角色 | 姓名 |
|------|------|------|
| admin@pmsy.com | admin | 系统管理员 |
| test@example.com | user | 测试用户 |

## 问题修复

### 问题 1: MinIO 配置导入错误
**现象**: `TypeError: Cannot read properties of undefined (reading 'endPoint')`
**原因**: `storageService.ts` 从错误的文件导入 `MINIO_CONFIG`
**修复**: 将导入从 `../config/minio` 改为 `../config/constants`

## 下一步计划

1. 更新前端环境变量，指向新 API
2. 启动前端服务
3. 测试前端与后端的集成
4. 验证所有功能正常

## 相关文档

- [本地部署指南](/api-new/docs/LOCAL_DEPLOYMENT.md)
- [项目总结文档](/.agent/records/2026-02-13-移除Supabase依赖-项目总结.md)
