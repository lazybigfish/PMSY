# PMSY 移除 Kong 网关记录

## 修改日期
2026-02-13

## 修改背景
项目架构已经移除了 Kong API 网关，改为直接使用 Nginx 反向代理到各个服务。但 docker-compose.yml 和部署脚本中仍然保留了 Kong 服务的配置，需要清理。

## 架构变更

### 变更前（使用 Kong）
```
用户 -> Nginx (80) -> Kong (8000) -> Auth/REST/Storage/...
```

### 变更后（直连模式）
```
用户 -> Nginx (80) -> Auth (9999)/REST (3000)/API (3001)/...
```

## 修改内容

### 1. 修改 config/docker/docker-compose.yml

#### 1.1 移除 Kong 服务
```yaml
# 删除整个 kong 服务配置
kong:
  image: kong:2.8.1
  container_name: supabase-kong
  ...
```

#### 1.2 更新 Studio 服务配置
```yaml
# 修改前
SUPABASE_URL: http://kong:8000
API_URL: http://kong:8000
SUPABASE_PUBLIC_URL: ${API_EXTERNAL_URL:-http://localhost:8000}

# 修改后
SUPABASE_URL: ${API_EXTERNAL_URL:-http://localhost}
API_URL: ${API_EXTERNAL_URL:-http://localhost}
SUPABASE_PUBLIC_URL: ${API_EXTERNAL_URL:-http://localhost}
```

#### 1.3 更新 API 服务配置
```yaml
# 修改前
depends_on:
  kong:
    condition: service_started

# 修改后
depends_on:
  - auth
  - rest
```

#### 1.4 更新 Nginx 服务配置
```yaml
# 修改前
depends_on:
  - api
  - kong

# 修改后
depends_on:
  - api
  - auth
  - rest
```

### 2. 修改 deploy/fresh-install/deploy.sh

#### 2.1 移除 Kong 镜像导出
```bash
# 修改前
IMAGES=(
    "supabase/postgres:15.1.1.78"
    "kong:2.8.1"  # 删除此行
    "supabase/gotrue:v2.158.1"
    ...
)

# 修改后
IMAGES=(
    "supabase/postgres:15.1.1.78"
    "supabase/gotrue:v2.158.1"
    ...
)
```

#### 2.2 更新端口配置
```bash
# 修改前
sed -i "s|API_EXTERNAL_URL=.*|API_EXTERNAL_URL=http://$DEPLOY_SERVER_IP:8000|" .env
sed -i "s|SUPABASE_PUBLIC_URL=.*|SUPABASE_PUBLIC_URL=http://$DEPLOY_SERVER_IP:8000|" .env

# 修改后
sed -i "s|API_EXTERNAL_URL=.*|API_EXTERNAL_URL=http://$DEPLOY_SERVER_IP|" .env
sed -i "s|SUPABASE_PUBLIC_URL=.*|SUPABASE_PUBLIC_URL=http://$DEPLOY_SERVER_IP|" .env
```

#### 2.3 更新所有 8000 端口引用
- 前端构建验证：移除 `:8000` 检查
- 端口检查命令：`grep -E '8000|3000|80'` -> `grep -E '3000|80'`
- 访问地址提示：`http://$DEPLOY_SERVER_IP:8000` -> `http://$DEPLOY_SERVER_IP`

### 3. 修改 config/env/.env.supabase

#### 3.1 更新注释说明
```bash
# 修改前
# - API_EXTERNAL_URL: http://YOUR_SERVER_IP:8000
# - 生产环境：使用本地 Docker Supabase (http://YOUR_SERVER_IP:8000)

# 修改后
# - API_EXTERNAL_URL: http://YOUR_SERVER_IP
# - 生产环境：使用本地 Docker Supabase (http://YOUR_SERVER_IP)
```

#### 3.2 更新默认配置值
```bash
# 修改前
API_EXTERNAL_URL=http://43.136.69.250:8000
SUPABASE_PUBLIC_URL=http://43.136.69.250:8000

# 修改后
API_EXTERNAL_URL=http://43.136.69.250
SUPABASE_PUBLIC_URL=http://43.136.69.250
```

## 访问地址变更

| 服务 | 变更前 | 变更后 |
|------|--------|--------|
| 前端 | http://IP | http://IP（不变） |
| Studio | http://IP:3000 | http://IP:3000（不变） |
| API | http://IP:8000 | http://IP（80端口） |
| Auth | http://IP:8000/auth | http://IP/auth |
| REST | http://IP:8000/rest | http://IP/rest |

## 服务列表变更

### 移除的服务
- `supabase-kong` (Kong API 网关)

### 保留的服务
- `supabase-db` (PostgreSQL)
- `supabase-auth` (GoTrue 认证)
- `supabase-rest` (PostgREST)
- `supabase-storage` (Storage)
- `supabase-realtime` (Realtime)
- `supabase-meta` (Postgres Meta)
- `supabase-studio` (Studio)
- `supabase-imgproxy` (Imgproxy)
- `pmsy-api` (PMSY 后端 API)
- `pmsy-nginx` (Nginx 前端)

## 测试建议

1. **部署测试**
   ```bash
   ./deploy/fresh-install/deploy.sh
   ```

2. **服务状态检查**
   ```bash
   ssh ubuntu@服务器IP "cd /opt/pmsy && sudo docker-compose ps"
   ```
   确认没有 `supabase-kong` 容器

3. **端口检查**
   ```bash
   ssh ubuntu@服务器IP "sudo netstat -tlnp | grep -E '3000|80'"
   ```
   确认没有 8000 端口监听

4. **功能测试**
   - 访问 http://服务器IP - 应显示前端页面
   - 访问 http://服务器IP/auth/v1/settings - 应返回 auth 配置
   - 访问 http://服务器IP/rest/v1/ - 应返回 PostgREST 信息
   - 登录功能应正常工作

## 注意事项

1. **端口冲突**
   - 80 端口可能被其他服务占用
   - 部署前检查端口占用情况

2. **防火墙配置**
   - 确保防火墙开放 80 端口
   - 3000 端口（Studio）根据需求开放

3. **Nginx 配置**
   - 所有 API 路由已通过 nginx.conf 配置
   - 无需额外配置 Kong 路由

4. **SSL/HTTPS**
   - 如需 HTTPS，配置 Nginx SSL 即可
   - 无需在 Kong 中配置证书

## 相关文件

- `config/docker/docker-compose.yml` - Docker 服务配置
- `deploy/fresh-install/deploy.sh` - 部署脚本
- `config/env/.env.supabase` - 服务器环境配置
- `nginx.conf` - Nginx 反向代理配置

## 回滚方案

如需恢复 Kong，从 git 历史恢复以下配置：
1. docker-compose.yml 中的 kong 服务
2. deploy.sh 中的 kong 镜像和端口配置
3. .env.supabase 中的 8000 端口配置
