# 移除 Supabase 依赖 - 任务 1.4 实施记录

## 任务信息
- **任务编号**: 1.4
- **任务名称**: 创建数据库 Schema
- **执行日期**: 2026-02-13
- **执行人**: AI Assistant

## 执行内容

### 分析现有 Supabase 结构

分析了 `/supabase/migrations/` 目录下的所有 migration 文件，提取了核心业务表结构。

### 创建的 Migration 文件

#### 001_create_profiles.sql
- **profiles 表**: 替代 Supabase auth.users
  - id, email, username, password_hash, full_name, avatar_url
  - role, phone, is_active, email_confirmed_at
  - created_at, updated_at, last_sign_in_at
- **索引**: email, username, role, is_active
- **触发器**: 自动更新 updated_at
- **默认数据**: 插入管理员用户（需替换密码哈希）

#### 002_create_projects.sql
- **projects 表**: 项目信息
  - id, name, customer_name, amount, description
  - status, is_public, manager_id, current_milestone_id
- **project_members 表**: 项目成员
  - id, project_id, user_id, role, joined_at
- **project_modules 表**: 项目功能模块
  - id, project_id, parent_id, name, description
  - status, progress, sort_order, level

#### 003_create_milestones.sql
- **milestone_templates 表**: 里程碑模板
  - id, name, description, phase_order, is_active
- **project_milestones 表**: 项目里程碑实例
  - id, project_id, template_id, name, description
  - status, start_date, end_date, phase_order, is_current
- **milestone_tasks 表**: 里程碑任务
  - id, milestone_id, name, description
  - is_required, is_completed, completed_at, output_documents
- **默认数据**: 插入7个标准里程碑模板

#### 004_create_tasks.sql
- **tasks 表**: 任务
  - id, project_id, module_id, milestone_id, title, description
  - status, priority, is_public, assigned_to, created_by
  - due_date, completed_at, progress
- **task_assignees 表**: 任务处理人（支持多处理人）
- **task_progress_updates 表**: 任务进度更新记录
- **task_comments 表**: 任务评论

#### 005_create_suppliers_and_risks.sql
- **suppliers 表**: 供应商
- **supplier_payment_plans 表**: 供应商付款计划
- **supplier_acceptance_records 表**: 供应商验收记录
- **risks 表**: 项目风险

#### 006_create_files_and_notifications.sql
- **folders 表**: 文件夹
- **files 表**: 文件
- **file_operation_logs 表**: 文件操作日志
- **notifications 表**: 通知
- **storage_quotas 表**: 存储配额

#### 007_create_reports_and_ai.sql
- **reports 表**: 日报/周报
- **report_templates 表**: 报告模板
- **ai_providers 表**: AI 提供商配置
- **ai_roles 表**: AI 角色配置
- **ai_analysis_results 表**: AI 分析结果
- **默认数据**: 插入默认 AI 角色

#### 008_create_water_module.sql
- **forum_posts 表**: 论坛帖子（水漫金山模块）
- **forum_comments 表**: 论坛评论
- **forum_likes 表**: 点赞记录
- **hot_news 表**: 热点资讯

## 设计特点

### 1. 使用 gen_random_uuid() 替代 uuid-ossp
- 标准 PostgreSQL 13+ 内置函数
- 无需额外扩展

### 2. 统一的更新时间戳触发器
- 复用 `update_updated_at_column()` 函数
- 所有表统一使用

### 3. 外键约束
- 所有关联表都设置了外键
- 使用 ON DELETE CASCADE 或 SET NULL

### 4. 索引优化
- 所有外键字段都有索引
- 常用查询字段都有索引
- 状态字段、时间字段都有索引

### 5. CHECK 约束
- 所有状态字段都有 CHECK 约束
- 保证数据完整性

## 遇到的问题

无

## 解决方案

无

## 下一步

任务 1.5：实现 JWT 服务
- 创建 services/jwtService.ts
- 实现 Token 生成和验证
- 编写单元测试

## 数据库表清单

| 序号 | 表名 | 说明 |
|------|------|------|
| 1 | profiles | 用户表（替代 auth.users） |
| 2 | projects | 项目表 |
| 3 | project_members | 项目成员表 |
| 4 | project_modules | 项目功能模块表 |
| 5 | milestone_templates | 里程碑模板表 |
| 6 | project_milestones | 项目里程碑表 |
| 7 | milestone_tasks | 里程碑任务表 |
| 8 | tasks | 任务表 |
| 9 | task_assignees | 任务处理人表 |
| 10 | task_progress_updates | 任务进度更新表 |
| 11 | task_comments | 任务评论表 |
| 12 | suppliers | 供应商表 |
| 13 | supplier_payment_plans | 供应商付款计划表 |
| 14 | supplier_acceptance_records | 供应商验收记录表 |
| 15 | risks | 风险表 |
| 16 | folders | 文件夹表 |
| 17 | files | 文件表 |
| 18 | file_operation_logs | 文件操作日志表 |
| 19 | notifications | 通知表 |
| 20 | storage_quotas | 存储配额表 |
| 21 | reports | 报告表 |
| 22 | report_templates | 报告模板表 |
| 23 | ai_providers | AI 提供商表 |
| 24 | ai_roles | AI 角色表 |
| 25 | ai_analysis_results | AI 分析结果表 |
| 26 | forum_posts | 论坛帖子表 |
| 27 | forum_comments | 论坛评论表 |
| 28 | forum_likes | 论坛点赞表 |
| 29 | hot_news | 热点资讯表 |

**总计: 29 张表**

## 备注

数据库 Schema 已创建完成，与原有 Supabase 结构保持一致。启动 Docker 后会自动执行这些 migrations。
