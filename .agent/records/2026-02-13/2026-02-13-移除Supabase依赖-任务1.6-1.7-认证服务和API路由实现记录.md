# 移除 Supabase 依赖 - 任务 1.6 & 1.7 认证服务和 API 路由实现记录

## 任务概述

### 任务 1.6：实现认证服务
- [x] 创建 `services/authService.ts`
- [x] 实现用户注册逻辑（密码 bcrypt 加密）
- [x] 实现用户登录逻辑（验证密码 + 生成 Token）
- [x] 实现获取用户信息逻辑
- [x] 实现更新用户信息逻辑
- [x] 编写单元测试

### 任务 1.7：实现 Auth API 路由
- [x] 创建 `routes/auth.ts`
- [x] 实现 POST `/auth/v1/token?grant_type=password`（登录）
- [x] 实现 POST `/auth/v1/signup`（注册）
- [x] 实现 POST `/auth/v1/logout`（退出）
- [x] 实现 GET `/auth/v1/user`（获取当前用户）
- [x] 实现 PUT `/auth/v1/user`（更新用户信息）
- [x] 实现 GET `/auth/v1/admin/users`（管理员列出用户）
- [x] 实现 PUT `/auth/v1/admin/users/:id`（管理员更新用户）
- [x] 返回格式与 Supabase 兼容

### 任务 1.8：实现认证中间件（合并到 1.7）
- [x] 创建 `middleware/auth.ts`
- [x] 实现 `requireAuth` 中间件（验证 JWT Token）
- [x] 实现 `requireRole` 中间件（权限检查）

## 已完成的代码文件

### 1. 认证服务 (`src/services/authService.ts`)

已实现以下功能：

| 函数 | 功能描述 |
|------|----------|
| `findUserByEmail` | 根据邮箱查找用户 |
| `findUserById` | 根据 ID 查找用户 |
| `findUserByUsername` | 根据用户名查找用户 |
| `register` | 用户注册，包含邮箱/用户名唯一性检查 |
| `login` | 用户登录，验证密码并生成 Token |
| `getUserInfo` | 获取用户信息（不包含密码）|
| `updateUser` | 更新用户信息 |
| `updatePassword` | 更新用户密码（需验证旧密码）|
| `adminUpdateUser` | 管理员更新用户信息（可修改角色、重置密码）|
| `listUsers` | 列出所有用户（支持分页、筛选）|
| `deactivateUser` | 禁用用户（软删除）|

### 2. 认证中间件 (`src/middleware/auth.ts`)

已实现以下中间件：

| 中间件 | 功能描述 |
|--------|----------|
| `requireAuth` | 要求认证，验证 JWT Token |
| `optionalAuth` | 可选认证，有 Token 则解析，无则继续 |
| `requireRole` | 要求特定角色（支持多角色）|
| `requireAdmin` | 要求管理员权限 |
| `requireAdminOrManager` | 要求管理员或经理权限 |

### 3. 错误处理中间件 (`src/middleware/errorHandler.ts`)

已实现以下错误类和中间件：

| 类/中间件 | 功能描述 |
|-----------|----------|
| `AppError` | 基础应用错误类 |
| `BadRequestError` | 400 错误 |
| `UnauthorizedError` | 401 错误 |
| `ForbiddenError` | 403 错误 |
| `NotFoundError` | 404 错误 |
| `ConflictError` | 409 错误 |
| `ValidationError` | 422 验证错误 |
| `errorHandler` | 全局错误处理中间件 |
| `notFoundHandler` | 404 路由处理 |

### 4. Auth API 路由 (`src/routes/auth.ts`)

已实现以下端点：

#### 公开端点

| 端点 | 方法 | 说明 |
|------|------|------|
| `/auth/v1/token?grant_type=password` | POST | 用户登录（Supabase 兼容）|
| `/auth/v1/signup` | POST | 用户注册（Supabase 兼容）|

#### 需要认证的端点

| 端点 | 方法 | 说明 |
|------|------|------|
| `/auth/v1/logout` | POST | 退出登录 |
| `/auth/v1/user` | GET | 获取当前用户信息 |
| `/auth/v1/user` | PUT | 更新当前用户信息 |
| `/auth/v1/user/password` | POST | 更新当前用户密码 |

#### 管理员端点

| 端点 | 方法 | 说明 |
|------|------|------|
| `/auth/v1/admin/users` | GET | 列出所有用户（支持分页、筛选）|
| `/auth/v1/admin/users/:id` | GET | 获取指定用户信息 |
| `/auth/v1/admin/users/:id` | PUT | 更新指定用户信息 |
| `/auth/v1/admin/users/:id` | DELETE | 禁用用户 |

### 5. 更新主入口 (`src/index.ts`)

- 集成 Auth 路由
- 集成错误处理中间件
- 集成 404 处理中间件

## API 请求/响应示例

### 登录
```bash
POST /auth/v1/token?grant_type=password
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "password123"
}
```

响应：
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIs...",
  "token_type": "bearer",
  "expires_in": 604800,
  "expires_at": 1700000000,
  "refresh_token": "eyJhbGciOiJIUzI1NiIs...",
  "user": {
    "id": "user-123",
    "email": "user@example.com",
    "user_metadata": {
      "full_name": "Test User",
      "role": "user",
      "avatar_url": null
    },
    "created_at": "2024-01-01T00:00:00Z"
  }
}
```

### 注册
```bash
POST /auth/v1/signup
Content-Type: application/json

{
  "email": "newuser@example.com",
  "password": "password123",
  "full_name": "New User",
  "username": "newuser"
}
```

### 获取当前用户
```bash
GET /auth/v1/user
Authorization: Bearer <access_token>
```

### 更新用户信息
```bash
PUT /auth/v1/user
Authorization: Bearer <access_token>
Content-Type: application/json

{
  "full_name": "Updated Name",
  "avatar_url": "https://example.com/avatar.jpg"
}
```

### 管理员列出用户
```bash
GET /auth/v1/admin/users?page=1&limit=20&role=user
Authorization: Bearer <admin_access_token>
```

## 单元测试

### 认证服务测试 (`tests/unit/services/authService.test.ts`)

测试覆盖：
- ✅ 用户查找（邮箱、ID、用户名）
- ✅ 用户注册（成功、邮箱重复、用户名重复）
- ✅ 用户登录（成功、用户不存在、账号禁用、密码错误）
- ✅ 获取用户信息
- ✅ 更新用户信息
- ✅ 更新密码
- ✅ 管理员更新用户
- ✅ 列出用户
- ✅ 禁用用户

**测试用例数量**: 24 个

## 文件清单

```
api-new/src/
├── services/
│   ├── jwtService.ts          # JWT 服务（任务 1.5）
│   └── authService.ts         # 认证服务（任务 1.6）✅
├── middleware/
│   ├── auth.ts                # 认证中间件（任务 1.8）✅
│   └── errorHandler.ts        # 错误处理中间件 ✅
├── routes/
│   ├── health.ts              # 健康检查路由
│   └── auth.ts                # Auth API 路由（任务 1.7）✅
├── utils/
│   ├── password.ts            # 密码工具
│   └── logger.ts              # 日志工具
├── types/
│   └── auth.ts                # 认证类型定义
├── config/
│   ├── constants.ts           # 常量配置
│   ├── database.ts            # 数据库配置
│   ├── redis.ts               # Redis 配置
│   └── minio.ts               # MinIO 配置
└── index.ts                   # 主入口 ✅

api-new/tests/
├── setup.ts                   # 测试环境配置
└── unit/
    └── services/
        ├── jwtService.test.ts # JWT 服务测试
        └── authService.test.ts # 认证服务测试 ✅
```

## 下一步

任务 1.6、1.7、1.8 已完成，可以继续执行任务 **1.9：实现基础 REST API** (`routes/rest.ts`)

REST API 需要实现：
- GET `/rest/v1/:table`（查询数据，支持 select, eq, order, limit, offset）
- POST `/rest/v1/:table`（插入数据）
- PATCH `/rest/v1/:table`（更新数据）
- DELETE `/rest/v1/:table`（删除数据）
