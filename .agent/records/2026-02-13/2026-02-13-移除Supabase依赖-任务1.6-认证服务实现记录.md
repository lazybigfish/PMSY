# 移除 Supabase 依赖 - 任务 1.6 认证服务实现记录

## 任务概述

任务 1.6：实现认证服务
- 创建 `services/authService.ts` ✅
- 实现用户注册逻辑（密码 bcrypt 加密）✅
- 实现用户登录逻辑（验证密码 + 生成 Token）✅
- 实现获取用户信息逻辑 ✅
- 实现更新用户信息逻辑 ✅
- 编写单元测试 ✅

## 已完成的代码文件

### 1. 认证服务 (`src/services/authService.ts`)

已实现以下功能：

| 函数 | 功能描述 |
|------|----------|
| `findUserByEmail` | 根据邮箱查找用户 |
| `findUserById` | 根据 ID 查找用户 |
| `findUserByUsername` | 根据用户名查找用户 |
| `register` | 用户注册（含邮箱/用户名唯一性检查）|
| `login` | 用户登录（验证密码 + 生成 Token）|
| `getUserInfo` | 获取用户信息（不包含密码）|
| `updateUser` | 更新用户信息 |
| `updatePassword` | 更新用户密码（需验证旧密码）|
| `adminUpdateUser` | 管理员更新用户信息（可修改角色、重置密码）|
| `listUsers` | 列出所有用户（支持分页和筛选）|
| `deactivateUser` | 禁用用户（软删除）|

### 2. 认证服务测试 (`tests/unit/services/authService.test.ts`)

测试覆盖：
- ✅ 用户查找测试（邮箱、ID、用户名）
- ✅ 用户注册测试（成功、邮箱已存在、用户名已存在）
- ✅ 用户登录测试（成功、用户不存在、账号禁用、密码错误）
- ✅ 获取用户信息测试
- ✅ 更新用户信息测试
- ✅ 更新密码测试
- ✅ 管理员功能测试（更新角色、重置密码）
- ✅ 用户列表测试
- ✅ 禁用用户测试

**测试用例数量**: 21 个

## 功能详情

### 用户注册流程

1. 检查邮箱是否已存在
2. 检查用户名是否已存在（如果提供）
3. 使用 bcrypt 哈希密码
4. 创建用户记录
5. 生成 JWT Token 和 Refresh Token
6. 返回 Supabase 兼容的响应格式

### 用户登录流程

1. 根据邮箱查找用户
2. 检查账号是否激活
3. 验证密码
4. 更新最后登录时间
5. 生成 JWT Token 和 Refresh Token
6. 返回 Supabase 兼容的响应格式

### 响应格式（兼容 Supabase）

```typescript
{
  user: {
    id: string;
    email: string;
    user_metadata: {
      full_name: string | null;
      role: string;
      avatar_url: string | null;
    };
    created_at: string;
  };
  session: {
    access_token: string;
    token_type: 'bearer';
    expires_in: number;
    expires_at: number;
    refresh_token: string;
  };
}
```

## 文件清单

```
api-new/
├── src/
│   └── services/
│       ├── jwtService.ts          # JWT 服务（任务 1.5）
│       └── authService.ts         # 认证服务（任务 1.6）
└── tests/
    └── unit/
        └── services/
            ├── jwtService.test.ts # JWT 服务测试
            └── authService.test.ts # 认证服务测试
```

## 依赖关系

```
authService.ts
  ├── jwtService.ts (generateToken, generateRefreshToken, getExpiresIn, getExpiresAt)
  ├── password.ts (hashPassword, verifyPassword)
  ├── database.ts (db)
  └── types/auth.ts (User, LoginRequest, SignUpRequest, etc.)
```

## 下一步

任务 1.6 已完成，可以继续执行任务 1.7：**实现 Auth API 路由** (`routes/auth.ts`)

Auth API 路由需要实现：
- POST `/auth/v1/token?grant_type=password`（登录）
- POST `/auth/v1/signup`（注册）
- POST `/auth/v1/logout`（退出）
- GET `/auth/v1/user`（获取当前用户）
- PUT `/auth/v1/user`（更新用户信息）
- GET `/auth/v1/admin/users`（管理员列出用户）
- PUT `/auth/v1/admin/users/:id`（管理员更新用户）
