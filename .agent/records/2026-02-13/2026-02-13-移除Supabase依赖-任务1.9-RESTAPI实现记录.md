# 移除 Supabase 依赖 - 任务 1.9 REST API 实现记录

## 任务概述

任务 1.9：实现基础 REST API
- [x] 创建 `services/dbService.ts` 封装数据库操作
- [x] 创建 `routes/rest.ts` REST API 路由
- [x] 实现 GET `/rest/v1/:table`（查询数据）
- [x] 实现 POST `/rest/v1/:table`（插入数据）
- [x] 实现 PATCH `/rest/v1/:table`（更新数据）
- [x] 实现 DELETE `/rest/v1/:table`（删除数据）
- [x] 返回格式与 Supabase 兼容（数组格式）

## 已完成的代码文件

### 1. 数据库服务 (`src/services/dbService.ts`)

已实现以下功能：

| 函数 | 功能描述 |
|------|----------|
| `query` | 查询数据，支持复杂条件 |
| `queryOne` | 查询单条数据 |
| `findById` | 根据 ID 查询 |
| `insert` | 插入单条数据 |
| `insertMany` | 批量插入数据 |
| `update` | 批量更新数据 |
| `updateById` | 根据 ID 更新 |
| `remove` | 批量删除数据 |
| `removeById` | 根据 ID 删除 |
| `count` | 统计数据数量 |
| `transaction` | 执行事务 |
| `tableExists` | 检查表是否存在 |
| `getTableColumns` | 获取表的所有列 |

#### 支持的查询条件

| 条件 | 说明 | 示例 |
|------|------|------|
| `select` | 选择字段 | `select=id,name,status` |
| `eq` | 等于 | `eq.status=active` |
| `neq` | 不等于 | `neq.status=deleted` |
| `gt` | 大于 | `gt.created_at=2024-01-01` |
| `gte` | 大于等于 | `gte.priority=1` |
| `lt` | 小于 | `lt.due_date=2024-12-31` |
| `lte` | 小于等于 | `lte.progress=100` |
| `like` | 模糊查询 | `like.name=%test%` |
| `ilike` | 不区分大小写模糊查询 | `ilike.email=%@example.com` |
| `in` | IN 查询 | `in.status=active,pending` |
| `is` | IS NULL/TRUE/FALSE | `is.deleted_at=null` |
| `order` | 排序 | `order=created_at.desc` |
| `limit` | 限制数量 | `limit=10` |
| `offset` | 偏移量 | `offset=20` |

### 2. REST API 路由 (`src/routes/rest.ts`)

已实现以下端点：

| 端点 | 方法 | 说明 |
|------|------|------|
| `/rest/v1/:table` | GET | 查询数据列表 |
| `/rest/v1/:table/:id` | GET | 根据 ID 查询单条数据 |
| `/rest/v1/:table` | POST | 插入数据 |
| `/rest/v1/:table` | PATCH | 批量更新数据 |
| `/rest/v1/:table/:id` | PATCH | 根据 ID 更新单条数据 |
| `/rest/v1/:table` | DELETE | 批量删除数据 |
| `/rest/v1/:table/:id` | DELETE | 根据 ID 删除单条数据 |
| `/rest/v1/:table` | HEAD | 获取数据计数 |

所有端点都需要认证（`requireAuth` 中间件）

## API 请求/响应示例

### 查询数据
```bash
GET /rest/v1/projects?select=id,name,status&eq.status=active&order=created_at.desc&limit=10
Authorization: Bearer <access_token>
```

响应：
```json
[
  {
    "id": "proj-1",
    "name": "项目 A",
    "status": "active"
  },
  {
    "id": "proj-2",
    "name": "项目 B",
    "status": "active"
  }
]
```

### 插入数据
```bash
POST /rest/v1/projects?select=*
Authorization: Bearer <access_token>
Content-Type: application/json

{
  "name": "新项目",
  "status": "active",
  "description": "项目描述"
}
```

### 更新数据
```bash
PATCH /rest/v1/projects/eq.id=proj-1?select=*
Authorization: Bearer <access_token>
Content-Type: application/json

{
  "name": "更新后的项目名称",
  "status": "completed"
}
```

或根据 ID 更新：
```bash
PATCH /rest/v1/projects/proj-1?select=*
Authorization: Bearer <access_token>
Content-Type: application/json

{
  "name": "更新后的项目名称"
}
```

### 删除数据
```bash
DELETE /rest/v1/projects/eq.id=proj-1
Authorization: Bearer <access_token>
```

或根据 ID 删除：
```bash
DELETE /rest/v1/projects/proj-1
Authorization: Bearer <access_token>
```

### 获取计数
```bash
HEAD /rest/v1/projects?eq.status=active
Authorization: Bearer <access_token>
```

响应头：
```
X-Total-Count: 42
```

## 安全特性

1. **表名验证**：使用正则表达式验证表名，防止 SQL 注入
2. **认证要求**：所有 REST API 端点都需要有效的 JWT Token
3. **自动添加审计字段**：
   - 插入时自动添加 `created_by` 字段
   - 更新时自动添加 `updated_by` 字段
4. **条件限制**：批量更新和删除必须提供条件参数，防止误操作

## 文件清单

```
api-new/src/
├── services/
│   ├── jwtService.ts          # JWT 服务
│   ├── authService.ts         # 认证服务
│   └── dbService.ts           # 数据库服务 ✅
├── middleware/
│   ├── auth.ts                # 认证中间件
│   └── errorHandler.ts        # 错误处理中间件
├── routes/
│   ├── health.ts              # 健康检查路由
│   ├── auth.ts                # Auth API 路由
│   └── rest.ts                # REST API 路由 ✅
└── index.ts                   # 主入口（已更新）
```

## 阶段 1 完成总结

至此，**阶段 1：搭建新后端** 的所有任务已完成：

| 任务 | 状态 |
|------|------|
| 1.1 创建项目基础结构 | ✅ 完成 |
| 1.2 配置 Docker 开发环境 | ✅ 完成 |
| 1.3 数据库连接和配置 | ✅ 完成 |
| 1.4 创建数据库 Schema | ✅ 完成 |
| 1.5 实现 JWT 服务 | ✅ 完成 |
| 1.6 实现认证服务 | ✅ 完成 |
| 1.7 实现 Auth API 路由 | ✅ 完成 |
| 1.8 实现认证中间件 | ✅ 完成 |
| 1.9 实现基础 REST API | ✅ 完成 |
| 1.10 错误处理和日志 | ✅ 完成 |

## 下一步

可以继续执行 **阶段 2：完善功能**：

- **任务 2.1**：实现复杂查询支持（关联查询 join、聚合查询 count/sum/avg）
- **任务 2.2**：实现 Storage API（文件上传、下载）
- **任务 2.3**：实现权限控制（RLS 替代方案）
- **任务 2.4**：数据迁移脚本
- **任务 2.5**：Supabase 格式兼容工具
- **任务 2.6**：API 服务入口完善

是否需要继续执行阶段 2 的任务？
