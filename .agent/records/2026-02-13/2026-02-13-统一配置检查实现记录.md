# PMSY 统一配置检查实现记录

## 实现日期
2026-02-13

## 背景
在 [2026-02-13-nginx配置修复记录](./2026-02-13-nginx配置修复记录.md) 中，我们发现 nginx.conf 与 docker-compose.yml 配置不一致导致了部署后页面无法访问的问题。为了防止类似问题再次发生，实现了统一的配置一致性检查脚本。

## 实现内容

### 1. 创建配置检查脚本

**文件**: `deploy/scripts/check-config-consistency.sh`

此脚本在部署前自动检查以下配置一致性：

#### 检查项 1: 配置文件存在性
- 检查 `config/docker/docker-compose.yml` 是否存在
- 检查 `config/nginx/nginx.conf` 是否存在
- 检查 `config/env/.env.supabase` 是否存在

#### 检查项 2: Nginx 代理配置
- 提取 nginx.conf 中的所有 `proxy_pass` 目标服务
- 验证每个代理目标是否在 docker-compose.yml 中定义
- 防止配置了不存在的服务（如已移除的 Kong）

#### 检查项 3: Kong 网关残留配置
- 检查 nginx.conf 中是否仍包含 "kong" 的引用
- 如果存在，提示修改为直连服务

#### 检查项 4: 端口配置一致性
- 检查 auth 服务端口 (9999)
- 检查 rest 服务端口 (3000)
- 检查 api 服务端口 (3001)
- 区分内部网络通信和主机端口映射

#### 检查项 5: 环境变量配置
- 检查 `API_EXTERNAL_URL` 是否包含已移除的 :8000 端口
- 检查 `SITE_URL` 是否包含已移除的 :8000 端口

### 2. 集成到部署脚本

**修改文件**: `deploy/fresh-install/deploy.sh`

在部署流程开始时（步骤 0）添加配置检查：

```bash
# ==========================================
# 配置一致性检查
# ==========================================
echo -e "${BLUE}[步骤 0] 执行配置一致性检查...${NC}"
echo ""

if [ -f "deploy/scripts/check-config-consistency.sh" ]; then
    if ! ./deploy/scripts/check-config-consistency.sh; then
        echo ""
        echo -e "${RED}❌ 配置检查未通过，请修复上述错误后再进行部署${NC}"
        echo ""
        echo "如需跳过检查，请修改 deploy/fresh-install/deploy.sh 脚本"
        exit 1
    fi
    echo ""
    echo -e "${GREEN}✅ 配置一致性检查通过${NC}"
else
    echo -e "${YELLOW}⚠️  警告: 配置检查脚本不存在，跳过检查${NC}"
fi
echo ""
```

## 使用方法

### 单独运行配置检查
```bash
./deploy/scripts/check-config-consistency.sh
```

### 部署时自动检查
```bash
./deploy/fresh-install/deploy.sh
```
部署脚本会在开始部署前自动执行配置检查，如果检查不通过会终止部署。

## 检查输出示例

### 检查通过
```
========================================
PMSY 配置一致性检查
========================================

[检查 1/5] 检查配置文件存在性

✅ docker-compose.yml 文件存在
✅ nginx.conf 文件存在
✅ .env.supabase 文件存在

[检查 2/5] 检查 Nginx 代理配置

ℹ️  Nginx 代理目标服务:
  - api
  - auth
  - rest

✅ 代理目标 'api' 在 docker-compose.yml 中存在
✅ 代理目标 'auth' 在 docker-compose.yml 中存在
✅ 代理目标 'rest' 在 docker-compose.yml 中存在

[检查 3/5] 检查 Kong 网关残留配置

✅ nginx.conf 中没有 Kong 相关配置

[检查 4/5] 检查端口配置一致性

ℹ️  检查关键服务端口...
ℹ️  auth 服务使用内部网络通信（端口 9999），无需主机端口映射
ℹ️  rest 服务使用内部网络通信（端口 3000），无需主机端口映射
✅ api 服务端口配置一致 (3001)

[检查 5/5] 检查环境变量配置

ℹ️  API_EXTERNAL_URL: http://43.136.69.250
ℹ️  SITE_URL: http://43.136.69.250

========================================
检查完成
========================================

🎉 所有检查通过，配置一致性良好！
```

### 检查失败示例
```
[检查 2/5] 检查 Nginx 代理配置

ℹ️  Nginx 代理目标服务:
  - kong

❌ 错误: 代理目标 'kong' 在 docker-compose.yml 中不存在！
ℹ️  请检查 nginx.conf 中的 proxy_pass 配置，或确保 docker-compose.yml 中定义了该服务

========================================
检查完成
========================================

❌ 检查完成，发现 1 个错误，0 个警告
请先修复错误后再进行部署
```

## 技术细节

### 关键正则表达式
```bash
# 提取 proxy_pass 目标服务
proxy_pass http://[a-zA-Z0-9_-]+:[0-9]+

# 检查服务是否存在
grep -qE "^\s+${service}:" docker-compose.yml

# 检查端口映射
grep -A 10 "^\s\+${service}:" docker-compose.yml | grep -q '"9999'
```

### 返回码
- `0` - 检查通过（无错误）
- `1` - 检查未通过（有错误）

## 后续建议

1. **扩展检查项**
   - 检查 JWT_SECRET 与 Key 是否匹配
   - 检查 .env.supabase 与 .env.production 配置一致性
   - 检查数据库迁移文件是否存在

2. **CI/CD 集成**
   - 在 GitHub Actions 中添加配置检查步骤
   - 在提交前自动检查配置变更

3. **文档同步检查**
   - 检查配置文件与文档描述是否一致
   - 自动提醒更新相关文档

## 相关文件

- `deploy/scripts/check-config-consistency.sh` - 配置检查脚本
- `deploy/fresh-install/deploy.sh` - 部署脚本（已集成检查）
- `config/docker/docker-compose.yml` - Docker 服务配置
- `config/nginx/nginx.conf` - Nginx 反向代理配置
- `config/env/.env.supabase` - 服务器环境配置

## 总结

通过实现统一的配置一致性检查，可以在部署前及时发现 nginx.conf 与 docker-compose.yml 不匹配的问题，避免部署后服务无法正常访问的情况。这是从之前的部署问题中吸取的教训，通过自动化检查来预防类似问题再次发生。
