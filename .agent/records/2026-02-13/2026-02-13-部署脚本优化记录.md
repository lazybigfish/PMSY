# PMSY 部署脚本优化记录

## 优化日期
2026-02-13

## 优化背景
在 2026-02-13 的全新部署过程中，遇到了以下问题：
1. uuid-ossp 扩展未创建，导致数据库迁移失败
2. auth schema 不存在，导致 auth 服务无法启动
3. supabase_admin 角色不存在，影响扩展创建
4. docker-compose.yml 中 PostgREST 的数据库密码硬编码，与 .env 文件不一致

## 优化内容

### 1. 修改 docker-compose.yml
**文件**: `config/docker/docker-compose.yml`

**修改内容**:
```yaml
# 修改前
PGRST_DB_URI: postgres://postgres:Willyou%402026@db:5432/postgres

# 修改后
PGRST_DB_URI: postgres://postgres:${POSTGRES_PASSWORD:-Pmsy2024@LocalDb#Secure}@db:5432/postgres
```

**优化说明**:
- 使用环境变量 `${POSTGRES_PASSWORD}` 替代硬编码密码
- 避免密码不一致导致的连接失败问题
- 支持从 .env 文件动态读取密码

### 2. 修改 deploy/fresh-install/deploy.sh

#### 2.1 在线部署模式
**修改内容**:
- 添加自动创建 `supabase_admin` 角色
- 添加自动创建 `uuid-ossp` 扩展
- 调整步骤编号（从 5 步增加到 7 步）

**新增代码**:
```bash
echo "     步骤 1/7: 创建 Supabase 角色..."
# 创建 supabase_admin 角色（uuid-ossp 扩展需要）
sudo docker-compose exec -T db psql -U postgres -c "CREATE ROLE supabase_admin WITH LOGIN SUPERUSER PASSWORD 'admin';" 2>/dev/null || echo "     角色已存在或创建失败"

echo "     步骤 3/7: 创建 uuid-ossp 扩展..."
# 创建 uuid-ossp 扩展（用于 uuid_generate_v4() 函数）
sudo docker-compose exec -T db psql -U postgres -c 'CREATE EXTENSION IF NOT EXISTS "uuid-ossp";' 2>/dev/null || echo "     警告: uuid-ossp 扩展创建失败"
```

#### 2.2 半离线部署模式
**修改内容**:
- 同步在线部署模式的修改
- 添加相同的角色创建和扩展创建逻辑
- 调整步骤编号

#### 2.3 离线部署脚本 (offline-deploy.sh)
**修改内容**:
- 在生成的离线脚本中添加角色创建和扩展创建
- 确保离线部署也能自动完成数据库初始化

## 优化效果

### 部署前需要手动修复的问题
```bash
# 1. 创建 supabase_admin 角色
ssh -t ubuntu@43.136.69.250 "cd /opt/pmsy && echo \"CREATE ROLE supabase_admin WITH LOGIN SUPERUSER PASSWORD 'admin';\" | sudo docker-compose exec -T db psql -U postgres"

# 2. 创建 uuid-ossp 扩展
ssh -t ubuntu@43.136.69.250 "cd /opt/pmsy && echo 'CREATE EXTENSION IF NOT EXISTS \"uuid-ossp\";' | sudo docker-compose exec -T db psql -U postgres"

# 3. 创建 auth schema
ssh -t ubuntu@43.136.69.250 "cd /opt/pmsy && sudo docker-compose exec -T db psql -U postgres -c 'CREATE SCHEMA IF NOT EXISTS auth;'"

# 4. 修复 PostgREST 密码
ssh -t ubuntu@43.136.69.250 "cd /opt/pmsy && sed -i 's|Willyou%402026|Willyou2026|g' docker-compose.yml"
```

### 部署后自动完成
优化后的脚本会自动执行上述所有步骤，无需手动干预。

## 测试建议

1. **全新部署测试**
   ```bash
   ./deploy/fresh-install/deploy.sh
   ```
   选择模式 1（在线部署），验证是否能一次部署成功。

2. **验证数据库扩展**
   ```bash
   ssh ubuntu@服务器IP "cd /opt/pmsy && sudo docker-compose exec db psql -U postgres -c 'SELECT extname FROM pg_extension;'"
   ```
   应包含：plpgsql, pgcrypto, uuid-ossp

3. **验证服务状态**
   ```bash
   ssh ubuntu@服务器IP "cd /opt/pmsy && sudo docker-compose ps"
   ```
   所有服务应显示为 Up 状态。

4. **验证前端访问**
   ```bash
   curl -I http://服务器IP
   ```
   应返回 HTTP 200。

## 注意事项

1. **密码安全**
   - 生产环境必须修改默认密码
   - 建议使用强密码生成器
   - 避免在密码中使用 `@` 等特殊字符，或确保正确进行 URL 编码

2. **备份重要**
   - 部署前备份现有数据
   - 全新部署会清空所有数据

3. **版本兼容**
   - 确保使用最新版本的部署脚本
   - 检查 Docker 和 Docker Compose 版本

## 相关文件

- `config/docker/docker-compose.yml` - Docker 服务配置
- `deploy/fresh-install/deploy.sh` - 全新部署脚本
- `config/env/.env.supabase` - 服务器环境配置模板
- `deploy/records/2026-02-13-全新部署记录.md` - 本次部署的详细记录

## 后续优化建议

1. **添加健康检查脚本**
   - 部署完成后自动验证所有服务
   - 检查数据库连接和 API 响应

2. **优化密码处理**
   - 添加密码强度检查
   - 自动生成强密码

3. **完善错误处理**
   - 添加更多错误检测和提示
   - 提供自动修复选项

4. **支持更多部署场景**
   - 支持 HTTPS 自动配置
   - 支持域名绑定
