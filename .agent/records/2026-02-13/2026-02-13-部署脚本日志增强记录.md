# PMSY 部署脚本日志增强记录

## 修改日期
2026-02-13

## 问题描述

全新部署脚本在容器启动后的数据库初始化和迁移步骤没有输出日志，无法判断这些操作是否成功。

## 根本原因

所有数据库操作命令都将错误输出重定向到 `/dev/null`：
```bash
sudo docker-compose exec -T db psql -U postgres -c "..." 2>/dev/null
```

这导致即使命令执行失败，也没有任何错误信息输出，用户无法判断数据库初始化是否成功。

## 解决方案

将 `2>/dev/null` 改为 `2>&1`，并添加详细的日志输出函数：

### 1. 添加日志函数

```bash
# 日志函数
log_info() {
    echo "       ℹ️  $1"
}

log_success() {
    echo "       ✅ $1"
}

log_warn() {
    echo "       ⚠️  $1"
}

log_error() {
    echo "       ❌ $1"
}
```

### 2. 修改命令输出

将原来的静默执行改为输出到控制台：

```bash
# 修改前
sudo docker-compose exec -T db psql -U postgres -c "..." 2>/dev/null || echo "失败"

# 修改后
if sudo docker-compose exec -T db psql -U postgres -c "..." 2>&1; then
    log_success "操作成功"
else
    log_warn "操作失败"
fi
```

## 修改范围

修改了 `deploy/fresh-install/deploy.sh` 中的以下部分：

### 1. 在线部署模式（模式1）
- 步骤 1/7: 创建 Supabase 角色
- 步骤 2/7: 创建必要的 schema
- 步骤 3/7: 创建 uuid-ossp 扩展
- 步骤 4/7: 重启 auth 服务
- 步骤 5/7: 执行数据库初始化脚本
- 步骤 6/7: 执行数据库迁移

### 2. 半离线部署模式（模式2）
- 同样的 6 个步骤添加了详细日志

### 3. 完全离线部署模式（模式3）
- 离线部署脚本中的数据库初始化部分

## 日志输出示例

### 数据库初始化日志
```
[服务器] 初始化数据库...

  步骤 1/7: 创建 Supabase 角色...
       ℹ️  创建 supabase_admin 角色...
       ✅ supabase_admin 角色创建成功
       ℹ️  执行角色初始化脚本...
       ✅ 角色初始化脚本执行成功

  步骤 2/7: 创建必要的 schema...
       ℹ️  创建 auth schema...
       ✅ auth schema 创建成功
       ℹ️  授权 auth schema 给 postgres...
       ℹ️  授权 auth schema 给 anon...
       ℹ️  授权 auth schema 给 authenticated...
       ℹ️  授权 auth schema 给 service_role...
       ℹ️  创建 _realtime schema...
       ✅ _realtime schema 创建成功
       ℹ️  授权 _realtime schema 给 postgres...

  步骤 3/7: 创建 uuid-ossp 扩展...
       ℹ️  创建 uuid-ossp 扩展...
       ✅ uuid-ossp 扩展创建成功

  步骤 4/7: 重启 auth 服务以应用 schema...
       ℹ️  重启 auth 服务...
       ℹ️  等待 5 秒让服务就绪...
       ✅ auth 服务重启完成

  步骤 5/7: 执行数据库初始化脚本...
       ℹ️  执行 init-supabase-db.sh...
       ✅ 数据库初始化脚本执行成功
       ℹ️  执行 00-initial-schema.sql...
       ✅ 初始 schema 执行成功

  步骤 6/7: 执行数据库迁移...
       ℹ️  找到 migrations 目录
       ℹ️  发现 45 个迁移文件
       ℹ️  执行: 20250209000000_init_schema.sql
       ✅ 20250209000000_init_schema.sql 执行成功
       ℹ️  执行: 20250209000001_add_task_details.sql
       ✅ 20250209000001_add_task_details.sql 执行成功
       ...

       ✅ 数据库迁移完成: 45 成功, 0 失败
```

### 失败示例
```
  步骤 6/7: 执行数据库迁移...
       ℹ️  找到 migrations 目录
       ℹ️  发现 45 个迁移文件
       ℹ️  执行: 20250209000000_init_schema.sql
       ✅ 20250209000000_init_schema.sql 执行成功
       ℹ️  执行: 20250209000001_add_task_details.sql
       ⚠️  20250209000001_add_task_details.sql 执行失败
       ...

       ✅ 数据库迁移完成: 44 成功, 1 失败
```

## 优势

1. **可视化进度**: 每个操作都有明确的开始和结束标记
2. **成功/失败标识**: 使用 ✅/⚠️/❌ 图标清晰标识操作结果
3. **统计信息**: 数据库迁移显示成功/失败数量统计
4. **故障排查**: 命令输出直接显示，便于排查问题
5. **用户体验**: 部署过程更加透明，用户可以实时了解进度

## 相关文件

- `deploy/fresh-install/deploy.sh` - 部署脚本（已增强日志）

## 使用方式

```bash
./deploy/fresh-install/deploy.sh
```

部署过程中会自动输出详细的数据库初始化和迁移日志。

## 总结

通过将 `2>/dev/null` 改为 `2>&1` 并添加详细的日志函数，解决了数据库初始化和迁移步骤无日志输出的问题。现在用户可以清楚地看到每个操作的执行结果，便于判断部署是否成功，以及排查可能出现的问题。
