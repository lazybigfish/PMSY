# 数字类型转换修复记录 - 2026-02-14

## 问题背景

在修复 Dashboard 金额显示异常问题时，发现 PostgreSQL 的 DECIMAL 类型通过 API 返回时被转换为字符串类型，导致数值计算变成了字符串拼接。

## 排查范围

基于 Dashboard 问题的经验，对以下模块进行排查：
- 项目管理模块
- 供应商模块

## 修复文件清单

### 1. Dashboard.tsx (已修复)
**路径**: `src/pages/Dashboard.tsx`
**行号**: 196-198
```typescript
// 修复前
.reduce((sum: number, p: any) => sum + (p.amount || 0), 0)

// 修复后
.reduce((sum: number, p: any) => sum + (Number(p.amount) || 0), 0)
```

### 2. ProjectOverview.tsx
**路径**: `src/pages/projects/tabs/ProjectOverview.tsx`

#### 修复点 1 - 供应商合同金额计算 (第 155 行)
```typescript
// 修复前
const totalContract = suppliers?.reduce((sum, s) => sum + (s.contract_amount || 0), 0) || 0;

// 修复后
const totalContract = suppliers?.reduce((sum, s) => sum + (Number(s.contract_amount) || 0), 0) || 0;
```

#### 修复点 2 - 付款金额计算 (第 167 行)
```typescript
// 修复前
const totalPaid = payments?.reduce((sum, p) => sum + (p.amount || 0), 0) || 0;

// 修复后
const totalPaid = payments?.reduce((sum, p) => sum + (Number(p.amount) || 0), 0) || 0;
```

#### 修复点 3 - 模块进度计算 (第 201 行)
```typescript
// 修复前
const totalProgress = modulesData?.reduce((sum, m) => sum + (m.progress || 0), 0) || 0;

// 修复后
const totalProgress = modulesData?.reduce((sum, m) => sum + (Number(m.progress) || 0), 0) || 0;
```

### 3. ProjectList.tsx
**路径**: `src/pages/projects/ProjectList.tsx`

#### 修复点 1 - 模块进度计算 (第 132 行)
```typescript
// 修复前
const totalProgress = projectModules.reduce((sum: number, m: any) => sum + (m.progress || 0), 0);

// 修复后
const totalProgress = projectModules.reduce((sum: number, m: any) => sum + (Number(m.progress) || 0), 0);
```

#### 修复点 2 - 合同总金额计算 (第 294 行)
```typescript
// 修复前
.reduce((sum, p) => sum + (p.amount || 0), 0)

// 修复后
.reduce((sum, p) => sum + (Number(p.amount) || 0), 0)
```

### 4. Suppliers.tsx
**路径**: `src/pages/projects/tabs/Suppliers.tsx`

#### 修复点 1 - 供应商合同总额计算 (第 271 行)
```typescript
// 修复前
const currentTotalContractAmount = projectSuppliers.reduce((sum, ps) => sum + (ps.contract_amount || 0), 0);

// 修复后
const currentTotalContractAmount = projectSuppliers.reduce((sum, ps) => sum + (Number(ps.contract_amount) || 0), 0);
```

#### 修复点 2 - 付款金额显示 (第 374 行)
```typescript
// 修复前
¥{ps.payments?.reduce((sum, p) => sum + (p.amount || 0), 0).toLocaleString()}

// 修复后
¥{ps.payments?.reduce((sum, p) => sum + (Number(p.amount) || 0), 0).toLocaleString()}
```

### 5. SupplierDetailModal.tsx
**路径**: `src/pages/projects/components/SupplierDetailModal.tsx`

#### 修复点 1 - 付款统计计算 (第 350-351 行)
```typescript
// 修复前
.reduce((sum, p) => sum + (p.amount || 0), 0);
const remaining = (projectSupplier.contract_amount || 0) - totalPaid;

// 修复后
.reduce((sum, p) => sum + (Number(p.amount) || 0), 0);
const remaining = (Number(projectSupplier.contract_amount) || 0) - totalPaid;
```

#### 修复点 2 - 统计计算 (第 531-534 行)
```typescript
// 修复前
const contractAmount = projectSupplier.contract_amount || 0;
const totalPaid = paymentPlans
  .filter(p => p.status === 'paid')
  .reduce((sum, p) => sum + (p.amount || 0), 0);

// 修复后
const contractAmount = Number(projectSupplier.contract_amount) || 0;
const totalPaid = paymentPlans
  .filter(p => p.status === 'paid')
  .reduce((sum, p) => sum + (Number(p.amount) || 0), 0);
```

### 6. FunctionalModules.tsx
**路径**: `src/pages/projects/tabs/FunctionalModules.tsx`

#### 修复点 - 合同金额显示 (第 810 行)
```typescript
// 修复前
¥{(supplier.contract_amount || 0).toLocaleString()}

// 修复后
¥{(Number(supplier.contract_amount) || 0).toLocaleString()}
```

## 修复模式总结

所有修复遵循统一模式：
```typescript
// 修复前
value || 0

// 修复后
Number(value) || 0
```

## 涉及字段类型

- `amount` - DECIMAL(15, 2) - 项目金额、付款金额
- `contract_amount` - DECIMAL(15, 2) - 合同金额
- `progress` - INTEGER - 进度百分比

## 预防措施

1. 在 API 层统一将 DECIMAL 类型转换为数字
2. 前端使用 TypeScript 严格类型检查
3. 对从 API 返回的数值字段统一进行 Number() 转换
