# 新增用户功能修复记录 - 2026-02-14

## 问题描述
系统配置模块中新增用户功能失败。

## 修复过程

### 第一阶段：修复 404 错误

**问题现象**: 前端调用 `/api/auth/create-user` 返回 404 错误

**问题原因**: 
- 前端调用路径：`POST /api/auth/create-user`
- Nginx 代理配置：`/api/` → `http://api:3001/api/`
- 但 api-new 服务中 auth 路由只挂载在 `/auth/v1`，没有 `/api/auth/create-user` 路由

**修复方案**:

1. **api-new/src/index.ts**: 添加 `/api/auth` 路由挂载
```typescript
// 兼容前端调用的 /api/auth/create-user 路由
app.use('/api/auth', authRouter);
```

2. **api-new/src/routes/auth.ts**: 添加 `/create-user` 端点
- 导入 `findUserByUsername` 和 `findUserByEmail` 函数
- 实现用户创建逻辑

---

### 第二阶段：修复 401 错误（认证问题）

**问题现象**: 修复 404 后，返回 401 错误 "未提供认证令牌"

**问题原因**:
1. 前端登录调用 `/auth/v1/token?grant_type=password`
2. Nginx 配置中 `/auth/v1/` 代理到 Supabase GoTrue (`http://auth:9999/`)
3. 但新增用户接口在 api-new 中，需要验证 api-new 生成的 token
4. **两个 Token 不兼容**：Supabase Token vs api-new Token

**修复方案**:

1. **nginx.conf**: 将 `/auth/v1/` 从 Supabase GoTrue 切换到 api-new
```nginx
# 修改前
location /auth/v1/ {
    proxy_pass http://auth:9999/;
}

# 修改后
location /auth/v1/ {
    proxy_pass http://api:3001/auth/v1/;
}
```

2. **src/pages/system/tabs/UserManagement.tsx**: 添加认证头
```typescript
const token = localStorage.getItem('access_token');
if (!token) {
  throw new Error('未登录或登录已过期，请重新登录');
}

const response = await fetch('/api/auth/create-user', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`,
  },
  body: JSON.stringify(newUser),
});
```

## 修改文件清单

| 文件路径 | 修改内容 |
|---------|---------|
| `nginx.conf` | `/auth/v1/` 代理从 Supabase 切换到 api-new |
| `api-new/src/index.ts` | 添加 `/api/auth` 路由挂载 |
| `api-new/src/routes/auth.ts` | 添加 `/create-user` 端点，导入所需函数 |
| `src/pages/system/tabs/UserManagement.tsx` | 添加 Authorization 请求头 |

## 验证结果

使用 curl 测试完整流程：
```bash
# 1. 登录获取 api-new Token
curl -X POST "http://localhost:3001/auth/v1/token?grant_type=password" \
  -H "Content-Type: application/json" \
  -d '{"email": "admin@pmsy.com", "password": "Willyou@2026"}'

# 2. 使用 api-new Token 创建新用户
curl -X POST "http://localhost:3001/api/auth/create-user" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{
    "username": "newuser2026",
    "full_name": "新用户2026",
    "password": "password123",
    "role": "user"
  }'
```

**测试结果**: ✅ 新增用户功能完全正常

## 关键决策说明

**为什么不兼容 Supabase Token？**
- 项目正在从 Supabase 迁移到自研后端
- 应该彻底移除 Supabase 依赖，而不是兼容它
- 修改 Nginx 配置是最干净、最彻底的解决方案

## 注意事项

如果部署到生产环境，需要同步更新生产环境的 Nginx 配置。
