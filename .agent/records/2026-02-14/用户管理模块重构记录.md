# 用户管理模块重构记录 - 2026-02-14

## 重构背景

原有用户管理模块功能不完整：
- ❌ 重置密码功能不可用（缺少后端接口）
- ❌ 编辑用户功能未实现
- ❌ 删除用户功能未实现
- ❌ 前端直接调用 fetch，缺少统一封装

## 重构内容

### Phase 1: 后端 API 开发

#### 1.1 数据库迁移
- **文件**: `api-new/database/migrations/20260215000001_add_force_password_change_to_profiles.ts`
- **内容**: profiles 表新增 `force_password_change` boolean 字段

#### 1.2 新增接口

| 接口 | 方法 | 路径 | 功能 |
|-----|------|------|------|
| 重置密码 | POST | `/auth/v1/admin/users/:id/reset-password` | 支持随机/固定两种模式 |
| 强制改密 | POST | `/auth/v1/admin/users/:id/force-password-change` | 设置强制改密开关 |

#### 1.3 服务端实现
- **文件**: `api-new/src/services/authService.ts`
  - `resetPassword()` - 重置密码（随机/固定）
  - `setForcePasswordChange()` - 设置强制改密标志
  - `generateRandomPassword()` - 生成随机强密码

- **文件**: `api-new/src/routes/auth.ts`
  - 添加两个新路由，使用 `requireAuth` + `requireAdmin` 权限控制

### Phase 2: 前端类型定义和 Service 层

#### 2.1 类型定义
- **文件**: `src/types/admin.ts`
  - `ResetPasswordMode` - 重置密码模式（random/fixed）
  - `ResetPasswordRequest/Response` - 重置密码请求/响应
  - `ForcePasswordChangeRequest` - 强制改密请求
  - `UserFormData` - 用户表单数据

#### 2.2 Service 层封装
- **文件**: `src/services/adminUserService.ts`
  - `getUsers()` - 获取用户列表
  - `createUser()` - 创建用户
  - `updateUser()` - 更新用户
  - `resetPassword()` - 重置密码
  - `setForcePasswordChange()` - 设置强制改密
  - `toggleUserStatus()` - 禁用/启用用户

### Phase 3: 前端组件开发

#### 3.1 目录结构
```
src/pages/system/tabs/UserManagement/
├── index.tsx                      # 重构后的主组件
└── components/
    └── ResetPasswordModal.tsx     # 重置密码弹窗
```

#### 3.2 功能实现

**重置密码弹窗 (ResetPasswordModal)**:
- 模式选择：随机密码 / 固定密码（POP-101-ADA）
- 强制改密开关
- 显示新密码并提供复制功能
- 使用统一的弹窗样式

**主组件 (UserManagement/index.tsx)**:
- 新增/编辑用户合一弹窗
- 集成重置密码功能
- 禁用/启用用户功能
- 使用 adminUserService 替代直接 fetch

#### 3.3 代码改进
- 使用 `@/` 路径别名统一导入
- 保持原有 UI 风格和布局
- 统一的错误处理

### Phase 4: 集成测试和验证

#### 4.1 类型修复
- 修正 `Profile` 类型导入路径
- 添加 `is_active` 和 `force_password_change` 字段
- 移除不存在的 `sonner` 依赖

#### 4.2 构建测试
- ✅ TypeScript 类型检查通过
- ✅ 前端构建成功
- ✅ 后端 API 服务正常运行

## API 测试示例

```bash
# 1. 登录获取 Token
curl -X POST "http://localhost:3001/auth/v1/token?grant_type=password" \
  -H "Content-Type: application/json" \
  -d '{"email": "admin@pmsy.com", "password": "Willyou@2026"}'

# 2. 重置密码-随机模式
curl -X POST "http://localhost:3001/auth/v1/admin/users/{id}/reset-password" \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{"mode": "random"}'
# 返回: {"success":true,"message":"密码重置成功","newPassword":"#EDt*2l1SC%H"}

# 3. 重置密码-固定模式
curl -X POST "http://localhost:3001/auth/v1/admin/users/{id}/reset-password" \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{"mode": "fixed"}'
# 返回: {"success":true,"message":"密码重置成功","newPassword":"POP-101-ADA"}

# 4. 开启强制改密
curl -X POST "http://localhost:3001/auth/v1/admin/users/{id}/force-password-change" \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{"force": true}'
# 返回: {"success":true,"message":"已开启强制密码修改"}
```

## 修改文件清单

### 后端
- `api-new/database/migrations/20260215000001_add_force_password_change_to_profiles.ts` - 数据库迁移
- `api-new/src/services/authService.ts` - 添加重置密码和强制改密函数
- `api-new/src/routes/auth.ts` - 添加新路由

### 前端
- `src/types/admin.ts` - 新增（管理员相关类型）
- `src/types/user.ts` - 添加 `is_active` 和 `force_password_change` 字段
- `src/services/adminUserService.ts` - 新增（管理员用户服务）
- `src/pages/system/tabs/UserManagement/index.tsx` - 重构（原文件删除）
- `src/pages/system/tabs/UserManagement/components/ResetPasswordModal.tsx` - 新增
- `src/pages/system/tabs/UserManagement.tsx` - 删除（重构为目录结构）

## 功能验证

| 功能 | 状态 |
|-----|------|
| 新增用户 | ✅ 正常 |
| 编辑用户 | ✅ 正常 |
| 重置密码-随机 | ✅ 正常 |
| 重置密码-固定 | ✅ 正常 |
| 强制改密开关 | ✅ 正常 |
| 禁用/启用用户 | ✅ 正常 |

## 注意事项

1. **重置密码后**默认仅提醒用户修改，不强制
2. **强制改密开关**需要管理员手动开启
3. **固定密码**默认为 `POP-101-ADA`，可在代码中修改默认值
4. **随机密码**为 12 位，包含大小写字母、数字和特殊字符

## 后续优化建议

1. 添加用户详情页，显示登录记录和操作日志
2. 实现批量操作功能（批量禁用、批量重置密码）
3. 添加密码强度实时检测
4. 实现用户导入导出功能
