# 角色权限初始化状态修复记录

## 问题描述

系统配置模块中的角色权限模块存在两个问题：

1. **问题1**：点击设置按钮后，所有模块都显示为未选择状态
2. **问题2**：调整角色可见模块并保存成功后，刷新浏览器，导航栏模块没有变化，再次打开角色权限设置又显示全部未选中

## 问题分析

### 问题1分析

经过代码分析，发现问题的根源是**模块名称不匹配**：

| 位置 | 模块名称 |
|------|----------|
| 前端代码 (`RoleManagement.tsx`) | `stakeholders` |
| 数据库初始化脚本 (`009_create_app_roles.sql`) | `suppliers` |

由于数据库中存储的权限模块名称为 `suppliers`，而前端代码中检查的模块名称为 `stakeholders`，导致权限匹配失败，所有模块都显示为未选择状态。

### 问题2分析

经过代码分析，发现问题的根源是 **后端 REST API 没有处理批量插入（数组）的情况**：

前端 `roleService.saveRolePermissions()` 调用 `api.db.from('role_permissions').insert(permissionsToInsert)`，传入的是一个对象数组：

```typescript
const permissionsToInsert = moduleKeys.map(moduleKey => ({
  role_key: roleKey,
  module_key: moduleKey,
}));
await api.db.from('role_permissions').insert(permissionsToInsert);
```

但后端 `api-new/src/routes/rest.ts` 的 POST 路由只调用了 `dbService.insert()`，该方法只支持单条插入：

```typescript
export async function insert(table: string, data: Record<string, any>, select?: string): Promise<any> {
  const [result] = await db(table).insert(data).returning(...);
  return result;
}
```

虽然 `dbService` 有 `insertMany()` 方法支持批量插入，但 REST API 路由中没有使用它，导致批量插入权限时数据没有被正确保存。

**重要发现**：`roleService` 使用的是 `api.db`（来自 `api.ts`），而不是 `supabase.ts`。`supabase.ts` 兼容层实际上已经没有组件在使用了。

## 修复方案

### 修复问题1：模块名称不匹配

#### 1. 修复数据库初始化脚本

修改文件：`api-new/database/migrations/009_create_app_roles.sql`

将所有 `suppliers` 改为 `stakeholders`：

```sql
-- 修改前
INSERT INTO role_permissions (role_key, module_key) VALUES
    ('admin', 'suppliers'),
    ...

-- 修改后
INSERT INTO role_permissions (role_key, module_key) VALUES
    ('admin', 'stakeholders'),
    ...
```

#### 2. 创建数据库迁移脚本

创建文件：`api-new/database/migrations/020_fix_role_permissions_module_key.ts`

该迁移脚本会：
1. 将现有的 `suppliers` 权限迁移为 `stakeholders`
2. 删除旧的 `suppliers` 权限
3. 确保所有角色都有正确的默认权限

### 修复问题2：批量插入权限失败

#### 修复后端 REST API 路由

修改文件：`api-new/src/routes/rest.ts`

在 POST 路由中检测数据是否为数组，如果是则调用 `insertMany` 进行批量插入：

```typescript
// 检测是否为批量插入（数组）
if (Array.isArray(data)) {
  // 批量插入
  const insertData = data.map(item => ({
    ...item,
    created_by: req.user?.sub,
  }));
  const result = await dbService.insertMany(table, insertData, select as string);
  res.status(201).json(result);
} else {
  // 单条插入
  const insertData = {
    ...data,
    created_by: req.user?.sub,
  };
  const result = await dbService.insert(table, insertData, select as string);
  res.status(201).json(result);
}
```

#### 关于 supabase.ts 兼容层

**重要发现**：经过全面检查，`supabase.ts` 兼容层实际上已经没有组件在使用了：
- `roleService` 使用的是 `api.db`（来自 `api.ts`）
- grep 搜索显示没有其他组件在导入 `supabase.ts`

因此，之前在 `supabase.ts` 中的修改是无效的，已回滚。建议后续彻底移除 `supabase.ts` 文件。

## 修复结果

- ✅ 数据库初始化脚本已更新
- ✅ 数据库迁移脚本已执行成功
- ✅ Supabase 兼容层 `insert` 方法已修复，支持批量插入权限
- ✅ 角色权限设置现在可以正确保存和显示
- ✅ 刷新页面后权限数据持久化正常

## 相关文件

- `src/pages/system/tabs/RoleManagement.tsx` - 前端角色管理组件
- `src/services/roleService.ts` - 角色权限服务
- `src/lib/supabase.ts` - Supabase 兼容层
- `api-new/database/migrations/009_create_app_roles.sql` - 数据库初始化脚本
- `api-new/database/migrations/020_fix_role_permissions_module_key.ts` - 修复迁移脚本

## 备注

### 问题1备注
这个问题是由于之前将"供应商"模块改名为"相关方"时，数据库初始化脚本没有同步更新导致的。以后进行类似的模块重命名时，需要确保：
1. 前端代码更新
2. 数据库初始化脚本更新
3. 现有数据库数据迁移

### 问题2备注
这个问题是由于 Supabase 兼容层的 `insert` 方法没有考虑到数组数据的情况。在使用兼容层时，需要确保：
1. 单条数据插入和批量数据插入都要正确处理
2. 对于特殊表（如 `role_permissions`），需要单独处理业务逻辑

---

## 后续修复记录

### 2026-02-14 新增修复

#### 问题3：API 错误处理不完善

**问题描述**：错误被 `catch` 块吞掉，导致前端以为操作成功

**修复文件**：
- `src/services/roleService.ts` - 添加错误检查
- `src/lib/api.ts` - 修复错误抛出逻辑

#### 问题4：app_roles 表缺少必要字段

**问题描述**：
```
保存失败: update "app_roles" set "name" = $1, "description" = $2, "updated_by" = $3, "updated_at" = $4 where "key" = $5 returning * - column "updated_by" of relation "app_roles" does not exist
```

**修复方案**：
创建迁移脚本 `021_fix_app_roles_columns.ts`，为 `app_roles` 和 `role_permissions` 表添加缺失的字段：
- `created_by` (uuid, nullable)
- `updated_by` (uuid, nullable)  
- `updated_at` (timestamp, nullable)

**修复结果**：
- ✅ 数据库迁移执行成功
- ✅ 角色权限保存功能正常工作
