# 金额格式化显示修复记录 - 2026-02-14

## 问题描述

Dashboard 统计卡片中的合同总金额显示异常，显示为 `¥0500000.00800000.001200000.00`。

## 问题分析

### 初步诊断

**文件路径**: `src/pages/dashboard/components/StatsCards.tsx`

初步认为是 `formatAmount` 函数缺少 `¥` 符号前缀。

### 深入排查

发现问题根源不在格式化函数，而在数据计算逻辑。

**真正原因**: `src/pages/Dashboard.tsx` 中计算 `totalBudget` 时，`p.amount` 从 PostgreSQL 返回的是字符串类型，导致 `sum + (p.amount || 0)` 变成了字符串拼接而非数字相加。

```typescript
// 问题代码
const totalBudget = projects
  ?.filter((p: any) => p.manager_id === user?.id)
  .reduce((sum: number, p: any) => sum + (p.amount || 0), 0) || 0;
// 结果: "0" + "500000" + "800000" + "1200000" = "05000008000001200000"
```

## 修复内容

### 修复 1: 数据类型转换

**文件**: `src/pages/Dashboard.tsx` (第 196-198 行)

```typescript
// 修复前
.reduce((sum: number, p: any) => sum + (p.amount || 0), 0) || 0;

// 修复后
.reduce((sum: number, p: any) => sum + (Number(p.amount) || 0), 0) || 0;
```

### 修复 2: 格式化函数完善

**文件**: `src/pages/dashboard/components/StatsCards.tsx` (第 21-30 行)

```typescript
// 修复前
const formatAmount = (amount?: number) => {
  if (amount === undefined || amount === null) return '0.00';
  if (amount >= 100000000) {
    return (amount / 100000000).toLocaleString('zh-CN', ...) + '亿';
  }
  if (amount >= 10000) {
    return (amount / 10000).toLocaleString('zh-CN', ...) + '万';
  }
  return '¥' + amount.toLocaleString('zh-CN', ...);
};

// 修复后
const formatAmount = (amount?: number) => {
  if (amount === undefined || amount === null) return '¥0.00';
  if (amount >= 100000000) {
    return '¥' + (amount / 100000000).toLocaleString('zh-CN', ...) + '亿';
  }
  if (amount >= 10000) {
    return '¥' + (amount / 10000).toLocaleString('zh-CN', ...) + '万';
  }
  return '¥' + amount.toLocaleString('zh-CN', ...);
};
```

## 修复点总结

1. **数据计算**: 添加 `Number()` 转换，确保字符串类型的 amount 被正确转为数字
2. **空值处理**: `'0.00'` → `'¥0.00'`
3. **亿级金额**: 添加 `¥` 前缀
4. **万级金额**: 添加 `¥` 前缀

## 预期显示效果

| 金额值 | 修复前 | 修复后 |
|--------|--------|--------|
| 2500000 (三个项目) | `¥0500000.00800000.001200000.00` | `¥250.00万` |
| null/undefined | `0.00` | `¥0.00` |
| 500000 | `50.00万` | `¥50.00万` |
| 120000000 | `1.20亿` | `¥1.20亿` |
| 5000 | `¥5,000.00` | `¥5,000.00` |

## 验证方式

刷新 Dashboard 页面，检查合同总金额卡片显示是否正常。
