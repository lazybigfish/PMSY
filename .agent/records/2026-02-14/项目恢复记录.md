# PMSY 项目恢复记录 - 2026-02-14

## 问题背景

项目在完成 Supabase 移除迁移后，由于配置冲突和部署脚本未更新，导致本地开发环境无法正常启动。

## 问题诊断

### 根本原因

1. **环境变量冲突**: `.env.local` 文件存在 Supabase 配置，覆盖了新的 API 配置
2. **部署配置混乱**: `deploy/fresh-install/` 仍使用旧 Supabase 架构，与新架构不匹配
3. **启动流程不明确**: 缺乏清晰的本地开发环境启动文档

### 架构状态

- ✅ 前端服务层已完全移除 Supabase 依赖
- ✅ API 服务实现完整（Express + JWT + PostgreSQL）
- ✅ 数据库迁移文件完整（16 个迁移文件）
- ❌ 部署脚本未更新
- ❌ 环境配置存在冲突

## 修复措施

### 1. 删除冲突配置

```bash
# 删除 .env.local，避免覆盖 VITE_API_URL 配置
rm .env.local
```

### 2. 启动服务验证

```bash
# 启动基础设施
cd api-new && docker-compose up -d postgres redis minio

# 执行数据库迁移
npm run db:migrate
npm run db:seed

# 启动 API 服务
npm run dev

# 启动前端（另一个终端）
npm run dev
```

### 3. 创建新的部署脚本

- 路径: `deploy/new-architecture/`
- 文件:
  - `README.md` - 部署文档
  - `deploy.sh` - 一键部署脚本

## 验证结果

### 服务状态

| 服务 | 地址 | 状态 |
|------|------|------|
| API | http://localhost:3001 | ✅ 运行中 |
| 前端 | http://localhost:5173 | ✅ 运行中 |
| PostgreSQL | localhost:5432 | ✅ 运行中 |
| Redis | localhost:6379 | ✅ 运行中 |
| MinIO | localhost:9000/9001 | ✅ 运行中 |

### 接口测试

- ✅ Health Check: `{"status":"ok","database":true,"redis":true,"minio":true}`
- ✅ 登录接口: 返回有效 JWT Token
- ✅ 用户认证: 默认管理员账号可正常登录

## 后续工作

1. **服务器部署**: 将新部署脚本应用到服务器环境
2. **文档更新**: 更新主 README.md，指向新的部署文档
3. **清理旧配置**: 归档或删除旧的 Supabase 相关部署配置

## 关键文件

```
deploy/new-architecture/
├── README.md      # 新架构部署文档
└── deploy.sh      # 一键部署脚本

api-new/
├── docker-compose.yml    # Docker 配置
├── database/migrations/  # 16 个迁移文件
└── database/seeds/       # 种子数据
```

## 默认账号

- **邮箱**: admin@pmsy.com
- **密码**: Willyou@2026
