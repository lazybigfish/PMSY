# 里程碑任务初始化修复记录

## 问题描述

修复 API 查询问题后，里程碑页面可以显示阶段列表，但任务仍然显示为 "任务: 0 / 0"，没有显示初始化的任务。

## 问题分析

### 根本原因

数据库表结构设计问题：

1. `milestone_tasks` 表缺少 `milestone_id` 字段来关联具体的项目里程碑
2. 原有设计使用 `template_id` 关联模板，但任务应该关联到具体的项目里程碑 (`project_milestones.id`)
3. 现有项目的里程碑 `template_id` 为 `null`，导致无法根据模板创建任务

### 数据库结构问题

**修改前的 milestone_tasks 表结构：**
```sql
CREATE TABLE milestone_tasks (
    id UUID PRIMARY KEY,
    template_id UUID REFERENCES milestone_templates(id),  -- 关联模板，不是里程碑
    name TEXT,
    ...
    -- 缺少 milestone_id 字段
);
```

**应该的结构：**
```sql
CREATE TABLE milestone_tasks (
    id UUID PRIMARY KEY,
    milestone_id UUID REFERENCES project_milestones(id),  -- 关联具体里程碑
    template_id UUID REFERENCES milestone_templates(id),  -- 可选，记录来源模板
    name TEXT,
    ...
);
```

## 修复方案

### 1. 修改表结构

添加 `milestone_id` 字段并创建索引：
```sql
ALTER TABLE milestone_tasks 
ADD COLUMN IF NOT EXISTS milestone_id UUID REFERENCES project_milestones(id) ON DELETE CASCADE;

CREATE INDEX IF NOT EXISTS idx_milestone_tasks_milestone_id ON milestone_tasks(milestone_id);
```

### 2. 为所有里程碑创建任务

由于现有项目的里程碑 `template_id` 为 `null`，无法根据模板创建任务，因此为每个里程碑创建默认任务：

```typescript
const defaultTasks = [
  {
    name: '任务规划',
    description: '制定阶段任务计划，明确目标和交付物',
    is_required: true,
    output_documents: [{ name: '任务计划书', required: true }],
  },
  {
    name: '执行与监控',
    description: '执行阶段任务并监控进度',
    is_required: true,
    output_documents: [{ name: '进度报告', required: true }],
  },
  {
    name: '阶段评审',
    description: '完成阶段评审并输出评审报告',
    is_required: true,
    output_documents: [{ name: '评审报告', required: true }],
  },
];
```

对于有 `template_id` 的里程碑，从 `milestone_task_templates` 表获取模板任务创建。

### 3. 修复脚本

创建了修复脚本 `scripts/fix-milestone-tasks-v2.ts`，执行以下操作：
1. 确保 `milestone_id` 字段存在
2. 创建索引
3. 查找所有没有任务的里程碑
4. 为每个里程碑创建默认任务（或从模板获取）

## 修复结果

- 为 35 个没有任务的里程碑创建了任务
- 每个里程碑现在有 3 个默认任务：任务规划、执行与监控、阶段评审
- 里程碑页面现在正确显示任务列表
- 任务统计显示正确（如："任务: 0 / 3"）

## 相关文件

- `api-new/database/migrations/017_fix_milestone_tasks.sql` - 数据库迁移文件
- `api-new/scripts/fix-milestone-tasks-v2.ts` - 修复脚本
- `src/pages/projects/tabs/Milestones.tsx` - 前端页面（之前已修复）

## 修复时间

2026-02-15

## 后续建议

1. 新项目创建时，应该自动初始化里程碑和任务
2. 考虑完善 `milestone_task_templates` 表的数据，为每个阶段定义更详细的任务模板
3. 在项目创建流程中调用初始化函数，确保每个项目都有完整的里程碑结构
