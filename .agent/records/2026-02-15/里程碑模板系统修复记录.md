# 里程碑模板系统修复记录

## 日期
2026-02-15

## 问题概述
1. 里程碑模板页面无法正常显示和切换
2. 新建版本后数据不立即显示，需要刷新
3. 数据库表结构设计有问题
4. 缺少初始化 SQL 更新

## 修复内容

### 1. 数据库表结构修复

#### 文件: `010_create_milestone_templates.sql` (已整合修复)

**修复内容:**
- 修复 `milestone_task_templates` 表:
  - 使用正确的 `milestone_template_id` 字段（原错误为 `template_id`）
  - 更新索引

- 修复 `template_versions` 表:
  - 删除错误的 `template_id` 字段和外键
  - 添加正确的字段: `name`, `description`, `version_number`, `is_active`
  - 更新唯一约束

- 修复 `milestone_templates` 表:
  - 确保 `version_id` 字段存在

- 创建函数:
  - `set_active_template_version()` - 设置激活版本

- 插入默认数据:
  - 版本: "标准项目里程碑模板 v1.0" (1.0.0)
  - 7 个里程碑阶段
  - 26 个任务模板

### 2. 后端 API 添加

#### 文件: `api-new/src/routes/rest.ts`

**添加的 API:**
- `GET /rest/v1/milestone-templates/active` - 获取当前激活版本的完整模板数据
- `GET /rest/v1/template-versions/list` - 获取所有版本列表

### 3. 前端修复

#### 文件: `src/pages/system/tabs/MilestoneTemplates.tsx`

**修复内容:**
- 修复 `handleCreateVersion` 函数:
  - 添加 `.select()` 获取插入后的完整数据
  - 创建版本后立即加载里程碑数据
  - 确保数据立即显示，无需刷新

#### 文件: `src/pages/projects/ProjectCreate.tsx`

**修改内容:**
- 添加 `fetchMilestoneTemplates` 函数，从 API 获取模板
- 项目创建时使用 API 获取的模板
- 显示当前使用的模板版本信息
- 添加后备机制（API 失败时使用硬编码模板）

### 4. 数据修复脚本

创建以下脚本用于修复现有数据:
- `scripts/fix-version-data.ts` - 修复版本数据
- `scripts/run-migration-018.ts` - 运行迁移 018
- `scripts/restore-milestone-tasks.ts` - 恢复里程碑任务
- `scripts/create-rpc-function.ts` - 创建 RPC 函数

## 数据库表结构 (最终)

### template_versions
| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| name | TEXT | 版本名称 |
| version_number | TEXT | 版本号 |
| description | TEXT | 描述 |
| is_active | BOOLEAN | 是否激活 |
| created_by | UUID | 创建者 |
| created_at | TIMESTAMPTZ | 创建时间 |
| updated_at | TIMESTAMPTZ | 更新时间 |

### milestone_templates
| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| version_id | UUID | 关联版本 |
| name | TEXT | 阶段名称 |
| phase_order | INTEGER | 阶段顺序 |
| is_active | BOOLEAN | 是否激活 |
| created_at | TIMESTAMPTZ | 创建时间 |
| updated_at | TIMESTAMPTZ | 更新时间 |

### milestone_task_templates
| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| milestone_template_id | UUID | 关联里程碑模板 |
| name | TEXT | 任务名称 |
| description | TEXT | 描述 |
| is_required | BOOLEAN | 是否必需 |
| output_documents | JSONB | 输出文档 |
| sort_order | INTEGER | 排序 |
| created_at | TIMESTAMPTZ | 创建时间 |
| updated_at | TIMESTAMPTZ | 更新时间 |

## 默认模板数据

### 版本信息
- 名称: 标准项目里程碑模板 v1.0
- 版本号: 1.0.0
- 描述: 适用于一般项目的标准里程碑流程模板

### 里程碑阶段 (7个)
1. 进场前阶段 - 5个任务
2. 启动阶段 - 6个任务
3. 实施阶段 - 5个任务
4. 初验阶段 - 4个任务
5. 试运行阶段 - 2个任务
6. 终验阶段 - 3个任务
7. 运维阶段 - 1个任务

总计: 26个任务

## 待修复问题

### 标签页切换问题
**问题**: 系统设置页面的标签页无法正常切换
**状态**: 待修复
**可能原因**: 
- @radix-ui/react-tabs 组件使用问题
- 事件绑定问题
- 状态管理问题

## 验证清单

- [x] 数据库表结构正确
- [x] 默认数据已插入
- [x] 后端 API 可用
- [x] 新建版本后数据立即显示
- [ ] 标签页可以正常切换
- [ ] 项目创建时使用正确模板

## 后续建议

1. 修复标签页切换问题
2. 添加版本对比功能
3. 添加模板导入/导出功能
4. 优化前端加载性能
