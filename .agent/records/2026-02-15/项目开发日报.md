# 项目开发日报 - 2026-02-15

## 今日完成工作

### 1. 里程碑页面 API 查询修复

**问题**：项目详情的里程碑页面打开后，内容显示不完整，阶段和任务都没有加载出来，控制台报 500 错误。

**原因**：前端使用了 PostgREST 风格的嵌入查询语法 `milestone_tasks(id, is_completed)`，但后端不支持这种语法，导致 SQL 报错。

**修复**：将嵌套查询改为两次独立查询，先查询里程碑，再分别查询每个里程碑的任务统计。

**状态**：✅ 已完成并验证

### 2. 任务中心新建任务按钮修复

**问题**：任务中心页面的「新建任务」按钮点击后无法正常跳转，页面无响应。

**原因**：TaskList.tsx 中的导航路径为 `/tasks/new`，但 App.tsx 路由配置为 `/tasks/create`，两者不一致导致路由匹配失败。

**修复**：将 TaskList.tsx 中的导航路径从 `/tasks/new` 修改为 `/tasks/create`。

**涉及文件**：
- [src/pages/tasks/TaskList.tsx](file:///Users/liiiiins/Downloads/文稿%20-%20liiiiins%20的%20MacBook%20Pro/Mweb/PMSY/src/pages/tasks/TaskList.tsx#L308)

**状态**：✅ 已完成

### 3. 任务创建功能修复

**问题**：进入新建任务页面，填完信息后点击「创建任务」按钮报错，控制台显示 500 错误。

**错误信息**：`column "start_date" of relation "tasks" does not exist`

**原因**：后端代码尝试向 `tasks` 表插入 `start_date` 字段，但数据库表结构中没有该字段。

**修复**：
1. 为 `tasks` 表添加 `start_date` 字段（TIMESTAMPTZ 类型）
2. 创建对应索引 `idx_tasks_start_date`
3. 更新数据库迁移脚本，确保新环境自动包含该字段

**涉及文件**：
- [api-new/database/migrations/011_create_task_extensions.sql](file:///Users/liiiiins/Downloads/文稿%20-%20liiiiins%20的%20MacBook%20Pro/Mweb/PMSY/api-new/database/migrations/011_create_task_extensions.sql)

**状态**：✅ 已完成并验证

### 4. 新建任务页面字段调整

**需求**：调整新建任务页面中项目和模块的必选状态。

**调整内容**：
- **所属项目**：改为必填项，添加红色星号标记和 `required` 属性
- **功能模块**：保持非必填（可选）状态

**涉及文件**：
- [src/pages/tasks/TaskCreatePage.tsx](file:///Users/liiiiins/Downloads/文稿%20-%20liiiiins%20的%20MacBook%20Pro/Mweb/PMSY/src/pages/tasks/TaskCreatePage.tsx)

**状态**：✅ 已完成

### 5. 任务状态值统一修复

**问题**：创建任务时报错 `violates check constraint "tasks_status_check"`，前端传入的状态值与数据库约束不匹配。

**原因分析**：
- **数据库约束**：`status IN ('todo', 'in_progress', 'paused', 'done', 'canceled')`
- **前端类型定义**：`'pending' | 'in_progress' | 'completed' | 'cancelled'`
- 两者不一致导致插入失败

**修复内容**：
1. 更新 `TaskStatus` 类型定义，与数据库约束保持一致
2. 统一修改所有使用旧状态值的代码：
   - `'pending'` → `'todo'`
   - `'completed'` → `'done'`
   - `'cancelled'` → `'canceled'`

**涉及文件**：
- [src/types/task.ts](file:///Users/liiiiins/Downloads/文稿%20-%20liiiiins%20的%20MacBook%20Pro/Mweb/PMSY/src/types/task.ts)
- [src/pages/tasks/TaskCreatePage.tsx](file:///Users/liiiiins/Downloads/文稿%20-%20liiiiins%20的%20MacBook%20Pro/Mweb/PMSY/src/pages/tasks/TaskCreatePage.tsx)
- [src/pages/tasks/TaskList.tsx](file:///Users/liiiiins/Downloads/文稿%20-%20liiiiins%20的%20MacBook%20Pro/Mweb/PMSY/src/pages/tasks/TaskList.tsx)
- [src/pages/tasks/TaskDetailPage.tsx](file:///Users/liiiiins/Downloads/文稿%20-%20liiiiins%20的%20MacBook%20Pro/Mweb/PMSY/src/pages/tasks/TaskDetailPage.tsx)
- [src/pages/tasks/components/TaskDetail.tsx](file:///Users/liiiiins/Downloads/文稿%20-%20liiiiins%20的%20MacBook%20Pro/Mweb/PMSY/src/pages/tasks/components/TaskDetail.tsx)
- [src/services/taskService.ts](file:///Users/liiiiins/Downloads/文稿%20-%20liiiiins%20的%20MacBook%20Pro/Mweb/PMSY/src/services/taskService.ts)

**状态**：✅ 已完成

### 6. 任务创建返回值修复

**问题**：创建任务时报错 `Cannot read properties of undefined (reading 'id')`，`taskService.createTask` 返回 undefined。

**原因分析**：
- `api.db.insert` 返回的是 `{ data: T[], error: null }` 格式
- 代码中错误地使用了 `taskData?.[0]` 而不是 `taskData.data?.[0]`
- 同时状态默认值 `'pending'` 也应该改为 `'todo'`

**修复内容**：
1. 修正返回值获取方式：`response?.data?.[0]`
2. 添加空值检查，如果创建失败抛出错误
3. 修正默认状态值为 `'todo'`

**涉及文件**：
- [src/services/taskService.ts](file:///Users/liiiiins/Downloads/文稿%20-%20liiiiins%20的%20MacBook%20Pro/Mweb/PMSY/src/services/taskService.ts)

**状态**：✅ 已完成

### 7. 后端 Insert 返回格式修复

**问题**：任务创建成功但前端报错「未能获取新创建的任务」，后端 `insert` 返回单个对象而非数组。

**原因分析**：
- 前端期望 Supabase 兼容格式：返回数组 `{ data: T[] }`
- 后端 `dbService.insert` 返回的是单个对象
- 导致 `response?.data?.[0]` 获取不到值

**修复内容**：
- 修改 `dbService.insert` 返回数组格式，与 Supabase 保持一致
- 返回结果使用 `Array.isArray(result) ? result : [result]` 确保是数组

**涉及文件**：
- [api-new/src/services/dbService.ts](file:///Users/liiiiins/Downloads/文稿%20-%20liiiiins%20的%20MacBook%20Pro/Mweb/PMSY/api-new/src/services/dbService.ts)

**状态**：✅ 已完成

### 8. 任务处理人插入修复

**问题**：创建任务时插入处理人报错 `column "0" of relation "task_assignees" does not exist`。

**原因分析**：
- 后端 REST API 强制给所有插入操作添加 `created_by` 字段
- 但 `task_assignees` 表没有 `created_by` 字段
- 同时前端 TaskCreatePage.tsx 重复插入了处理人（taskService 已经处理过）

**修复内容**：
1. 修改后端 insert 路由，先检查表是否有 `created_by` 字段，有才添加
2. 支持批量插入数组格式
3. 简化前端 TaskCreatePage.tsx，将 `assignee_ids` 和 `module_ids` 传给 `taskService.createTask` 统一处理

**涉及文件**：
- [api-new/src/routes/rest.ts](file:///Users/liiiiins/Downloads/文稿%20-%20liiiiins%20的%20MacBook%20Pro/Mweb/PMSY/api-new/src/routes/rest.ts)
- [src/pages/tasks/TaskCreatePage.tsx](file:///Users/liiiiins/Downloads/文稿%20-%20liiiiins%20的%20MacBook%20Pro/Mweb/PMSY/src/pages/tasks/TaskCreatePage.tsx)

**状态**：✅ 已完成

### 9. 任务详情页嵌入查询修复

**问题**：任务详情页面评论和进度日志查询报 500 错误，显示 `select=*,profiles(*)` 嵌入查询语法后端不支持。

**原因分析**：
- 前端使用了 PostgREST 风格的嵌入查询 `select('*, profiles(*)')`
- 后端不支持这种关联查询语法

**修复内容**：
1. 修改 TaskDetailPage.tsx，将嵌入查询改为两次独立查询
2. 先查询评论/日志，再查询关联的用户信息
3. 同样修改 TaskDetail.tsx 组件

**涉及文件**：
- [src/pages/tasks/TaskDetailPage.tsx](file:///Users/liiiiins/Downloads/文稿%20-%20liiiiins%20的%20MacBook%20Pro/Mweb/PMSY/src/pages/tasks/TaskDetailPage.tsx)
- [src/pages/tasks/components/TaskDetail.tsx](file:///Users/liiiiins/Downloads/文稿%20-%20liiiiins%20的%20MacBook%20Pro/Mweb/PMSY/src/pages/tasks/components/TaskDetail.tsx)

**状态**：✅ 已完成

### 10. 登录信息确认

**发现**：项目登录使用**用户名**而非邮箱。

- 用户名：`admin`
- 密码：`Willyou@2026`

（不是 `admin@pmsy.com`）

## 遇到的问题

1. 里程碑页面 API 查询兼容性问题 - 已解决
2. 任务创建时数据库字段缺失问题 - 已解决
3. 任务状态值与数据库约束不匹配问题 - 已解决
4. 任务创建返回值处理问题 - 已解决
5. 任务处理人插入字段不匹配问题 - 已解决
6. 任务详情页嵌入查询兼容性问题 - 已解决
7. 登录方式与文档记录不符 - 已确认正确方式

## 明日计划

1. 继续验证其他功能模块
2. 更新相关文档

## 备注

- 前端服务已自动热更新
- 后端服务运行正常
