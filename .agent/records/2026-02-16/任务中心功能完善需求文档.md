# 任务中心功能完善需求文档

## 1. 背景 (Context)

当前任务中心已实现基础功能，包括任务列表展示、多选功能、任务详情查看等。但多选后缺乏批量操作能力，且任务详情的编辑功能不完善（无法修改优先级和截止日期），同时任务历史记录功能缺失。本需求旨在完善这些功能，提升任务中心的易用性和完整性。

---

## 2. 用户故事 (User Stories)

### 需求一：任务列表批量操作

- 作为 **任务创建者/管理员**，我想要 **在任务列表多选后执行批量操作**，以便 **高效管理多个任务**。
- 作为 **任务创建者**，我想要 **批量删除不需要的任务**，以便 **快速清理任务列表**。
- 作为 **任务创建者**，我想要 **批量调整多个任务的状态**，以便 **统一推进任务进度**。
- 作为 **任务创建者**，我想要 **批量新增任务处理人**，以便 **快速分配任务执行人员**。

### 需求二：任务详情完善

- 作为 **任务创建者**，我想要 **在任务详情页调整任务优先级**，以便 **根据情况调整任务重要程度**。
- 作为 **任务创建者**，我想要 **在任务详情页调整任务截止日期**，以便 **灵活调整任务时间安排**。
- 作为 **任务参与者**，我想要 **查看任务的所有历史变更记录**，以便 **了解任务的演变过程**。

---

## 3. 验收标准 (Acceptance Criteria - EARS)

### 3.1 任务列表批量操作

#### 3.1.1 批量删除任务
- **前置条件**: 当用户在任务列表页面且已选择至少一个任务时
- **触发器**: 如果用户点击"批量删除"按钮并确认删除
- **响应**: 系统应当删除所有选中的任务，刷新列表，并显示删除成功提示

#### 3.1.2 批量调整任务状态
- **前置条件**: 当用户在任务列表页面且已选择至少一个任务时
- **触发器**: 如果用户点击"批量修改状态"按钮并选择目标状态
- **响应**: 系统应当将所有选中任务的状态更新为目标状态，刷新列表，并显示更新成功提示
- **状态选项**: 待办(todo)、进行中(in_progress)、已暂停(paused)、已完成(done)、已取消(canceled)

#### 3.1.3 批量新增任务处理人
- **前置条件**: 当用户在任务列表页面且已选择至少一个任务时
- **触发器**: 如果用户点击"批量分配处理人"按钮并选择要添加的处理人
- **响应**: 系统应当将所有选中任务的处理人列表中添加选中的用户，刷新列表，并显示分配成功提示
- **注意**: 原有处理人保留，新处理人追加

#### 3.1.4 批量操作 UI 要求
- 选中任务后，在列表上方或下方显示批量操作工具栏
- 工具栏显示已选中任务数量
- 提供"取消选择"按钮清空选择
- 批量操作前需要二次确认

### 3.2 任务详情完善

#### 3.2.1 调整任务优先级
- **前置条件**: 当用户进入任务详情页且是任务创建者时
- **触发器**: 如果用户点击优先级字段并选择新的优先级
- **响应**: 系统应当更新任务优先级，保存变更，并在历史中记录此次修改
- **优先级选项**: 低(low)、中(medium)、高(high)、紧急(urgent)

#### 3.2.2 调整任务截止日期
- **前置条件**: 当用户进入任务详情页且是任务创建者时
- **触发器**: 如果用户点击截止日期字段并选择新的日期
- **响应**: 系统应当更新任务截止日期，保存变更，并在历史中记录此次修改
- **日期格式**: YYYY-MM-DD

#### 3.2.3 任务历史记录
- **前置条件**: 当任务发生任何变更时
- **触发器**: 如果任务的任何字段被修改（标题、描述、状态、优先级、截止日期、处理人、进度等）
- **响应**: 系统应当在任务历史中创建一条记录，包含：变更字段、变更前值、变更后值、操作人、操作时间

#### 3.2.4 历史记录展示
- 在任务详情页的"历史"Tab 中展示所有历史记录
- 按时间倒序排列（最新的在前）
- 每条记录显示：操作人头像/名称、操作时间、变更内容描述
- 变更内容描述应清晰易读，例如："将优先级从'中'修改为'高'"

---

## 4. 边缘情况与风险 (Edge Cases)

### 4.1 批量操作

| 场景 | 处理方案 |
|------|----------|
| 批量删除时部分任务无权限 | 跳过无权限任务，删除有权限的任务，并提示用户哪些任务未删除 |
| 批量操作过程中网络中断 | 显示操作失败提示，保留选中状态，允许用户重试 |
| 批量操作的任务数量过多 | 增加加载状态，分批处理，避免界面卡顿 |
| 用户刷新页面时仍有选中任务 | 不保留选中状态，避免数据不一致 |

### 4.2 任务详情编辑

| 场景 | 处理方案 |
|------|----------|
| 非创建者尝试编辑 | 隐藏编辑入口，或显示无权限提示 |
| 编辑时任务已被他人修改 | 提示用户数据已变更，刷新后重试 |
| 截止日期早于开始日期 | 表单校验提示，不允许保存 |
| 历史记录数据量过大 | 分页加载，或只展示最近 N 条 |

### 4.3 历史记录

| 场景 | 处理方案 |
|------|----------|
| 历史记录表数据增长过快 | 考虑定期归档或清理策略 |
| 并发修改导致历史记录冲突 | 使用数据库事务保证一致性 |
| 敏感信息变更记录 | 确保历史记录访问权限与任务查看权限一致 |

---

## 5. 技术实现要点

### 5.1 数据库变更

需要新增任务历史记录表：

```sql
-- 任务历史记录表
CREATE TABLE IF NOT EXISTS task_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    task_id UUID REFERENCES tasks(id) ON DELETE CASCADE NOT NULL,
    user_id UUID REFERENCES profiles(id) ON DELETE SET NULL,
    field_name TEXT NOT NULL,           -- 变更字段名
    old_value TEXT,                      -- 变更前值
    new_value TEXT,                      -- 变更后值
    change_type TEXT NOT NULL,           -- 变更类型: update/delete/create
    description TEXT,                    -- 变更描述
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);

CREATE INDEX IF NOT EXISTS idx_task_history_task_id ON task_history(task_id);
CREATE INDEX IF NOT EXISTS idx_task_history_created_at ON task_history(created_at);
```

### 5.2 API 接口

| 接口 | 方法 | 说明 |
|------|------|------|
| /api/tasks/batch-delete | POST | 批量删除任务 |
| /api/tasks/batch-update-status | POST | 批量更新任务状态 |
| /api/tasks/batch-assign | POST | 批量分配处理人 |
| /api/tasks/:id/history | GET | 获取任务历史记录 |

### 5.3 前端组件

| 组件 | 说明 |
|------|------|
| BatchActionBar | 批量操作工具栏 |
| BatchDeleteModal | 批量删除确认弹窗 |
| BatchStatusModal | 批量修改状态弹窗 |
| BatchAssignModal | 批量分配处理人弹窗 |
| TaskHistory | 任务历史记录展示组件 |

---

## 6. 相关文件

### 6.1 现有文件

| 文件路径 | 说明 |
|---------|------|
| `/src/pages/tasks/TaskList.tsx` | 任务列表页面 |
| `/src/pages/tasks/components/TaskTable.tsx` | 任务表格组件（含多选） |
| `/src/pages/tasks/TaskDetailPage.tsx` | 任务详情页面 |
| `/src/services/taskService.ts` | 任务服务接口 |
| `/src/types/task.ts` | 任务类型定义 |
| `/api-new/database/migrations/004_create_tasks.sql` | 数据库表结构 |

### 6.2 需新增/修改的文件

| 文件路径 | 操作 | 说明 |
|---------|------|------|
| `/src/pages/tasks/components/BatchActionBar.tsx` | 新增 | 批量操作工具栏 |
| `/src/pages/tasks/components/BatchDeleteModal.tsx` | 新增 | 批量删除确认弹窗 |
| `/src/pages/tasks/components/BatchStatusModal.tsx` | 新增 | 批量修改状态弹窗 |
| `/src/pages/tasks/components/BatchAssignModal.tsx` | 新增 | 批量分配处理人弹窗 |
| `/src/pages/tasks/components/TaskHistory.tsx` | 新增 | 任务历史记录组件 |
| `/src/pages/tasks/TaskList.tsx` | 修改 | 集成批量操作功能 |
| `/src/pages/tasks/TaskDetailPage.tsx` | 修改 | 添加优先级/截止日期编辑，集成历史记录 |
| `/src/services/taskService.ts` | 修改 | 添加批量操作和历史记录接口 |
| `/api-new/database/migrations/xxx_add_task_history.sql` | 新增 | 任务历史记录表迁移 |
| `/api-new/src/routes/tasks.ts` | 修改 | 添加批量操作和历史记录 API |

---

## 7. 优先级与排期

| 需求 | 优先级 | 预估工时 |
|------|--------|----------|
| 批量删除任务 | P1 | 4h |
| 批量调整任务状态 | P1 | 4h |
| 批量新增任务处理人 | P1 | 4h |
| 调整任务优先级 | P2 | 3h |
| 调整任务截止日期 | P2 | 3h |
| 任务历史记录 | P2 | 6h |

---

*文档创建时间: 2026-02-16*
*需求提出人: 产品负责人*
