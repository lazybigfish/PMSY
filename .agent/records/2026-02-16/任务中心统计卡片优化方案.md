# 任务中心统计卡片优化方案

## 一、问题诊断

### 1.1 当前统计卡片列表（7个）

| 序号 | 卡片名称 | 统计逻辑 | 筛选逻辑 |
|-----|---------|---------|---------|
| 1 | 总任务 | 所有任务数量 | 无筛选（展示全部） |
| 2 | 我负责 | 当前用户为主要负责人的任务 | 筛选 `is_primary = true` |
| 3 | 我参与 | 当前用户为处理人的任务 | 筛选 `assignees` 包含当前用户 |
| 4 | 已完成 | 状态为 `done` 的任务 | 筛选 `status = 'done'` |
| 5 | 本周截止 | 7天内到期且未完成的任务 | 筛选 `due_date` 在本周内且 `status !== 'done'` |
| 6 | 本月截止 | 30天内到期且未完成的任务 | 筛选 `due_date` 在本月内且 `status !== 'done'` |
| 7 | 超期 | 已过期且未完成/未取消的任务 | 筛选 `due_date < now` 且 `status` 非 `done/canceled` |

### 1.2 发现的冲突问题

#### 问题1：默认列表筛选与统计卡片筛选冲突

**当前默认筛选配置（第37行）：**
```typescript
statuses: ['todo', 'in_progress', 'paused'],  // 默认筛除已完成
```

**冲突场景：**
- 用户点击"已完成"统计卡片 → 筛选 `status = 'done'`
- 但默认筛选器状态为 `['todo', 'in_progress', 'paused']`
- 两者取交集后结果为空，无法展示已完成任务

**代码位置：** [TaskList.tsx#L37](file:///Users/liiiiins/Downloads/文稿 - liiiiins 的 MacBook Pro/Mweb/PMSY/src/pages/tasks/TaskList.tsx#L37)

#### 问题2：统计卡片筛选与过滤器状态不同步

**当前筛选逻辑（第157-159行）：**
```typescript
if (filters.statuses.length > 0) {
  result = result.filter(t => filters.statuses.includes(t.status));
}
```

**问题：**
- 点击统计卡片时，只设置了 `activeStatCard`，没有同步更新 `filters.statuses`
- 导致统计卡片筛选与过滤器筛选叠加，结果不符合预期

**代码位置：** [TaskList.tsx#L157-L159](file:///Users/liiiiins/Downloads/文稿 - liiiiins 的 MacBook Pro/Mweb/PMSY/src/pages/tasks/TaskList.tsx#L157-L159)

#### 问题3："我负责"和"我参与"存在包含关系

**统计逻辑：**
- 我负责：`assignees?.some(a => a.user_id === user?.id && a.is_primary)`
- 我参与：`assignees?.some(a => a.user_id === user?.id)`

**问题：**
- "我负责"的任务一定"我参与"
- 两个卡片数字存在包含关系，用户可能困惑

#### 问题4：缺少"进行中"统计维度

**当前状态定义（task.ts）：**
```typescript
type TaskStatus = 'todo' | 'in_progress' | 'paused' | 'done' | 'canceled';
```

**缺失：**
- 没有单独统计"进行中"（in_progress）任务的卡片
- 用户无法快速了解当前活跃的任务数量

---

## 二、优化方案

### 2.1 统计卡片重新设计（8个）

**顺序：总任务 → 进行中 → 我负责 → 我参与 → 本周截止 → 本月截止 → 已完成 → 超期**

| 序号 | 卡片名称 | 统计逻辑 | 点击后筛选行为 | 颜色主题 |
|-----|---------|---------|--------------|---------|
| 1 | 总任务 | `tasks.length` | 清除所有筛选，展示全部 | 主色（indigo） |
| 2 | **进行中** | `status === 'in_progress'` | 设置 `statuses = ['in_progress']` | 蓝色（blue） |
| 3 | 我负责 | `is_primary = true` | 筛选主要负责人 | 紫色（violet） |
| 4 | 我参与 | `assignees` 包含当前用户 | 筛选参与的任务 | 薄荷绿（mint） |
| 5 | 本周截止 | 7天内到期且未完成 | 筛选截止日期范围 | 黄色（sun） |
| 6 | 本月截止 | 30天内到期且未完成 | 筛选截止日期范围 | 橙色（orange） |
| 7 | 已完成 | `status === 'done'` | 设置 `statuses = ['done']` | 绿色（green） |
| 8 | 超期 | 已过期且未完成/未取消 | 筛选超期任务 | 红色（red） |

### 2.2 筛选逻辑优化

#### 方案A：统计卡片优先模式（推荐）

**核心原则：**
- 点击统计卡片时，**重置过滤器**为卡片对应的筛选条件
- 统计卡片筛选与过滤器筛选互斥，不叠加

**实现逻辑：**
```typescript
// 点击统计卡片时
const handleStatCardClick = (cardType: ActiveStatCard) => {
  if (activeStatCard === cardType) {
    // 取消激活，恢复默认筛选
    setActiveStatCard(null);
    setFilters({
      ...filters,
      statuses: ['todo', 'in_progress', 'paused'] // 默认筛除已完成
    });
  } else {
    // 激活卡片，根据卡片类型设置筛选
    setActiveStatCard(cardType);
    switch (cardType) {
      case 'in_progress':
        setFilters({ ...filters, statuses: ['in_progress'] });
        break;
      case 'done':
        setFilters({ ...filters, statuses: ['done'] });
        break;
      case 'my_primary':
        // 不清除状态筛选，只添加负责人筛选
        break;
      // ... 其他情况
    }
  }
};
```

#### 方案B：筛选叠加模式

**核心原则：**
- 统计卡片筛选作为基础筛选
- 过滤器筛选在此基础上进一步过滤
- 需要明确展示当前应用的筛选条件

**适用场景：**
- 用户想查看"我负责的进行中任务"
- 用户想查看"本周截止的高优先级任务"

### 2.3 推荐采用方案A + 扩展方案B

**主要交互（方案A）：**
- 点击统计卡片 → 重置为卡片对应筛选
- 再次点击 → 恢复默认筛选

**高级交互（扩展）：**
- 按住 Shift 点击统计卡片 → 叠加筛选（方案B）
- 或提供"叠加筛选"开关供高级用户使用

---

## 三、具体修改点

### 3.1 新增"进行中"统计卡片

**位置：** 第2位（总任务之后，我负责之前）

**代码变更（TaskList.tsx）：**

1. 类型定义扩展：
```typescript
type ActiveStatCard =
  | 'all'
  | 'in_progress'  // 新增
  | 'my_primary'
  | 'my_participate'
  | 'done'
  | 'due_this_week'
  | 'due_this_month'
  | 'overdue'
  | null;
```

2. stats 计算新增：
```typescript
const stats = useMemo(() => {
  return {
    total: tasks.length,
    inProgress: tasks.filter(t => t.status === 'in_progress').length,  // 新增
    myPrimary: tasks.filter(t => t.assignees?.some(a => a.user_id === user?.id && a.is_primary)).length,
    // ...
  };
}, [tasks, user?.id]);
```

3. filteredTasks 筛选逻辑新增：
```typescript
case 'in_progress':
  result = result.filter(t => t.status === 'in_progress');
  break;
```

4. UI 新增卡片（放在总任务之后）：
```tsx
<button
  onClick={() => setActiveStatCard(activeStatCard === 'in_progress' ? null : 'in_progress')}
  className={`stat-card card-hover text-left ${activeStatCard === 'in_progress' ? 'ring-2 ring-blue-500' : ''}`}
>
  <div className="flex items-center gap-3">
    <div className="w-10 h-10 rounded-xl bg-blue-100 flex items-center justify-center">
      <Play className="w-5 h-5 text-blue-600" />  {/* 需要导入 Play 图标 */}
    </div>
    <div>
      <div className="text-2xl font-bold text-dark-900">{stats.inProgress}</div>
      <div className="text-xs text-dark-500">进行中</div>
    </div>
  </div>
</button>
```

### 3.2 修复筛选冲突问题

**修改筛选逻辑（第179-217行）：**

当前代码：
```typescript
if (activeStatCard) {
  // 统计卡片筛选逻辑...
}
// 过滤器筛选始终执行
if (filters.statuses.length > 0) {
  result = result.filter(t => filters.statuses.includes(t.status));
}
```

修改为：
```typescript
if (activeStatCard) {
  // 统计卡片筛选逻辑...
  // 注意：这里不叠加 filters.statuses 筛选
} else {
  // 只在未激活统计卡片时应用过滤器筛选
  if (filters.statuses.length > 0) {
    result = result.filter(t => filters.statuses.includes(t.status));
  }
}
```

### 3.3 优化"总任务"卡片行为

**当前问题：**
- 点击"总任务"只设置 `activeStatCard = 'all'`，但没有实际筛选逻辑

**修复方案：**
```typescript
case 'all':
  // 总任务不添加任何筛选，展示全部
  break;
```

同时点击"总任务"时应重置所有筛选器：
```typescript
if (activeStatCard === 'all') {
  setFilters({
    keyword: '',
    projectId: '',
    dateRange: { type: 'created', start: '', end: '' },
    statuses: [],  // 总任务展示所有状态
    priorities: []
  });
}
```

---

## 四、界面布局调整

### 4.1 当前布局（7个卡片，grid-cols-7）

```
| 总任务 | 我负责 | 我参与 | 已完成 | 本周截止 | 本月截止 | 超期 |
```

### 4.2 优化后布局（8个卡片，响应式）

**大屏（≥1280px）：一行8个**
```
| 总任务 | 进行中 | 我负责 | 我参与 | 本周截止 | 本月截止 | 已完成 | 超期 |
```

**中屏（1024px-1279px）：一行4个，两行**
```
| 总任务 | 进行中 | 我负责 | 我参与 |
| 本周截止 | 本月截止 | 已完成 | 超期 |
```

**小屏（768px-1023px）：一行2个，四行**
```
| 总任务 | 进行中 |
| 我负责 | 我参与 |
| 本周截止 | 本月截止 |
| 已完成 | 超期 |
```

**超小屏（<768px）：一行2个，四行，紧凑模式**
```
| 总任务 | 进行中 |
| 我负责 | 我参与 |
| 本周截止 | 本月截止 |
| 已完成 | 超期 |
```

### 4.3 布局代码调整

**当前代码（第381行）：**
```tsx
<div className="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-7 gap-4">
```

**修改为：**
```tsx
<div className="grid grid-cols-2 sm:grid-cols-4 xl:grid-cols-8 gap-3">
```

**调整说明：**
- `grid-cols-2`：超小屏一行2个
- `sm:grid-cols-4`：小屏一行4个
- `xl:grid-cols-8`：大屏（≥1280px）一行8个
- `gap-3`：间距从4调整为3，更紧凑

**卡片内部微调：**
- 图标容器：`w-10 h-10` → `w-9 h-9`（大屏保持 `w-10 h-10`）
- 数字：`text-2xl` → `text-xl xl:text-2xl`
- 标签：`text-xs` 保持不变

---

## 五、状态流转图

```
┌─────────────────────────────────────────────────────────────┐
│                        默认状态                              │
│  列表默认筛除已完成，展示：未开始(todo) + 进行中(in_progress) + 已暂停(paused)  │
└─────────────────────────────────────────────────────────────┘
                              │
          ┌───────────────────┼───────────────────┐
          ▼                   ▼                   ▼
   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
   │  点击总任务  │    │ 点击进行中  │    │ 点击已完成  │
   └─────────────┘    └─────────────┘    └─────────────┘
          │                   │                   │
          ▼                   ▼                   ▼
   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
   │  展示全部   │    │ 仅展示进行中 │    │ 仅展示已完成 │
   │ (重置筛选)  │    │             │    │             │
   └─────────────┘    └─────────────┘    └─────────────┘
          │                   │                   │
          └───────────────────┼───────────────────┘
                              ▼
                    ┌─────────────────┐
                    │ 再次点击同一卡片 │
                    │  恢复默认筛选   │
                    └─────────────────┘
```

---

## 六、测试用例

### 6.1 基础功能测试

| 用例ID | 操作 | 预期结果 |
|-------|------|---------|
| TC-01 | 页面初始加载 | 列表展示未开始+进行中+已暂停的任务，统计卡片显示正确数字 |
| TC-02 | 点击"进行中"卡片 | 列表仅展示进行中任务，其他统计卡片取消激活状态 |
| TC-03 | 再次点击"进行中"卡片 | 恢复默认筛选，展示未开始+进行中+已暂停的任务 |
| TC-04 | 点击"已完成"卡片 | 列表仅展示已完成任务，过滤器状态同步更新为 ['done'] |
| TC-05 | 点击"总任务"卡片 | 列表展示所有任务（包括已完成），清除所有筛选条件 |

### 6.2 边界情况测试

| 用例ID | 场景 | 预期结果 |
|-------|------|---------|
| TC-06 | 进行中任务数为0 | 卡片显示0，点击后列表为空 |
| TC-07 | 同时点击多个卡片 | 只有最后点击的卡片生效（互斥） |
| TC-08 | 点击卡片后使用过滤器 | 过滤器筛选叠加在卡片筛选之上（根据最终方案） |
| TC-09 | 快速切换卡片 | 筛选结果正确，无闪烁或卡顿 |

---

## 七、实施建议

### 7.1 实施优先级

| 优先级 | 任务 | 说明 |
|-------|------|------|
| P0 | 修复筛选冲突问题 | 当前影响用户体验，必须优先修复 |
| P0 | 新增"进行中"统计卡片 | 用户明确要求 |
| P1 | 优化统计卡片交互逻辑 | 点击后重置筛选器 |
| P2 | 响应式布局调整 | 8个卡片在不同屏幕下的展示优化 |
| P3 | 高级筛选叠加功能 | Shift+点击或开关控制 |

### 7.2 风险评估

| 风险点 | 影响 | 缓解措施 |
|-------|------|---------|
| 筛选逻辑变更影响现有功能 | 中 | 全面测试所有筛选场景 |
| 新增卡片导致布局错乱 | 低 | 使用响应式网格布局 |
| 用户习惯改变 | 低 | 保持主要交互一致，添加视觉反馈 |

---

## 八、最终确认方案

### 8.1 已确认事项

- [x] **统计卡片顺序**：总任务 → 进行中 → 我负责 → 我参与 → 本周截止 → 本月截止 → 已完成 → 超期
- [x] **筛选交互模式**：方案A（点击卡片重置筛选）
- [x] **"总任务"行为**：点击后展示所有状态（包括已完成）
- [x] **布局方案**：响应式网格，大屏一行8个，中屏一行4个，小屏一行2个
- [x] **颜色方案**：进行中使用蓝色主题

### 8.2 实施检查清单

- [ ] 1. 扩展 `ActiveStatCard` 类型，添加 `'in_progress'`
- [ ] 2. 在 `stats` useMemo 中添加 `inProgress` 计算
- [ ] 3. 在 `filteredTasks` 中添加 `case 'in_progress'` 筛选逻辑
- [ ] 4. 修复筛选冲突（`activeStatCard` 与 `filters.statuses` 互斥）
- [ ] 5. 优化"总任务"点击行为（重置所有筛选）
- [ ] 6. 添加"进行中"统计卡片 UI
- [ ] 7. 调整布局为 `xl:grid-cols-8 gap-3`
- [ ] 8. 导入 `Play` 图标
- [ ] 9. 自测所有统计卡片点击行为
- [ ] 10. 重启前端服务验证

---

*文档创建时间: 2026-02-16*
*关联代码: [TaskList.tsx](file:///Users/liiiiins/Downloads/文稿 - liiiiins 的 MacBook Pro/Mweb/PMSY/src/pages/tasks/TaskList.tsx)*
