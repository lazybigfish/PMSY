# 任务历史记录操作人员修复记录

## 问题描述
任务详情页的历史页面，操作记录里操作人员的名称和头像与实际操作人不符合，只有添加处理人的操作记录显示正常了。

## 问题原因
任务历史记录是通过数据库触发器自动记录的，触发器需要从会话变量 `app.current_user_id` 中获取当前用户ID。

但是，通用的 PATCH 更新路由（用于更新任务状态、标题等）没有设置这个会话变量，导致触发器无法获取当前用户ID，历史记录中的 user_id 为 null。

**触发器代码**：
```sql
BEGIN
    current_user_id := current_setting('app.current_user_id', true)::UUID;
EXCEPTION WHEN OTHERS THEN
    current_user_id := NULL;
END;
```

**批量操作API（已正确设置）**：
- `/tasks/batch-status` - 批量更新状态
- `/tasks/batch-assign` - 批量分配处理人

**通用PATCH路由（未设置）**：
- `PATCH /rest/v1/:table` - 批量更新数据
- `PATCH /rest/v1/:table/:id` - 根据ID更新单条数据

## 修复方案
在通用 PATCH 路由中，当操作 `tasks` 表时，设置 `app.current_user_id` 会话变量：

```typescript
// 设置当前用户ID（供触发器使用）- 仅当操作 tasks 表时
if (table === 'tasks' && userId) {
  const { db } = await import('../config/database');
  await db.raw(`SET LOCAL "app.current_user_id" = '${userId}'`);
}
```

## 修改文件
- `api-new/src/routes/rest.ts` - 修改两个 PATCH 路由

## 测试验证
- [x] 在任务列表更新任务状态，历史记录显示正确的操作人员
- [x] 在任务详情页更新任务标题，历史记录显示正确的操作人员
- [x] 在任务详情页更新任务优先级，历史记录显示正确的操作人员
- [x] 批量更新状态，历史记录显示正确的操作人员
- [x] 添加处理人，历史记录显示正确的操作人员

## 重启服务
后端服务已重启，更改已生效。
