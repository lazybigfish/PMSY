# 任务处理人历史记录补充实现记录

## 实现时间
2026-02-16

## 需求概述
任务详情的历史记录中，添加和调整处理人的操作没有做记录，需要补充。

## 实现详情

### 1. 后端批量分配API记录历史

**修改文件**：`api-new/src/routes/rest.ts`

**修改内容**：
在 `/tasks/batch-assign` API 中，添加历史记录逻辑：

- 在替换模式下，先记录被移除的处理人历史
- 添加新处理人后，记录新增处理人历史
- 使用数据库函数 `record_task_assignee_change` 记录历史

```typescript
// 获取已存在的处理人信息（用于记录历史）
const existingAssignees = await trx('task_assignees')
  .where('task_id', taskId)
  .leftJoin('profiles', 'task_assignees.user_id', 'profiles.id')
  .select('task_assignees.user_id', 'profiles.full_name');

if (mode === 'replace') {
  // 记录被移除的处理人历史
  for (const assignee of existingAssignees) {
    await trx.raw(
      `SELECT record_task_assignee_change(?, ?, 'remove', ?)`,
      [taskId, userId, assignee.full_name || '未知用户']
    );
  }
  // 删除现有分配
  await trx('task_assignees').where('task_id', taskId).delete();
}

// ... 添加新处理人后
// 记录新增处理人的历史
for (const newUserId of newUserIds) {
  await trx.raw(
    `SELECT record_task_assignee_change(?, ?, 'add', ?)`,
    [taskId, userId, userNameMap.get(newUserId) || '未知用户']
  );
}
```

### 2. 新增记录处理人变更历史的API

**修改文件**：`api-new/src/routes/rest.ts`

**新增API**：`POST /rest/v1/tasks/record-assignee-change`

供前端在单个添加/移除处理人时调用。

```typescript
router.post('/tasks/record-assignee-change', requireAuth, async (req: Request, res: Response, next: NextFunction) => {
  const { task_id, change_type, assignee_name } = req.body;
  const userId = req.user?.sub;

  // 调用数据库函数记录历史
  await db.raw(
    `SELECT record_task_assignee_change(?, ?, ?, ?)`,
    [task_id, userId, change_type, assignee_name]
  );
});
```

### 3. 前端服务层添加记录方法

**修改文件**：`src/services/taskService.ts`

**新增方法**：`recordTaskAssigneeChange`

```typescript
export async function recordTaskAssigneeChange(
  taskId: string,
  changeType: 'add' | 'remove',
  assigneeName: string
): Promise<void> {
  await apiClient.post('/rest/v1/tasks/record-assignee-change', {
    task_id: taskId,
    change_type: changeType,
    assignee_name: assigneeName,
  });
}
```

### 4. 前端任务详情页记录历史

**修改文件**：`src/pages/tasks/TaskDetailPage.tsx`

**修改内容**：

#### handleAddAssignee 函数：
```typescript
const handleAddAssignee = async (userId: string) => {
  // 先获取用户姓名
  const { data: userData } = await api.db.from('profiles').select('full_name').eq('id', userId).single();
  const userName = userData?.full_name || '未知用户';

  // 添加处理人
  await api.db.from('task_assignees').insert({...});

  // 记录添加处理人的历史
  await recordTaskAssigneeChange(task.id, 'add', userName);
};
```

#### handleRemoveAssignee 函数：
```typescript
const handleRemoveAssignee = async (userId: string) => {
  // 先获取用户姓名
  const { data: userData } = await api.db.from('profiles').select('full_name').eq('id', userId).single();
  const userName = userData?.full_name || '未知用户';

  // 删除指定处理人
  await apiClient.delete(`/rest/v1/task_assignees?task_id=eq.${task.id}&user_id=eq.${userId}`);

  // 记录移除处理人的历史
  await recordTaskAssigneeChange(task.id, 'remove', userName);
};
```

## 数据库函数

数据库中已存在 `record_task_assignee_change` 函数（在 `005_add_task_history.sql` 中定义）：

```sql
CREATE OR REPLACE FUNCTION record_task_assignee_change(
    p_task_id UUID,
    p_user_id UUID,
    p_change_type TEXT,  -- 'add' 或 'remove'
    p_assignee_name TEXT
)
RETURNS VOID AS $$
BEGIN
    INSERT INTO task_history (task_id, user_id, field_name, old_value, new_value, change_type, description)
    VALUES (
        p_task_id, 
        p_user_id, 
        'assignees', 
        CASE WHEN p_change_type = 'remove' THEN p_assignee_name ELSE NULL END,
        CASE WHEN p_change_type = 'add' THEN p_assignee_name ELSE NULL END,
        'update',
        CASE 
            WHEN p_change_type = 'add' THEN '添加处理人: ' || p_assignee_name
            WHEN p_change_type = 'remove' THEN '移除处理人: ' || p_assignee_name
            ELSE '修改处理人'
        END
    );
END;
$$ LANGUAGE plpgsql;
```

## 测试验证

- [x] 添加处理人时，历史记录中显示"添加处理人: xxx"
- [x] 移除处理人时，历史记录中显示"移除处理人: xxx"
- [x] 批量分配处理人时，正确记录每个变更
- [x] 替换模式时，先记录移除再记录添加

## 相关文件

- `src/pages/tasks/TaskDetailPage.tsx` - 任务详情页
- `src/services/taskService.ts` - 任务服务
- `api-new/src/routes/rest.ts` - 后端API路由
- `api-new/database/migrations/005_add_task_history.sql` - 数据库触发器

## 重启服务

后端和前端服务已重启，更改已生效。
