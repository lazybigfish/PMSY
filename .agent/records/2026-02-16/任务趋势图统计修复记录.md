# 任务趋势图统计修复记录

## 问题描述
在任务列表直接更新任务状态为已完成，任务趋势图并没有更新。

## 问题原因
在任务列表中更新任务状态时，只更新了 `status` 字段，没有更新 `completed_at` 字段。

而任务趋势图的统计逻辑是基于 `completed_at` 字段来判断的：

```typescript
const dailyCompletedData = useMemo(() => {
  return dateRange.map(date => {
    const nextDay = new Date(date);
    nextDay.setDate(date.getDate() + 1);

    return tasks.filter(task => {
      if (task.status !== 'done' || !task.completed_at) return false;
      const completedAt = new Date(task.completed_at);
      return completedAt >= date && completedAt < nextDay;
    }).length;
  });
}, [tasks, dateRange]);
```

由于 `completed_at` 为 null，任务不会被统计到趋势图中。

## 修复方案
修改任务列表中的 `onUpdateStatus` 回调函数，在状态变为已完成时设置 `completed_at` 时间戳：

```typescript
onUpdateStatus={async (taskId, status) => {
  try {
    const updates: any = { status };
    // 当状态变为已完成时，设置 completed_at 时间戳
    if (status === 'done') {
      updates.completed_at = new Date().toISOString();
    } else {
      updates.completed_at = null;
    }
    await api.db.from('tasks').update(updates).eq('id', taskId);
    fetchTasks();
  } catch (error) {
    console.error('Error updating task status:', error);
  }
}}
```

## 修改文件
- `src/pages/tasks/TaskList.tsx` - 修改 `onUpdateStatus` 回调函数

## 相关代码检查

### 后端批量更新状态API
文件：`api-new/src/routes/rest.ts`
状态：✅ 已正确处理 `completed_at` 字段

```typescript
const updateData: any = { status };
if (status === 'done') {
  updateData.completed_at = new Date().toISOString();
} else {
  updateData.completed_at = null;
}
```

### 任务详情页更新状态
文件：`src/pages/tasks/TaskDetailPage.tsx`
状态：✅ 已正确处理 `completed_at` 字段

```typescript
if (newStatus === 'done') {
  updates.completed_at = new Date().toISOString();
} else {
  updates.completed_at = null;
}
```

## 测试验证
- [x] 在任务列表更新状态为已完成，趋势图正确更新
- [x] 在任务详情页更新状态为已完成，趋势图正确更新
- [x] 批量更新状态为已完成，趋势图正确更新

## 重启服务
前端服务已热更新，更改已生效。
