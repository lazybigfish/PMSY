# 供应商付款计划新增失败修复记录

## 问题描述

供应商付款计划页面，新增付款计划失败，报错信息：

```
POST http://localhost:3001/rest/v1/supplier_payment_plans 500 (Internal Server Error)
[API] Insert error to supplier_payment_plans: Error: insert into "supplier_payment_plans" ("amount", "created_by", "percentage", "planned_date", "project_supplier_id", "reason", "status") values ($1, $2, $3, $4, $5, $6, $7) returning * - column "amount" of relation "supplier_payment_plans" does not exist
```

## 问题分析

### 数据库表结构（005_create_suppliers_and_risks.sql）

```sql
CREATE TABLE IF NOT EXISTS supplier_payment_plans (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    supplier_id UUID REFERENCES suppliers(id) ON DELETE CASCADE NOT NULL,
    project_id UUID REFERENCES projects(id) ON DELETE CASCADE NOT NULL,
    phase_name TEXT NOT NULL,
    planned_amount DECIMAL(15, 2) NOT NULL,
    planned_date DATE,
    actual_amount DECIMAL(15, 2),
    actual_date DATE,
    status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'paid', 'overdue')),
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);
```

### 前端代码期望的字段（SupplierDetailModal.tsx）

```typescript
const paymentPlans = plans.map(plan => ({
  project_supplier_id: projectSupplierId,
  planned_date: plan.planned_date,
  amount: plan.amount,
  percentage: plan.percentage,
  reason: plan.reason,
  status: 'pending'
}));
```

### 字段不匹配对比

| 前端字段 | 数据库字段 | 说明 |
|---------|-----------|------|
| project_supplier_id | - | 数据库缺少此字段 |
| amount | planned_amount | 字段名不一致 |
| percentage | - | 数据库缺少此字段 |
| reason | phase_name | 字段名不一致 |
| created_by | - | 数据库缺少此字段 |

## 修复方案

### 1. 创建数据库迁移文件

创建文件：`api-new/database/migrations/017_update_supplier_payment_plans.sql`

```sql
-- 修改 supplier_payment_plans 表结构，使其与前端代码保持一致

-- 1. 添加新字段
ALTER TABLE supplier_payment_plans 
    ADD COLUMN IF NOT EXISTS project_supplier_id UUID REFERENCES project_suppliers(id) ON DELETE CASCADE,
    ADD COLUMN IF NOT EXISTS amount DECIMAL(15, 2),
    ADD COLUMN IF NOT EXISTS percentage DECIMAL(5, 2),
    ADD COLUMN IF NOT EXISTS reason TEXT,
    ADD COLUMN IF NOT EXISTS created_by UUID REFERENCES profiles(id);

-- 2. 创建新索引
CREATE INDEX IF NOT EXISTS idx_supplier_payment_plans_project_supplier_id ON supplier_payment_plans(project_supplier_id);
CREATE INDEX IF NOT EXISTS idx_supplier_payment_plans_created_by ON supplier_payment_plans(created_by);

-- 3. 添加注释
COMMENT ON COLUMN supplier_payment_plans.project_supplier_id IS '项目供应商关联ID';
COMMENT ON COLUMN supplier_payment_plans.amount IS '付款金额';
COMMENT ON COLUMN supplier_payment_plans.percentage IS '付款比例（百分比）';
COMMENT ON COLUMN supplier_payment_plans.reason IS '付款原因/阶段说明';
COMMENT ON COLUMN supplier_payment_plans.created_by IS '创建人ID';
```

### 2. 执行迁移

```bash
cd api-new
npx ts-node scripts/run-sql-migration.ts 017_update_supplier_payment_plans.sql
```

### 3. 修改前端代码

在 `SupplierDetailModal.tsx` 的 `AddPaymentPlanModal` 组件中，修改 `handleSubmit` 函数，添加 `created_by` 字段：

```typescript
const handleSubmit = async () => {
  // ... 验证代码 ...

  try {
    const currentUser = await api.auth.getUser();
    const paymentPlans = plans.map(plan => ({
      project_supplier_id: projectSupplierId,
      planned_date: plan.planned_date,
      amount: plan.amount,
      percentage: plan.percentage,
      reason: plan.reason,
      status: 'pending',
      created_by: currentUser?.id  // 添加创建人字段
    }));

    const { error } = await api.db
      .from('supplier_payment_plans')
      .insert(paymentPlans);

    if (error) throw error;
    onSuccess();
  } catch (error) {
    console.error('Error creating payment plans:', error);
    alert('创建付款计划失败');
  }
};
```

## 修复结果

- 数据库表结构已更新，添加了前端需要的字段
- 前端代码已更新，提交时包含 `created_by` 字段
- 前端服务已重启，功能已恢复正常

## 相关文件

1. `api-new/database/migrations/017_update_supplier_payment_plans.sql` - 数据库迁移文件
2. `src/pages/projects/components/SupplierDetailModal.tsx` - 前端组件文件

## 后续问题修复

### 问题 2：非空约束错误

**错误信息**：`null value in column "supplier_id" of relation "supplier_payment_plans" violates not-null constraint`

**解决方案**：创建迁移文件 `018_fix_supplier_payment_plans_constraint.sql`，移除 `supplier_id` 和 `project_id` 的 NOT NULL 约束。

### 问题 3：phase_name 非空约束错误

**错误信息**：`null value in column "phase_name" of relation "supplier_payment_plans" violates not-null constraint`

**解决方案**：创建迁移文件 `019_fix_supplier_payment_plans_phase_name.sql`，移除 `phase_name` 和 `planned_amount` 的 NOT NULL 约束。

### 问题 4：数据添加成功但不显示

**原因**：`fetchPaymentPlans` 函数使用旧的查询条件（`supplier_id` 和 `project_id`），但插入数据使用的是 `project_supplier_id`。

**修复代码**：
```typescript
const fetchPaymentPlans = async () => {
  try {
    const { data, error } = await api.db
      .from('supplier_payment_plans')
      .select('*')
      .eq('project_supplier_id', projectSupplier.id)  // 修改查询条件
      .order('planned_date', { ascending: true });

    if (error) throw error;
    setPaymentPlans(data || []);
  } catch (error) {
    console.error('Error fetching payment plans:', error);
  }
};
```

### 问题 5：确认付款失败

**错误信息**：`column "actual_payment_date" of relation "supplier_payment_plans" does not exist`

**解决方案**：创建迁移文件 `020_add_payment_confirmation_fields.sql`，添加确认付款相关字段（actual_payment_date, voucher_url, updated_by）。

### 问题 6：供应商列表已支付金额不同步

**原因**：`Suppliers.tsx` 中的支付金额查询逻辑使用旧的表结构和字段（supplier_id, project_id），且依赖 `supplier_payments` 表计算金额。

**修复代码**：
```typescript
// 获取所有付款计划（使用新的字段结构）
let paymentsMap: Record<string, number> = {};
if (suppliersData && suppliersData.length > 0) {
  const projectSupplierIds = suppliersData.map((item: any) => item.id);
  const { data: paymentPlansData } = await api.db
    .from('supplier_payment_plans')
    .select('project_supplier_id, amount, status')
    .in('project_supplier_id', projectSupplierIds);
  
  // 按 project_supplier_id 计算已支付金额（status = 'paid'）
  paymentsMap = (paymentPlansData || []).reduce((acc: any, plan: any) => {
    if (plan.status === 'paid') {
      if (!acc[plan.project_supplier_id]) acc[plan.project_supplier_id] = 0;
      acc[plan.project_supplier_id] += Number(plan.amount) || 0;
    }
    return acc;
  }, {});
}

// 将返回数据中的字段映射为组件期望的格式
const mappedSuppliersData = (suppliersData || []).map((item: any) => ({
  ...item,
  supplier: suppliersMap[item.supplier_id] || null,
  paid_amount: paymentsMap[item.id] || 0
}));
```

显示部分修改为：
```typescript
<td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
  ¥{(ps.paid_amount || 0).toLocaleString()}
</td>
```

### 问题 7：已支付金额统计不同步

**原因**：`fetchPaymentStats` 函数使用旧的查询条件和字段名。

**修复代码**：
```typescript
const fetchPaymentStats = async () => {
  const { data } = await api.db
    .from('supplier_payment_plans')
    .select('amount, status')  // 改为 amount
    .eq('project_supplier_id', projectSupplier.id);  // 改为 project_supplier_id

  const plans = data || [];
  const totalPaid = plans
    .filter(p => p.status === 'paid')
    .reduce((sum, p) => sum + (Number(p.amount) || 0), 0);  // 改为 amount
  // ...
};
```

## 完整迁移文件列表

1. `017_update_supplier_payment_plans.sql` - 添加新字段（project_supplier_id, amount, percentage, reason, created_by）
2. `018_fix_supplier_payment_plans_constraint.sql` - 移除 supplier_id 和 project_id 的非空约束
3. `019_fix_supplier_payment_plans_phase_name.sql` - 移除 phase_name 和 planned_amount 的非空约束
4. `020_add_payment_confirmation_fields.sql` - 添加确认付款相关字段（actual_payment_date, voucher_url, updated_by）

## 前端修复文件列表

1. `SupplierDetailModal.tsx` - 修复 fetchPaymentPlans 查询条件
2. `SupplierDetailModal.tsx` - 修复 fetchPaymentStats 查询条件和字段名
3. `SupplierDetailModal.tsx` - 添加 created_by 字段到插入数据
4. `Suppliers.tsx` - 修复支付金额查询逻辑和计算方式

## 备注

旧字段（supplier_id, phase_name, planned_amount, actual_amount, actual_date, notes）暂时保留以确保兼容性，后续可以清理。
