# 供应商付款计划查询报错修复

## 问题描述

添加供应商成功后，控制台还是报错：

```
GET http://localhost:3001/rest/v1/supplier_payments?select=*&in.project_supplier_id=... 500 (Internal Server Error)
GET http://localhost:3001/rest/v1/supplier_payment_plans?select=amount%2C+status&eq.project_supplier_id=... 500 (Internal Server Error)
```

## 问题原因

数据库表结构定义：

1. `supplier_payment_plans` 表字段：`id`, `supplier_id`, `project_id`, `phase_name`, `planned_amount`, `planned_date`, `actual_amount`, `actual_date`, `status`, `notes`, `created_at`, `updated_at`
   - **没有 `project_supplier_id` 字段**，只有 `supplier_id` 和 `project_id`

2. `supplier_payments` 表字段：`id`, `payment_plan_id`, `amount`, `payment_date`, `payment_method`, `voucher_no`, `notes`, `created_by`, `created_at`, `updated_at`
   - **没有 `project_supplier_id` 字段**，只有 `payment_plan_id`

但前端代码错误地使用了 `project_supplier_id` 字段来查询这两个表。

## 修复内容

### 修改文件

`src/pages/projects/components/SupplierDetailModal.tsx`

### 修复 1：fetchPaymentStats 函数

**修改前：**
```typescript
const fetchPaymentStats = async () => {
  const { data } = await api.db
    .from('supplier_payment_plans')
    .select('amount, status')
    .eq('project_supplier_id', projectSupplier.id);

  const plans = data || [];
  const totalPaid = plans
    .filter(p => p.status === 'paid')
    .reduce((sum, p) => sum + (Number(p.amount) || 0), 0);
  // ...
};
```

**修改后：**
```typescript
const fetchPaymentStats = async () => {
  const { data } = await api.db
    .from('supplier_payment_plans')
    .select('planned_amount, status')
    .eq('supplier_id', projectSupplier.supplier_id)
    .eq('project_id', projectSupplier.project_id);

  const plans = data || [];
  const totalPaid = plans
    .filter(p => p.status === 'paid')
    .reduce((sum, p) => sum + (Number(p.planned_amount) || 0), 0);
  // ...
};
```

### 修复 2：fetchPaymentPlans 函数

**修改前：**
```typescript
const fetchPaymentPlans = async () => {
  const { data, error } = await api.db
    .from('supplier_payment_plans')
    .select('*')
    .eq('project_supplier_id', projectSupplier.id)
    .order('planned_date', { ascending: true });
  // ...
};
```

**修改后：**
```typescript
const fetchPaymentPlans = async () => {
  const { data, error } = await api.db
    .from('supplier_payment_plans')
    .select('*')
    .eq('supplier_id', projectSupplier.supplier_id)
    .eq('project_id', projectSupplier.project_id)
    .order('planned_date', { ascending: true });
  // ...
};
```

## 修复要点

1. 使用 `supplier_id` 和 `project_id` 组合查询替代不存在的 `project_supplier_id`
2. 字段名从 `amount` 改为 `planned_amount`（与数据库表定义一致）

## 测试验证

1. 进入项目详情页的供应商页面
2. 关联一个供应商
3. 点击供应商打开详情弹窗
4. 付款计划应正确加载，不再出现 500 错误

## 修复时间

2026-02-16
