# 供应商付款记录查询修复

## 问题描述

添加供应商成功后，控制台还报错：

```
GET http://localhost:3001/rest/v1/supplier_payments?select=*&in.project_supplier_id=... 500 (Internal Server Error)
```

## 问题原因

`supplier_payments` 表没有 `project_supplier_id` 字段，只有 `payment_plan_id` 字段。表结构如下：

- `supplier_payments` 表：`id`, `payment_plan_id`, `amount`, `payment_date`, `payment_method`, `voucher_no`, `notes`, `created_by`, `created_at`, `updated_at`
- `supplier_payment_plans` 表：`id`, `supplier_id`, `project_id`, `phase_name`, `planned_amount`, ...

需要通过 `supplier_payment_plans` 表作为中间关联表来查询付款记录。

## 修复内容

### 修改文件

`src/pages/projects/tabs/Suppliers.tsx`

### 修改前

```typescript
// 获取付款信息
const projectSupplierIds = (suppliersData || []).map((item: any) => item.id);
let paymentsMap: Record<string, any[]> = {};
if (projectSupplierIds.length > 0) {
  const { data: paymentsData } = await api.db
    .from('supplier_payments')
    .select('*')
    .in('project_supplier_id', projectSupplierIds);
  paymentsMap = (paymentsData || []).reduce((acc: any, p: any) => {
    if (!acc[p.project_supplier_id]) acc[p.project_supplier_id] = [];
    acc[p.project_supplier_id].push(p);
    return acc;
  }, {});
}
```

### 修改后

```typescript
// 获取付款计划信息（通过 supplier_id 和 project_id 关联）
const supplierProjectPairs = (suppliersData || []).map((item: any) => ({
  supplier_id: item.supplier_id,
  project_id: item.project_id
}));

let paymentsMap: Record<string, any[]> = {};
if (supplierProjectPairs.length > 0) {
  // 先获取付款计划
  const { data: paymentPlansData } = await api.db
    .from('supplier_payment_plans')
    .select('*')
    .in('supplier_id', supplierProjectPairs.map((p: any) => p.supplier_id))
    .eq('project_id', projectId);
  
  // 获取付款计划ID对应的 project_supplier_id 映射
  const planIdToProjectSupplierId: Record<string, string> = {};
  (suppliersData || []).forEach((item: any) => {
    const plans = (paymentPlansData || []).filter((p: any) => p.supplier_id === item.supplier_id);
    plans.forEach((plan: any) => {
      planIdToProjectSupplierId[plan.id] = item.id;
    });
  });
  
  // 获取付款记录
  const planIds = Object.keys(planIdToProjectSupplierId);
  if (planIds.length > 0) {
    const { data: paymentsData } = await api.db
      .from('supplier_payments')
      .select('*')
      .in('payment_plan_id', planIds);
    
    // 按 project_supplier_id 分组
    paymentsMap = (paymentsData || []).reduce((acc: any, p: any) => {
      const projectSupplierId = planIdToProjectSupplierId[p.payment_plan_id];
      if (projectSupplierId) {
        if (!acc[projectSupplierId]) acc[projectSupplierId] = [];
        acc[projectSupplierId].push(p);
      }
      return acc;
    }, {});
  }
}
```

## 修复逻辑

1. 先查询 `supplier_payment_plans` 表获取付款计划（通过 `supplier_id` 和 `project_id` 关联）
2. 建立付款计划ID到 project_supplier_id 的映射关系
3. 再查询 `supplier_payments` 表获取付款记录（通过 `payment_plan_id` 关联）
4. 按 project_supplier_id 分组返回数据

## 测试验证

1. 进入项目详情页的供应商页面
2. 添加或查看供应商
3. 付款记录应正确加载，不再出现 500 错误

## 修复时间

2026-02-16
