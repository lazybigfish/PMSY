# 供应商关联功能完善修复

## 问题描述

添加关联供应商时，虽然显示成功了，但还是报错，同时关联的功能模块也没有生效。

## 问题原因

添加供应商时只保存了 `contract_amount`，但没有保存 `module_ids` 和 `contract_file_url` 字段，导致：
1. 功能模块关联不生效
2. 合同文件URL丢失

## 修复内容

### 修改文件

`src/pages/projects/tabs/Suppliers.tsx`

### 修改前

```typescript
try {
  const { error } = await api.db.from('project_suppliers').insert({
    project_id: projectId,
    supplier_id: selectedSupplierId,
    contract_amount: addForm.contract_amount
  });
  // ...
}
```

### 修改后

```typescript
try {
  const { error } = await api.db.from('project_suppliers').insert({
    project_id: projectId,
    supplier_id: selectedSupplierId,
    contract_amount: addForm.contract_amount,
    module_ids: selectedModuleIds,
    contract_file_url: addForm.contract_file_url || null
  });
  // ...
}
```

## 修复要点

1. 添加 `module_ids: selectedModuleIds` - 保存关联的功能模块ID列表
2. 添加 `contract_file_url: addForm.contract_file_url || null` - 保存合同文件URL

## 依赖修复

此修复依赖于之前的数据库迁移：
- `api-new/database/migrations/021_add_project_supplier_module_ids.sql` - 添加 `module_ids` 字段
- `api-new/database/migrations/022_add_project_supplier_contract_file.sql` - 添加 `contract_file_url` 字段

## 测试验证

1. 进入项目详情页的供应商页面
2. 点击"关联供应商"按钮
3. 选择供应商、填写合同金额
4. 选择功能模块、上传合同文件
5. 点击确认保存
6. 供应商应正确关联，功能模块和合同文件URL都应正确保存

## 修复时间

2026-02-16
