# 供应商模块调整报错修复

## 问题描述

调整供应商模块时报错：

```
PATCH http://localhost:3001/rest/v1/project_suppliers?eq.id=... 500 (Internal Server Error)
Error: update "project_suppliers" set "module_ids" = $1... - column "module_ids" of relation "project_suppliers" does not exist
```

## 问题原因

`project_suppliers` 表缺少 `module_ids` 字段，但前端代码尝试更新这个字段来保存供应商负责的模块ID列表。

## 修复内容

### 1. 创建数据库迁移文件

**文件**: `api-new/database/migrations/021_add_project_supplier_module_ids.sql`

```sql
-- 为 project_suppliers 表添加 module_ids 字段
ALTER TABLE project_suppliers
ADD COLUMN IF NOT EXISTS module_ids JSONB DEFAULT '[]'::jsonb;

-- 添加注释
COMMENT ON COLUMN project_suppliers.module_ids IS '供应商负责的模块ID列表';
```

### 2. 执行迁移脚本

**文件**: `api-new/scripts/add-module-ids-column.ts`

```typescript
import { db } from '../src/config/database';

async function runMigration() {
  try {
    await db.raw(`
      ALTER TABLE project_suppliers
      ADD COLUMN IF NOT EXISTS module_ids JSONB DEFAULT '[]'::jsonb;
    `);
    console.log('Migration completed successfully: module_ids column added to project_suppliers');
    process.exit(0);
  } catch (error) {
    console.error('Migration failed:', error);
    process.exit(1);
  }
}

runMigration();
```

**执行命令**:
```bash
cd api-new && npx ts-node scripts/add-module-ids-column.ts
```

**执行结果**:
```
Migration completed successfully: module_ids column added to project_suppliers
```

## 修复后的表结构

`project_suppliers` 表现在包含以下字段：
- `id`, `project_id`, `supplier_id`, `contract_amount`, `contract_date`, `delivery_date`
- `status`, `notes`, `module_ids` (新增), `created_at`, `updated_at`

## 测试验证

1. 进入项目详情页的供应商页面
2. 点击供应商打开详情弹窗
3. 点击"调整模块"按钮
4. 选择模块后保存
5. 应成功保存，不再报错

## 修复时间

2026-02-16
