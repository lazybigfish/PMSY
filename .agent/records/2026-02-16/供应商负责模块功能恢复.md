# 供应商负责模块功能恢复

## 问题描述

前端提示"负责模块功能暂不可用，需要数据库支持"。

## 问题原因

之前 `module_ids` 字段在数据库中不存在，所以前端代码被临时禁用，显示提示信息。现在数据库字段已经添加，需要恢复功能。

## 修复内容

### 修改文件

`src/pages/projects/components/SupplierDetailModal.tsx`

### 修改前

```typescript
const handleSaveModules = async () => {
  // TODO: module_ids 字段在数据库中不存在，需要添加迁移或创建关联表
  // 暂时禁用此功能
  alert('负责模块功能暂不可用，需要数据库支持');
  setIsEditingModules(false);
  return;

  /* 原代码，等待数据库支持后恢复
  setLoading(true);
  try {
    const { error } = await api.db
      .from('project_suppliers')
      .update({ module_ids: selectedModules })
      .eq('id', projectSupplier.id);

    if (error) throw error;
    onUpdate();
    setIsEditingModules(false);
  } catch (error) {
    console.error('Error updating modules:', error);
    alert('更新负责模块失败');
  } finally {
    setLoading(false);
  }
  */
};
```

### 修改后

```typescript
const handleSaveModules = async () => {
  setLoading(true);
  try {
    const { error } = await api.db
      .from('project_suppliers')
      .update({ module_ids: selectedModules })
      .eq('id', projectSupplier.id);

    if (error) throw error;
    onUpdate();
    setIsEditingModules(false);
  } catch (error) {
    console.error('Error updating modules:', error);
    alert('更新负责模块失败');
  } finally {
    setLoading(false);
  }
};
```

## 修复逻辑

1. 移除了临时的禁用代码和提示信息
2. 恢复了原有的保存模块功能代码
3. 现在可以正常更新 `module_ids` 字段

## 依赖修复

此修复依赖于之前的数据库迁移：
- `api-new/database/migrations/021_add_project_supplier_module_ids.sql`
- 已为 `project_suppliers` 表添加 `module_ids` JSONB 字段

## 测试验证

1. 进入项目详情页的供应商页面
2. 点击供应商打开详情弹窗
3. 点击"调整模块"按钮
4. 选择模块后保存
5. 应成功保存，不再提示"功能暂不可用"

## 修复时间

2026-02-16
