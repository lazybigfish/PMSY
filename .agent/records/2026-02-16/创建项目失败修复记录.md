# 创建项目失败修复记录

## 问题描述

在项目管理模块中，点击"创建项目"按钮后，提示创建失败。控制台报错：

```
POST http://localhost:3001/rest/v1/milestone_tasks 500 (Internal Server Error)
insert into "milestone_tasks" ("created_by", "description", "is_required", "milestone_id", "name", "output_documents") 
values ($1, $2, $3, $4, $5, $6) returning * - invalid input syntax for type json
```

## 问题分析

### 1. 错误信息分析

从 PostgreSQL 错误日志可以看到：

```
where: 'JSON data, line 1: {"{\\"name\\":\\"移交清单\\",\\"required\\":true}"}\n'
```

这说明 `output_documents` 字段被错误地序列化为：
```json
{"{\"name\":\"移交清单\",\"required\":true}"}
```

而不是正确的数组格式：
```json
[{"name":"移交清单","required":true}]
```

### 2. 根本原因

`output_documents` 在 HTTP 传输过程中被错误地构造为对象格式 `{[JSON字符串]: undefined}`，而不是数组格式。

这可能是由于：
1. 前端 `JSON.stringify` 和后端 `express.json()` 解析之间的兼容性问题
2. 或者 `output_documents` 在传输前被错误地转换了格式

### 3. 相关代码

**前端代码** (`src/pages/projects/ProjectCreate.tsx`):
```typescript
const tasksToInsert = template.tasks.map(t => ({
  milestone_id: milestone.id,
  name: t.name,
  description: t.description,
  is_required: t.is_required,
  output_documents: t.output_documents  // 这是一个数组
}));
```

**后端代码** (`api-new/src/routes/rest.ts`):
- 接收前端发送的 JSON 数据
- 使用 Knex 插入 PostgreSQL 的 JSONB 字段

## 修复方案

### 1. 后端修复 (api-new/src/routes/rest.ts)

在插入数据前，添加对 `output_documents` 字段的格式检查和转换：

```typescript
// 处理 JSONB 字段：确保它们是对象/数组而不是字符串
if (table === 'milestone_tasks' && processedItem.output_documents) {
  console.log('[REST] output_documents type:', typeof processedItem.output_documents);
  console.log('[REST] output_documents value:', JSON.stringify(processedItem.output_documents));
  
  if (typeof processedItem.output_documents === 'string') {
    try {
      processedItem.output_documents = JSON.parse(processedItem.output_documents);
    } catch (e) {
      console.warn('[REST] Failed to parse output_documents as JSON:', processedItem.output_documents);
      processedItem.output_documents = [];
    }
  } else if (typeof processedItem.output_documents === 'object' && !Array.isArray(processedItem.output_documents)) {
    // 如果 output_documents 是对象但不是数组，可能是错误的格式
    // 尝试将其转换为数组
    console.warn('[REST] output_documents is object but not array, converting to array');
    processedItem.output_documents = Object.entries(processedItem.output_documents).map(([key, value]) => {
      try {
        return JSON.parse(key);
      } catch (e) {
        return { name: key, required: value };
      }
    });
  }
}
```

### 2. 数据库迁移文件 (api-new/database/migrations/018_fix_milestone_tasks_table.sql)

确保 `milestone_tasks` 表结构正确：

```sql
-- 修复 milestone_tasks 表结构
-- 1. 添加 milestone_id 字段（如果不存在）
ALTER TABLE milestone_tasks
ADD COLUMN IF NOT EXISTS milestone_id UUID REFERENCES project_milestones(id) ON DELETE CASCADE;

-- 2. 修改 template_id 为可选（如果还是 NOT NULL）
DO $$
BEGIN
    ALTER TABLE milestone_tasks
    ALTER COLUMN template_id DROP NOT NULL;
EXCEPTION
    WHEN others THEN
        RAISE NOTICE 'template_id 可能已经是可选的';
END $$;

-- 3. 添加 created_by 字段（如果不存在）
ALTER TABLE milestone_tasks
ADD COLUMN IF NOT EXISTS created_by UUID REFERENCES profiles(id);

-- 4. 创建索引（如果不存在）
CREATE INDEX IF NOT EXISTS idx_milestone_tasks_milestone_id ON milestone_tasks(milestone_id);
CREATE INDEX IF NOT EXISTS idx_milestone_tasks_created_by ON milestone_tasks(created_by);
```

## 修复结果

- [x] 后端添加 `output_documents` 字段格式检查和转换
- [x] 创建数据库迁移文件修复表结构
- [ ] 需要进一步测试验证

## 后续建议

1. **前端验证**：在前端添加 `output_documents` 的数据格式验证，确保发送的数据是正确的数组格式
2. **类型检查**：考虑使用 TypeScript 严格类型检查，避免数据格式错误
3. **单元测试**：添加单元测试覆盖项目创建流程，特别是里程碑任务的创建

## 相关文件

- `src/pages/projects/ProjectCreate.tsx` - 前端创建项目页面
- `src/lib/api.ts` - 前端 API 客户端
- `api-new/src/routes/rest.ts` - 后端 REST API 路由
- `api-new/database/migrations/018_fix_milestone_tasks_table.sql` - 数据库迁移文件
