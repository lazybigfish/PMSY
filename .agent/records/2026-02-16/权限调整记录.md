# 项目管理与任务中心权限调整记录

## 一、调整概述

### 调整时间
2026-02-16

### 调整目标
全面验证与调整项目管理模块的项目权限和任务中心的任务查看/编辑权限，确保符合权限控制逻辑。

### 核心原则
- **系统设置角色**（admin/manager/user）只控制**导航模块的显示**
- **项目和任务权限**完全基于**项目团队**中的成员身份

---

## 二、权限规则定义

### 2.1 项目权限级别（由低到高）

| 级别 | 说明 | 获取条件 |
|-----|------|---------|
| `none` | 无权限 | 非项目成员且项目不公开 |
| `viewer` | 仅查看 | 公开项目，非成员（相关方） |
| `member` | 项目成员 | project_members.role = 'member' |
| `manager` | 项目经理 | projects.manager_id = user.id 或 project_members.role = 'manager' |
| `admin` | 系统管理员 | profiles.role = 'admin' |

### 2.2 任务查看权限规则

用户只能看到满足以下任一条件的任务：

1. **自己创建的任务** - 始终可见
2. **自己是处理人的任务** - 始终可见
3. **任务状态为"项目内公开"(is_public=true)** 且 **自己是项目组成员** - 可见

### 2.3 各模块权限矩阵

| 模块 | 项目经理 | 项目成员 | 相关方(viewer) |
|-----|---------|---------|---------------|
| 项目概览 | 查看+编辑 | 查看 | 仅查看 |
| 功能模块 | 查看+编辑 | 查看 | - |
| 里程碑 | 查看+编辑 | 查看 | - |
| 供应商 | 查看+编辑 | 查看+编辑 | - |
| 风险 | 查看+编辑 | 查看+编辑 | - |
| 周日报 | 查看+编辑 | 查看+编辑 | - |
| 任务 | 全部权限 | 更新状态+进度 | - |

---

## 三、发现的问题

### 3.1 严重问题

| 模块 | 问题描述 | 影响 |
|-----|---------|------|
| 项目列表 | 查询所有项目，无权限过滤 | 用户看到所有项目 |
| 任务列表 | 查询所有任务，无权限过滤 | 用户看到所有任务 |
| 工作台 | 查询所有项目和任务 | 统计数据不准确，数据泄露 |

### 3.2 中等问题

| 模块 | 问题描述 | 影响 |
|-----|---------|------|
| 任务详情 | 未判断项目管理员权限 | 项目经理无法编辑任务 |
| 供应商 | 缺少权限控制 | 所有人都能编辑 |
| 风险 | 缺少权限控制 | 所有人都能编辑 |
| 周日报 | 缺少权限控制 | 所有人都能编辑 |

---

## 四、修复内容

### 4.1 后端权限服务修复

**文件**: `api-new/src/services/permissionService.ts`

**修改内容**:
- 更新权限检查逻辑
- 添加任务查看权限判断函数 `canViewTask`
- 添加获取用户可访问任务列表函数 `getUserAccessibleTasks`
- 完善项目权限级别判断逻辑

### 4.2 前端项目列表权限过滤

**文件**: `src/pages/projects/ProjectList.tsx`

**修改内容**:
- 只查询用户是成员或项目经理的项目
- 先获取用户成员关系，再查询项目详情

### 4.3 前端任务列表权限过滤

**文件**: `src/pages/tasks/TaskList.tsx`

**修改内容**:
- 实现精细的任务权限查询逻辑
- 合并自己创建的任务、自己是处理人的任务、公开任务

### 4.4 前端任务详情权限判断

**文件**: `src/pages/tasks/TaskDetailPage.tsx`

**修改内容**:
- 添加项目权限判断函数 `getProjectPermissionLevel`
- 更新编辑权限判断：任务创建者 或 项目管理员
- 更新状态更新权限判断：任务创建者 或 任务处理人 或 项目管理员 或 项目成员

### 4.5 前端工作台权限过滤

**文件**: `src/pages/Dashboard.tsx`

**修改内容**:
- 只统计用户有权限的项目
- 只统计用户有权限的任务
- 只统计用户有权限的项目中的风险

### 4.6 项目详情页组件调用完善

**文件**: `src/pages/projects/ProjectDetail.tsx`

**修改内容**:
- 添加所有 tab 的条件渲染代码
- 传递 `canEdit` 属性给各子组件

### 4.7 子组件权限控制

**修改的文件**:
- `src/pages/projects/tabs/Suppliers.tsx` - 添加 canEdit 属性，控制添加按钮
- `src/pages/projects/tabs/Risks.tsx` - 添加 canEdit 属性，控制添加按钮
- `src/pages/projects/tabs/Reports.tsx` - 添加 canEdit 属性，控制新建按钮
- `src/pages/projects/tabs/FunctionalModules.tsx` - 添加 canEdit 属性
- `src/pages/projects/tabs/Milestones.tsx` - 添加 canEdit 属性
- `src/pages/projects/tabs/ProjectOverview.tsx` - 添加 canEdit 属性

---

## 五、测试场景

### 5.1 测试账号准备

需要创建以下角色的测试账号：

1. **系统管理员** - 验证全局数据访问权限
2. **项目经理** - 验证项目管理和任务编辑权限
3. **项目成员** - 验证任务状态更新权限
4. **相关方** - 验证仅查看权限

### 5.2 测试用例

#### 项目列表测试
- [ ] 系统管理员可以看到所有项目
- [ ] 项目经理可以看到自己管理的项目
- [ ] 项目成员可以看到自己参与的项目
- [ ] 相关方只能看到公开项目

#### 任务列表测试
- [ ] 用户只能看到自己创建的任务
- [ ] 用户只能看到自己是处理人的任务
- [ ] 用户只能看到项目内公开且自己是成员的任务
- [ ] 用户看不到不相关的任务

#### 任务详情测试
- [ ] 项目经理可以编辑项目内所有任务
- [ ] 任务创建者可以编辑自己的任务
- [ ] 项目成员可以更新任务状态
- [ ] 任务处理人可以更新任务状态

#### 供应商/风险/周日报测试
- [ ] 项目经理可以添加/编辑
- [ ] 项目成员可以添加/编辑
- [ ] 相关方不能添加/编辑

---

## 六、后续工作

1. **创建测试账号** - 按照测试场景创建不同角色的测试账号
2. **执行测试用例** - 验证各权限场景
3. **修复发现的问题** - 根据测试结果修复权限问题
4. **文档更新** - 更新用户手册，说明权限规则

---

## 七、相关文件清单

### 后端文件
- `api-new/src/services/permissionService.ts`

### 前端文件
- `src/pages/projects/ProjectList.tsx`
- `src/pages/projects/ProjectDetail.tsx`
- `src/pages/projects/tabs/ProjectOverview.tsx`
- `src/pages/projects/tabs/FunctionalModules.tsx`
- `src/pages/projects/tabs/Milestones.tsx`
- `src/pages/projects/tabs/Risks.tsx`
- `src/pages/projects/tabs/Suppliers.tsx`
- `src/pages/projects/tabs/Reports.tsx`
- `src/pages/tasks/TaskList.tsx`
- `src/pages/tasks/TaskDetailPage.tsx`
- `src/pages/Dashboard.tsx`

---

## 八、注意事项

1. **系统设置角色**只控制导航模块显示，不参与项目和任务权限控制
2. **项目权限**完全基于项目团队成员身份
3. **任务权限**基于创建者、处理人、项目成员身份
4. **相关方**（viewer）只能查看项目概览，无编辑权限
