# 水底探宝页面 500 错误修复记录

## 问题描述

**时间**: 2026-02-16

**现象**: 打开水漫金山模块的「水底探宝」页面时，控制台报错：

```
GET http://localhost:3001/rest/v1/forum_post_likes?select=post_id&eq.user_id=00000000-0000-0000-0000-000000000001 500 (Internal Server Error)
```

## 问题分析

### 根因定位

1. 前端代码查询的表名是 `forum_post_likes`
2. 数据库中实际存在的表名是 `forum_likes`
3. 表结构不匹配导致查询失败，返回 500 错误

### 数据库表结构

根据迁移文件 `008_create_water_module.sql`，点赞表结构如下：

```sql
CREATE TABLE IF NOT EXISTS forum_likes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES profiles(id) ON DELETE CASCADE NOT NULL,
    target_type TEXT NOT NULL CHECK (target_type IN ('post', 'comment')),
    target_id UUID NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    UNIQUE(user_id, target_type, target_id)
);
```

### 字段差异

| 前端使用 | 数据库实际 |
|---------|-----------|
| 表名: `forum_post_likes` | 表名: `forum_likes` |
| 字段: `post_id` | 字段: `target_id` |
| 无类型区分 | 需要 `target_type = 'post'` |

## 修复内容

### 修改文件 1: ForumTab.tsx

**位置**: `src/pages/water/ForumTab.tsx`

**修改点**:
1. 第 85-89 行: 查询点赞记录时修改表名和字段
2. 第 199-210 行: 取消点赞时修改表名和字段
3. 第 232-233 行: 点赞时修改表名和字段

**修改前**:
```typescript
.from('forum_post_likes')
.select('post_id')
.eq('user_id', user.id)
```

**修改后**:
```typescript
.from('forum_likes')
.select('target_id')
.eq('user_id', user.id)
.eq('target_type', 'post')
```

### 修改文件 2: ForumPostDetailPage.tsx

**位置**: `src/pages/water/ForumPostDetailPage.tsx`

**修改点**:
1. 第 67-71 行: 检查点赞状态时修改表名和字段
2. 第 198-209 行: 取消点赞时修改表名和字段
3. 第 221-222 行: 点赞时修改表名和字段

## 问题 2: 发帖时 category 约束错误

### 现象
发帖时控制台报错：
```
POST http://localhost:3001/rest/v1/forum_posts 500 (Internal Server Error)
new row for relation "forum_posts" violates check constraint "forum_posts_category_check"
```

### 根因分析
数据库 `forum_posts` 表的 `category` 字段约束为：
```sql
CHECK (category IN ('general', 'question', 'share', 'discussion'))
```

但前端使用的分类值为：
- `tech` (技术分享)
- `experience` (项目经验)
- `help` (问题求助)
- `chat` (闲聊)
- `other` (其他)

前后端分类值完全不匹配，导致插入数据时违反约束。

### 修复方案
创建数据库迁移文件 `021_fix_forum_posts_category.sql`：

```sql
-- 删除旧的 check 约束
ALTER TABLE forum_posts DROP CONSTRAINT IF EXISTS forum_posts_category_check;

-- 添加新的 check 约束，匹配前端分类值
ALTER TABLE forum_posts ADD CONSTRAINT forum_posts_category_check 
    CHECK (category IN ('tech', 'experience', 'help', 'chat', 'other'));

-- 更新现有的数据，将旧分类值映射到新分类值
UPDATE forum_posts SET category = 'tech' WHERE category = 'share';
UPDATE forum_posts SET category = 'help' WHERE category = 'question';
UPDATE forum_posts SET category = 'chat' WHERE category = 'discussion';
UPDATE forum_posts SET category = 'other' WHERE category = 'general';

-- 设置默认值为 'other'
ALTER TABLE forum_posts ALTER COLUMN category SET DEFAULT 'other';
```

### 执行命令
```bash
cd api-new && npx ts-node scripts/run-sql-migration.ts 021_fix_forum_posts_category.sql
```

## 问题 3: 帖子内容显示异常

### 现象
帖子发布成功后，内容显示为 JSON 字符串格式，如 `{"text":"测试一下"}`，而不是纯文本内容。

### 根因分析
1. 发帖时存储的是 `{ text: formContent.trim() }` 对象
2. 数据库 `content` 字段是 TEXT 类型，存储的是 JSON 字符串
3. 前端显示时直接显示了 JSON 字符串，没有正确解析

### 修复方案
在 `ForumTab.tsx` 和 `ForumPostDetailPage.tsx` 中添加 `parseContent` 辅助函数：

```typescript
// 辅助函数：解析帖子内容
const parseContent = (content: any): string => {
  if (!content) return '';
  // 如果是字符串，尝试解析为 JSON
  if (typeof content === 'string') {
    try {
      const parsed = JSON.parse(content);
      return parsed.text || parsed.content || content;
    } catch {
      return content;
    }
  }
  // 如果是对象，取 text 或 content 字段
  if (typeof content === 'object') {
    return content.text || content.content || '';
  }
  return String(content);
};
```

**修改位置**:
1. `ForumTab.tsx`: 
   - 搜索过滤时使用 `parseContent(post.content)`
   - 内容预览显示时使用 `parseContent(post.content)`
   
2. `ForumPostDetailPage.tsx`:
   - 帖子正文显示时使用 `parseContent(post.content)`
   - 回复内容处理时使用 `parseContent(reply.content)`

## 问题 4: 点赞数据未正确保存

### 现象
点击点赞按钮后，点赞记录保存了，但 `forum_posts` 表的 `like_count` 字段没有更新，导致点赞数显示不正确。

### 根因分析
代码注释中提到"触发器会自动更新 like_count"，但实际上数据库中没有创建相应的触发器。

### 修复方案
创建数据库迁移文件 `022_add_forum_likes_triggers.sql`，添加触发器：

```sql
-- 创建触发器函数：当添加点赞时，更新 forum_posts 的 like_count
CREATE OR REPLACE FUNCTION increment_post_like_count()
RETURNS TRIGGER AS $$
BEGIN
    UPDATE forum_posts
    SET like_count = COALESCE(like_count, 0) + 1
    WHERE id = NEW.target_id;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- 创建触发器函数：当删除点赞时，更新 forum_posts 的 like_count
CREATE OR REPLACE FUNCTION decrement_post_like_count()
RETURNS TRIGGER AS $$
BEGIN
    UPDATE forum_posts
    SET like_count = GREATEST(COALESCE(like_count, 0) - 1, 0)
    WHERE id = OLD.target_id;
    RETURN OLD;
END;
$$ LANGUAGE plpgsql;

-- 创建触发器：插入点赞记录时增加 like_count
CREATE TRIGGER trg_forum_likes_insert
    AFTER INSERT ON forum_likes
    FOR EACH ROW
    WHEN (NEW.target_type = 'post')
    EXECUTE FUNCTION increment_post_like_count();

-- 创建触发器：删除点赞记录时减少 like_count
CREATE TRIGGER trg_forum_likes_delete
    AFTER DELETE ON forum_likes
    FOR EACH ROW
    WHEN (OLD.target_type = 'post')
    EXECUTE FUNCTION decrement_post_like_count();
```

### 执行命令
```bash
cd api-new && npx ts-node scripts/run-sql-migration.ts 022_add_forum_likes_triggers.sql
```

## 验证结果

- Vite HMR 自动检测到文件变化并成功编译
- 数据库迁移执行成功
- 前端服务正常运行，无报错

## 总结

此次修复解决了四个问题：
1. **点赞表名不匹配**: 前端使用 `forum_post_likes`，数据库实际为 `forum_likes`
2. **分类约束不匹配**: 数据库约束值与前端使用的分类值不一致
3. **内容显示异常**: JSON 字符串没有正确解析为纯文本
4. **点赞数不更新**: 缺少触发器自动更新 like_count

修复后，水底探宝页面的点赞、发帖、内容显示和点赞数统计功能应能正常工作。

## 相关文件

- `src/pages/water/ForumTab.tsx`
- `src/pages/water/ForumPostDetailPage.tsx`
- `api-new/database/migrations/008_create_water_module.sql`
- `api-new/database/migrations/021_fix_forum_posts_category.sql`
- `api-new/database/migrations/022_add_forum_likes_triggers.sql`
