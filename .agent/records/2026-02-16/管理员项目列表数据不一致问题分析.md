# 管理员项目列表数据不一致问题分析

## 问题描述

普通用户"张三"创建的项目，在系统管理员的项目列表中不存在，数据不一致。

## 问题定位

### 根本原因

**后端项目列表API未针对管理员角色做特殊处理**。

### 详细分析

#### 1. 当前项目列表查询逻辑

**文件**: `/Users/liiiiins/Downloads/文稿 - liiiiins 的 MacBook Pro/Mweb/PMSY/api-new/src/routes/projects.ts` (第115-182行)

```typescript
router.get('/', requireAuth, async (req: Request, res: Response, next: NextFunction) => {
  try {
    const userId = req.user?.sub;
    // ...

    // 过滤条件：用户只能看到公开项目或自己参与的项目
    query = query.where(function() {
      this.where('projects.is_public', true)
        .orWhereExists(function() {
          this.select('*')
            .from('project_members')
            .whereRaw('project_members.project_id = projects.id')
            .andWhere('project_members.user_id', userId);
        });
    });
    // ...
  }
});
```

**问题点**:
- 该API对所有用户（包括管理员）使用相同的查询逻辑
- 只返回 `is_public = true` 的项目，或当前用户是成员的项目
- **没有判断用户是否为管理员，也没有给管理员返回所有项目**

#### 2. 权限服务已有相关功能但未使用

**文件**: `/Users/liiiiins/Downloads/文稿 - liiiiins 的 MacBook Pro/Mweb/PMSY/api-new/src/services/permissionService.ts` (第530-554行)

```typescript
export async function getUserAccessibleProjects(userId: string, userRole?: string): Promise<string[]> {
  // 管理员可以访问所有项目
  if (userRole === 'admin') {
    const projects = await db('projects').select('id');
    return projects.map(p => p.id);
  }
  // ...
}
```

**现状**:
- 权限服务中已经实现了管理员可以访问所有项目的逻辑
- 但项目列表API (`/api/projects`) **没有调用这个函数**

#### 3. 前端项目列表也有同样问题

**文件**: `/Users/liiiiins/Downloads/文稿 - liiiiins 的 MacBook Pro/Mweb/PMSY/src/pages/projects/ProjectList.tsx`

前端自行实现了权限过滤，只查询用户是成员或项目经理的项目，**没有检查admin角色**。

### 数据流向分析

```
张三创建项目
    ↓
项目数据写入 projects 表
    ↓
张三被添加为 project_members (role='manager')
    ↓
管理员请求项目列表
    ↓
API 只返回 is_public=true 或 管理员是成员的项目
    ↓
管理员不是张三项目的成员，且项目非公开
    ↓
管理员看不到张三的项目 ← 问题！
```

## 结论

**这不是脏数据问题，而是代码逻辑缺陷**。

项目列表API没有针对管理员角色做特殊处理，导致管理员只能看到：
1. 公开项目 (`is_public = true`)
2. 管理员自己是成员的项目

而看不到普通用户创建的私有项目。

## 修复建议

### 方案1: 修改后端API (推荐)

在 `/api/projects` 接口中，判断用户角色，如果是管理员则返回所有项目：

```typescript
router.get('/', requireAuth, async (req: Request, res: Response, next: NextFunction) => {
  try {
    const userId = req.user?.sub;
    const userRole = req.user?.role; // 获取用户角色
    // ...

    // 如果不是管理员，才应用权限过滤
    if (userRole !== 'admin') {
      query = query.where(function() {
        this.where('projects.is_public', true)
          .orWhereExists(function() {
            this.select('*')
              .from('project_members')
              .whereRaw('project_members.project_id = projects.id')
              .andWhere('project_members.user_id', userId);
          });
      });
    }
    // 管理员不走上面的过滤，可以看到所有项目
    // ...
  }
});
```

### 方案2: 使用已有的权限服务

调用 `permissionService.getUserAccessibleProjects()` 函数获取可访问的项目ID列表。

## 相关文件

| 文件路径 | 说明 |
|---------|------|
| `/api-new/src/routes/projects.ts` | 后端项目列表API |
| `/api-new/src/services/permissionService.ts` | 权限服务，已有管理员判断逻辑 |
| `/src/pages/projects/ProjectList.tsx` | 前端项目列表页面 |

## 记录时间

2026-02-16
