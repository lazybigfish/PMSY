# ç®¡ç†å‘˜é¡¹ç›®æƒé™å®Œæ•´ä¿®å¤è®°å½•

## é—®é¢˜æè¿°

ç³»ç»Ÿç®¡ç†å‘˜æ‰“å¼€é¡¹ç›®ç®¡ç†æ¨¡å—ï¼Œåªèƒ½çœ‹åˆ°è‡ªå·±çš„é¡¹ç›®ï¼Œçœ‹ä¸åˆ°å…¨å±€æ‰€æœ‰é¡¹ç›®æ•°æ®ã€‚

## æ ¹æœ¬åŸå› 

å¤šå¤„ä»£ç æ²¡æœ‰æ­£ç¡®å¤„ç†ç®¡ç†å‘˜æƒé™ï¼š

1. **åç«¯ `/api/projects` æ¥å£** - å·²ä¿®å¤ï¼ˆç¬¬ä¸€æ¬¡ï¼‰
2. **åç«¯ `/api/projects/:id` æ¥å£** - æœªä¿®å¤
3. **åç«¯ `/api/projects/:id` (PUT/DELETE)** - æœªä¿®å¤
4. **åç«¯ `/rest/v1/projects` (REST API)** - æœªä¿®å¤
5. **å‰ç«¯ ProjectList** - å·²ä¿®å¤ä½†å†—ä½™

## ä¿®å¤æ–¹æ¡ˆ

### æ ¸å¿ƒåŸåˆ™

**ç³»ç»Ÿç®¡ç†å‘˜æ˜¯å…¨å±€è¶…ç®¡ï¼Œå¯¹æ‰€æœ‰é¡¹ç›®æ‹¥æœ‰å®Œå…¨æƒé™ï¼š**
- å¯ä»¥æŸ¥çœ‹æ‰€æœ‰é¡¹ç›®
- å¯ä»¥ç¼–è¾‘æ‰€æœ‰é¡¹ç›®
- å¯ä»¥åˆ é™¤æ‰€æœ‰é¡¹ç›®
- æ‹¥æœ‰é¡¹ç›®ç»ç†çš„æ‰€æœ‰æƒé™

### å…·ä½“ä¿®å¤

#### 1. åç«¯ `/api/projects` åˆ—è¡¨æ¥å£

**æ–‡ä»¶**: `api-new/src/routes/projects.ts` (ç¬¬115-147è¡Œ)

```typescript
// è·å–ç”¨æˆ·è§’è‰²
const userRole = req.user?.role;

// éç®¡ç†å‘˜ç”¨æˆ·åªèƒ½çœ‹åˆ°å…¬å¼€é¡¹ç›®æˆ–è‡ªå·±å‚ä¸çš„é¡¹ç›®
// ç®¡ç†å‘˜å¯ä»¥çœ‹åˆ°æ‰€æœ‰é¡¹ç›®
if (userRole !== 'admin') {
  query = query.where(function() {
    this.where('projects.is_public', true)
      .orWhereExists(function() {
        this.select('*')
          .from('project_members')
          .whereRaw('project_members.project_id = projects.id')
          .andWhere('project_members.user_id', userId);
      });
  });
}
```

#### 2. åç«¯ `/api/projects/:id` è¯¦æƒ…æ¥å£

**æ–‡ä»¶**: `api-new/src/routes/projects.ts` (ç¬¬192-227è¡Œ)

```typescript
const userRole = req.user?.role;

// æ£€æŸ¥æƒé™ï¼šç®¡ç†å‘˜å¯ä»¥è®¿é—®æ‰€æœ‰é¡¹ç›®
const isAdmin = userRole === 'admin';
const hasAccess = isAdmin || project.is_public || project.manager_id === userId ||
  await dbService.getDb()('project_members')
    .where({ project_id: id, user_id: userId })
    .first();
```

#### 3. åç«¯ `/api/projects/:id` (PUT) æ›´æ–°æ¥å£

**æ–‡ä»¶**: `api-new/src/routes/projects.ts` (ç¬¬235-269è¡Œ)

```typescript
const userRole = req.user?.role;

// æ£€æŸ¥æƒé™ï¼ˆåªæœ‰é¡¹ç›®ç»ç†æˆ–ç®¡ç†å‘˜å¯ä»¥æ›´æ–°ï¼‰
const isAdmin = userRole === 'admin';
if (!isAdmin && project.manager_id !== userId) {
  throw new ValidationError('æ— æƒæ›´æ–°è¯¥é¡¹ç›®');
}
```

#### 4. åç«¯ `/api/projects/:id` (DELETE) åˆ é™¤æ¥å£

**æ–‡ä»¶**: `api-new/src/routes/projects.ts` (ç¬¬277-300è¡Œ)

```typescript
const userRole = req.user?.role;

// æ£€æŸ¥æƒé™
const isAdmin = userRole === 'admin';
if (!isAdmin && project.manager_id !== userId) {
  throw new ValidationError('æ— æƒåˆ é™¤è¯¥é¡¹ç›®');
}
```

#### 5. åç«¯ `/rest/v1/projects` REST API

**æ–‡ä»¶**: `api-new/src/routes/rest.ts` (ç¬¬247-290è¡Œ)

```typescript
// å¯¹ projects è¡¨è¿›è¡Œæƒé™æ§åˆ¶
if (table === 'projects') {
  const isAdmin = userRole === 'admin';

  // éç®¡ç†å‘˜åªèƒ½çœ‹åˆ°å…¬å¼€é¡¹ç›®æˆ–è‡ªå·±å‚ä¸çš„é¡¹ç›®
  if (!isAdmin) {
    // è·å–ç”¨æˆ·å¯è®¿é—®çš„é¡¹ç›®IDåˆ—è¡¨
    const accessibleProjectIds = await getUserAccessibleProjects(userId, userRole);

    if (accessibleProjectIds.length === 0) {
      // ç”¨æˆ·æ²¡æœ‰å¯è®¿é—®çš„é¡¹ç›®ï¼Œè¿”å›ç©ºæ•°ç»„
      res.json([]);
      return;
    }

    // æ·»åŠ  id è¿‡æ»¤æ¡ä»¶
    if (!options.in) {
      options.in = {};
    }
    options.in['id'] = accessibleProjectIds;
  }
  // ç®¡ç†å‘˜å¯ä»¥çœ‹åˆ°æ‰€æœ‰é¡¹ç›®ï¼Œä¸æ·»åŠ é¢å¤–è¿‡æ»¤
}
```

#### 6. å‰ç«¯ ProjectList ç®€åŒ– + ç®¡ç†å‘˜åˆ é™¤æŒ‰é’®

**æ–‡ä»¶**: `src/pages/projects/ProjectList.tsx`

**A. ç®€åŒ–æƒé™è¿‡æ»¤é€»è¾‘**

**ç®€åŒ–å‰**: å‰ç«¯æ‰‹åŠ¨è¿‡æ»¤é¡¹ç›®ID
**ç®€åŒ–å**: ä¿¡ä»»åç«¯æƒé™æ§åˆ¶ï¼Œåªè·å–è§’è‰²æ˜ å°„ç”¨äºæ˜¾ç¤º

```typescript
// åˆ›å»ºç”¨æˆ·è§’è‰²æ˜ å°„ï¼ˆä¾›åç»­ä½¿ç”¨ï¼‰
const userRoleMap = new Map<string, 'manager' | 'member'>();

// è·å–å½“å‰ç”¨æˆ·æ˜¯æˆå‘˜çš„é¡¹ç›®IDåˆ—è¡¨ï¼ˆç”¨äºæ˜¾ç¤ºè§’è‰²ï¼‰
const { data: userMemberships } = await api.db
  .from('project_members')
  .select('project_id, role')
  .eq('user_id', user?.id);

if (userMemberships) {
  userMemberships.forEach((membership) => {
    userRoleMap.set(membership.project_id, membership.role);
  });
}

// è·å–é¡¹ç›®æ•°æ®ï¼ˆåç«¯å·²æ ¹æ®ç”¨æˆ·è§’è‰²è¿›è¡Œæƒé™è¿‡æ»¤ï¼‰
const { data: projectsData } = await api.db
  .from('projects')
  .select('*')
  .order('created_at', { ascending: false });
```

**B. ç®¡ç†å‘˜æ˜¾ç¤ºåˆ é™¤æŒ‰é’®**

**é—®é¢˜1**: åˆ é™¤æŒ‰é’®åªæ˜¾ç¤ºç»™ `user_role === 'manager'` çš„ç”¨æˆ·
**ä¿®å¤1**: ç®¡ç†å‘˜ä¹Ÿè§†ä¸ºé¡¹ç›®ç»ç†ï¼Œå¯ä»¥åˆ é™¤æ‰€æœ‰é¡¹ç›®

```typescript
// ä¿®å¤å‰
let userRole: 'manager' | 'member' | null = null;
if (project.manager_id === user?.id) {
  userRole = 'manager';
} else {
  userRole = userRoleMap.get(project.id) || null;
}

// ä¿®å¤å - ç®¡ç†å‘˜è§†ä¸ºæ‰€æœ‰é¡¹ç›®çš„ç»ç†
let userRole: 'manager' | 'member' | null = null;
if (profile?.role === 'admin' || project.manager_id === user?.id) {
  userRole = 'manager';
} else {
  userRole = userRoleMap.get(project.id) || null;
}
```

**é—®é¢˜2**: ä½¿ç”¨ `user?.role` åˆ¤æ–­ç®¡ç†å‘˜ï¼Œä½† `role` åœ¨ `profile` å¯¹è±¡ä¸­
**ä¿®å¤2**: ä» AuthContext è·å– `profile`ï¼Œä½¿ç”¨ `profile?.role` åˆ¤æ–­

```typescript
// ä¿®å¤å‰
const { user } = useAuth();
// ...
if (user?.role === 'admin' || project.manager_id === user?.id) {

// ä¿®å¤å
const { user, profile } = useAuth();
// ...
if (profile?.role === 'admin' || project.manager_id === user?.id) {
```

#### 7. å‰ç«¯ ProjectOverview æˆå‘˜ç®¡ç†æƒé™

**æ–‡ä»¶**: `src/pages/projects/tabs/ProjectOverview.tsx`

**é—®é¢˜**: æˆå‘˜ç®¡ç†æƒé™åˆ¤æ–­ä½¿ç”¨ `user?.role === 'admin'`ï¼Œä½† `role` åœ¨ `profile` ä¸­
**ä¿®å¤**: ä½¿ç”¨ `profile?.role === 'admin'` åˆ¤æ–­

```typescript
// ä¿®å¤å‰
const { user } = useAuth();
// ...
{(user?.id === project?.manager_id || members.some(m => m.id === user?.id && m.member_role === 'manager') || user?.role === 'admin') && (

// ä¿®å¤å
const { user, profile } = useAuth();
// ...
{(user?.id === project?.manager_id || members.some(m => m.id === user?.id && m.member_role === 'manager') || profile?.role === 'admin') && (
```

**æ³¨æ„**: æœ‰ä¸¤å¤„éœ€è¦ä¿®æ”¹ï¼ˆæ·»åŠ æˆå‘˜æŒ‰é’®å’Œåˆ é™¤æˆå‘˜æŒ‰é’®ï¼‰

#### 8. é¡¹ç›®ç»ç†ä¸èƒ½åˆ é™¤è‡ªå·±

**æ–‡ä»¶**: `src/pages/projects/tabs/ProjectOverview.tsx`

**é—®é¢˜**: é¡¹ç›®ç»ç†å¯ä»¥åˆ é™¤è‡ªå·±ï¼Œå¯¼è‡´é¡¹ç›®å¯èƒ½æ²¡æœ‰ç»ç†
**ä¿®å¤**: æ·»åŠ æ¡ä»¶ï¼Œç¦æ­¢åˆ é™¤è‡ªå·±ï¼ˆç®¡ç†å‘˜é™¤å¤–ï¼‰

```typescript
// ä¿®å¤å‰
{(user?.id === project?.manager_id || members.some(m => m.id === user?.id && m.member_role === 'manager') || profile?.role === 'admin') && (
  <button onClick={() => handleRemoveMember(member.member_id)}>...</button>
)}

// ä¿®å¤å
{/* é¡¹ç›®ç»ç†æˆ–ç®¡ç†å‘˜å¯ä»¥åˆ é™¤æˆå‘˜ï¼Œä½†ä¸èƒ½åˆ é™¤è‡ªå·± */}
{(profile?.role === 'admin' || (user?.id === project?.manager_id || members.some(m => m.id === user?.id && m.member_role === 'manager')) && member.id !== user?.id) && (
  <button onClick={() => handleRemoveMember(member.member_id)}>...</button>
)}
```

**é€»è¾‘è¯´æ˜**:
- ç®¡ç†å‘˜å¯ä»¥åˆ é™¤ä»»ä½•äººï¼ˆåŒ…æ‹¬è‡ªå·±ï¼‰
- é¡¹ç›®ç»ç†å¯ä»¥åˆ é™¤å…¶ä»–æˆå‘˜ï¼Œä½†ä¸èƒ½åˆ é™¤è‡ªå·±
- æ™®é€šæˆå‘˜ä¸èƒ½åˆ é™¤ä»»ä½•äºº

## æƒé™å±‚çº§æ€»ç»“

| æƒé™çº§åˆ« | è¯´æ˜ | æƒé™èŒƒå›´ |
|---------|------|---------|
| **admin** | ç³»ç»Ÿç®¡ç†å‘˜ | æ‰€æœ‰é¡¹ç›®çš„æ‰€æœ‰æ“ä½œ |
| **manager** | é¡¹ç›®ç»ç† | æŒ‡å®šé¡¹ç›®çš„æ‰€æœ‰æ“ä½œ |
| **member** | é¡¹ç›®æˆå‘˜ | æŒ‡å®šé¡¹ç›®çš„æŸ¥çœ‹å’Œéƒ¨åˆ†æ“ä½œ |
| **viewer** | ç›¸å…³æ–¹ï¼ˆå…¬å¼€é¡¹ç›®ï¼‰| ä»…æŸ¥çœ‹ |
| **none** | æ— æƒé™ | æ— æ³•è®¿é—® |

## ä¿®å¤éªŒè¯

### åç«¯æœåŠ¡é‡å¯

```bash
# é‡å¯åæœåŠ¡æ­£å¸¸å¯åŠ¨
[INFO] 22:00:37 ts-node-dev ver. 2.0.0
Redis connected successfully
info: Database connected successfully
info: Server is running on port 3001
ğŸš€ Server ready at http://localhost:3001
```

### æµ‹è¯•åœºæ™¯

1. **ç®¡ç†å‘˜ç™»å½•** - åº”è¯¥èƒ½çœ‹åˆ°æ‰€æœ‰é¡¹ç›®
2. **æ™®é€šç”¨æˆ·ç™»å½•** - åªèƒ½çœ‹åˆ°å…¬å¼€é¡¹ç›®å’Œè‡ªå·±å‚ä¸çš„é¡¹ç›®
3. **ç®¡ç†å‘˜è®¿é—®é¡¹ç›®è¯¦æƒ…** - å¯ä»¥è®¿é—®ä»»ä½•é¡¹ç›®
4. **ç®¡ç†å‘˜ç¼–è¾‘é¡¹ç›®** - å¯ä»¥ç¼–è¾‘ä»»ä½•é¡¹ç›®
5. **ç®¡ç†å‘˜åˆ é™¤é¡¹ç›®** - å¯ä»¥åˆ é™¤ä»»ä½•é¡¹ç›®

## ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹å†…å®¹ |
|---------|---------|
| `api-new/src/routes/projects.ts` | æ·»åŠ ç®¡ç†å‘˜æƒé™åˆ¤æ–­ï¼ˆåˆ—è¡¨ã€è¯¦æƒ…ã€æ›´æ–°ã€åˆ é™¤ï¼‰ |
| `api-new/src/routes/rest.ts` | æ·»åŠ  projects è¡¨æƒé™æ§åˆ¶ |
| `src/pages/projects/ProjectList.tsx` | ç®€åŒ–æƒé™è¿‡æ»¤é€»è¾‘ + ç®¡ç†å‘˜æ˜¾ç¤ºåˆ é™¤æŒ‰é’® |
| `src/pages/projects/tabs/ProjectOverview.tsx` | ä¿®å¤ç®¡ç†å‘˜æˆå‘˜ç®¡ç†æƒé™ |

## è®°å½•æ—¶é—´

2026-02-16
