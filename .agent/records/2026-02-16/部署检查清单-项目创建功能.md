# 部署检查清单 - 项目创建功能

## 概述

本文档总结了项目创建功能的部署检查要点，确保新环境部署时不会出现已知问题。

## 数据库检查

### 1. 表结构检查

#### milestone_tasks 表

```sql
-- 检查表结构
\d milestone_tasks

-- 应该包含以下列：
-- - id: UUID PRIMARY KEY
-- - template_id: UUID REFERENCES milestone_task_templates(id) ON DELETE SET NULL
-- - milestone_id: UUID REFERENCES project_milestones(id) ON DELETE CASCADE
-- - name: TEXT NOT NULL
-- - description: TEXT
-- - is_required: BOOLEAN DEFAULT false
-- - is_completed: BOOLEAN DEFAULT false
-- - completed_at: TIMESTAMPTZ
-- - output_documents: JSONB DEFAULT '[]'::jsonb
-- - sort_order: INTEGER DEFAULT 0
-- - status: TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'in_progress', 'completed'))
-- - created_by: UUID REFERENCES profiles(id)
-- - created_at: TIMESTAMPTZ DEFAULT NOW() NOT NULL
-- - updated_at: TIMESTAMPTZ DEFAULT NOW() NOT NULL
```

#### 关键检查点

- [ ] `template_id` 外键引用 `milestone_task_templates(id)`，而不是 `milestone_templates(id)`
- [ ] `status` 列存在且有正确的 CHECK 约束
- [ ] `milestone_id` 列存在且外键正确
- [ ] `created_by` 列存在

### 2. 外键约束检查

```sql
-- 检查外键约束
SELECT
    tc.constraint_name,
    tc.table_name,
    kcu.column_name,
    ccu.table_name AS foreign_table_name,
    ccu.column_name AS foreign_column_name
FROM information_schema.table_constraints tc
JOIN information_schema.key_column_usage kcu ON tc.constraint_name = kcu.constraint_name
JOIN information_schema.constraint_column_usage ccu ON ccu.constraint_name = tc.constraint_name
WHERE tc.constraint_type = 'FOREIGN KEY'
AND tc.table_name = 'milestone_tasks';
```

**预期结果：**
- `milestone_tasks_template_id_fkey` -> `milestone_task_templates(id)`
- `milestone_tasks_milestone_id_fkey` -> `project_milestones(id)`
- `milestone_tasks_created_by_fkey` -> `profiles(id)`

### 3. 迁移脚本执行顺序

确保按正确顺序执行迁移脚本：

1. `003_create_milestones.sql` - 创建里程碑相关表（已修复）
2. `010_create_milestone_templates.sql` - 创建模板表和初始化数据
3. `018_fix_milestone_tasks_table.sql` - 修复 milestone_tasks 表结构（幂等）
4. `019_fix_milestone_tasks_foreign_key.sql` - 修复外键约束（针对旧环境）

## 后端代码检查

### 1. 路由顺序检查

**文件：** `api-new/src/routes/rest.ts`

确保特定路由在通用路由之前：

```typescript
// ✅ 正确顺序
router.get('/milestone-templates/active', ...);
router.get('/template-versions/list', ...);
router.get('/:table', ...);  // 通用路由在最后
```

### 2. dbService 使用检查

**文件：** `api-new/src/routes/projects.ts`

- [ ] 使用默认导入：`import dbService from '../services/dbService'`
- [ ] 使用 `queryOne` 而不是 `selectOne`
- [ ] 正确处理 `insert` 返回值（数组）

```typescript
// ✅ 正确用法
const projects = await dbService.insert('projects', projectData, '*');
const project = projects[0];

const project = await dbService.queryOne('projects', { eq: { id } });
```

### 3. 项目初始化服务检查

**文件：** `api-new/src/services/projectInitService.ts`

- [ ] `template_id` 正确引用 `taskTemplate.id`
- [ ] `status` 字段设置为 `'pending'`

```typescript
return {
  milestone_id: milestone.id,
  template_id: taskTemplate.id,  // ✅ 正确引用
  status: 'pending',  // ✅ 包含状态
  // ...
};
```

## 前端配置检查

### 1. Vite 代理配置

**文件：** `vite.config.ts`

```typescript
server: {
  proxy: {
    '/api': {
      target: 'http://localhost:3001',
      changeOrigin: true,
      secure: false,
    },
    '/rest': {  // ✅ 必须包含 /rest 代理
      target: 'http://localhost:3001',
      changeOrigin: true,
      secure: false,
    }
  }
}
```

## 部署验证测试

### 1. 数据库连接测试

```bash
# 检查数据库连接
curl http://localhost:3001/health
```

### 2. 模板版本 API 测试

```bash
# 应该返回 JSON，不是 HTML
curl http://localhost:3001/rest/v1/milestone-templates/active \
  -H "Authorization: Bearer <token>"
```

### 3. 项目创建流程测试

1. 打开项目创建页面
2. 填写项目信息
3. 选择客户
4. 点击创建
5. 验证：
   - [ ] 项目创建成功
   - [ ] 里程碑正确初始化（7个阶段）
   - [ ] 任务正确创建（每个里程碑的任务）
   - [ ] 没有控制台错误

## 常见问题排查

### 问题 1：模板版本 API 返回 HTML

**原因：** Vite 代理配置缺少 `/rest`
**解决：** 检查 `vite.config.ts` 中的代理配置

### 问题 2：外键约束错误

**原因：** `milestone_tasks.template_id` 引用错误的表
**解决：** 执行修复脚本 `018_fix_milestone_tasks_table.sql`

### 问题 3：status 列不存在

**原因：** 数据库表结构旧
**解决：** 执行 `ALTER TABLE` 添加 status 列

### 问题 4：dbService 函数不存在

**原因：** 使用了错误的函数名
**解决：** 使用 `queryOne` 代替 `selectOne`

## 部署脚本建议

### 新环境部署

```bash
# 1. 执行数据库迁移
# 按顺序执行所有迁移脚本

# 2. 验证表结构
psql $DATABASE_URL -c "\d milestone_tasks"

# 3. 启动后端服务
cd api-new && npm run start

# 4. 启动前端服务
cd .. && npm run client:dev

# 5. 执行验证测试
./scripts/verify-deployment.sh
```

### 旧环境升级

```bash
# 1. 备份数据库
pg_dump $DATABASE_URL > backup_$(date +%Y%m%d).sql

# 2. 执行修复脚本
psql $DATABASE_URL -f api-new/database/migrations/018_fix_milestone_tasks_table.sql
psql $DATABASE_URL -f api-new/database/migrations/019_fix_milestone_tasks_foreign_key.sql

# 3. 验证修复
psql $DATABASE_URL -c "SELECT * FROM information_schema.table_constraints WHERE table_name = 'milestone_tasks'"

# 4. 重启服务
```

## 总结

通过本次修复，以下文件已更新：

1. **数据库迁移脚本：**
   - `003_create_milestones.sql` - 修复了 `milestone_tasks` 表定义
   - `018_fix_milestone_tasks_table.sql` - 更新为幂等操作
   - `019_fix_milestone_tasks_foreign_key.sql` - 修复外键约束

2. **后端代码：**
   - `api-new/src/routes/rest.ts` - 修复路由顺序
   - `api-new/src/routes/projects.ts` - 修复 dbService 使用
   - `api-new/src/services/projectInitService.ts` - 修复任务初始化

3. **前端配置：**
   - `vite.config.ts` - 添加 `/rest` 代理

新环境部署时，按顺序执行迁移脚本即可避免所有已知问题。
