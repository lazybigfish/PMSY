# 里程碑任务状态更新修复记录

## 问题描述

在项目详情页的里程碑页面，调整里程碑任务的状态时报错：

```
更新任务状态失败: update "milestone_tasks" set "is_completed" = $1, "completed_at" = $2, "completed_by" = $3, "updated_by" = $4, "updated_at" = $5 where "id" = $6 returning * - column "completed_by" of relation "milestone_tasks" does not exist
```

## 问题分析

### 1. 代码分析

**前端代码** (`src/pages/projects/tabs/Milestones.tsx` 第 179-205 行)：
```typescript
const toggleTaskCompleted = async (task: MilestoneTask) => {
  const newStatus = !task.is_completed;
  const updates = {
    is_completed: newStatus,
    completed_at: newStatus ? new Date().toISOString() : null,
    completed_by: newStatus ? user?.id : null  // 尝试更新 completed_by 字段
  };
  // ...
};
```

**数据库表结构** (`api-new/database/migrations/003_create_milestones.sql` 第 44-59 行)：
```sql
CREATE TABLE IF NOT EXISTS milestone_tasks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    milestone_id UUID REFERENCES project_milestones(id) ON DELETE CASCADE,
    template_id UUID REFERENCES milestone_task_templates(id) ON DELETE SET NULL,
    name TEXT NOT NULL,
    description TEXT,
    is_required BOOLEAN DEFAULT false,
    is_completed BOOLEAN DEFAULT false,
    completed_at TIMESTAMPTZ,
    output_documents JSONB DEFAULT '[]'::jsonb,
    sort_order INTEGER DEFAULT 0,
    status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'in_progress', 'completed')),
    created_by UUID REFERENCES profiles(id),
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
    -- 缺少 completed_by 字段
);
```

### 2. 问题原因

- 数据库表 `milestone_tasks` 创建时只有 `created_by` 字段
- 前端代码在更新任务状态时尝试设置 `completed_by` 字段
- 数据库中不存在该字段，导致更新失败

## 修复方案

### 1. 创建数据库迁移脚本

**文件**: `api-new/database/migrations/020_add_milestone_tasks_completed_by.sql`

```sql
-- 为 milestone_tasks 表添加 completed_by 字段
-- 用于记录任务完成者

-- 添加 completed_by 字段（如果不存在）
ALTER TABLE milestone_tasks
ADD COLUMN IF NOT EXISTS completed_by UUID REFERENCES profiles(id);

-- 创建索引（如果不存在）
CREATE INDEX IF NOT EXISTS idx_milestone_tasks_completed_by ON milestone_tasks(completed_by);
```

### 2. 创建 SQL 迁移执行脚本

**文件**: `api-new/scripts/run-sql-migration.ts`

用于执行原生 SQL 迁移脚本，因为项目使用 Knex 作为迁移工具，但部分迁移是原生 SQL 格式。

```typescript
/**
 * 执行 SQL 迁移文件
 * 用于执行原生 SQL 迁移脚本
 */
import fs from 'fs';
import path from 'path';
import db from '../src/config/database';

async function runMigration() {
  const migrationFile = process.argv[2];
  
  if (!migrationFile) {
    console.error('Usage: npx ts-node scripts/run-sql-migration.ts <migration-file.sql>');
    process.exit(1);
  }

  const filePath = path.resolve(__dirname, '..', 'database', 'migrations', migrationFile);
  
  if (!fs.existsSync(filePath)) {
    console.error(`Migration file not found: ${filePath}`);
    process.exit(1);
  }

  const sql = fs.readFileSync(filePath, 'utf-8');
  
  console.log(`Running migration: ${migrationFile}`);
  
  try {
    await db.raw(sql);
    console.log('Migration completed successfully!');
  } catch (error) {
    console.error('Migration failed:', error);
    process.exit(1);
  } finally {
    await db.destroy();
  }
}

runMigration();
```

### 3. 执行迁移

```bash
cd api-new
npx ts-node scripts/run-sql-migration.ts 020_add_milestone_tasks_completed_by.sql
```

**执行结果**：
```
Running migration: 020_add_milestone_tasks_completed_by.sql
Migration completed successfully!
```

## 文件变更清单

| 文件路径 | 操作 | 说明 |
|---------|------|------|
| `api-new/database/migrations/020_add_milestone_tasks_completed_by.sql` | 新增 | 添加 completed_by 字段的迁移脚本 |
| `api-new/scripts/run-sql-migration.ts` | 新增 | SQL 迁移执行工具脚本 |

## 验证结果

- ✅ 迁移脚本执行成功
- ✅ `completed_by` 字段已添加到 `milestone_tasks` 表
- ✅ 已创建 `idx_milestone_tasks_completed_by` 索引
- ✅ 前端服务已重启，可正常更新任务状态

## 后续建议

1. **更新表结构文档**：确保数据库文档中包含 `completed_by` 字段
2. **检查其他缺失字段**：审查 `milestone_tasks` 表是否还有其他前端使用但数据库缺失的字段
3. **统一迁移规范**：后续数据库变更统一使用迁移脚本，确保前后端字段一致性

---

*记录时间: 2026-02-16*
*修复状态: ✅ 已完成*
