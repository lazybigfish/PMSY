# 项目创建功能问题总结与修复

## 问题概述

在项目创建功能重构过程中，发现并修复了多个问题，涉及数据库设计、代码逻辑和配置等方面。

## 问题清单及修复

### 1. 路由顺序问题

**问题：** Express 路由匹配顺序错误，特定路由 `/milestone-templates/active` 被通用路由 `/:table` 拦截

**错误表现：**
```
获取模板版本失败: SyntaxError: Unexpected token '<', "<!doctype "... is not valid JSON
```

**修复：** 将特定路由移到通用路由之前
- 文件：`api-new/src/routes/rest.ts`
- 将 `/milestone-templates/active` 和 `/template-versions/list` 路由移到 `router.get('/:table', ...)` 之前

### 2. Vite 代理配置缺失

**问题：** 前端开发服务器没有配置 `/rest` 路径的代理

**错误表现：** 请求 `/rest/v1/milestone-templates/active` 返回前端 HTML 而不是 JSON

**修复：** 添加 `/rest` 代理配置
- 文件：`vite.config.ts`
```typescript
'/rest': {
  target: 'http://localhost:3001',
  changeOrigin: true,
  secure: false,
}
```

### 3. dbService 导入方式错误

**问题：** 使用了命名导入 `{ dbService }` 而不是默认导入

**错误表现：**
```
TypeError: Cannot read properties of undefined (reading 'insert')
```

**修复：** 修改导入语句
- 文件：`api-new/src/routes/projects.ts`
```typescript
import dbService from '../services/dbService';  // 正确
// import { dbService } from '../services/dbService';  // 错误
```

### 4. dbService.insert 返回值处理错误

**问题：** `insert` 返回数组，但代码当作单个对象使用

**错误表现：**
```
null value in column "project_id" of relation "project_milestones" violates not-null constraint
```

**修复：** 正确处理数组返回值
```typescript
const projects = await dbService.insert('projects', projectData, '*');
const project = projects[0];  // 取数组第一个元素
const projectId = project.id;
```

### 5. milestone_tasks 表缺少 status 列

**问题：** 数据库表 `milestone_tasks` 缺少 `status` 列

**错误表现：**
```
column "status" of relation "milestone_tasks" does not exist
```

**修复：** 添加 status 列
- 执行 SQL：
```sql
ALTER TABLE milestone_tasks 
ADD COLUMN IF NOT EXISTS status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'in_progress', 'completed'));
```

### 6. milestone_tasks 外键约束错误（关键设计问题）

**问题：** `milestone_tasks.template_id` 错误地引用了 `milestone_templates(id)`，而不是正确的 `milestone_task_templates(id)`

**错误表现：**
```
insert or update on table "milestone_tasks" violates foreign key constraint "milestone_tasks_template_id_fkey"
```

**修复：**
1. 删除旧的外键约束
2. 添加正确的外键约束：
```sql
ALTER TABLE milestone_tasks
ADD CONSTRAINT milestone_tasks_template_id_fkey
FOREIGN KEY (template_id) REFERENCES milestone_task_templates(id) ON DELETE SET NULL;
```

### 7. dbService.selectOne 函数不存在

**问题：** 代码中使用了不存在的 `selectOne` 函数

**错误表现：**
```
TypeError: dbService_1.default.selectOne is not a function
```

**修复：** 使用正确的函数名 `queryOne`
```typescript
// 错误
const project = await dbService.selectOne('projects', '*', { id });

// 正确
const project = await dbService.queryOne('projects', { eq: { id } });
```

## 根本原因分析

### 数据库设计缺陷

1. **003_create_milestones.sql** 中 `milestone_tasks` 表的外键定义错误：
```sql
-- 错误的定义
template_id UUID REFERENCES milestone_templates(id) ON DELETE CASCADE NOT NULL

-- 应该是
template_id UUID REFERENCES milestone_task_templates(id) ON DELETE SET NULL
```

2. **milestone_tasks 表缺少 status 列**

### 代码问题

1. 对 `dbService` API 的不熟悉导致使用错误的函数名
2. 对 `insert` 返回值类型理解错误

## 需要修复的初始化 SQL 文件

### 1. 003_create_milestones.sql

需要修改的内容：
- `milestone_tasks.template_id` 外键引用错误的表
- 缺少 `status` 列
- 缺少 `milestone_id` 列（在 018_fix_milestone_tasks_table.sql 中添加）

### 2. 018_fix_milestone_tasks_table.sql

需要添加的内容：
- 添加 `status` 列
- 修复外键约束

## 部署前检查清单

- [ ] 数据库迁移脚本已按正确顺序执行
- [ ] `milestone_tasks` 表结构正确：
  - [ ] `status` 列存在
  - [ ] `template_id` 外键引用 `milestone_task_templates(id)`
  - [ ] `milestone_id` 外键引用 `project_milestones(id)`
- [ ] 后端服务正常启动无错误
- [ ] 前端代理配置正确
- [ ] 项目创建功能测试通过
