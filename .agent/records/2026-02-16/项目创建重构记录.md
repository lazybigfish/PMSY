# 项目创建功能重构记录

## 重构背景

原项目创建功能存在以下问题：
1. 前端硬编码了 `MILESTONE_TEMPLATES`，同时又尝试从 API 获取模板，逻辑混乱
2. 里程碑和任务的初始化逻辑在前端处理，容易出错且难以维护
3. `output_documents` 字段格式在传输过程中容易出错
4. 缺乏事务保证，可能出现项目创建成功但里程碑初始化失败的情况

## 重构方案

### 核心改进

1. **后端统一处理**：创建项目时，后端自动根据激活的里程碑模板初始化里程碑和任务
2. **前端简化**：前端只负责收集项目基本信息，调用创建项目 API
3. **事务保证**：使用数据库事务确保项目、里程碑、任务的原子性创建
4. **清晰的职责分离**：前端负责 UI 和表单，后端负责业务逻辑和数据一致性

## 实现详情

### 1. 后端新增文件

#### `api-new/src/services/projectInitService.ts`
项目初始化服务，负责：
- 获取当前激活的里程碑模板版本
- 根据模板创建项目里程碑
- 为每个里程碑创建任务
- 使用数据库事务保证原子性
- 处理 `output_documents` 字段格式

核心函数：
```typescript
initializeProjectMilestones(projectId: string, createdBy: string)
```

#### `api-new/src/routes/projects.ts`
项目管理路由，提供 RESTful API：
- `POST /api/projects` - 创建项目（自动初始化里程碑）
- `GET /api/projects` - 获取项目列表
- `GET /api/projects/:id` - 获取项目详情
- `PUT /api/projects/:id` - 更新项目
- `DELETE /api/projects/:id` - 删除项目

### 2. 前端修改文件

#### `src/pages/projects/ProjectCreate.tsx`
简化后的项目创建页面：
- 移除了硬编码的 `MILESTONE_TEMPLATES`
- 移除了复杂的里程碑初始化逻辑
- 只负责收集表单数据
- 调用新的 `/api/projects` API 创建项目
- 显示当前激活的模板版本信息（仅展示）

### 3. 注册新路由

在 `api-new/src/index.ts` 中注册新的项目路由：
```typescript
import projectsRouter from './routes/projects';
app.use('/api/projects', projectsRouter);
```

## 数据流

### 新的项目创建流程

1. **前端**
   - 用户填写项目表单（名称、客户、金额等）
   - 前端展示当前激活的里程碑模板版本信息
   - 提交表单到 `/api/projects`

2. **后端**
   - 接收项目创建请求
   - 验证必填字段
   - 创建项目记录
   - 创建项目-客户关联（如有）
   - 添加创建者为项目经理
   - **调用 `initializeProjectMilestones` 初始化里程碑和任务**
   - 返回完整的项目信息

3. **初始化服务**
   - 开启数据库事务
   - 获取当前激活的模板版本
   - 获取该版本的所有里程碑模板
   - 批量创建项目里程碑
   - 为每个里程碑获取任务模板并批量创建任务
   - 设置项目的当前里程碑为第一个阶段
   - 提交事务

## 关键改进点

### 1. 事务保证
```typescript
const trx = await db.transaction();
try {
  // 创建里程碑
  // 创建任务
  // 更新项目
  await trx.commit();
} catch (error) {
  await trx.rollback();
}
```

### 2. output_documents 格式处理
```typescript
let outputDocs = taskTemplate.output_documents;
if (typeof outputDocs === 'string') {
  try {
    outputDocs = JSON.parse(outputDocs);
  } catch (e) {
    outputDocs = [];
  }
}
// 存储时确保是 JSON 字符串
output_documents: JSON.stringify(outputDocs)
```

### 3. 错误处理
- 项目创建失败：返回 500 错误
- 里程碑初始化失败：项目已创建，返回警告信息
- 客户关联/成员添加失败：记录日志，不阻断主流程

## API 变更

### 新的项目创建 API

**请求**
```http
POST /api/projects
Content-Type: application/json
Authorization: Bearer <token>

{
  "name": "项目名称",
  "customer_name": "客户名称",
  "amount": 100000,
  "description": "项目描述",
  "is_public": false,
  "client_id": "客户ID（可选）"
}
```

**响应**
```http
201 Created

{
  "id": "项目ID",
  "name": "项目名称",
  "customer_name": "客户名称",
  "amount": "100000.00",
  "description": "项目描述",
  "status": "pending",
  "manager_id": "经理ID",
  "current_milestone_id": "当前里程碑ID",
  "created_at": "2026-02-16T12:00:00.000Z",
  "created_by": "创建者ID"
}
```

**警告响应**（里程碑初始化失败但项目已创建）
```http
201 Created

{
  "id": "项目ID",
  "name": "项目名称",
  ...,
  "warning": "项目创建成功，但里程碑初始化失败: 没有激活的里程碑模板版本"
}
```

## 文件变更清单

### 新增文件
- `api-new/src/services/projectInitService.ts` - 项目初始化服务
- `api-new/src/routes/projects.ts` - 项目管理路由

### 修改文件
- `src/pages/projects/ProjectCreate.tsx` - 重写项目创建页面
- `api-new/src/index.ts` - 注册新路由

### 删除/废弃
- 原前端 `MILESTONE_TEMPLATES` 硬编码数据（已从前端移除，但保留在数据库中）
- 原前端复杂的里程碑初始化逻辑

## 测试建议

1. **正常流程测试**
   - 创建项目，验证里程碑和任务是否正确初始化
   - 检查第一个里程碑是否设置为当前里程碑
   - 验证任务数量和内容是否与模板一致

2. **异常流程测试**
   - 无激活模板版本时的处理
   - 数据库连接中断时的回滚
   - 部分任务创建失败的处理

3. **边界条件测试**
   - 空项目名称/客户名称的验证
   - 超大金额的显示
   - 特殊字符的处理

## 后续优化建议

1. **异步处理**：考虑使用消息队列异步处理里程碑初始化，提高响应速度
2. **模板预览**：在前端添加模板预览功能，让用户在创建前了解里程碑结构
3. **自定义模板**：支持为特定项目类型选择不同的模板版本
4. **初始化重试**：如果初始化失败，提供手动重试的接口
