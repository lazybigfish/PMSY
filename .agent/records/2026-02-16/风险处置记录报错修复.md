# 风险处置记录报错修复

## 问题描述

在项目风险页，对某条风险打开详情添加处置记录时，控制台报错：

```
Risks.tsx:169  Uncaught (in promise) TypeError: (selectedRisk.handling_records || []) is not iterable
    at handleAddRecord
```

## 问题原因

`handling_records` 字段从数据库返回时可能是 JSON 字符串格式，而不是数组。当尝试使用展开运算符 `[...(selectedRisk.handling_records || [])]` 时，字符串是不可迭代的，导致报错。

## 修复内容

### 修改文件

`src/pages/projects/tabs/Risks.tsx`

### 修改前

```typescript
// 获取风险负责人信息
const risksData = data || [];
if (risksData.length > 0) {
  // ...
}
```

### 修改后

```typescript
// 获取风险负责人信息
let risksData = data || [];

// 处理 handling_records 字段，确保它是数组
risksData = risksData.map(r => ({
  ...r,
  handling_records: Array.isArray(r.handling_records) 
    ? r.handling_records 
    : (typeof r.handling_records === 'string' && r.handling_records 
        ? JSON.parse(r.handling_records) 
        : [])
}));

if (risksData.length > 0) {
  // ...
}
```

## 修复逻辑

在 `fetchRisks` 函数中，对从数据库获取的风险数据进行处理：
1. 检查 `handling_records` 是否已经是数组
2. 如果是字符串，则使用 `JSON.parse` 解析为数组
3. 如果是其他情况（null、undefined等），则设为空数组

## 后续问题修复

### 问题 2：JSON 格式提交错误

修复后出现新的报错：
```
update "risks" set "handling_records" = $1... - invalid input syntax for type json
```

**原因**：后端数据库期望 `handling_records` 是 JSON 字符串格式，但前端直接提交了数组对象。

**修复**：在 `handleAddRecord` 函数中，提交前将数组转换为 JSON 字符串：

```typescript
const updates: any = {
  handling_records: JSON.stringify(updatedRecords)  // 添加 JSON.stringify
};
```

### 问题 3：本地状态更新错误

修复后出现新的问题：添加一条处置记录后，界面上显示了 105 条重复内容。

**原因**：更新本地状态时，直接把包含 JSON 字符串的 `updates` 对象展开到状态中，导致前端状态变成了字符串而不是数组。

**修复**：分开处理 API 提交数据和本地状态更新：

```typescript
// 提交给 API 的数据（JSON 字符串）
const updates: any = {
  handling_records: JSON.stringify(updatedRecords)
};

// 更新本地状态的数据（数组格式）
const localUpdates = {
  handling_records: updatedRecords,  // 保持数组格式
  ...(newRecord.newStatus && { status: newRecord.newStatus })
};

setRisks(risks.map(r => r.id === selectedRisk.id ? { ...r, ...localUpdates } : r));
setSelectedRisk({ ...selectedRisk, ...localUpdates });
```

## 完整修复总结

1. **读取时**（`fetchRisks`）：将数据库返回的 JSON 字符串解析为数组（`JSON.parse`）
2. **写入时**（`handleAddRecord`）：
   - 提交给 API：将数组转换为 JSON 字符串（`JSON.stringify`）
   - 更新本地状态：保持数组格式

## 测试验证

1. 进入项目详情页的风险页面
2. 点击某条风险的"详情"按钮
3. 在处置记录区域添加新的处置记录
4. 处置记录应成功保存，且只显示刚添加的一条记录

## 修复时间

2026-02-16
