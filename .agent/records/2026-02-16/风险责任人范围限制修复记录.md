# 风险责任人范围限制修复记录

## 问题描述

项目详情页的风险页面中，添加风险时可选的责任人范围是系统中所有用户，应该限制为仅该项目的团队成员范围。

## 影响范围

- 文件: `src/pages/projects/tabs/Risks.tsx`
- 功能: 风险添加表单中的责任人选择下拉框

## 修复内容

### 修改前

```typescript
const fetchUsers = async () => {
  const { data } = await api.db.from('profiles').select('*');
  setUsers(data || []);
};
```

**问题**: 获取了系统中所有用户，没有限制范围。

### 修改后

```typescript
const fetchProjectMembers = async () => {
  try {
    // 获取项目成员
    const { data: membersData, error: membersError } = await api.db
      .from('project_members')
      .select('user_id')
      .eq('project_id', projectId);

    if (membersError) throw membersError;

    // 获取项目经理
    const { data: projectData } = await api.db
      .from('projects')
      .select('manager_id')
      .eq('id', projectId)
      .single();

    // 收集所有用户ID（成员 + 项目经理）
    const userIds = new Set<string>();
    membersData?.forEach(m => userIds.add(m.user_id));
    if (projectData?.manager_id) {
      userIds.add(projectData.manager_id);
    }

    if (userIds.size > 0) {
      const { data: profilesData } = await api.db
        .from('profiles')
        .select('*')
        .in('id', Array.from(userIds));
      setUsers(profilesData || []);
    } else {
      setUsers([]);
    }
  } catch (error) {
    console.error('Error fetching project members:', error);
    setUsers([]);
  }
};
```

**改进**:
1. 查询 `project_members` 表获取项目成员
2. 查询 `projects` 表获取项目经理
3. 合并成员和项目经理的用户ID
4. 仅查询这些用户的详细信息

## 测试验证

1. 进入项目详情页的风险页面
2. 点击"新增风险"按钮
3. 在责任人下拉框中，应只显示该项目的团队成员和项目经理
4. 不应显示系统中其他非项目成员的用户

## 相关文件

- `src/pages/projects/tabs/Risks.tsx` - 风险页面组件
- `src/pages/projects/tabs/ProjectOverview.tsx` - 参考了获取项目成员的实现方式

## 修复时间

2026-02-16
