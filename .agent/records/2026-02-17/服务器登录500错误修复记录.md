# 服务器登录500错误修复记录

## 问题描述

**现象**: 服务器环境登录时返回500错误，提示"邮箱或密码错误"

**错误信息**:
```
POST http://43.136.69.250/api/auth/v1/token?grant_type=password 500 (Internal Server Error)
登录失败: Error: 邮箱或密码错误
```

## 问题分析

### 根本原因

数据库中的管理员用户密码是**占位符** `$2b$10$placeholder`，而非真实的密码哈希值。

### 问题溯源

1. **迁移脚本** ([001_create_profiles.sql](file:///Users/liiiiins/Downloads/文稿 - liiiiins 的 MacBook Pro/Mweb/PMSY/api-new/database/migrations/001_create_profiles.sql#L47)) 中插入了占位符密码：
   ```sql
   '$2b$10$placeholder',  -- 占位符，真实密码通过 seed 脚本生成
   ```

2. **种子脚本** ([001_seed_admin_user.ts](file:///Users/liiiiins/Downloads/文稿 - liiiiins 的 MacBook Pro/Mweb/PMSY/api-new/database/seeds/001_seed_admin_user.ts)) 负责生成真实密码哈希，但服务器部署时**未执行种子脚本**。

3. **部署流程问题**: 
   - 部署脚本执行了数据库迁移 (`npm run migrate`)
   - 但**未执行种子脚本** (`npm run db:seed`)
   - 导致管理员用户只有占位符密码，无法登录

### 代码层面的问题

1. **登录只支持邮箱**: 后端登录接口只通过 `email` 字段查询用户，不支持用户名登录
2. **密码验证未做空值检查**: `bcrypt.compare()` 在密码哈希为空时会抛出异常

## 修复方案

### 1. 后端代码修复

#### 1.1 支持用户名或邮箱登录 ([authService.ts](file:///Users/liiiiins/Downloads/文稿 - liiiiins 的 MacBook Pro/Mweb/PMSY/api-new/src/services/authService.ts))

```typescript
// 查找用户 - 支持邮箱或用户名登录
let user = await findUserByEmail(email);

// 如果邮箱找不到，尝试用用户名查找
if (!user) {
  user = await findUserByUsername(email);
}
```

#### 1.2 修复密码验证空值问题 ([password.ts](file:///Users/liiiiins/Downloads/文稿 - liiiiins 的 MacBook Pro/Mweb/PMSY/api-new/src/utils/password.ts))

```typescript
export async function verifyPassword(password: string, hashedPassword: string): Promise<boolean> {
  if (!hashedPassword) {
    return false;
  }
  const isMatch = await bcrypt.compare(password, hashedPassword);
  return isMatch;
}
```

### 2. 数据库密码修复

手动更新服务器数据库中的管理员密码：

```sql
UPDATE profiles 
SET password_hash = '$2a$10$za3UpLuxe/vK739nAMuRmOhcQyN5YNO5MY5KOk.nk1iNDH3G1W.Ai' 
WHERE username = 'admin';
```

## 优化方案（已实施）

### 解决方案: 迁移脚本直接初始化管理员

**核心思路**: 将管理员用户的初始化从种子脚本迁移到迁移脚本中，确保部署时自动完成。

#### 1. 修改迁移脚本 ([001_create_profiles.sql](file:///Users/liiiiins/Downloads/文稿 - liiiiins 的 MacBook Pro/Mweb/PMSY/api-new/database/migrations/001_create_profiles.sql))

```sql
-- ==========================================
-- 初始化系统管理员用户
-- ==========================================
-- 默认用户名: admin
-- 默认密码: Willyou@2026
-- 登录时可以使用用户名或邮箱

INSERT INTO profiles (id, email, username, password_hash, full_name, role, is_active, email_confirmed_at, created_at, updated_at)
VALUES (
    '00000000-0000-0000-0000-000000000001',
    'admin@pmsy.com',
    'admin',
    '$2a$10$za3UpLuxe/vK739nAMuRmOhcQyN5YNO5MY5KOk.nk1iNDH3G1W.Ai',  -- Willyou@2026 的 bcrypt 哈希
    '系统管理员',
    'admin',
    true,
    NOW(),
    NOW(),
    NOW()
)
ON CONFLICT (id) DO UPDATE SET
    password_hash = EXCLUDED.password_hash,
    email = EXCLUDED.email,
    username = EXCLUDED.username,
    full_name = EXCLUDED.full_name,
    role = EXCLUDED.role,
    is_active = EXCLUDED.is_active,
    email_confirmed_at = EXCLUDED.email_confirmed_at,
    updated_at = NOW();
```

**关键改进**:
- 使用 `ON CONFLICT (id) DO UPDATE` 实现幂等性
- 直接设置真实密码哈希，不再使用占位符
- 每次迁移都会更新密码，确保一致性

#### 2. 简化种子脚本 ([001_seed_admin_user.ts](file:///Users/liiiiins/Downloads/文稿 - liiiiins 的 MacBook Pro/Mweb/PMSY/api-new/database/seeds/001_seed_admin_user.ts))

```typescript
/**
 * 管理员用户初始化脚本
 * 
 * 【注意】管理员用户现在已在迁移脚本中直接初始化
 * 此脚本保留用于幂等性检查和密码重置（如需要）
 */

export async function seed(knex: Knex): Promise<void> {
  // 检查管理员是否已存在
  const existingAdmin = await knex('profiles')
    .where('id', '00000000-0000-0000-0000-000000000001')
    .first();

  if (existingAdmin) {
    console.log('✅ 管理员用户已存在，跳过初始化');
    return;
  }

  console.log('⚠️  警告: 管理员用户不存在，请检查迁移脚本是否已执行');
}
```

#### 3. 优势

| 方面 | 优化前 | 优化后 |
|-----|-------|-------|
| 初始化位置 | 迁移脚本(占位符) + 种子脚本(真实密码) | 迁移脚本直接完成 |
| 部署步骤 | 迁移 + 种子 | 仅需迁移 |
| 幂等性 | 依赖种子脚本判断 | `ON CONFLICT DO UPDATE` |
| 失败风险 | 种子脚本未执行导致登录失败 | 迁移必执行，无遗漏风险 |
| 维护复杂度 | 高（两个地方维护） | 低（一个地方维护） |

## 验证结果

修复后登录测试成功：

```bash
curl -X POST "http://43.136.69.250/api/auth/v1/token?grant_type=password" \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@pmsy.com","password":"Willyou@2026"}'

# 返回成功，获取到 access_token
```

## 登录信息

- **访问地址**: http://43.136.69.250/login
- **用户名**: `admin`
- **密码**: `Willyou@2026`

## 预防措施

1. **部署检查清单** 中添加密码验证步骤
2. **CI/CD 流程** 中集成登录功能测试
3. **健康检查接口** 增加数据库用户状态检查

## 相关文件

- 迁移脚本: [api-new/database/migrations/001_create_profiles.sql](file:///Users/liiiiins/Downloads/文稿 - liiiiins 的 MacBook Pro/Mweb/PMSY/api-new/database/migrations/001_create_profiles.sql)
- 种子脚本: [api-new/database/seeds/001_seed_admin_user.ts](file:///Users/liiiiins/Downloads/文稿 - liiiiins 的 MacBook Pro/Mweb/PMSY/api-new/database/seeds/001_seed_admin_user.ts)
- 认证服务: [api-new/src/services/authService.ts](file:///Users/liiiiins/Downloads/文稿 - liiiiins 的 MacBook Pro/Mweb/PMSY/api-new/src/services/authService.ts)
- 密码工具: [api-new/src/utils/password.ts](file:///Users/liiiiins/Downloads/文稿 - liiiiins 的 MacBook Pro/Mweb/PMSY/api-new/src/utils/password.ts)
- 部署脚本: [api-new/scripts/deploy.sh](file:///Users/liiiiins/Downloads/文稿 - liiiiins 的 MacBook Pro/Mweb/PMSY/api-new/scripts/deploy.sh)

## 修复时间

2026-02-17
