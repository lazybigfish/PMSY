# 服务器登录接口 404 错误修复记录

## 问题描述

**现象**：服务器环境登录页可以正常打开，但登录时显示报错：
```
Failed to load resource: the server responded with a status of 404 (Not Found)
登录失败: Error: 路由 POST /api/auth/v1/token 不存在
```

## 问题分析

### 1. 前端请求路径
- 前端生产环境配置：`VITE_API_URL=http://43.136.69.250/api`
- 登录请求路径：`/api/auth/v1/token`

### 2. Nginx 代理配置
```nginx
location /api/ {
    proxy_pass http://api:3001/api/;
    ...
}
```
Nginx 将 `/api/auth/v1/token` 代理到后端服务的 `/api/auth/v1/token`

### 3. 后端路由配置（修复前）
```typescript
// 路由
app.use('/health', healthRouter);
app.use('/auth/v1', authRouter);      // 只有 /auth/v1，没有 /api/auth/v1
app.use('/rest/v1', restRouter);
app.use('/storage/v1', storageRouter);
app.use('/api/projects', projectsRouter);
app.use('/api/project-suppliers', projectSuppliersRouter);
```

### 4. 问题根源
后端 Express 应用没有配置 `/api` 前缀的路由，导致：
- 前端请求 `/api/auth/v1/token`
- Nginx 代理到后端 `/api/auth/v1/token`
- 后端只有 `/auth/v1/token`，没有 `/api/auth/v1/token`
- 返回 404 错误

## 修复方案

在 [api-new/src/index.ts](../../api-new/src/index.ts) 中添加带 `/api` 前缀的路由，保持向后兼容：

```typescript
// 路由（兼容直接访问）
app.use('/health', healthRouter);
app.use('/auth/v1', authRouter);
app.use('/rest/v1', restRouter);
app.use('/storage/v1', storageRouter);
app.use('/api/projects', projectsRouter);
app.use('/api/project-suppliers', projectSuppliersRouter);

// 路由（带 /api 前缀，兼容 Nginx 代理配置）
app.use('/api/health', healthRouter);
app.use('/api/auth/v1', authRouter);
app.use('/api/rest/v1', restRouter);
app.use('/api/storage/v1', storageRouter);
```

## 验证结果

### 1. 测试带 /api 前缀的路径
```bash
curl -X POST "http://localhost:3001/api/auth/v1/token?grant_type=password" \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"test123"}'
```
结果：HTTP 500（用户不存在，这是预期的业务错误，不再是 404）

### 2. 测试不带 /api 前缀的路径（向后兼容）
```bash
curl -X POST "http://localhost:3001/auth/v1/token?grant_type=password" \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com","password":"test123"}'
```
结果：HTTP 500（同样正常工作）

## 影响范围

| 路径 | 状态 |
|------|------|
| `/api/auth/v1/*` | ✅ 新增支持 |
| `/api/rest/v1/*` | ✅ 新增支持 |
| `/api/storage/v1/*` | ✅ 新增支持 |
| `/api/health` | ✅ 新增支持 |
| `/auth/v1/*` | ✅ 保持兼容 |
| `/rest/v1/*` | ✅ 保持兼容 |
| `/storage/v1/*` | ✅ 保持兼容 |
| `/health` | ✅ 保持兼容 |

## 后续建议

1. **部署到服务器**：需要将修改后的代码部署到服务器环境
2. **重启后端服务**：确保新的路由配置生效
3. **测试验证**：在生产环境验证登录功能是否正常

## 相关文件

- [api-new/src/index.ts](../../api-new/src/index.ts) - 后端路由配置
- [nginx.conf](../../nginx.conf) - Nginx 代理配置
- [config/env/.env.production](../../config/env/.env.production) - 生产环境配置
- [src/lib/api.ts](../../src/lib/api.ts) - 前端 API 客户端

## 修复时间

2026-02-17
