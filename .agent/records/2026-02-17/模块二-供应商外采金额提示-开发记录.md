# 模块二：供应商外采金额提示 - 开发记录

## 开发日期
2026-02-17

## 功能概述
在项目管理的供应商页面，关联供应商时显示剩余可外采金额，并在剩余金额低于10%时进行醒目提醒。

## 实现内容

### 1. 后端实现

#### 1.1 项目外采统计服务 (`api-new/src/services/projectFinanceService.ts`)
- 实现 `getProcurementStats()` 方法，计算：
  - 项目总金额
  - 已外采金额合计
  - 剩余可外采金额
  - 剩余金额百分比
- 实现 `checkContractAmount()` 方法，校验合同金额是否超出剩余金额
- 实现 `isLowRemainingBudget()` 方法，检查是否低余额（<10%）

#### 1.2 外采统计 API (`api-new/src/routes/projects.ts`)
- 添加 `GET /api/projects/:id/procurement-stats` 端点
- 包含权限校验（项目成员可访问）

#### 1.3 项目供应商关联路由 (`api-new/src/routes/projectSuppliers.ts`)
- 创建新的路由文件，包含金额校验逻辑
- `POST /api/project-suppliers` - 创建关联（带金额校验）
- `PUT /api/project-suppliers/:id` - 更新关联（带金额校验）
- `DELETE /api/project-suppliers/:id` - 删除关联
- 在 `api-new/src/index.ts` 中注册路由

### 2. 前端实现

#### 2.1 项目财务服务 (`src/services/projectFinanceService.ts`)
- 定义类型接口：`ProjectProcurementStats`, `SupplierContractSummary`, `ProjectSupplierAssociation`
- 实现 API 调用函数：
  - `getProjectProcurementStats()`
  - `createProjectSupplier()`
  - `updateProjectSupplier()`
  - `deleteProjectSupplier()`

#### 2.2 useProjectFinance Hook (`src/hooks/useProjectFinance.ts`)
- 封装外采统计数据的获取和缓存
- 提供操作方法：`createAssociation`, `updateAssociation`, `deleteAssociation`
- 提供辅助状态：`isLowBudget`

#### 2.3 外采统计卡片组件 (`src/components/ProcurementStatsCard.tsx`)
- 显示三个统计卡片：项目金额、已外采金额、剩余可外采金额
- 低余额时（<10%）显示红色预警提示
- 显示外采进度条
- 支持加载状态

#### 2.4 修改供应商页面 (`src/pages/projects/tabs/Suppliers.tsx`)
- 集成 `ProcurementStatsCard` 组件到页面顶部
- 使用 `useProjectFinance` Hook 获取统计数据
- 关联供应商弹窗中：
  - 显示剩余可外采金额提示
  - 实时校验合同金额输入
  - 超出时显示红色错误提示
  - 提交按钮在有错误时禁用
- 关联成功后刷新统计数据

## 界面效果

### 供应商页面
- 页面顶部显示外采统计卡片
- 三个统计项：项目金额、已外采金额、剩余可外采金额
- 进度条显示外采比例

### 低余额预警
当剩余金额低于10%时：
- 剩余金额卡片变为红色
- 显示醒目的红色预警提示框
- 进度条变为红色

### 关联供应商弹窗
- 合同金额标签旁显示剩余可外采金额
- 输入金额超出时：
  - 输入框边框变红
  - 下方显示红色错误提示
  - 确认按钮禁用

## 测试要点

1. **统计计算准确性**
   - 验证项目金额正确显示
   - 验证已外采金额计算正确
   - 验证剩余金额 = 项目金额 - 已外采金额

2. **低余额预警**
   - 当剩余金额 < 10% 时显示预警
   - 预警提示醒目（红色背景 + 图标）

3. **金额校验**
   - 合同金额 > 剩余金额时阻止提交
   - 实时显示错误提示
   - 错误时禁用提交按钮

4. **数据刷新**
   - 关联供应商后统计数据自动刷新
   - 移除供应商后统计数据自动刷新

## 文件变更列表

### 后端
- `api-new/src/services/projectFinanceService.ts` (新增)
- `api-new/src/routes/projectSuppliers.ts` (新增)
- `api-new/src/routes/projects.ts` (修改)
- `api-new/src/index.ts` (修改)

### 前端
- `src/services/projectFinanceService.ts` (新增)
- `src/hooks/useProjectFinance.ts` (新增)
- `src/components/ProcurementStatsCard.tsx` (新增)
- `src/pages/projects/tabs/Suppliers.tsx` (修改)

## 注意事项

1. 项目金额字段为 `projects.amount`，需要确保该字段有值
2. 供应商合同金额字段为 `project_suppliers.contract_amount`
3. 金额计算使用 `parseFloat` 转换，确保精度
4. 低余额阈值为 10%，可根据业务需求调整

## Bug 修复记录

### 2026-02-17 - 修复统计数据不自动加载问题
**问题**: 供应商页面显示剩余可外采金额为 0
**原因**: `useProjectFinance` Hook 没有自动调用 `fetchStats` 获取数据
**修复**: 在 Hook 中添加 `useEffect`，组件挂载时自动获取统计数据

```typescript
// 组件挂载时自动获取数据
useEffect(() => {
  fetchStats();
}, [fetchStats]);
```

### 2026-02-17 - 修复统计卡片不同步更新问题
**问题**: 供应商详情页修改合同金额后，统计卡片没有及时同步更新
**原因**: `onUpdate` 回调和 `handleRemoveSupplier` 中没有调用 `refreshStats()`
**修复**: 在以下位置添加 `refreshStats()` 调用：
1. `SupplierDetailModal` 的 `onUpdate` 回调中
2. `handleRemoveSupplier` 函数中

```typescript
// 供应商详情更新后刷新统计
onUpdate={() => {
    fetchData();
    refreshStats(); // 刷新外采统计
}}

// 移除供应商后刷新统计
const handleRemoveSupplier = async (id: string) => {
    // ... 删除逻辑
    refreshStats(); // 刷新外采统计
}
```

### 2026-02-17 - 增加关联供应商前置校验
**需求**: 关联供应商前增加两层校验
1. 项目必须有功能模块，否则不能关联供应商
2. 所有模块都已关联供应商时，不能继续关联

**实现**: 在 `openAddModal` 函数中添加 `canAssociateSupplier()` 校验逻辑

```typescript
const canAssociateSupplier = (): { canAdd: boolean; message?: string } => {
  // 1. 检查项目是否有功能模块
  if (projectModules.length === 0) {
    return {
      canAdd: false,
      message: '该项目暂无功能模块，请先创建功能模块后再关联供应商。'
    };
  }

  // 2. 检查是否所有模块都已关联供应商
  const allAssociatedModuleIds = new Set<string>();
  projectSuppliers.forEach(ps => {
    (ps.module_ids || []).forEach((moduleId: string) => {
      allAssociatedModuleIds.add(moduleId);
    });
  });

  const allModuleIds = projectModules.map(m => m.id);
  const allModulesAssociated = allModuleIds.every(id => allAssociatedModuleIds.has(id));

  if (allModulesAssociated) {
    return {
      canAdd: false,
      message: '所有功能模块已关联供应商，无法继续添加。如需调整，请先移除现有供应商或修改模块分配。'
    };
  }

  return { canAdd: true };
};
```

### 2026-02-17 - 过滤已关联供应商
**需求**: 关联供应商弹窗中不显示已关联的供应商，避免重复关联

**实现**: 修改 `fetchAvailableSuppliers` 函数，在前端过滤已关联的供应商

```typescript
const fetchAvailableSuppliers = async () => {
  // 获取已关联的供应商ID列表
  const existingIds = projectSuppliers.map(ps => ps.supplier_id).filter(Boolean);

  // 获取所有活跃的供应商
  const { data: allSuppliers, error } = await api.db
    .from('suppliers')
    .select('*')
    .eq('status', 'active')
    .order('name');

  // 过滤掉已关联的供应商
  const availableSuppliers = (allSuppliers || []).filter(
    (supplier: Supplier) => !existingIds.includes(supplier.id)
  );

  setAvailableSuppliers(availableSuppliers);

  // 如果没有可用供应商，给出提示
  if (availableSuppliers.length === 0 && (allSuppliers || []).length > 0) {
    alert('所有可用供应商已关联到该项目，如需调整请前往已关联供应商详情页修改。');
  }
};
```

## 后续优化建议

1. 在供应商详情弹窗中也显示外采统计，方便查看
2. 添加合同金额修改时的金额校验
3. 考虑添加邮件/消息通知，当剩余金额低于阈值时通知项目经理
