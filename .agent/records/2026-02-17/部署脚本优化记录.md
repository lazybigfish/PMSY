# 部署脚本优化记录

## 优化目标
分离数据库初始化与前后端构建，数据库迁移文件不再打包进 Docker 镜像。

## 修改内容

### 1. Dockerfile（api-new/Dockerfile）

**修改前：**
```dockerfile
# 复制数据库迁移文件（重要！）
COPY database ./database
COPY knexfile.ts ./
```

**修改后：**
```dockerfile
# 注意：数据库迁移文件不再打包进镜像
# 迁移文件通过开发机上传到服务器，在宿主机上执行
```

**说明：** 移除了数据库迁移文件的 COPY 指令，镜像更轻量。

---

### 2. 开发机部署脚本（deploy/fresh-install/deploy.sh）

#### 2.1 上传文件清单调整

**修改前：**
```bash
cp -r dist "$DEPLOY_TMP/pmsy/"
cp -r api-new "$DEPLOY_TMP/pmsy/"  # 复制整个 api-new 目录
```

**修改后：**
```bash
# 前端构建产物
cp -r dist "$DEPLOY_TMP/pmsy/"

# 后端构建产物（只复制 dist，不复制整个 api-new）
mkdir -p "$DEPLOY_TMP/pmsy/api-new"
cp -r api-new/dist "$DEPLOY_TMP/pmsy/api-new/"
cp api-new/package*.json "$DEPLOY_TMP/pmsy/api-new/"
cp api-new/Dockerfile "$DEPLOY_TMP/pmsy/api-new/"

# 【新增】数据库迁移文件（不再打包进镜像，独立上传）
mkdir -p "$DEPLOY_TMP/pmsy/api-new/database/migrations"
cp -r api-new/database/migrations/*.sql "$DEPLOY_TMP/pmsy/api-new/database/migrations/"
cp api-new/knexfile.ts "$DEPLOY_TMP/pmsy/api-new/"
```

**说明：** 
- 不再上传整个 `api-new` 目录（包含 src/ node_modules/ 等）
- 只上传构建产物 `dist/` 和必要的配置文件
- **新增上传数据库迁移文件**，用于服务器上执行初始化

---

#### 2.2 服务器部署流程调整

**修改前：**
```bash
# 1. 拉取镜像并启动所有服务
sudo docker-compose pull
sudo docker-compose up -d

# 2. 等待服务启动
sleep 10

# 3. 在容器内执行迁移
sudo docker-compose exec -T api sh -c "cd /app && npm run db:migrate"
sudo docker-compose exec -T api sh -c "cd /app && npm run db:seed"
```

**修改后：**
```bash
# 1. 只启动 PostgreSQL
sudo docker-compose up -d postgres

# 2. 等待 PostgreSQL 就绪
...

# 3. 检查数据库是否已初始化
DB_INITIALIZED=$(sudo docker-compose exec -T postgres psql ...)

# 4. 如未初始化，在宿主机执行迁移（通过 postgres 容器执行 SQL）
if [ "$DB_INITIALIZED" != "t" ]; then
    for sql_file in api-new/database/migrations/*.sql; do
        sudo docker-compose exec -T postgres psql ... < "$sql_file"
    done
fi

# 5. 拉取并启动其他服务
sudo docker-compose pull
sudo docker-compose up -d
```

**说明：**
- 先单独启动 PostgreSQL 进行数据库初始化
- 在宿主机上执行迁移（通过 `docker-compose exec postgres psql`）
- 不再进入 API 容器执行迁移（因为迁移文件不在镜像中）
- 数据库初始化完成后再启动其他服务

---

## 优化效果

| 方面 | 优化前 | 优化后 |
|-----|-------|-------|
| 镜像大小 | 大（包含迁移文件） | 小（不包含迁移文件） |
| 数据库初始化 | 在容器内执行 | 在宿主机执行 |
| 上传文件大小 | 大（整个 api-new） | 小（只上传 dist） |
| 职责分离 | 混合 | 清晰 |

---

## 部署流程（优化后）

```
开发机执行：
  ./deploy/fresh-install/deploy.sh
    ├── 步骤1-4: 检查、配置、构建
    └── 步骤5: 上传文件（包含迁移文件，不包含 seeds）
         └── 通过 SSH 在服务器上自动执行：
              ├── 启动 PostgreSQL
              ├── 等待 PostgreSQL 就绪
              ├── 检查数据库是否已初始化
              ├── 如未初始化，执行 SQL 迁移文件
              ├── 拉取并启动其他服务
              └── 验证部署
```

**用户操作**：只需在开发机执行一个命令，所有操作全自动完成。

---

## 文件变更清单

### 修改的文件
1. `api-new/Dockerfile` - 移除数据库迁移文件 COPY
2. `deploy/fresh-install/deploy.sh` - 调整上传逻辑和部署流程

### 已修改的文件（之前）
3. `api-new/.dockerignore` - 保留 knexfile.ts
4. `api-new/database/migrations/001_create_profiles.sql` - 管理员初始化移到迁移文件
5. `api-new/database/seeds/001_seed_admin_user.ts` - 简化（只保留检查）

---

## 测试建议

1. 在开发机构建：`npm run build` 和 `cd api-new && npm run build`
2. 执行部署脚本：`./deploy/fresh-install/deploy.sh`
3. 验证服务器部署：检查数据库表是否正确创建
4. 验证登录功能：使用 admin/Willyou@2026 登录

---

## 注意事项

1. **首次部署** - 会执行所有迁移文件创建数据库表
2. **后续部署** - 检测到表已存在，跳过迁移
3. **数据库密码** - 确保 `.env.production` 中的 `DB_PASSWORD` 正确设置
4. **SSH 配置** - 确保开发机可以免密登录服务器
