# 部署脚本配置检查优化记录

## 日期
2026-02-17

## 问题
用户反馈部署脚本调用的配置文件不清晰，不知道去哪里修改初始化的数据库密码等内容。

## 解决方案

### 1. 统一配置文件位置

所有部署配置统一放在 `config/env/.env.production`：

```
config/
├── docker/
│   └── docker-compose.yml
├── nginx/
│   └── nginx.conf
└── env/
    ├── .env.example          # 示例配置
    └── .env.production       # ⚠️ 生产环境配置（部署前必须修改）
```

### 2. 配置文件内容优化

更新了 `config/env/.env.production`，添加了清晰的注释和必须修改的标记：

```bash
# ==========================================
# PMSY 生产环境配置
# ==========================================
# 此文件用于服务器部署
# 部署前必须修改以下配置：
#   1. DB_PASSWORD - 数据库密码（必须修改）
#   2. JWT_SECRET - JWT密钥（必须修改）
#   3. MINIO_SECRET_KEY - MinIO密钥（必须修改）
#   4. API_URL - 服务器IP地址（必须修改）
# ==========================================
```

### 3. 部署脚本配置检查增强

更新了 `deploy/fresh-install/deploy-v2.sh`，添加了智能配置检查：

#### 新增功能：

1. **配置状态表格显示**
   ```
   ┌─────────────────────────────────────────────────────────┐
   │ 配置项              │ 当前值                            │
   ├─────────────────────────────────────────────────────────┤
   │ 1. DB_PASSWORD      │ ⚠️  未修改 (必须修改)              │
   │ 2. JWT_SECRET       │ ⚠️  未修改 (必须修改)              │
   │ 3. MINIO_SECRET_KEY │ ⚠️  未修改 (必须修改)              │
   │ 4. API_URL          │ ⚠️  建议修改: http://x.x.x.x       │
   └─────────────────────────────────────────────────────────┘
   ```

2. **自动检测配置是否已修改**
   - 检测默认密码是否已更改
   - 检测 JWT_SECRET 是否为随机字符串
   - 检测 API_URL 是否已设置为实际IP

3. **强制配置检查**
   - 如果关键配置未修改，脚本会强制要求修改
   - 提供一键打开编辑器功能（支持 VS Code、vim、nano）
   - 修改后重新验证，确保配置正确

4. **清晰的错误提示**
   ```
   ❌ 检测到配置未正确设置，必须先修改配置文件
   
   必须修改的配置项：
     1. DB_PASSWORD - 数据库密码（生产环境强密码）
     2. JWT_SECRET - JWT签名密钥（至少32位随机字符串）
     3. MINIO_SECRET_KEY - MinIO存储密钥（强密码）
     4. API_URL - 服务器IP地址
   
   生成随机密码命令：
     openssl rand -base64 32
   ```

### 4. 创建部署配置指南

创建了详细的 `部署配置指南.md` 文档，包含：
- 配置文件位置说明
- 必须修改的配置项清单
- 配置文件示例
- 部署流程说明
- 常见问题解答

## 使用方法

### 部署前配置

```bash
# 1. 编辑配置文件
vim config/env/.env.production

# 2. 修改以下配置：
#    - DB_PASSWORD: 数据库密码
#    - JWT_SECRET: JWT密钥（至少32位）
#    - MINIO_SECRET_KEY: MinIO密钥
#    - API_URL: 服务器IP地址
#    - VITE_API_URL: 前端API地址

# 3. 运行部署脚本
./deploy/fresh-install/deploy-v2.sh
```

### 配置检查流程

脚本会自动：
1. 检查 `config/env/.env.production` 是否存在
2. 如果不存在，从 `.env.example` 自动创建
3. 显示配置状态表格
4. 检测关键配置是否已修改
5. 如果未修改，强制要求编辑配置文件
6. 修改后重新验证
7. 验证通过后继续部署

## 关键配置项说明

| 配置项 | 用途 | 要求 |
|--------|------|------|
| DB_PASSWORD | PostgreSQL 数据库密码 | 强密码，至少16位 |
| JWT_SECRET | JWT 签名密钥 | 随机字符串，至少32位 |
| MINIO_SECRET_KEY | MinIO 存储密钥 | 强密码 |
| API_URL | 后端 API 地址 | 服务器实际IP |
| VITE_API_URL | 前端调用的 API 地址 | 服务器实际IP + /api |

## 生成强密码

```bash
# 生成32位随机密码
openssl rand -base64 32

# 生成64位 JWT 密钥
openssl rand -base64 64
```
