# 项目开发日报 - 2026-02-17

## 今日完成工作

### 1. 全新部署脚本修复

#### 问题修复
- **SSH 远程脚本执行语法错误**：修复了 deploy-v2.sh 中 SSH here-document 语法问题，确保远程脚本正确执行
- **颜色代码显示问题**：修复了配置检查表格中颜色代码（`\033`）被直接显示的问题，添加 `echo -e` 启用转义序列解释
- **SQL 文件列表格式问题**：修复了带空格路径下 SQL 文件列表显示异常的问题

#### 文件变更
- `deploy/fresh-install/deploy-v2.sh`
- `config/docker/docker-compose.yml`

### 2. 清理 Supabase 残留依赖

#### 背景
项目已完成从 Supabase 迁移到 PostgreSQL + Knex 的工作，但仍有 Supabase 相关残留。

#### 清理内容
1. **移除 package.json 中的 Supabase 依赖**
   - 删除 `devDependencies` 中的 `@supabase/supabase-js`
   - 删除 `scripts` 中的 `migrate:supabase` 命令

2. **删除迁移脚本**
   - 删除 `api-new/scripts/migrate-from-supabase.js`

#### 文件变更
- `api-new/package.json`
- 删除 `api-new/scripts/migrate-from-supabase.js`

### 3. Docker 配置优化

#### 问题
- API 容器 volume 挂载使用了 `:ro`（只读）标记，导致 `npm ci` 无法写入 `node_modules`
- 容器启动命令执行 `npm ci --only=production`，但生产环境不应在启动时安装依赖
- 开发环境使用 Node 24，但生产容器使用 Node 18，版本不统一

#### 修复
- 移除 `docker-compose.yml` 中 API 服务的 `:ro` 只读标记
- 将启动命令从 `npm ci --only=production && node dist/index.js` 简化为 `node dist/index.js`
- **统一 Node.js 版本为 24**：将 `node:18-alpine` 升级到 `node:24-alpine`
- 更新 `package.json` 的 `engines` 字段：`"node": ">=24.0.0"`

#### 文件变更
- `config/docker/docker-compose.yml`
- `api-new/package.json`

### 4. 重新生成 package-lock.json

#### 操作
- 删除 `node_modules` 和 `package-lock.json`
- 执行 `npm install` 重新安装依赖
- 验证 Supabase 相关依赖已完全移除

#### 文件变更
- `api-new/package-lock.json`

### 5. 自定义 Docker 镜像构建方案

#### 背景
原有的部署方案使用 volume 挂载源代码，在服务器上执行 `npm ci` 安装依赖，存在以下问题：
- 启动慢（需要安装依赖）
- 依赖网络（npm registry）
- 环境不一致风险

#### 新方案
采用自定义 Docker 镜像构建方案：

1. **多阶段构建 Dockerfile**
   - 阶段1：安装依赖
   - 阶段2：复制依赖和代码，运行应用
   - 内置健康检查

2. **部署流程优化**
   - 开发机构建镜像 → 导出镜像 → 上传到服务器 → 导入镜像 → 启动
   - 无需上传源代码和 node_modules
   - 服务器直接启动，无需安装依赖

3. **三种部署模式支持**
   - **在线部署**：构建镜像 → 导出 → 上传 → 导入 → 启动
   - **半离线部署**：包含自定义 API 镜像导出
   - **完全离线部署**：包含自定义 API 镜像导出

#### 文件变更
- 新增 `api-new/Dockerfile`
- 新增 `api-new/.dockerignore`
- 修改 `config/docker/docker-compose.yml`
- 修改 `deploy/fresh-install/deploy-v2.sh`

### 6. 修复架构不匹配问题（智能检测）

#### 问题
- 本地开发环境：ARM64 (Apple Silicon)
- 服务器环境：x86_64 (AMD64)
- 直接构建的 Docker 镜像架构不匹配，无法在服务器上运行

#### 修复
- **智能检测架构**：自动获取本地和服务器架构信息
- **架构一致时**：直接本地构建（无需跨架构，更快更稳定）
- **架构不一致时**：提供选项
  - **选项 1**：本地跨架构构建（使用 Docker Buildx，需要良好网络）
  - **选项 2**：在服务器上构建（推荐，避免跨架构问题）
- 根据选择自动调整部署流程和 docker-compose.yml 配置

#### 文件变更
- 修改 `deploy/fresh-install/deploy-v2.sh`

### 7. 优化种子数据执行

#### 调整
- 只执行必要的管理员用户初始化（`001_seed_admin_user.ts`）
- 跳过示例项目数据（`002_seed_demo_data.ts`）
- 使用 `npx knex seed:run --specific=001_seed_admin_user.ts` 精确执行

#### 文件变更
- 修改 `deploy/fresh-install/deploy-v2.sh`

### 8. 修复 Docker Compose 版本警告

#### 调整
- 删除 `version: '3.8'` 字段（Docker Compose v2.x 已弃用）

#### 文件变更
- 修改 `config/docker/docker-compose.yml`
- 修改 `deploy/fresh-install/deploy-v2.sh`

## 待办事项

1. **重新部署验证**：需要重新执行全新部署脚本验证修复效果

## 备注

- 部署脚本 V2 版本已修复多处问题，后续全新部署请使用 `./deploy/fresh-install/deploy-v2.sh`
- 旧版 `deploy.sh` 不再维护
- 自定义 Docker 镜像方案使部署更快速、更可靠
- 支持智能架构检测和适配
- 架构一致时直接构建，避免不必要的跨架构构建
- 只初始化必要数据（管理员账号），不包含示例数据
