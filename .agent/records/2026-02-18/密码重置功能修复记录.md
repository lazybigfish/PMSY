# 密码重置功能修复记录

## 问题描述

用户管理模块的密码重置功能出现 404 错误，无法正常使用。

**错误信息：**
```
auth/v1/admin/users/aca9a371-940a-4f7f-bfe6-c7a0bac2cfc7/reset-password:1
Failed to load resource: the server responded with a status of 404 (Not Found)
```

## 问题分析

通过代码审查发现：

1. **前端代码已完整实现**：
   - `src/services/adminUserService.ts` 中已定义 `resetPassword` 和 `setForcePasswordChange` 方法
   - `src/pages/system/tabs/UserManagement/components/ResetPasswordModal.tsx` 中已实现弹窗组件
   - 支持两种重置模式：随机密码 / 固定密码
   - 支持强制改密开关

2. **后端代码缺失**：
   - `api-new/src/routes/auth.ts` 中缺少以下两个 API 端点：
     - `POST /auth/v1/admin/users/:id/reset-password`
     - `POST /auth/v1/admin/users/:id/force-password-change`
   - `api-new/src/services/authService.ts` 中缺少对应的业务逻辑方法

3. **数据库字段缺失**：
   - `profiles` 表缺少 `force_password_change` 字段

## 修复内容

### 1. 后端服务层（authService.ts）

新增以下方法：

- `generateRandomPassword()` - 生成随机强密码（包含大小写字母、数字、特殊字符）
- `resetPassword(userId, mode, fixedPassword)` - 重置用户密码
- `setForcePasswordChange(userId, force)` - 设置强制改密状态

### 2. 后端路由层（auth.ts）

新增以下 API 端点：

- `POST /auth/v1/admin/users/:id/reset-password` - 重置密码接口
  - 请求参数：`mode` ('random' | 'fixed'), `fixedPassword` (可选)
  - 响应：`{ success: true, newPassword: string, message: string }`

- `POST /auth/v1/admin/users/:id/force-password-change` - 强制改密接口
  - 请求参数：`force` (boolean)
  - 响应：`{ success: true, message: string }`

### 3. 数据库迁移

创建迁移文件 `026_add_force_password_change.sql`：

```sql
ALTER TABLE profiles
ADD COLUMN IF NOT EXISTS force_password_change BOOLEAN DEFAULT false;
```

## 文件变更

| 文件路径 | 变更类型 | 说明 |
|---------|---------|------|
| `api-new/src/services/authService.ts` | 修改 | 新增密码重置相关方法 |
| `api-new/src/routes/auth.ts` | 修改 | 新增密码重置API路由 |
| `api-new/database/migrations/026_add_force_password_change.sql` | 新增 | 数据库迁移文件 |

## 验证步骤

1. 执行数据库迁移：
   ```bash
   cd api-new
   npm run migrate
   ```

2. 重新编译后端代码：
   ```bash
   npm run build
   ```

3. 重启后端服务

4. 前端测试：
   - 进入用户管理页面
   - 点击用户行的"重置密码"按钮
   - 选择随机密码或固定密码模式
   - 确认重置成功并显示新密码

## 后续建议

1. **部署前执行数据库迁移脚本**，确保 `force_password_change` 字段已添加
2. 考虑在登录接口中检查 `force_password_change` 字段，强制要求用户修改密码
3. 建议记录密码重置操作日志，便于审计

## 修复时间

2026-02-18
