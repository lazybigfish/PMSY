# 数据库迁移方案优化记录

## 日期
2026-02-18

## 问题背景

随着开发环境增加和修复了很多功能，涉及大量数据库结构调整（新增表、修改字段、添加索引等）。原有更新部署脚本 `./deploy/update/deploy.sh` 存在以下问题：

1. **没有数据库迁移机制** - 只更新代码，不执行数据库变更
2. **无法追踪迁移状态** - 不知道哪些迁移已执行、哪些待执行
3. **不支持幂等执行** - 重复执行可能导致错误
4. **缺少迁移回滚机制** - 迁移失败时无法自动恢复

## 优化方案

### 1. 迁移记录表设计

创建 `schema_migrations` 表记录所有已执行的迁移：

```sql
CREATE TABLE schema_migrations (
    id SERIAL PRIMARY KEY,
    filename TEXT UNIQUE NOT NULL,        -- 迁移文件名
    executed_at TIMESTAMPTZ DEFAULT NOW(), -- 执行时间
    checksum TEXT,                         -- 文件校验和（防篡改）
    execution_time_ms INTEGER              -- 执行耗时（毫秒）
);
```

### 2. 迁移脚本设计

新建 `api-new/database/migrate.sh` 脚本，功能包括：

- **自动检测待执行迁移** - 对比 migrations 目录和数据库记录
- **幂等执行** - 已执行的迁移不会重复执行
- **事务支持** - 每个迁移在独立事务中执行，失败自动回滚
- **执行记录** - 记录执行时间、校验和等信息
- **错误处理** - 失败的迁移会记录并报告

### 3. 更新部署脚本集成

修改 `./deploy/update/deploy.sh`，集成数据库迁移：

- **步骤 5** - 复制迁移文件和迁移脚本到服务器
- **步骤 6** - 在服务器上执行数据库迁移
- **步骤 8** - 显示迁移状态摘要

## 文件变更清单

### 新增文件

| 文件路径 | 说明 |
|---------|------|
| `api-new/database/migrate.sh` | 数据库迁移执行脚本 |

### 修改文件

| 文件路径 | 说明 |
|---------|------|
| `deploy/update/deploy.sh` | 集成数据库迁移功能，从 v1.0 升级到 v2.0 |

## 迁移文件命名规范

迁移文件按序号命名，确保执行顺序：

```
api-new/database/migrations/
├── 001_create_profiles.sql
├── 002_create_projects.sql
├── ...
├── 023_add_duplicate_check_indexes.sql
├── 024_add_client_payments.sql
└── 025_add_extra_requirements.sql
```

命名规则：`{序号}_{描述}.sql`
- 序号：3位数字，按顺序递增
- 描述：下划线分隔的英文描述

## 使用说明

### 1. 添加新的数据库变更

1. 创建新的迁移文件，按序号命名：
   ```bash
   touch api-new/database/migrations/026_add_new_feature.sql
   ```

2. 编写迁移 SQL（使用 `IF NOT EXISTS` 确保幂等）：
   ```sql
   -- 示例：添加新表
   CREATE TABLE IF NOT EXISTS new_table (
       id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
       name TEXT NOT NULL,
       created_at TIMESTAMPTZ DEFAULT NOW()
   );
   
   -- 示例：添加字段
   ALTER TABLE existing_table 
       ADD COLUMN IF NOT EXISTS new_field TEXT;
   
   -- 示例：创建索引
   CREATE INDEX IF NOT EXISTS idx_new_field ON existing_table(new_field);
   ```

### 2. 执行更新部署

```bash
./deploy/update/deploy.sh
```

部署脚本会自动：
1. 构建前端代码
2. 构建后端代码
3. 复制文件到服务器
4. **执行数据库迁移**（新增）
5. 重启服务
6. 验证部署

### 3. 查看迁移状态

```bash
# 在服务器上查看迁移记录
ssh ubuntu@43.136.69.250
cd /opt/pmsy
sudo docker-compose exec postgres psql -U pmsy -d pmsy -c "
    SELECT filename, executed_at, execution_time_ms 
    FROM schema_migrations 
    ORDER BY executed_at DESC;
"
```

### 4. 手动执行迁移（调试）

```bash
# 在服务器上手动执行
ssh ubuntu@43.136.69.250
cd /opt/pmsy
DB_HOST=postgres \
DB_PORT=5432 \
DB_USER=pmsy \
DB_PASSWORD=你的密码 \
DB_NAME=pmsy \
bash api-new/database/migrate.sh
```

## 迁移脚本工作原理

```
┌─────────────────────────────────────────────────────────┐
│                    migrate.sh 执行流程                    │
├─────────────────────────────────────────────────────────┤
│ 1. 检查数据库连接                                         │
│    └─ 失败 → 退出并报告错误                                │
│                                                         │
│ 2. 初始化迁移记录表（如果不存在）                           │
│    └─ 创建 schema_migrations 表                           │
│                                                         │
│ 3. 扫描 migrations 目录                                   │
│    └─ 获取所有 .sql 文件列表                              │
│                                                         │
│ 4. 查询已执行的迁移                                       │
│    └─ 从 schema_migrations 表读取                         │
│                                                         │
│ 5. 对比找出待执行迁移                                     │
│    └─ 文件存在但数据库未记录 = 待执行                      │
│                                                         │
│ 6. 逐个执行迁移（在事务中）                                │
│    ├─ BEGIN                                             │
│    ├─ 执行 SQL 文件内容                                  │
│    ├─ 成功 → COMMIT + 记录到 schema_migrations            │
│    └─ 失败 → ROLLBACK + 记录错误                          │
│                                                         │
│ 7. 输出执行结果                                           │
│    └─ 成功/失败统计                                       │
└─────────────────────────────────────────────────────────┘
```

## 注意事项

### 1. 迁移文件编写规范

- **必须幂等** - 使用 `IF NOT EXISTS`、`IF EXISTS` 等
- **避免破坏性操作** - 不要直接删除字段/表，先保留兼容性
- **事务安全** - 每个迁移应该可以独立回滚
- **注释清晰** - 说明迁移的目的和影响

### 2. 生产环境注意事项

- **备份数据** - 执行迁移前建议备份数据库
- **测试验证** - 在测试环境验证迁移脚本
- **监控执行** - 关注迁移执行时间和资源消耗
- **回滚准备** - 准备好回滚方案

### 3. 常见问题

**Q: 迁移执行失败怎么办？**
A: 由于每个迁移在事务中执行，失败会自动回滚。检查错误日志，修复 SQL 后重新执行。

**Q: 可以跳过某个迁移吗？**
A: 不建议。如果需要跳过，可以手动插入记录到 schema_migrations 表，但需确保数据库状态一致。

**Q: 如何修改已执行的迁移？**
A: 不要修改已执行的迁移文件！应该创建新的迁移来修正问题。

## 后续优化建议

1. **迁移回滚支持** - 添加 `down` 迁移支持
2. **迁移预览** - 执行前显示将要执行的变更
3. **并发控制** - 防止多个部署同时执行迁移
4. **迁移验证** - 执行后自动验证数据结构
5. **图形化管理** - 开发迁移管理界面
