# 新增用户 405 错误修复记录

## 问题描述

**时间**: 2026-02-18

**现象**: 在服务器环境（http://43.136.69.250）新增用户时，浏览器控制台报错：

```
POST http://43.136.69.250/auth/v1/admin/users 405 (Not Allowed)
```

## 问题分析

### 1. 前端调用

前端服务调用 `POST /auth/v1/admin/users` 接口来创建用户：

```typescript
// src/services/adminUserService.ts
async createUser(data: UserFormData): Promise<{ success: boolean; user: Profile; message?: string }> {
  const response = await fetch('/auth/v1/admin/users', {
    method: 'POST',
    headers: buildHeaders(),
    body: JSON.stringify(data),
  });
  return handleResponse<{ success: boolean; user: Profile; message?: string }>(response);
}
```

### 2. 后端路由检查

检查后端路由文件 `api-new/src/routes/auth.ts`，发现管理员用户接口只定义了以下路由：

- `GET /auth/v1/admin/users` - 列出所有用户
- `GET /auth/v1/admin/users/:id` - 获取指定用户信息
- `PUT /auth/v1/admin/users/:id` - 更新指定用户信息
- `DELETE /auth/v1/admin/users/:id` - 禁用用户

**缺少**: `POST /auth/v1/admin/users` - 创建用户的接口

### 3. 根本原因

后端 API 路由中未实现管理员创建用户的 POST 接口，导致请求返回 405 Method Not Allowed 错误。

## 修复方案

### 1. 添加服务层函数

在 `api-new/src/services/authService.ts` 中添加 `adminCreateUser` 函数：

```typescript
// 管理员创建用户请求类型
export interface AdminCreateUserRequest {
  email: string;
  password: string;
  full_name?: string;
  username?: string;
  role?: string;
  phone?: string;
}

/**
 * 管理员创建用户
 * @param data - 创建用户请求数据
 * @returns 创建的用户信息
 */
export async function adminCreateUser(data: AdminCreateUserRequest): Promise<User> {
  const { email, password, full_name, username, role = 'user', phone } = data;

  // 检查邮箱是否已存在
  const existingUser = await findUserByEmail(email);
  if (existingUser) {
    throw new Error('该邮箱已被注册');
  }

  // 如果提供了用户名，检查是否已存在
  if (username) {
    const existingUsername = await findUserByUsername(username);
    if (existingUsername) {
      throw new Error('该用户名已被使用');
    }
  }

  // 哈希密码
  const passwordHash = await hashPassword(password);

  // 创建用户
  const newUser = {
    id: uuidv4(),
    email: email.toLowerCase(),
    username: username ? username.toLowerCase() : null,
    password_hash: passwordHash,
    full_name: full_name || null,
    avatar_url: null,
    role: role,
    is_active: true,
    email_confirmed_at: new Date(),
    created_at: new Date(),
    updated_at: new Date(),
    last_sign_in_at: null,
    phone: phone || null,
  };

  await db('profiles').insert(newUser);

  // 返回用户信息（不包含密码）
  const { password_hash, ...userWithoutPassword } = newUser;
  return userWithoutPassword as User;
}
```

### 2. 添加路由接口

在 `api-new/src/routes/auth.ts` 中添加 POST 路由：

```typescript
/**
 * POST /auth/v1/admin/users
 * 创建用户（管理员权限）
 */
router.post('/admin/users', requireAuth, requireAdmin, async (req: Request, res: Response, next: NextFunction) => {
  try {
    const { email, password, full_name, username, role, phone } = req.body;

    if (!email || !password) {
      throw new ValidationError('邮箱和密码不能为空');
    }

    if (password.length < 6) {
      throw new ValidationError('密码长度不能少于 6 位');
    }

    const newUser = await adminCreateUser({
      email,
      password,
      full_name,
      username,
      role,
      phone,
    });

    res.status(201).json({
      success: true,
      user: newUser,
      message: '用户创建成功',
    });
  } catch (error) {
    next(error);
  }
});
```

## 修改文件清单

| 文件 | 修改内容 |
|-----|---------|
| `api-new/src/services/authService.ts` | 添加 `AdminCreateUserRequest` 接口和 `adminCreateUser` 函数 |
| `api-new/src/routes/auth.ts` | 导入 `adminCreateUser` 函数，添加 POST `/admin/users` 路由 |

## 后续操作

1. **重启后端服务**：修改完成后需要重启后端服务使更改生效
2. **验证修复**：在服务器环境测试新增用户功能是否正常

## 经验总结

1. **接口对齐**：前后端接口需要保持一致，新增功能时需同时检查前后端实现
2. **错误码含义**：405 错误表示请求方法不被允许，通常是后端未实现对应的 HTTP 方法
3. **代码审查**：在功能开发完成后，应进行接口对齐检查，确保所有前端调用的接口后端都有实现
