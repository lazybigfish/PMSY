# 新增用户功能修复记录

## 修复时间
2026-02-18

## 问题概述
服务器环境新增用户功能出现多个问题，经过逐步排查和修复，现已全部解决。

## 问题清单及修复

### 问题1: 405 Method Not Allowed
**现象**: POST `/auth/v1/admin/users` 返回 405
**原因**: 后端缺少创建用户的 POST 接口
**修复**: 
- 在 `api-new/src/services/authService.ts` 添加 `adminCreateUser` 函数
- 在 `api-new/src/routes/auth.ts` 添加 POST `/admin/users` 路由

### 问题2: 404 Not Found (开发环境)
**现象**: 开发环境新增用户返回 404
**原因**: Vite 代理配置缺少 `/auth` 路径
**修复**: 在 `vite.config.ts` 添加 `/auth` 代理配置

### 问题3: 404 Not Found (服务器环境)
**现象**: 服务器环境新增用户返回 404
**原因**: Nginx 配置缺少 `/auth`、`/rest`、`/storage` 路径代理
**修复**: 在 `config/nginx/nginx.conf` 添加相应 location 配置

### 问题4: TypeScript 类型错误
**现象**: 构建时 `authService.ts:445` 报错
**原因**: `adminCreateUser` 返回的 Date 类型与 User 接口的 string 类型不匹配
**修复**: 将 Date 转换为 ISO 字符串后返回

### 问题5: 422 Unprocessable Entity
**现象**: 新增用户返回 422
**原因**: 前端表单邮箱选填，但后端强制要求邮箱
**修复**: 前端根据用户名自动生成邮箱 (`${username}@pmsy.com`)

### 问题6: 500 Internal Server Error
**现象**: 开发环境新增用户返回 500
**原因**: 数据库表 `profiles` 的 `email` 字段为 `NOT NULL`，但传入 null
**修复**: 前端自动生成邮箱，确保始终有值传入

## 修改文件清单

| 文件 | 修改内容 |
|-----|---------|
| `api-new/src/services/authService.ts` | 添加 `adminCreateUser` 函数，修复类型错误 |
| `api-new/src/routes/auth.ts` | 添加 POST `/admin/users` 路由 |
| `vite.config.ts` | 添加 `/auth` 代理配置 |
| `config/nginx/nginx.conf` | 添加 `/auth`、`/rest`、`/storage` 代理配置 |
| `src/pages/system/tabs/UserManagement/index.tsx` | 自动生成邮箱逻辑 |

## 部署说明
执行 `./deploy/update/deploy.sh` 部署所有修改到服务器。

## 经验总结
1. 新增接口时需同时检查前后端实现
2. 代理配置需覆盖所有 API 路径
3. 表单验证前后端需保持一致
4. 注意 TypeScript 类型匹配
