# 用户体验优化四大模块开发记录

## 开发日期
2026-02-18

## 需求背景
根据 `.agent/specs/user-experience-optimization` 中的需求文档，完成四大模块的开发：
1. 查重机制
2. 供应商外采金额提示
3. 客户回款管理
4. 合同外需求管理

---

## 模块一：查重机制

### 实现内容

#### 1. 数据库索引优化
- **文件**: `api-new/database/migrations/023_add_duplicate_check_indexes.sql`
- **内容**:
  - 为 `projects.name` 创建索引
  - 为 `suppliers.name` 创建索引
  - 为 `clients.name` 创建索引
  - 为 `tasks.title + project_id` 创建联合索引

#### 2. 查重服务层
- **文件**: `api-new/src/services/duplicateCheckService.ts`
- **功能**:
  - 支持 project/task/supplier/client 四种类型查重
  - 实现名称标准化（去除前后空格、转小写、全角转半角）
  - 任务查重支持可见范围过滤（管理员/项目经理/普通用户）
  - 支持排除自身ID（编辑场景）

#### 3. 查重 API 路由
- **文件**: `api-new/src/routes/duplicateCheck.ts`
- **端点**: `POST /api/duplicate-check`
- **特性**:
  - 速率限制（10次/分钟）
  - 参数校验
  - 权限校验

#### 4. 前端 Hook
- **文件**: `src/hooks/useDuplicateCheck.ts`
- **功能**:
  - 防抖查重（默认300ms）
  - 请求取消（避免竞态条件）
  - 返回 `{ isDuplicate, isChecking, error, existingItem }`

---

## 模块二：供应商外采金额提示

### 实现内容

#### 1. 项目外采统计服务
- **文件**: `api-new/src/services/projectFinanceService.ts`
- **功能**:
  - `getProcurementStats(projectId)`: 获取外采统计
  - `checkContractAmount()`: 检查合同金额是否超额

#### 2. 外采统计 API
- **端点**: `GET /api/projects/:id/procurement-stats`
- **权限**: 项目成员可见

#### 3. 前端组件
- **文件**: `src/components/ProcurementStatsCard.tsx`
- **功能**:
  - 显示项目金额、已外采金额、剩余金额
  - 剩余金额<10%时显示红色预警

---

## 模块三：客户回款管理

### 实现内容

#### 1. 数据库表
- **文件**: `api-new/database/migrations/024_add_client_payments.sql`
- **表结构**:
  - `client_payments`: 客户回款记录表
  - 索引: project_id, client_id, payment_date
  - 触发器: 自动更新 updated_at

#### 2. 服务层
- **文件**: `api-new/src/services/clientPaymentService.ts`
- **方法**:
  - `getProjectPayments(projectId)`: 获取回款列表
  - `createPayment()`: 创建回款记录
  - `deletePayment(paymentId)`: 删除回款记录
  - `getProjectPaymentStats()`: 获取付款统计
  - `checkPaymentBalance()`: 检查付款余额

#### 3. API 路由
- **端点**:
  - `GET /api/projects/:id/client-payments`
  - `POST /api/projects/:id/client-payments`
  - `DELETE /api/projects/client-payments/:id`
  - `GET /api/projects/:id/payment-stats`
  - `GET /api/projects/:id/payment-balance-check`

#### 4. 前端组件
- **文件**: `src/pages/projects/tabs/ClientPayments.tsx`
- **功能**:
  - 回款统计卡片（合同金额、已回款、未回款）
  - 资金缺口警告提示
  - 回款记录列表
  - 新增回款弹窗

#### 5. 供应商付款余额检查
- **修改文件**: `src/pages/projects/components/SupplierDetailModal.tsx`
- **功能**:
  - 确认付款前自动检查余额
  - 余额不足时显示警告信息
  - 支持二次确认继续付款

---

## 模块四：合同外需求管理

### 实现内容

#### 1. 数据库表
- **文件**: `api-new/database/migrations/025_add_extra_requirements.sql`
- **表结构**:
  - `extra_requirements`: 合同外需求表
  - `extra_requirement_expenses`: 合同外需求支出表
  - 索引和触发器已配置

#### 2. 服务层
- **文件**: `api-new/src/services/extraRequirementService.ts`
- **方法**:
  - `getProjectRequirements()`: 获取需求列表
  - `createRequirement()`: 创建需求
  - `updateRequirementStatus()`: 更新需求状态
  - `getRequirementExpenses()`: 获取支出记录
  - `createExpense()`: 创建支出记录
  - `deleteExpense()`: 删除支出记录

#### 3. API 路由
- **端点**:
  - `GET /api/projects/:id/extra-requirements`
  - `POST /api/projects/:id/extra-requirements`
  - `PATCH /api/projects/extra-requirements/:id/status`
  - `GET /api/projects/extra-requirements/:id/expenses`
  - `POST /api/projects/extra-requirements/:id/expenses`
  - `DELETE /api/projects/extra-requirement-expenses/:id`

#### 4. 前端组件
- **文件**: `src/pages/projects/tabs/ExtraRequirements.tsx`
- **功能**:
  - 需求列表展示
  - 状态标签（待评估/已批准/已拒绝/已完成）
  - 成本状态提示（正常/接近预估/超出预估）
  - 操作按钮（批准/拒绝/标记完成/记录支出）
  - 新增需求弹窗
  - 支出记录弹窗

---

## 项目详情页更新

### 修改文件
- `src/pages/projects/ProjectDetail.tsx`

### 新增 Tab
- **回款管理**: 使用 Wallet 图标
- **合同外需求**: 使用 FilePlus 图标

### Tab 顺序
1. 项目概览
2. 功能模块
3. 里程碑
4. 风险
5. 供应商
6. **回款管理** (新增)
7. **合同外需求** (新增)
8. 周日报

---

## 新增 Hooks

### 1. useDuplicateCheck
- **路径**: `src/hooks/useDuplicateCheck.ts`
- **用途**: 名称查重

### 2. useClientPayment
- **路径**: `src/hooks/useClientPayment.ts`
- **用途**: 客户回款管理

### 3. useExtraRequirement
- **路径**: `src/hooks/useExtraRequirement.ts`
- **用途**: 合同外需求管理

---

## 构建验证

### 前端构建
```bash
npm run build
# 结果: ✓ built in 6.35s
```

### 后端构建
```bash
cd api-new && npm run build
# 结果: tsc 编译成功，无错误
```

---

## 部署步骤

### 1. 执行数据库迁移
```bash
# 在服务器上执行以下 SQL 文件
api-new/database/migrations/023_add_duplicate_check_indexes.sql
api-new/database/migrations/024_add_client_payments.sql
api-new/database/migrations/025_add_extra_requirements.sql
```

### 2. 部署后端
```bash
cd api-new
npm run build
# 重启服务
```

### 3. 部署前端
```bash
npm run build
# 部署 dist 目录
```

---

## 任务完成状态

| 模块 | 任务数 | 完成状态 |
|-----|-------|---------|
| 查重机制 | 10个 | ✅ 完成 |
| 供应商外采金额提示 | 6个 | ✅ 完成 |
| 客户回款管理 | 9个 | ✅ 完成 |
| 合同外需求管理 | 8个 | ✅ 完成 |
| **总计** | **33个** | **✅ 全部完成** |

---

## 后续工作

1. **单元测试**: 为新增的服务层编写单元测试
2. **组件测试**: 为新增的前端组件编写测试
3. **端到端测试**: 验证完整业务流程
4. **生产部署**: 执行数据库迁移并部署代码

---

## 相关文件

### 数据库迁移
- `api-new/database/migrations/023_add_duplicate_check_indexes.sql`
- `api-new/database/migrations/024_add_client_payments.sql`
- `api-new/database/migrations/025_add_extra_requirements.sql`

### 后端服务
- `api-new/src/services/duplicateCheckService.ts`
- `api-new/src/services/clientPaymentService.ts`
- `api-new/src/services/extraRequirementService.ts`
- `api-new/src/routes/duplicateCheck.ts`

### 前端 Hooks
- `src/hooks/useDuplicateCheck.ts`
- `src/hooks/useClientPayment.ts`
- `src/hooks/useExtraRequirement.ts`

### 前端组件
- `src/pages/projects/tabs/ClientPayments.tsx`
- `src/pages/projects/tabs/ExtraRequirements.tsx`
- `src/pages/projects/ProjectDetail.tsx` (修改)
- `src/pages/projects/components/SupplierDetailModal.tsx` (修改)

---

## 功能增强记录

### 2026-02-18 下午 - 回款比例输入功能

#### 需求描述
在新增回款时，用户可以通过比例方式输入回款金额：
1. 添加比例选择控件（进度条 + 数字输入）
2. 比例范围：0% - 100%
3. 回款金额 = 比例 × 合同金额（自动计算）
4. 校验：所有回款总比例不能超过 100%

#### 实现内容

1. **输入方式切换**
   - 支持"按比例"和"按金额"两种输入方式
   - Radio 按钮切换，默认"按比例"

2. **按比例输入**
   - 进度条滑块（range input），最大值为剩余可回款比例
   - 数字输入框，精确到小数点后两位
   - 实时显示计算出的回款金额

3. **按金额输入**
   - 金额输入框
   - 实时显示计算出的回款比例

4. **实时校验**
   - 计算已回款比例 + 当前输入比例
   - 超过 100% 时显示错误提示
   - 显示最大可输入比例

5. **比例预览**
   - 进度条可视化显示已回款、本次回款、剩余比例
   - 统计卡片显示百分比
   - 回款列表显示每条记录的比例

#### 相关文件
- `src/pages/projects/tabs/ClientPayments.tsx`

---

## 问题修复记录

### 2026-02-18 下午 - API 请求修复

#### 问题描述
前端 Hooks 中直接使用 `fetch` 和 `localStorage.getItem('token')`，导致：
1. 请求发送到错误的地址（`localhost:5173` 而不是后端 API）
2. Token key 不一致（`token` vs `access_token`）
3. 返回 401 Unauthorized 错误

#### 修复内容

1. **修复 `useClientPayment.ts`**
   - 使用 `apiClient` 替代原生 `fetch`
   - 统一使用项目的 API 客户端

2. **修复 `useExtraRequirement.ts`**
   - 使用 `apiClient` 替代原生 `fetch`
   - 添加 `patch` 方法调用

3. **修复 `useDuplicateCheck.ts`**
   - 使用 `apiClient.post` 替代原生 `fetch`
   - 简化防抖逻辑

4. **扩展 `apiClient`**
   - 添加泛型支持 `<T = any>`
   - 新增 `patch` 方法

#### 相关文件
- `src/hooks/useClientPayment.ts`
- `src/hooks/useExtraRequirement.ts`
- `src/hooks/useDuplicateCheck.ts`
- `src/lib/api.ts`

---

## 修订记录

| 版本 | 日期 | 修订内容 |
|-----|------|---------|
| 1.0 | 2026-02-18 | 初始版本，完成四大模块开发 |
| 1.1 | 2026-02-18 | 修复 API 请求问题，统一使用 apiClient |
