# 角色权限页面跳转异常问题分析报告

## 问题概述

**问题描述**：在开发环境的系统设置模块中，角色权限页面存在功能异常。当用户调整角色对应的模块权限并点击保存按钮后，页面未停留在当前角色权限页面，而是直接刷新并重定向至系统设置模块下的用户管理页面。

**发现时间**：2026-02-18

**影响范围**：系统设置 - 角色权限页面

---

## 问题复现步骤

1. 登录系统，进入「系统设置」页面
2. 切换到「角色权限」Tab
3. 点击任意角色的「编辑权限」按钮
4. 在弹窗中调整模块权限（勾选或取消勾选）
5. 点击「确认」按钮保存
6. **异常现象**：页面刷新后自动跳转到「用户管理」Tab，而非停留在「角色权限」Tab

---

## 根本原因分析

### 1. 代码层面的问题点

**问题文件**：`src/pages/system/tabs/RoleManagement.tsx`

**问题函数**：`handleSave`（第 73 行）

**问题代码**：
```typescript
// ❌ 错误实现 - 缺少 e.preventDefault()
const handleSave = async () => {
  if (!formData.key || !formData.name) {
    alert('请输入角色标识和名称');
    return;
  }
  // ...
}
```

### 2. 问题原因详解

**ModalForm 组件机制**：
- `ModalForm` 组件内部使用了原生的 HTML `<form>` 元素
- 表单的 `onSubmit` 事件绑定到了传入的 `handleSave` 函数
- 当用户点击「确认」按钮（type="submit"）时，会触发表单的默认提交行为

**浏览器默认行为**：
- 当表单提交时没有调用 `e.preventDefault()`，浏览器会执行默认的表单提交动作
- 默认行为会导致页面刷新（POST 请求到当前 URL）
- 由于系统设置页面使用 Tabs 组件管理状态，页面刷新后 Tabs 会重置为默认值 `defaultValue="users"`
- 因此页面刷新后显示的是「用户管理」Tab，而非「角色权限」Tab

### 3. 因果关系链

```
用户点击保存按钮
    ↓
触发 ModalForm 中的 form onSubmit
    ↓
调用 handleSave 函数（无 e.preventDefault()）
    ↓
浏览器执行默认表单提交行为
    ↓
页面刷新（POST 到当前 URL）
    ↓
Tabs 组件重置为 defaultValue="users"
    ↓
页面显示「用户管理」Tab（异常现象）
```

---

## 对比分析：正常 vs 异常

### 异常代码（RoleManagement.tsx）
```typescript
const handleSave = async () => {  // ❌ 缺少 e 参数
  // 没有调用 e.preventDefault()
  // ...
}
```

### 正常代码（UserManagement/index.tsx）
```typescript
const handleSubmit = async (e: React.FormEvent) => {  // ✅ 正确接收事件参数
  e.preventDefault();  // ✅ 阻止默认表单提交行为
  // ...
}
```

### 正常代码（ReportTemplates.tsx）
```typescript
const handleSubmit = async (e: React.FormEvent) => {  // ✅ 正确接收事件参数
  e.preventDefault();  // ✅ 阻止默认表单提交行为
  // ...
}
```

### 正常代码（TaskCreateModal.tsx）
```typescript
const handleSubmit = async (e: React.FormEvent) => {  // ✅ 正确接收事件参数
  e.preventDefault();  // ✅ 阻止默认表单提交行为
  // ...
}
```

---

## 修复方案

### 修复代码

```typescript
// ✅ 正确实现
const handleSave = async (e: React.FormEvent) => {
  e.preventDefault();  // 阻止默认表单提交行为，防止页面刷新
  
  if (!formData.key || !formData.name) {
    alert('请输入角色标识和名称');
    return;
  }
  // ...
}
```

### 修复提交

**文件**：`src/pages/system/tabs/RoleManagement.tsx`

**修改内容**：
- 为 `handleSave` 函数添加 `e: React.FormEvent` 参数
- 在函数开头添加 `e.preventDefault()` 调用

---

## 其他模块检查结果

经检查，系统中其他使用 `ModalForm` 组件的表单提交功能均正常，已正确调用 `e.preventDefault()`：

| 模块 | 文件路径 | 状态 |
|------|----------|------|
| 用户管理 | `src/pages/system/tabs/UserManagement/index.tsx` | ✅ 正常 |
| 报告模板 | `src/pages/system/tabs/ReportTemplates.tsx` | ✅ 正常 |
| 任务创建弹窗 | `src/pages/tasks/components/TaskCreateModal.tsx` | ✅ 正常 |
| 任务进度更新 | `src/pages/tasks/components/TaskProgressUpdateModal.tsx` | ✅ 正常 |
| 项目创建 | `src/pages/projects/ProjectCreate.tsx` | ✅ 正常 |
| 任务创建页面 | `src/pages/tasks/TaskCreatePage.tsx` | ✅ 正常 |

---

## 影响范围评估

### 直接影响
- 仅影响「系统设置 - 角色权限」页面的保存功能
- 保存操作本身可以正常完成（数据已正确保存到数据库）
- 仅影响用户体验（页面跳转不符合预期）

### 间接影响
- 无其他功能受影响
- 无数据丢失风险
- 无安全漏洞风险

---

## 预防措施

1. **代码审查**：在使用 `ModalForm` 组件时，确保 `onSubmit` 回调函数正确处理表单事件
2. **类型检查**：使用 TypeScript 类型检查确保事件参数被正确声明
3. **规范文档**：在弹窗使用规范中明确说明需要调用 `e.preventDefault()`

---

## 修复验证

修复后验证步骤：
1. 进入「系统设置 - 角色权限」页面
2. 编辑任意角色的权限
3. 点击保存
4. **预期结果**：弹窗关闭，页面停留在「角色权限」Tab，显示保存成功提示

---

**报告生成时间**：2026-02-18

**修复状态**：✅ 已修复
