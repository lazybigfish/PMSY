# 部署脚本调整记录

## 日期
2026-02-18

## 调整原因
准备部署到生产服务器验证，需要确保开发环境和部署环境的数据库结构完全一致。

## 发现的问题

### 1. docker-compose.yml 配置错误
**问题**：PostgreSQL 初始化目录挂载错误
- 原配置：`./api-new/database/migrations:/docker-entrypoint-initdb.d:ro`
- 问题：migrations 目录包含的是 ALTER 语句，不适合全新部署

**修复**：改为挂载 init 目录
- 新配置：`./api-new/database/init:/docker-entrypoint-initdb.d:ro`

### 2. 缺少最新的 SQL 表结构
**问题**：init 目录缺少最近开发的新表

**新增文件**：
1. `018_create_client_payments.sql` - 客户回款记录表
2. `019_create_extra_requirements.sql` - 合同外需求表和支出表
3. `020_create_duplicate_check_indexes.sql` - 查重功能索引

### 3. 文档更新
**更新文件**：`999_complete_schema.sql`
- 更新注释，反映最新的文件列表（001-020）

## 文件变更清单

### 修改的文件
| 文件路径 | 变更类型 | 说明 |
|---------|---------|------|
| config/docker/docker-compose.yml | 修改 | 修复 PostgreSQL 初始化目录挂载 |
| api-new/database/init/999_complete_schema.sql | 修改 | 更新注释文档 |

### 新增的文件
| 文件路径 | 说明 |
|---------|------|
| api-new/database/init/018_create_client_payments.sql | 客户回款记录表 |
| api-new/database/init/019_create_extra_requirements.sql | 合同外需求表和支出表 |
| api-new/database/init/020_create_duplicate_check_indexes.sql | 查重功能索引 |

## 当前 init 目录完整文件列表

```
api-new/database/init/
├── 001_create_profiles.sql          # 用户基础表
├── 002_create_projects.sql          # 项目相关表
├── 003_create_milestones.sql        # 里程碑相关表
├── 004_create_tasks.sql             # 任务相关表
├── 005_create_task_history.sql      # 任务历史记录
├── 006_create_suppliers_and_risks.sql  # 供应商和风险表
├── 007_create_files_and_notifications.sql  # 文件和通知表
├── 008_create_reports_and_ai.sql    # 报告和AI表
├── 009_create_water_module.sql      # 论坛模块表
├── 010_create_app_roles.sql         # 角色权限表
├── 011_create_milestone_templates.sql  # 里程碑模板表
├── 012_create_task_extensions.sql   # 任务扩展表
├── 013_create_supplier_extensions.sql  # 供应商扩展表
├── 014_create_client_tables.sql     # 客户相关表
├── 015_create_file_extensions.sql   # 文件扩展表
├── 016_create_forum_extensions.sql  # 论坛扩展表
├── 017_create_system_tables.sql     # 系统表
├── 018_create_client_payments.sql   # 客户回款记录表（新增）
├── 019_create_extra_requirements.sql  # 合同外需求表（新增）
├── 020_create_duplicate_check_indexes.sql  # 查重索引（新增）
└── 999_complete_schema.sql          # 说明文档
```

## 部署前检查清单

- [ ] 确认 config/env/.env.production 已配置正确的数据库密码
- [ ] 确认 config/env/.env.production 已配置正确的 JWT_SECRET
- [ ] 确认 config/env/.env.production 已配置正确的 MINIO_SECRET_KEY
- [ ] 确认 config/env/.env.production 已配置正确的 API_URL（服务器IP）
- [ ] 确认 api-new/database/init 目录包含所有 20 个 SQL 文件
- [ ] 确认 docker-compose.yml 正确挂载 init 目录

## 部署命令

```bash
# 使用 v2 部署脚本（推荐）
./deploy/fresh-install/deploy-v2.sh

# 或使用原部署脚本
./deploy/fresh-install/deploy.sh
```

## 验证部署

部署完成后，验证数据库表是否完整：

```bash
# 进入 PostgreSQL 容器
sudo docker-compose exec postgres psql -U pmsy -d pmsy

# 查看所有表
\dt

# 检查关键表数量（应该超过 40 个）
SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public';
```

## 注意事项

1. **全新部署会清空所有数据**，请确保这是预期的操作
2. PostgreSQL 初始化脚本只在数据卷为空时执行
3. 如果部署失败需要重新初始化，必须先删除 postgres_data 数据卷
