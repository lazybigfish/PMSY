# 部署问题记录

## 问题1: SSH heredoc 变量转义问题

### 现象
部署脚本执行时，服务器端的变量没有正确传递：
```bash
DB_INITIALIZED=f
if [ "" = "t" ]; then  # 变量为空
```

### 原因
在 SSH heredoc 中，变量转义规则混淆：
- `$VAR` - 在本地解析
- `\$VAR` - 在远程解析
- `$(cmd)` - 在本地解析
- `\$(cmd)` - 在远程解析

### 修复方案
将所有需要在服务器端执行的变量和命令替换都加上反斜杠转义：

**修复前：**
```bash
DB_INITIALIZED=$(sudo docker-compose exec ...)
if [ "$DB_INITIALIZED" = "t" ]; then
```

**修复后：**
```bash
DB_INITIALIZED=\$(sudo docker-compose exec ...)
if [ "\$DB_INITIALIZED" = "t" ]; then
```

### 经验总结
在 SSH heredoc 中：
1. 需要本地解析的变量：`$LOCAL_VAR`
2. 需要远程解析的变量：`\$REMOTE_VAR`
3. 需要本地执行的命令：`$(local_cmd)`
4. 需要远程执行的命令：`\$(remote_cmd)`

---

## 问题2: 数据库迁移文件外键依赖问题

### 现象
PostgreSQL 容器启动失败，日志显示：
```
ERROR:  relation "milestone_task_templates" does not exist
psql:/docker-entrypoint-initdb.d/003_create_milestones.sql:60: ERROR
```

### 原因
`003_create_milestones.sql` 中创建 `milestone_tasks` 表时，引用了 `milestone_task_templates` 表的外键：
```sql
template_id UUID REFERENCES milestone_task_templates(id) ON DELETE SET NULL,
```

但 `milestone_task_templates` 表是在 `010_create_milestone_templates.sql` 中创建的，执行顺序靠后。

### 修复方案

**步骤1**：在 `003_create_milestones.sql` 中移除外键约束：
```sql
-- 创建 milestone_tasks 表
-- 注意：template_id 外键约束在 010_create_milestone_templates.sql 中添加
CREATE TABLE IF NOT EXISTS milestone_tasks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    milestone_id UUID REFERENCES project_milestones(id) ON DELETE CASCADE,
    template_id UUID,  -- 外键约束稍后添加，避免依赖问题
    ...
);
```

**步骤2**：在 `010_create_milestone_templates.sql` 末尾添加外键约束：
```sql
-- 添加 milestone_tasks.template_id 的外键约束（在 milestone_task_templates 表创建后）
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.table_constraints 
        WHERE constraint_name = 'milestone_tasks_template_id_fkey' 
        AND table_name = 'milestone_tasks'
    ) THEN
        ALTER TABLE milestone_tasks 
        ADD CONSTRAINT milestone_tasks_template_id_fkey 
        FOREIGN KEY (template_id) REFERENCES milestone_task_templates(id) ON DELETE SET NULL;
    END IF;
END $$;
```

### 经验总结
1. 数据库迁移文件要避免循环依赖和前向引用
2. 外键约束可以在表创建后通过 ALTER TABLE 添加
3. 使用 `IF NOT EXISTS` 确保幂等性

---

## 问题3: docker-compose.yml 挂载路径错误

### 现象
PostgreSQL 日志显示：
```
/usr/local/bin/docker-entrypoint.sh: ignoring /docker-entrypoint-initdb.d/*
```

### 原因
docker-compose.yml 中挂载的是 `api-new/database/init`，但实际迁移文件在 `api-new/database/migrations`：
```yaml
volumes:
  - ./api-new/database/init:/docker-entrypoint-initdb.d:ro  # 错误路径
```

### 修复方案
修改 docker-compose.yml：
```yaml
volumes:
  - ./api-new/database/migrations:/docker-entrypoint-initdb.d:ro  # 正确路径
```

---

## 问题4: milestone_templates 表缺少 updated_at 列

### 现象
PostgreSQL 执行 `010_create_milestone_templates.sql` 时出错：
```
ERROR:  column "updated_at" of relation "milestone_templates" does not exist
```

### 原因
`003_create_milestones.sql` 中创建的 `milestone_templates` 表缺少 `updated_at` 列，但后续脚本引用了该列。

### 修复方案
在 `003_create_milestones.sql` 中添加 `updated_at` 列和触发器：
```sql
CREATE TABLE IF NOT EXISTS milestone_templates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name TEXT NOT NULL,
    description TEXT,
    phase_order INTEGER NOT NULL,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL  -- 添加此行
);

-- 添加触发器
CREATE TRIGGER update_milestone_templates_updated_at
    BEFORE UPDATE ON milestone_templates
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

---

## 问题5: milestone_tasks 外键约束数据冲突

### 现象
PostgreSQL 执行外键约束添加时出错：
```
ERROR:  insert or update on table "milestone_tasks" violates foreign key constraint "milestone_tasks_template_id_fkey"
```

### 原因
`milestone_tasks` 表中存在 `template_id` 值不在 `milestone_task_templates` 表中的记录。

### 修复方案
在添加外键约束前，先清理无效数据：
```sql
-- 清理无效的 template_id 值（设置为 NULL）
UPDATE milestone_tasks 
SET template_id = NULL 
WHERE template_id IS NOT NULL 
AND template_id NOT IN (SELECT id FROM milestone_task_templates);

-- 添加外键约束
ALTER TABLE milestone_tasks 
ADD CONSTRAINT milestone_tasks_template_id_fkey 
FOREIGN KEY (template_id) REFERENCES milestone_task_templates(id) ON DELETE SET NULL;
```

---

## 验证结果

- [x] 数据库初始化正常执行（22个迁移文件全部成功）
- [x] 迁移文件正确上传
- [x] 服务正常启动（PostgreSQL、Redis、MinIO、API、Nginx）
- [x] 登录功能正常（admin/Willyou@2026）

## 访问地址

- **网站**: http://43.136.69.250
- **登录**: admin@pmsy.com / Willyou@2026
