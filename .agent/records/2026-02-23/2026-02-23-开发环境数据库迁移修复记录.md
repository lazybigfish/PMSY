# 开发环境数据库迁移修复记录

## 问题描述

开发环境启动后显示"数据库打开异常"，无法正常完成数据迁移。

## 问题分析

1. **Docker 容器状态**: PostgreSQL 容器 (`pmsy-postgres`) 已在运行
2. **数据库状态**: 数据库为空，仅有 2 个 Knex 迁移锁定表
3. **根本原因**: `knexfile.ts` 配置的迁移文件扩展名为 `ts`，但实际迁移文件为 `sql` 格式，导致 Knex 迁移命令无法识别迁移文件

## 修复步骤

### 1. 修复 knexfile.ts 配置
- 将 `migrations.extension` 从 `ts` 改为 `sql`
- 涉及 `development` 和 `production` 两个环境配置

### 2. 创建自定义迁移脚本
- 文件: `scripts/run-sql-migrations.js`
- 功能: 解析 SQL 文件中的 dollar-quoted 字符串 (`$$...$$`)，正确分割 SQL 语句
- 处理 38 个迁移文件

### 3. 执行迁移
- 成功执行 37 个迁移文件
- 创建 60 个数据库表

### 4. 创建管理员账户
- 文件: `scripts/create-admin.js`
- 用户名: `admin`
- 密码: `Willyou@2026`

## 验证结果

- ✅ 数据库连接正常
- ✅ 60 个表创建成功
- ✅ 管理员用户已创建

## 涉及文件

- `api-new/knexfile.ts` - 修复扩展名配置
- `api-new/scripts/run-sql-migrations.js` - 新建迁移脚本
- `api-new/scripts/create-admin.js` - 新建管理员创建脚本
- `api-new/scripts/check-db.js` - 新建数据库检查脚本
