# 项目开发日报

## 日期
2026-02-27

## 工作内容

### 1. 水底探宝帖子图片功能优化

#### 需求背景
用户希望在"水底探宝"论坛的帖子和回复中支持图片上传功能，包括：
- 发布帖子时上传图片
- 回复帖子时上传图片
- 支持 Ctrl+V 粘贴图片
- 支持多张图片

#### 技术实现

1. **新增组件**
   - `Postx` - 图片ImageUploader.ts上传组件，支持点击上传和粘贴上传
   - `ImagePreview.tsx` - 图片预览组件，支持缩放、旋转、切换

2. **数据库设计**
   - 帖子内容存储为 JSON 格式：`{ text: string, images: string[] }`
   - 图片 URL 存储在数据库的 content 字段中

3. **文件上传处理**
   - 上传路径：`/storage/v1/object/files/forum`
   - 使用本地 blob URL 预览，解决跨域问题
   - 保存时转换 URL 为 MinIO 地址

4. **图片预览功能**
   - 帖子列表：点击缩略图打开预览
   - 帖子详情：点击图片打开预览
   - 支持功能：
     - 缩放（放大/缩小）
     - 旋转
     - 键盘左右箭头切换
     - 缩略图导航

#### 修改文件
| 文件 | 说明 |
|-----|------|
| `src/pages/water/components/PostImageUploader.tsx` | 新增图片上传组件 |
| `src/pages/water/components/ImagePreview.tsx` | 新增图片预览组件 |
| `src/pages/water/ForumTab.tsx` | 发帖支持图片、列表预览 |
| `src/pages/water/ForumPostDetailPage.tsx` | 回复支持图片、详情预览 |
| `src/services/fileService.ts` | 修复上传路径 |
| `api-new/src/routes/storage.ts` | 添加 CORS 支持 |
| `api-new/src/services/storageService.ts` | 修复 URL 返回格式 |
| `api-new/src/index.ts` | CORS 配置 |

### 2. 问题解决

1. **上传 404 错误**
   - 原因：上传路径错误
   - 解决：从 `/storage/v1/upload` 改为 `/storage/v1/object/files/forum`

2. **图片显示失败（401 未授权）**
   - 原因：MinIO 直连有跨域问题
   - 解决：使用本地 blob URL 进行预览

3. **React Key 警告**
   - 解决：使用 `image.id || img-${index}` 作为 key

## 后续优化建议
1. 回复中的图片也可以添加预览功能
2. 可以考虑将图片存储到数据库而不是直接存 URL
3. 添加图片压缩功能，减少存储空间
