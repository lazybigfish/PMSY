# 消息通知系统 需求规格说明书

## 1. 背景 (Context)

PMSY项目管理平台当前已具备基础的消息通知功能（数据库存储、前端组件展示），但缺乏实时推送、通知管理、多渠道触达等核心能力。本方案旨在构建一套完整的企业级消息通知系统，实现消息的全生命周期管理，提升团队协作效率。

---

## 2. 用户故事 (User Stories)

### 2.1 消息接收
- 作为**项目成员**，我想要**实时收到任务相关的通知**，以便**及时了解工作动态**。
- 作为**项目经理**，我想要**收到项目里程碑完成的通知**，以便**掌握项目进度**。
- 作为**系统用户**，我想要**在消息中心查看所有历史通知**，以便**追溯重要信息**。

### 2.2 消息管理
- 作为**用户**，我想要**对通知进行分类筛选**，以便**快速找到关注的通知**。
- 作为**用户**，我想要**标记通知为已读/未读**，以便**管理消息状态**。
- 作为**用户**，我想要**删除不需要的通知**，以便**保持消息列表整洁**。
- 作为**用户**，我想要**一键清空已读通知**，以便**批量清理消息**。

### 2.3 通知设置
- 作为**用户**，我想要**自定义接收哪些类型的通知**，以便**避免信息过载**。
- 作为**用户**，我想要**设置免打扰时段**，以便**在专注时不被打断**。
- 作为**用户**，我想要**选择通知渠道（站内/邮件/短信）**，以便**按紧急程度接收**。

### 2.4 系统管理
- 作为**系统管理员**，我想要**查看系统通知发送统计**，以便**监控通知服务质量**。
- 作为**系统管理员**，我想要**配置通知模板**，以便**统一消息格式**。

---

## 3. 验收标准 (Acceptance Criteria - EARS)

### 3.1 实时消息推送
- **前置条件**: 当用户已登录系统时...
- **触发器**: 如果有新的通知产生...
- **响应**: 系统应当通过 WebSocket 实时推送通知到客户端，并在导航栏显示未读数角标。

### 3.2 消息中心页面
- **前置条件**: 当用户进入消息中心页面时...
- **触发器**: 如果用户打开消息中心...
- **响应**: 系统应当以列表形式展示通知，支持按类型/状态/时间筛选，支持分页加载。

### 3.3 通知分类筛选
- **前置条件**: 当用户在消息中心时...
- **触发器**: 如果用户点击筛选条件（全部/任务/项目/系统/@我）...
- **响应**: 系统应当实时过滤并展示符合条件的通知。

### 3.4 消息已读管理
- **前置条件**: 当用户查看通知时...
- **触发器**: 如果用户点击单条通知或"全部已读"按钮...
- **响应**: 系统应当将通知标记为已读，并更新未读数角标。

### 3.5 通知偏好设置
- **前置条件**: 当用户进入个人设置时...
- **触发器**: 如果用户修改通知偏好（开关/渠道/免打扰）...
- **响应**: 系统应当保存设置，并按新配置发送后续通知。

### 3.6 通知点击跳转
- **前置条件**: 当通知包含关联链接时...
- **触发器**: 如果用户点击通知条目...
- **响应**: 系统应当自动标记为已读，并跳转到对应页面（任务详情/项目看板等）。

### 3.7 通知模板配置
- **前置条件**: 当管理员进入系统管理时...
- **触发器**: 如果管理员编辑通知模板...
- **响应**: 系统应当保存模板，并应用于后续同类通知。

---

## 4. 边缘情况与风险 (Edge Cases)

| 场景 | 处理方案 |
|------|----------|
| 用户离线时收到通知 | 消息持久化存储，用户上线后拉取未读消息 |
| WebSocket连接断开 | 自动重连机制，重连后同步离线期间的消息 |
| 大量通知并发 | 消息队列削峰，分批推送，避免客户端卡顿 |
| 用户设置免打扰 | 站内通知静默，紧急通知仍通过短信/邮件发送 |
| 通知关联资源被删除 | 点击时提示"相关内容已不存在"，并标记为已读 |
| 浏览器不支持WebSocket | 降级为轮询机制，保证基础功能可用 |
| 用户同时多设备登录 | 所有设备同步接收通知，已读状态实时同步 |

---

## 5. 通知类型定义

| 类型 | 说明 | 触发场景示例 |
|------|------|--------------|
| task | 任务通知 | 任务分配、状态变更、截止日期提醒 |
| project | 项目通知 | 项目创建、里程碑达成、成员变动 |
| system | 系统通知 | 系统公告、功能更新、账户安全提醒 |
| mention | @我通知 | 评论中被@、描述中被@ |

---

## 6. 优先级划分

| 优先级 | 功能模块 | 说明 |
|--------|----------|------|
| P0 | 实时推送 | WebSocket实时消息推送 |
| P0 | 消息中心 | 独立的消息中心页面 |
| P1 | 通知设置 | 用户通知偏好配置 |
| P1 | 消息筛选 | 分类筛选与搜索 |
| P2 | 邮件通知 | 邮件渠道集成 |
| P2 | 通知模板 | 管理员模板配置 |
| P3 | 短信通知 | 短信渠道集成 |
| P3 | 数据统计 | 通知发送统计报表 |
