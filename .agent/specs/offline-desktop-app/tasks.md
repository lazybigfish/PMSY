# 离线桌面应用改造项目 - 实施任务清单

## 阶段一：项目初始化与基础架构搭建（第 1-2 周）

### 1.1 Electron 项目初始化
- [ ] 创建 desktop 目录结构
- [ ] 初始化 Electron 项目配置（package.json）
- [ ] 配置 TypeScript 编译环境
- [ ] 配置 Vite 多入口构建（主进程 + 渲染进程）
- [ ] 配置 ESLint + Prettier 代码规范

### 1.2 主进程基础架构
- [ ] 实现主进程入口（main/index.ts）
- [ ] 实现应用生命周期管理（app.ts）
- [ ] 实现窗口管理器（window-manager.ts）
- [ ] 实现菜单栏和托盘图标
- [ ] 实现应用自动更新检查机制

### 1.3 预加载脚本
- [ ] 创建预加载脚本（preload/index.ts）
- [ ] 定义 IPC 通信接口类型
- [ ] 实现安全的 IPC 桥接层
- [ ] 配置 CSP 安全策略

### 1.4 渲染进程集成
- [ ] 配置渲染进程入口 HTML
- [ ] 集成现有 React 应用
- [ ] 配置开发环境热更新
- [ ] 验证前端功能正常运行

## 阶段二：数据库迁移与本地存储（第 3-4 周）

### 2.1 SQLite 数据库集成
- [ ] 安装 better-sqlite3 依赖
- [ ] 实现数据库连接管理器
- [ ] 配置 Knex.js SQLite 适配器
- [ ] 实现数据库初始化逻辑

### 2.2 数据模型迁移
- [ ] 分析现有 PostgreSQL 表结构
- [ ] 创建 PostgreSQL → SQLite 类型映射表
- [ ] 转换所有表结构定义
- [ ] 转换所有索引定义
- [ ] 转换所有外键约束

### 2.3 迁移脚本开发
- [ ] 创建初始迁移脚本（001-010）
- [ ] 迁移 profiles 表
- [ ] 迁移 projects 及相关表
- [ ] 迁移 tasks 及相关表
- [ ] 迁移 suppliers 和 clients 表
- [ ] 迁移 files 和 forum 表
- [ ] 迁移系统配置表

### 2.4 数据迁移工具
- [ ] 开发 PostgreSQL 数据导出工具
- [ ] 开发 SQLite 数据导入工具
- [ ] 实现数据格式转换逻辑
- [ ] 测试数据迁移完整性

## 阶段三：后端 API 本地化（第 5-6 周）

### 3.1 Express 服务集成
- [ ] 将现有 Express 服务迁移到主进程
- [ ] 配置 Express 在 Electron 中运行
- [ ] 实现本地 HTTP 服务（localhost:port）
- [ ] 配置请求日志和错误处理

### 3.2 API 路由适配
- [ ] 适配认证相关路由（/auth/v1/*）
- [ ] 适配数据库路由（/rest/v1/*）
- [ ] 适配文件路由（/storage/v1/*）
- [ ] 适配项目专用路由（/api/projects/*）
- [ ] 适配健康检查路由（/health）

### 3.3 业务服务迁移
- [ ] 迁移用户认证服务
- [ ] 迁移项目管理服务
- [ ] 迁移任务管理服务
- [ ] 迁移文件管理服务
- [ ] 迁移通知服务

### 3.4 前端 API 客户端适配
- [ ] 创建桌面版 API 客户端
- [ ] 实现 IPC 调用封装
- [ ] 保持与原 API 接口兼容
- [ ] 更新所有前端服务调用

## 阶段四：文件存储本地化（第 7 周）

### 4.1 本地文件系统服务
- [ ] 实现文件存储服务（FileStorageService）
- [ ] 配置文件存储路径（userData/files）
- [ ] 实现文件上传接口
- [ ] 实现文件下载接口
- [ ] 实现文件删除接口

### 4.2 文件管理功能
- [ ] 实现文件元数据管理
- [ ] 实现文件预览功能
- [ ] 实现文件夹管理
- [ ] 实现文件搜索功能

### 4.3 文件导入导出
- [ ] 实现数据备份功能（导出加密文件）
- [ ] 实现数据恢复功能（导入备份文件）
- [ ] 实现与在线版本的数据交换格式

## 阶段五：功能测试与优化（第 8 周）

### 5.1 功能完整性测试
- [ ] 测试用户认证流程
- [ ] 测试项目管理全流程
- [ ] 测试任务管理全流程
- [ ] 测试文件上传下载
- [ ] 测试所有页面功能

### 5.2 性能优化
- [ ] 优化数据库查询性能
- [ ] 实现查询结果缓存
- [ ] 优化大数据列表渲染
- [ ] 优化应用启动速度

### 5.3 异常处理
- [ ] 实现数据库损坏检测
- [ ] 实现自动备份机制
- [ ] 实现错误日志记录
- [ ] 实现用户友好的错误提示

## 阶段六：打包与分发（第 9 周）

### 6.1 打包配置
- [ ] 配置 electron-builder
- [ ] 配置 Windows 安装包（NSIS）
- [ ] 配置 macOS 安装包（DMG）
- [ ] 配置 Linux 安装包（AppImage/Deb）

### 6.2 代码签名
- [ ] 配置 Windows 代码签名
- [ ] 配置 macOS 代码签名
- [ ] 配置公证（Notarization）

### 6.3 自动更新
- [ ] 配置自动更新服务器
- [ ] 实现更新检查逻辑
- [ ] 实现静默下载更新
- [ ] 实现更新安装提示

### 6.4 安装程序优化
- [ ] 优化安装向导界面
- [ ] 配置默认安装路径
- [ ] 配置桌面快捷方式
- [ ] 配置卸载程序

## 阶段七：文档与交付（第 10 周）

### 7.1 技术文档
- [ ] 编写架构设计文档
- [ ] 编写数据库迁移文档
- [ ] 编写 API 接口文档
- [ ] 编写部署文档

### 7.2 用户文档
- [ ] 编写安装指南
- [ ] 编写使用手册
- [ ] 编写数据备份指南
- [ ] 编写故障排除指南

### 7.3 交付准备
- [ ] 创建发布版本
- [ ] 准备安装包
- [ ] 准备更新包
- [ ] 编写发布说明

## 关键依赖清单

### 核心依赖
```json
{
  "electron": "^28.0.0",
  "better-sqlite3": "^9.4.0",
  "knex": "^3.1.0",
  "express": "^4.18.2",
  "electron-builder": "^24.9.0",
  "electron-updater": "^6.1.0"
}
```

### 开发依赖
```json
{
  "typescript": "^5.3.0",
  "vite": "^5.0.0",
  "electron-vite": "^2.0.0",
  "@types/better-sqlite3": "^7.6.8"
}
```

## 实施路线图

```
第 1-2 周: [项目初始化与基础架构搭建]
    │
第 3-4 周: [数据库迁移与本地存储]
    │
第 5-6 周: [后端 API 本地化]
    │
第 7 周:   [文件存储本地化]
    │
第 8 周:   [功能测试与优化]
    │
第 9 周:   [打包与分发]
    │
第 10 周:  [文档与交付]
```

## 风险与应对

| 风险 | 概率 | 影响 | 应对措施 |
|------|------|------|----------|
| better-sqlite3 编译失败 | 中 | 高 | 使用预编译二进制包，配置 node-gyp 环境 |
| 数据库性能不达标 | 中 | 高 | 提前进行性能测试，准备优化方案 |
| 打包体积过大 | 高 | 中 | 代码分割，按需加载，压缩资源 |
| 跨平台兼容性问题 | 中 | 中 | CI/CD 多平台测试，虚拟机验证 |
| 数据迁移丢失 | 低 | 高 | 完整备份，分阶段验证，回滚方案 |

## 验收检查点

### 阶段一验收
- [ ] Electron 应用能正常启动
- [ ] 现有 React 应用在 Electron 中正常运行
- [ ] 开发环境热更新配置完成

### 阶段二验收
- [ ] SQLite 数据库能正常连接
- [ ] 所有表结构迁移完成
- [ ] 数据导入导出工具可用

### 阶段三验收
- [ ] 所有 API 路由在本地可用
- [ ] 前端能正常调用本地 API
- [ ] 业务功能完整可用

### 阶段四验收
- [ ] 文件上传下载功能正常
- [ ] 文件预览功能正常
- [ ] 数据备份恢复功能正常

### 阶段五验收
- [ ] 所有功能测试通过
- [ ] 性能指标达标
- [ ] 异常处理机制完善

### 阶段六验收
- [ ] Windows 安装包可用
- [ ] macOS 安装包可用
- [ ] Linux 安装包可用
- [ ] 自动更新功能正常

### 最终验收
- [ ] 所有功能完整可用
- [ ] 跨平台兼容性验证通过
- [ ] 技术文档和用户文档完成
