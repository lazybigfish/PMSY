# PMSY 移除 Supabase 依赖需求规格说明书

## 1. 背景 (Context)

当前 PMSY 项目深度依赖 Supabase 云服务（Auth、Database、Storage、Realtime），但服务器无法连接 Supabase 网络，导致本地化部署困难。需要将项目架构从 Supabase 迁移到自托管的独立组件（PostgreSQL + JWT + MinIO），同时保持前端代码不变，通过后端 API 层封装实现平滑过渡。

## 2. 用户故事 (User Stories)

- **作为** 运维人员，**我想要** 能够在无法连接外网的服务器上一键部署 PMSY，**以便** 降低部署难度和维护成本。
- **作为** 开发人员，**我想要** 开发环境使用本地 Docker 运行所有依赖组件，**以便** 提高开发效率和一致性。
- **作为** 产品经理，**我想要** 迁移过程中前端功能不受影响，**以便** 保证业务连续性。
- **作为** 系统管理员，**我想要** 使用标准 PostgreSQL 替代 Supabase 数据库，**以便** 更容易维护和备份。

## 3. 验收标准 (Acceptance Criteria - EARS)

### 3.1 开发环境部署
- **前置条件**: 当开发人员运行 `docker-compose up` 时
- **触发器**: 如果本地 Docker 环境正常
- **响应**: 系统应当启动 PostgreSQL、Redis、MinIO 和 API 服务，并在 30 秒内可访问

### 3.2 后端 API 兼容性
- **前置条件**: 当现有前端代码调用 `/rest/v1/xxx` 或 `/auth/v1/xxx` 接口时
- **触发器**: 如果请求参数符合 Supabase 格式
- **响应**: 系统应当返回与 Supabase 格式兼容的响应数据

### 3.3 用户认证功能
- **前置条件**: 当用户尝试登录时
- **触发器**: 如果用户名和密码正确
- **响应**: 系统应当返回 JWT Token，前端可正常获取用户信息和权限

### 3.4 数据库操作
- **前置条件**: 当业务页面查询、插入、更新或删除数据时
- **触发器**: 如果用户具有相应权限
- **响应**: 系统应当正确执行 CRUD 操作并返回结果

### 3.5 文件存储功能
- **前置条件**: 当用户上传或下载文件时
- **触发器**: 如果文件大小在限制范围内
- **响应**: 系统应当使用 MinIO 存储文件并返回可访问的 URL

### 3.6 实时通知功能（可选）
- **前置条件**: 当系统产生新通知时
- **触发器**: 如果用户在线
- **响应**: 系统应当通过 WebSocket 推送通知到前端

### 3.7 数据迁移
- **前置条件**: 当从 Supabase 迁移数据时
- **触发器**: 如果运行迁移脚本
- **响应**: 系统应当将所有业务数据完整迁移到新的 PostgreSQL 数据库

## 4. 边缘情况与风险 (Edge Cases)

### 4.1 边缘情况
- **JWT Token 格式不兼容**: 新系统生成的 Token 格式需要与前端解析逻辑兼容
- **RLS 策略缺失**: Supabase 的行级安全策略需要在新系统中手动实现
- **特殊字符处理**: 数据库密码、文件名等特殊字符需要正确处理
- **并发访问**: 多个用户同时操作时的数据一致性
- **大文件上传**: 超过 50MB 的文件上传处理

### 4.2 风险
- **迁移期间数据丢失**: 需要完整的数据备份和回滚方案
- **性能下降**: 自建服务可能不如 Supabase 优化，需要性能测试
- **功能缺失**: 部分 Supabase 高级功能（如 Edge Functions）可能需要重新实现
- **学习成本**: 团队成员需要适应新的架构和部署流程

## 5. 非功能性需求

### 5.1 性能要求
- API 响应时间 < 200ms（95% 请求）
- 数据库查询时间 < 100ms（简单查询）
- 文件上传速度 > 5MB/s

### 5.2 安全要求
- 密码使用 bcrypt 加密存储
- JWT Token 设置合理的过期时间（建议 7 天）
- API 接口需要验证 Token
- 数据库连接使用 SSL（生产环境）

### 5.3 可用性要求
- 系统可用性 > 99.5%
- 支持 graceful shutdown
- 数据库自动备份

## 6. 技术约束

- 前端代码保持不动，通过 API 层兼容
- 使用本地 Docker 运行开发环境
- 数据库使用标准 PostgreSQL 15+
- 文件存储使用 MinIO（S3 兼容）
- 后端使用 Node.js + Express + TypeScript
- 缓存使用 Redis
