# ä»»åŠ¡ä¾èµ–å…³ç³»æŠ€æœ¯è®¾è®¡æ–‡æ¡£

## 1. ç³»ç»Ÿæ¦‚è¦ (System Summary)

æœ¬åŠŸèƒ½ä¸ºä»»åŠ¡ç³»ç»Ÿå¢åŠ ä¾èµ–å…³ç³»ç®¡ç†æ¨¡å—ï¼Œé€šè¿‡æ•°æ®åº“è¡¨è®°å½•ä»»åŠ¡é—´çš„ä¾èµ–å…³ç³»ï¼Œæä¾› API æ¥å£æ”¯æŒä¾èµ–çš„å¢åˆ æ”¹æŸ¥ï¼Œå¹¶åœ¨å‰ç«¯ä»»åŠ¡è¯¦æƒ…é¡µå±•ç¤ºä¾èµ–å…³ç³»ã€‚

**æŠ€æœ¯è·¯çº¿**ï¼š
- æ–°å¢ `task_dependencies` æ•°æ®åº“è¡¨
- æ–°å¢ä¾èµ–ç®¡ç† API æ¥å£
- å‰ç«¯ä»»åŠ¡è¯¦æƒ…é¡µå¢åŠ ä¾èµ–ç®¡ç† UI

---

## 2. æ•°æ®åº“è®¾è®¡

### 2.1 è¡¨ç»“æ„

```sql
CREATE TABLE task_dependencies (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  task_id UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,
  depends_on_task_id UUID NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,
  dependency_type VARCHAR(2) NOT NULL DEFAULT 'FS',
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

  UNIQUE(task_id, depends_on_task_id)
);

CREATE INDEX idx_task_dependencies_task_id ON task_dependencies(task_id);
CREATE INDEX idx_task_dependencies_depends_on ON task_dependencies(depends_on_task_id);
```

### 2.2 ä¾èµ–ç±»å‹è¯´æ˜

| ç±»å‹ | åç§° | è¯´æ˜ |
|------|------|------|
| FS | å®Œæˆâ†’å¼€å§‹ | å‰ç½®ä»»åŠ¡å®Œæˆåæ‰å¼€å§‹ï¼ˆé»˜è®¤ï¼‰ |
| SS | å¼€å§‹â†’å¼€å§‹ | å‰ç½®ä»»åŠ¡å¼€å§‹åå¼€å§‹ |
| FF | å®Œæˆâ†’å®Œæˆ | å‰ç½®ä»»åŠ¡å®Œæˆåæ‰èƒ½å®Œæˆ |
| SF | å¼€å§‹â†’å®Œæˆ | å‰ç½®ä»»åŠ¡å¼€å§‹åæ‰èƒ½å®Œæˆ |

---

## 3. API æ¥å£è®¾è®¡

### 3.1 è·å–ä»»åŠ¡ä¾èµ–

```
GET /tasks/:taskId/dependencies

Response:
{
  "dependencies": [
    {
      "id": "uuid",
      "task_id": "uuid",
      "depends_on_task_id": "uuid",
      "dependency_type": "FS",
      "depends_on_task": {
        "id": "uuid",
        "title": "ä»»åŠ¡æ ‡é¢˜",
        "status": "todo",
        "due_date": "2024-01-15"
      }
    }
  ],
  "dependents": [
    {
      "id": "uuid",
      "task_id": "uuid",
      "depends_on_task_id": "uuid",
      "dependency_type": "FS",
      "task": {
        "id": "uuid",
        "title": "åç»­ä»»åŠ¡æ ‡é¢˜"
      }
    }
  ]
}
```

### 3.2 æ·»åŠ ä¾èµ–

```
POST /tasks/:taskId/dependencies

Body:
{
  "depends_on_task_id": "uuid",
  "dependency_type": "FS"
}

Response:
{
  "id": "uuid",
  "task_id": "uuid",
  "depends_on_task_id": "uuid",
  "dependency_type": "FS"
}
```

### 3.3 åˆ é™¤ä¾èµ–

```
DELETE /tasks/:taskId/dependencies/:dependencyId

Response: 204 No Content
```

---

## 4. å¾ªç¯æ£€æµ‹ç®—æ³•

### 4.1 æ£€æµ‹é€»è¾‘

```typescript
function hasCycle(taskId: string, newDependsOnId: string, existingDependencies: Map<string, string[]>): boolean {
  // æ„å»ºä¾èµ–å›¾
  const graph = new Map<string, string[]>();
  for (const [task, deps] of existingDependencies) {
    if (!graph.has(task)) graph.set(task, []);
    graph.get(task)!.push(...deps);
  }

  // æ·»åŠ æ–°è¾¹
  if (!graph.has(taskId)) graph.set(taskId, []);
  graph.get(taskId)!.push(newDependsOnId);

  // DFS æ£€æµ‹å¾ªç¯
  const visited = new Set<string>();
  const recursionStack = new Set<string>();

  function dfs(node: string): boolean {
    visited.add(node);
    recursionStack.add(node);

    const neighbors = graph.get(node) || [];
    for (const neighbor of neighbors) {
      if (!visited.has(neighbor)) {
        if (dfs(neighbor)) return true;
      } else if (recursionStack.has(neighbor)) {
        return true;
      }
    }

    recursionStack.delete(node);
    return false;
  }

  for (const node of graph.keys()) {
    if (!visited.has(node)) {
      if (dfs(node)) return true;
    }
  }

  return false;
}
```

### 4.2 éªŒè¯åœºæ™¯

| åœºæ™¯ | ç»“æœ |
|------|------|
| Aâ†’B æ·»åŠ  Bâ†’A | âŒ æ£€æµ‹åˆ°å¾ªç¯ |
| Aâ†’B æ·»åŠ  Bâ†’C æ·»åŠ  Câ†’A | âŒ æ£€æµ‹åˆ°å¾ªç¯ |
| Aâ†’B æ·»åŠ  Câ†’A | âœ… å…è®¸ |
| Aâ†’B æ·»åŠ  Bâ†’C | âœ… å…è®¸ |

---

## 5. å‰ç«¯è®¾è®¡

### 5.1 ä»»åŠ¡è¯¦æƒ…é¡µå¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä»»åŠ¡æ ‡é¢˜                        [ç¼–è¾‘] [åˆ é™¤] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åŸºæœ¬ä¿¡æ¯                               â”‚
â”‚  - çŠ¶æ€: è¿›è¡Œä¸­                        â”‚
â”‚  - ä¼˜å…ˆçº§: é«˜                          â”‚
â”‚  - å¼€å§‹æ—¥æœŸ: 2024-01-01               â”‚
â”‚  - æˆªæ­¢æ—¥æœŸ: 2024-01-15               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä¾èµ–å…³ç³»                    [+ æ·»åŠ ä¾èµ–] â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ å‰ç½®ä»»åŠ¡:                            â”‚â”‚
â”‚ â”‚ â–¡ ä»»åŠ¡A (è¿›è¡Œä¸­) æˆªæ­¢:01-10    [Ã—] â”‚â”‚
â”‚ â”‚ â–¡ ä»»åŠ¡B (å·²å®Œæˆ) æˆªæ­¢:01-12    [Ã—] â”‚â”‚
â”‚ â”‚                                     â”‚â”‚
â”‚ â”‚ åç»­ä»»åŠ¡:                            â”‚â”‚
â”‚ â”‚ â–¡ ä»»åŠ¡C (å¾…åŠ) æˆªæ­¢:01-20          â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 æ·»åŠ ä¾èµ–å¼¹çª—

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ·»åŠ ä¾èµ–                    [Ã—]      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é€‰æ‹©å‰ç½®ä»»åŠ¡:                       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ ğŸ” æœç´¢ä»»åŠ¡...                  â”‚â”‚
â”‚ â”‚                                 â”‚â”‚
â”‚ â”‚ â—‹ ä»»åŠ¡A - è¿›è¡Œä¸­ - 01-10       â”‚â”‚
â”‚ â”‚ â— ä»»åŠ¡B - å·²å®Œæˆ - 01-12       â”‚â”‚ â† é€‰æ‹© â”‚
â”‚ â”‚ â—‹ ä»»åŠ¡C - å¾…åŠ - 01-15         â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                     â”‚
â”‚ ä¾èµ–ç±»å‹:                           â”‚
â”‚ (â—) å®Œæˆâ†’å¼€å§‹ (é»˜è®¤)                â”‚
â”‚ ( ) å¼€å§‹â†’å¼€å§‹                        â”‚
â”‚ ( ) å®Œæˆâ†’å®Œæˆ                        â”‚
â”‚ ( ) å¼€å§‹â†’å®Œæˆ                        â”‚
â”‚                                     â”‚
â”‚              [å–æ¶ˆ]  [ç¡®å®šæ·»åŠ ]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. æ–‡ä»¶å˜æ›´æ¸…å•

### 6.1 åç«¯

| æ–‡ä»¶ | æ“ä½œ |
|------|------|
| `api-new/database/migrations/` | æ–°å¢è¿ç§»è„šæœ¬ |
| `api-new/src/routes/tasks.ts` | æ–°å¢ä¾èµ– API |
| `api-new/src/services/taskDependencyService.ts` | æ–°å¢æœåŠ¡ |

### 6.2 å‰ç«¯

| æ–‡ä»¶ | æ“ä½œ |
|------|------|
| `src/types/task.ts` | æ–°å¢ä¾èµ–ç±»å‹ |
| `src/services/taskService.ts` | æ–°å¢ä¾èµ–æ–¹æ³• |
| `src/pages/tasks/components/TaskDetail.tsx` | æ–°å¢ä¾èµ–ç®¡ç† UI |
| `src/components/task/TaskDependencyModal.tsx` | æ–°å¢æ·»åŠ ä¾èµ–å¼¹çª— |

---

## 7. éªŒè¯æ–¹æ¡ˆ

### 7.1 åŠŸèƒ½éªŒè¯
- [ ] æ·»åŠ ä¾èµ–æˆåŠŸ
- [ ] åˆ é™¤ä¾èµ–æˆåŠŸ
- [ ] æŸ¥çœ‹ä¾èµ–åˆ—è¡¨æ­£ç¡®
- [ ] å¾ªç¯ä¾èµ–è¢«é˜»æ­¢

### 7.2 è¾¹ç¼˜éªŒè¯
- [ ] è·¨é¡¹ç›®ä¾èµ–è¢«é˜»æ­¢
- [ ] è‡ªå¼•ç”¨ä¾èµ–è¢«é˜»æ­¢
- [ ] åˆ é™¤ä»»åŠ¡æ—¶ä¾èµ–çº§è”åˆ é™¤

### 7.3 ç”˜ç‰¹å›¾é›†æˆ
- [ ] ç”˜ç‰¹å›¾æ­£ç¡®æ˜¾ç¤ºä¾èµ–ç®­å¤´
- [ ] ä¾èµ–ä»»åŠ¡æ—¶é—´æ¡æ­£ç¡®å…³è”
