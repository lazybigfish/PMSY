# 任务依赖关系需求规格说明书

## 1. 背景 (Context)
为任务系统增加任务依赖关系管理功能，支持任务间的阻塞关系（前置任务），使项目管理者能够清晰了解任务间的依赖关系和执行顺序，为甘特图展示提供数据支持。

## 2. 用户故事 (User Stories)
- 作为**项目经理**，我希望为任务设置前置任务，以便明确任务的执行顺序和阻塞关系。
- 作为**项目成员**，我希望查看任务的依赖关系，以便了解哪些任务完成后才能开始自己的工作。
- 作为**系统**，我希望自动检测循环依赖，避免设置死循环。

## 3. 验收标准 (Acceptance Criteria - EARS)

### 3.1 依赖关系创建
- **前置条件**: 用户在任务详情页面
- **触发器**: 用户点击"添加依赖"按钮
- **响应**: 系统弹出任务选择器，显示同一项目的其他任务供选择

### 3.2 依赖类型
- **前置条件**: 用户选择依赖任务
- **触发器**: 用户选择依赖类型
- **响应**: 系统支持以下依赖类型：
  - **完成→开始 (FS)**：前置任务完成后才开始（默认）
  - **开始→开始 (SS)**：前置任务开始后开始
  - **完成→完成 (FF)**：前置任务完成后才能完成
  - **开始→完成 (SF)**：前置任务开始后才能完成

### 3.3 循环依赖检测
- **前置条件**: 用户尝试创建依赖
- **触发器**: 用户选择目标任务
- **响应**:
  - 如果形成循环，系统显示错误提示："不能创建循环依赖"
  - 阻止保存依赖关系

### 3.4 依赖关系展示
- **前置条件**: 任务存在依赖任务
- **触发器**: 查看任务详情
- **响应**:
  - 显示"前置任务"列表
  - 显示"后续任务"列表（被依赖的任务）
  - 依赖任务显示：任务标题、状态、截止日期

### 3.5 依赖任务状态联动
- **前置条件**: 前置任务状态变更
- **触发器**: 前置任务标记为"已完成"
- **响应**: 检查依赖该任务的其他任务，如果有"阻塞中"状态，可提示用户

### 3.6 依赖关系删除
- **前置条件**: 用户查看依赖列表
- **触发器**: 用户点击删除按钮
- **响应**: 移除依赖关系，更新数据库

## 4. 边缘情况与风险

### 4.1 跨项目依赖
- 限制：任务只能依赖同一项目内的任务，不能跨项目

### 4.2 自引用依赖
- 限制：任务不能依赖自己

### 4.3 批量操作
- 删除项目时，级联删除相关的依赖关系

### 4.4 数据迁移
- 现有任务需要兼容，依赖字段可选

---

## 5. 数据模型设计

### 5.1 数据库表: task_dependencies

| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| task_id | UUID | 依赖任务ID（当前任务） |
| depends_on_task_id | UUID | 被依赖的任务ID（前置任务） |
| dependency_type | VARCHAR | 依赖类型：FS/SS/FF/SF |
| created_by | UUID | 创建人 |
| created_at | TIMESTAMP | 创建时间 |

### 5.2 约束
- 唯一约束：(task_id, depends_on_task_id)
- 外键约束：task_id → tasks.id
- 外键约束：depends_on_task_id → tasks.id

---

## 6. 功能优先级

| 功能 | 优先级 | 说明 |
|------|--------|------|
| 创建依赖关系 | P0 | 核心功能 |
| 循环检测 | P0 | 防止数据错误 |
| 查看依赖列表 | P0 | 展示功能 |
| 删除依赖 | P0 | 基础操作 |
| 依赖类型选择 | P1 | 增强功能 |
| 状态联动提示 | P2 | 优化功能 |
