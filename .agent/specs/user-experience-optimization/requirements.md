# 用户体验优化需求规格说明书

## 1. 背景 (Context)

PMSY 系统核心功能已基本实现，为提升用户使用体验和数据质量，需要对以下四个关键场景进行优化：
1. **数据唯一性保障** - 防止重复创建项目、任务、供应商、客户
2. **供应商外采金额管控** - 实时提示剩余可外采金额，避免超支
3. **客户回款深度管理** - 将客户回款与供应商付款联动，确保资金安全
4. **合同外需求追踪** - 管理客户提出的合同外额外需求及支出

---

## 2. 用户故事 (User Stories)

### 2.1 查重机制
- 作为 **项目经理**，我想要 **创建项目/任务时系统自动检查名称是否重复**，以便 **避免重复创建相同内容，保持数据整洁**
- 作为 **采购人员**，我想要 **创建供应商/客户时检查名称是否已存在**，以便 **维护统一的供应商/客户库**
- 作为 **任务执行者**，我想要 **任务名查重只在我可见的任务范围内进行**，以便 **不同项目可以有相同名称的任务而不冲突**

### 2.2 供应商外采金额提示
- 作为 **项目经理**，我想要 **关联供应商时看到剩余可外采金额**，以便 **合理规划供应商合同金额分配**
- 作为 **项目经理**，我想要 **当剩余金额低于10%时收到醒目提醒**，以便 **及时预警项目预算风险**

### 2.3 客户回款管理
- 作为 **项目经理**，我想要 **在项目详情中记录客户回款情况**，以便 **实时掌握项目资金流入**
- 作为 **财务人员**，我想要 **给供应商确认付款时检查客户回款是否充足**，以便 **避免超付风险**

### 2.4 合同外需求管理
- 作为 **项目经理**，我想要 **记录客户提出的合同外需求**，以便 **追踪额外工作内容和成本**
- 作为 **项目经理**，我想要 **管理合同外需求的采购支出**，以便 **准确核算项目真实成本**

---

## 3. 验收标准 (Acceptance Criteria - EARS)

### 3.1 查重机制

#### 3.1.1 项目名称查重
- **前置条件**: 当用户填写项目名称时
- **触发器**: 如果用户输入的项目名称与系统中已存在的项目名称（不区分大小写、去除前后空格后）相同
- **响应**: 系统应当 **实时提示"项目名称已存在"，并阻止表单提交**

#### 3.1.2 供应商名称查重
- **前置条件**: 当用户填写供应商名称时
- **触发器**: 如果用户输入的供应商名称与供应商库中已存在的名称相同
- **响应**: 系统应当 **实时提示"供应商已存在"，并显示已有供应商的基本信息**

#### 3.1.3 客户名称查重
- **前置条件**: 当用户填写客户名称时
- **触发器**: 如果用户输入的客户名称与客户库中已存在的名称相同
- **响应**: 系统应当 **实时提示"客户已存在"，并显示已有客户的基本信息**

#### 3.1.4 任务名称查重（范围限定）
- **前置条件**: 当用户在项目内创建/编辑任务时
- **触发器**: 如果用户输入的任务名称与当前用户**可见范围内**的已存在任务名称相同
- **响应**: 系统应当 **提示"该任务名称已存在"，但允许用户继续提交（警告级别）**

**可见范围定义**:
| 用户角色 | 可见任务范围 |
|---------|-------------|
| 系统管理员 | 系统中所有任务 |
| 项目经理 | 其管理的项目内的所有任务 + 其创建的任务 + 其作为处理人的任务 |
| 普通用户 | 其创建的任务 + 其作为处理人的任务 + 公开项目中的任务 |

### 3.2 供应商外采金额提示

#### 3.2.1 剩余可外采金额计算
- **前置条件**: 当用户在项目详情页打开"关联供应商"弹窗时
- **触发器**: 弹窗加载完成
- **响应**: 系统应当 **显示以下信息**：
  - 项目总金额
  - 已关联供应商的合同金额合计
  - 剩余可外采金额 = 项目金额 - 已关联供应商合同金额合计

#### 3.2.2 低余额预警
- **前置条件**: 当剩余可外采金额低于项目金额的10%时
- **触发器**: 用户打开关联供应商弹窗或修改供应商合同金额时
- **响应**: 系统应当 **以红色/橙色醒目提示"剩余可外采金额不足10%，请合理规划"**

#### 3.2.3 超额阻止
- **前置条件**: 当用户输入的供应商合同金额大于剩余可外采金额时
- **触发器**: 用户尝试保存供应商关联
- **响应**: 系统应当 **阻止保存，并提示"合同金额超出剩余可外采金额，请调整"**

### 3.3 客户回款管理

#### 3.3.1 回款记录管理
- **前置条件**: 当用户在项目详情页时
- **触发器**: 用户点击"回款管理"Tab
- **响应**: 系统应当 **显示**：
  - 项目合同金额
  - 已回款金额合计
  - 未回款金额 = 合同金额 - 已回款金额
  - 回款记录列表（回款时间、金额、付款方式、备注）
  - "新增回款"按钮

#### 3.3.2 新增回款
- **前置条件**: 当用户点击"新增回款"按钮时
- **触发器**: 用户填写回款信息并提交
- **响应**: 系统应当 **创建回款记录，并更新项目回款统计**

#### 3.3.2.1 回款比例输入方式
- **前置条件**: 当用户打开"新增回款"弹窗时
- **触发器**: 弹窗加载完成
- **响应**: 系统应当 **提供两种回款金额输入方式**：
  1. **比例输入方式**（默认）：
     - 显示进度条（0% - 100%），支持拖动选择
     - 显示数字输入框，支持直接输入百分比（精确到0.01%）
     - 回款金额 = 比例 × 合同金额（自动计算并显示）
  2. **金额输入方式**：
     - 直接输入回款金额
     - 自动计算并显示对应比例

#### 3.3.2.2 回款比例校验
- **前置条件**: 当用户调整回款比例/金额时
- **触发器**: 比例或金额发生变化
- **响应**: 系统应当 **实时校验**：
  - 计算当前所有回款记录的比例合计
  - 若本次回款后总比例 > 100%，显示错误提示"回款比例合计不能超过100%，当前已回款XX%"
  - 阻止提交按钮，直至比例调整到合法范围

#### 3.3.2.3 回款比例显示
- **前置条件**: 当用户查看回款记录时
- **触发器**: 回款列表加载完成
- **响应**: 系统应当 **显示每条回款记录的比例**（占合同金额的百分比）

#### 3.3.3 供应商付款余额检查
- **前置条件**: 当用户在供应商付款页面点击"确认付款"时
- **触发器**: 确认付款操作触发
- **响应**: 系统应当 **检查**：
  - 该项目客户已回款金额合计
  - 该项目已确认支付给供应商的金额合计
  - 若本次付款后，累计供应商付款 > 客户回款金额，则弹出二次确认对话框

#### 3.3.4 二次确认对话框
- **前置条件**: 当供应商付款超出客户回款时
- **触发器**: 用户尝试确认付款
- **响应**: 系统应当 **显示对话框**：
  - 标题："付款确认"
  - 内容："客户回款金额（¥X）不足以覆盖本次付款后累计供应商付款（¥Y），差额为¥Z。是否继续付款？"
  - 按钮："取消" / "仍要付款"

### 3.4 合同外需求管理

#### 3.4.1 合同外需求列表
- **前置条件**: 当用户在项目详情页时
- **触发器**: 用户点击"合同外需求"Tab
- **响应**: 系统应当 **显示合同外需求列表**：
  - 需求名称
  - 需求描述
  - 提出时间
  - 预估成本
  - 实际支出
  - 状态（待评估/已批准/已拒绝/已完成）

#### 3.4.2 新增合同外需求
- **前置条件**: 当用户点击"新增需求"按钮时
- **触发器**: 用户填写需求信息并提交
- **响应**: 系统应当 **创建合同外需求记录，状态默认为"待评估"**

#### 3.4.3 需求状态流转
- **前置条件**: 当需求状态为"待评估"时
- **触发器**: 用户点击"批准"或"拒绝"
- **响应**: 系统应当 **更新需求状态，若批准则允许后续记录实际支出**

#### 3.4.4 支出记录
- **前置条件**: 当需求状态为"已批准"或"已完成"时
- **触发器**: 用户点击"记录支出"
- **响应**: 系统应当 **允许用户记录实际支出金额、支出时间、供应商、备注**

---

## 4. 边缘情况与风险 (Edge Cases)

### 4.1 查重机制
| 边缘情况 | 处理方案 |
|---------|---------|
| 用户输入与已有名称只有空格差异 | 去除前后空格后比较 |
| 用户输入与已有名称只有大小写差异 | 不区分大小写比较 |
| 用户输入与已有名称只有全半角差异 | 统一转为半角后比较 |
| 任务查重时用户无可见任务 | 不进行查重提示 |
| 网络延迟导致查重结果滞后 | 提交时再次校验，最终阻止重复提交 |

### 4.2 供应商外采金额
| 边缘情况 | 处理方案 |
|---------|---------|
| 项目金额为0或未设置 | 不显示剩余金额提示，仅显示警告"项目金额未设置" |
| 多个用户同时关联供应商 | 使用数据库事务确保金额计算准确 |
| 已关联供应商合同金额被修改 | 实时重新计算剩余金额 |
| 项目金额被修改 | 重新计算剩余金额，若已超支则标记警告 |

### 4.3 客户回款管理
| 边缘情况 | 处理方案 |
|---------|---------|
| 项目未关联客户 | 回款管理Tab显示提示"请先关联客户" |
| 回款金额大于合同金额 | 允许记录，但标记为"超额回款"并提示 |
| 回款记录需要修改/删除 | 仅管理员或创建者可修改，保留修改历史 |

### 4.4 合同外需求
| 边缘情况 | 处理方案 |
|---------|---------|
| 实际支出超过预估成本 | 允许记录，但标记警告"超出预估" |
| 需求被拒绝后重新提出 | 创建新记录，保留历史记录 |
| 合同外需求需要关联供应商 | 支持选择供应商并记录采购支出 |

---

## 5. 数据模型扩展

### 5.1 新增表

#### client_payments（客户回款记录表）
```sql
CREATE TABLE IF NOT EXISTS client_payments (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID REFERENCES projects(id) ON DELETE CASCADE NOT NULL,
    client_id UUID REFERENCES clients(id) ON DELETE CASCADE NOT NULL,
    amount DECIMAL(15, 2) NOT NULL,
    payment_date DATE NOT NULL,
    payment_method TEXT,
    notes TEXT,
    created_by UUID REFERENCES profiles(id),
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);
```

#### extra_requirements（合同外需求表）
```sql
CREATE TABLE IF NOT EXISTS extra_requirements (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID REFERENCES projects(id) ON DELETE CASCADE NOT NULL,
    name TEXT NOT NULL,
    description TEXT,
    estimated_cost DECIMAL(15, 2),
    actual_cost DECIMAL(15, 2) DEFAULT 0,
    status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'approved', 'rejected', 'completed')),
    requested_by TEXT,
    request_date DATE,
    approval_date DATE,
    approved_by UUID REFERENCES profiles(id),
    completion_date DATE,
    notes TEXT,
    created_by UUID REFERENCES profiles(id),
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);
```

#### extra_requirement_expenses（合同外需求支出表）
```sql
CREATE TABLE IF NOT EXISTS extra_requirement_expenses (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    requirement_id UUID REFERENCES extra_requirements(id) ON DELETE CASCADE NOT NULL,
    amount DECIMAL(15, 2) NOT NULL,
    expense_date DATE NOT NULL,
    supplier_id UUID REFERENCES suppliers(id),
    description TEXT,
    created_by UUID REFERENCES profiles(id),
    created_at TIMESTAMPTZ DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMPTZ DEFAULT NOW() NOT NULL
);
```

### 5.2 索引
```sql
-- 客户回款记录索引
CREATE INDEX IF NOT EXISTS idx_client_payments_project_id ON client_payments(project_id);
CREATE INDEX IF NOT EXISTS idx_client_payments_client_id ON client_payments(client_id);
CREATE INDEX IF NOT EXISTS idx_client_payments_payment_date ON client_payments(payment_date);

-- 合同外需求索引
CREATE INDEX IF NOT EXISTS idx_extra_requirements_project_id ON extra_requirements(project_id);
CREATE INDEX IF NOT EXISTS idx_extra_requirements_status ON extra_requirements(status);

-- 合同外需求支出索引
CREATE INDEX IF NOT EXISTS idx_extra_req_expenses_requirement_id ON extra_requirement_expenses(requirement_id);
CREATE INDEX IF NOT EXISTS idx_extra_req_expenses_supplier_id ON extra_requirement_expenses(supplier_id);
```

---

## 6. 界面原型

### 6.1 查重提示示例
```
┌─────────────────────────────────────────┐
│ 创建项目                                │
├─────────────────────────────────────────┤
│                                         │
│ 项目名称 *                              │
│ ┌─────────────────────────────────────┐ │
│ │ 智慧园区建设项目                    │ │
│ └─────────────────────────────────────┘ │
│ ⚠️ 项目名称已存在，请确认是否继续      │
│                                         │
│ [取消]          [仍要创建]              │
│                                         │
└─────────────────────────────────────────┘
```

### 6.2 供应商外采金额提示
```
┌─────────────────────────────────────────────────────────────┐
│ 关联供应商                                          [×]     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐  │
│  │  项目金额    │  │  已外采金额  │  │  剩余可外采金额  │  │
│  │  ¥1,000,000 │  │  ¥920,000   │  │  ¥80,000        │  │
│  └──────────────┘  └──────────────┘  └──────────────────┘  │
│                                                             │
│  🔴 警告：剩余可外采金额不足10%，请合理规划！               │
│                                                             │
│  ─────────────────────────────────────────────────────────  │
│                                                             │
│  供应商: [请选择供应商 ▼]                                   │
│                                                             │
│  合同金额: [¥              ]                                │
│  ⚠️ 合同金额不能超过剩余可外采金额 ¥80,000                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.3 项目回款管理Tab
```
┌─────────────────────────────────────────────────────────────┐
│ [项目概览] [功能模块] [里程碑] [风险] [供应商] [回款管理] [合同外需求] │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  合同金额    │  │  已回款金额  │  │  未回款金额  │      │
│  │  ¥1,000,000 │  │  ¥600,000   │  │  ¥400,000   │      │
│  │   (100%)    │  │    (60%)    │  │    (40%)    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
│                                                             │
│  [+ 新增回款]                                               │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 回款时间   │ 回款金额   │ 比例    │ 付款方式   │ 操作 │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │ 2026-01-15 │ ¥200,000  │  20%   │ 银行转账   │ [删除]│   │
│  │ 2026-02-20 │ ¥400,000  │  40%   │ 银行转账   │ [删除]│   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.3.1 新增回款弹窗（比例输入方式）
```
┌─────────────────────────────────────────────────────────────┐
│ 新增回款                                            [×]     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  合同金额: ¥1,000,000 (100%)                               │
│  已回款比例: 60%                                           │
│  剩余可回款比例: 40%                                        │
│                                                             │
│  ─────────────────────────────────────────────────────────  │
│                                                             │
│  输入方式: [● 按比例] [○ 按金额]                           │
│                                                             │
│  回款比例:                                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  [━━━━━━━━━━━━●━━━━━━━━━━━━━━━━━━━━━━━━━━━━━] 35%  │   │
│  └─────────────────────────────────────────────────────┘   │
│  比例值: [  35.00  ] %                                     │
│                                                             │
│  回款金额: ¥350,000.00 (自动计算)                          │
│                                                             │
│  ⚠️ 回款比例合计将超过100% (60% + 35% = 95%)              │
│                                                             │
│  回款日期: [2026-02-25          ]                          │
│                                                             │
│  付款方式: [请选择付款方式 ▼]                              │
│                                                             │
│  备注:                                                     │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│           [取消]    [确定]                                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.3.2 新增回款弹窗（金额输入方式）
```
┌─────────────────────────────────────────────────────────────┐
│ 新增回款                                            [×]     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  合同金额: ¥1,000,000 (100%)                               │
│  已回款比例: 60%                                           │
│  剩余可回款比例: 40%                                        │
│                                                             │
│  ─────────────────────────────────────────────────────────  │
│                                                             │
│  输入方式: [○ 按比例] [● 按金额]                           │
│                                                             │
│  回款金额:                                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  ¥  [  350,000.00  ]                                │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  对应比例: 35.00% (自动计算)                               │
│                                                             │
│  ⚠️ 回款比例合计将超过100% (60% + 35% = 95%)              │
│                                                             │
│  回款日期: [2026-02-25          ]                          │
│                                                             │
│  付款方式: [请选择付款方式 ▼]                              │
│                                                             │
│  备注:                                                     │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│           [取消]    [确定]                                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.4 供应商付款二次确认
```
┌─────────────────────────────────────────────────────────────┐
│ 付款确认                                                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ⚠️ 资金余额不足提醒                                        │
│                                                             │
│  客户回款金额:        ¥600,000                              │
│  已付供应商金额:      ¥550,000                              │
│  本次付款金额:        ¥100,000                              │
│  ─────────────────────────────────                          │
│  付款后累计支出:      ¥650,000                              │
│  资金缺口:            ¥50,000                               │
│                                                             │
│  客户回款不足以覆盖本次付款，是否继续？                     │
│                                                             │
│           [取消]    [仍要付款]                              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 6.5 合同外需求管理Tab
```
┌─────────────────────────────────────────────────────────────┐
│ [项目概览] [功能模块] [里程碑] [风险] [供应商] [回款管理] [合同外需求] │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [+ 新增需求]                                               │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 需求名称      │ 预估成本   │ 实际支出   │ 状态      │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │ 额外功能开发A │ ¥50,000   │ ¥45,000   │ [已完成]  │   │
│  │ 硬件升级需求B │ ¥30,000   │ -         │ [已批准]  │   │
│  │ 培训服务需求C │ ¥10,000   │ -         │ [待评估]  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 7. 性能要求

| 功能 | 响应时间要求 |
|-----|-------------|
| 名称查重（实时） | < 300ms |
| 剩余金额计算 | < 500ms |
| 回款记录加载 | < 1s |
| 合同外需求列表加载 | < 1s |
| 客户回款统计计算 | < 1s |

---

## 8. 修订记录

| 版本 | 日期 | 修订内容 | 修订人 |
|-----|------|---------|-------|
| 1.0 | 2026-02-17 | 初始版本，包含查重机制、供应商金额提示、客户回款管理、合同外需求管理四大模块 | AI Assistant |
| 1.1 | 2026-02-18 | 新增回款比例输入功能需求（3.3.2.1 - 3.3.2.3） | AI Assistant |
