# PMSY 部署优化说明

## 本次部署优化的核心变更

### 1. 绕过 Kong 网关

**问题**: Kong 网关配置复杂，每次部署容易出现问题

**解决方案**: 使用 Nginx 直接代理 Supabase 服务

| 服务 | 之前 (通过 Kong) | 现在 (直接代理) |
|------|------------------|-----------------|
| Auth | `kong:8000/auth/` → `auth:9999` | Nginx `/auth/v1/` → `auth:9999` |
| REST | `kong:8000/rest/` → `rest:3000` | Nginx `/rest/` → `rest:3000` |
| API | `kong:8000/api/` → `api:3001` | Nginx `/api/` → `api:3001` |

### 2. 配置文件变更

#### docker-compose.yml
```yaml
# 新增 auth 服务端口映射
auth:
  ports:
    - "9999:9999"

# 修复 PostgREST 数据库连接字符串
rest:
  environment:
    PGRST_DB_URI: postgres://postgres:Willyou%402026@db:5432/postgres
```

#### nginx.conf
```nginx
# Auth 服务代理（去掉 /auth/v1 前缀）
location /auth/v1/ {
    proxy_pass http://auth:9999/;
}

# REST 服务代理
location /rest/ {
    proxy_pass http://rest:3000/;
}

# API 服务代理
location /api/ {
    proxy_pass http://api:3001/api/;
}
```

#### .env.production
```env
# 使用 Nginx 直接代理（绕过 Kong 网关）
VITE_SUPABASE_URL=http://43.136.69.250
```

### 3. 部署脚本需要更新的地方

#### 3.1 更新前端构建配置检查
```bash
# 旧配置（使用 Kong 端口）
VITE_SUPABASE_URL=http://$DEPLOY_SERVER_IP:8000

# 新配置（使用 Nginx 80 端口）
VITE_SUPABASE_URL=http://$DEPLOY_SERVER_IP
```

#### 3.2 更新服务器环境变量配置
```bash
# 旧配置
sed -i "s|API_EXTERNAL_URL=.*|API_EXTERNAL_URL=http://$DEPLOY_SERVER_IP:8000|" .env
sed -i "s|SITE_URL=.*|SITE_URL=http://$DEPLOY_SERVER_IP|" .env
sed -i "s|SUPABASE_PUBLIC_URL=.*|SUPABASE_PUBLIC_URL=http://$DEPLOY_SERVER_IP:8000|" .env

# 新配置（移除 8000 端口）
sed -i "s|API_EXTERNAL_URL=.*|API_EXTERNAL_URL=http://$DEPLOY_SERVER_IP|" .env
sed -i "s|SITE_URL=.*|SITE_URL=http://$DEPLOY_SERVER_IP|" .env
sed -i "s|SUPABASE_PUBLIC_URL=.*|SUPABASE_PUBLIC_URL=http://$DEPLOY_SERVER_IP|" .env
```

#### 3.3 更新 PostgREST 密码配置
```bash
# 在部署脚本中添加自动替换 PostgREST 密码的逻辑
POSTGRES_PASSWORD=$(grep '^POSTGRES_PASSWORD=' .env | cut -d'=' -f2)
if [ -n "$POSTGRES_PASSWORD" ]; then
    # 对密码进行 URL 编码
    URL_ENCODED_PASSWORD=$(echo "$POSTGRES_PASSWORD" | sed 's/@/%40/g; s/#/%23/g; s/:/%3A/g; s/\//%2F/g; s/+/%2B/g')
    # 替换 docker-compose.yml 中的占位符
    sed -i "s|POSTGRES_PASSWORD_PLACEHOLDER|$URL_ENCODED_PASSWORD|g" docker-compose.yml
fi
```

#### 3.4 更新 API 测试 URL
```bash
# 旧测试 URL
TEST_RESULT=$(curl -s -X POST "http://$DEPLOY_SERVER_IP/api/auth/create-user" ...)
LOGIN_RESULT=$(curl -s -X POST "http://$DEPLOY_SERVER_IP:8000/auth/v1/token?grant_type=password" ...)

# 新测试 URL（移除 8000 端口）
TEST_RESULT=$(curl -s -X POST "http://$DEPLOY_SERVER_IP/api/auth/create-user" ...)
LOGIN_RESULT=$(curl -s -X POST "http://$DEPLOY_SERVER_IP/auth/v1/token?grant_type=password" ...)
```

### 4. 部署验证清单

部署完成后，验证以下端点是否正常：

```bash
# 1. 验证 Auth 服务
curl http://<服务器IP>/auth/v1/settings

# 2. 验证 REST 服务
curl http://<服务器IP>/rest/v1/ \
  -H "apikey: <ANON_KEY>"

# 3. 验证 API 服务
curl http://<服务器IP>/api/health

# 4. 验证用户创建
curl -X POST http://<服务器IP>/api/auth/create-user \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"test123","full_name":"Test"}'

# 5. 验证登录
curl -X POST http://<服务器IP>/auth/v1/token?grant_type=password \
  -H "apikey: <ANON_KEY>" \
  -H "Content-Type: application/json" \
  -d '{"email":"test@pmsy.com","password":"test123"}'
```

### 5. 故障排查

#### 问题1: Auth 服务返回 404
**原因**: Nginx 代理路径配置错误
**解决**: 确保 `location /auth/v1/` 代理到 `http://auth:9999/`

#### 问题2: PostgREST 无法连接数据库
**原因**: 密码中包含特殊字符未进行 URL 编码
**解决**: 在 docker-compose.yml 中使用 URL 编码后的密码

#### 问题3: 前端无法连接 Supabase
**原因**: VITE_SUPABASE_URL 配置错误
**解决**: 确保使用 `http://<服务器IP>` 而不是 `http://<服务器IP>:8000`

#### 问题4: JWT Token 签名无效（导航栏消失）
**症状**: 
- 导航栏不显示
- 浏览器控制台显示 `JWSError JWSInvalidSignature`
- REST API 返回 `{"code":"PGRST301","message":"JWSError JWSInvalidSignature"}`

**原因**: 
- `JWT_SECRET` 与 `VITE_SUPABASE_ANON_KEY` 不匹配
- Anon Key 是用旧的 JWT_SECRET 生成的
- 修改 `JWT_SECRET` 后没有重新生成 Token

**解决**:
```bash
# 1. 使用正确的 JWT_SECRET 重新生成 Anon Key
JWT_SECRET="你的JWT_SECRET"
# 生成新的 Anon Key（参考 generate-jwt.js 脚本）

# 2. 更新 .env.production 中的 VITE_SUPABASE_ANON_KEY
VITE_SUPABASE_ANON_KEY=新的AnonKey

# 3. 更新服务器 .env 文件
sed -i "s|VITE_SUPABASE_ANON_KEY=.*|VITE_SUPABASE_ANON_KEY=新的AnonKey|g" .env

# 4. 重新构建前端
npm run build

# 5. 重新上传 dist 目录到服务器
rsync -avz --delete dist/ ubuntu@服务器IP:/opt/pmsy/dist/
```

**预防措施**:
- 修改 `JWT_SECRET` 后，必须重新生成所有 Token
- 包括：`ANON_KEY`、`SERVICE_ROLE_KEY`
- 重新构建前端（因为 Anon Key 被硬编码在前端代码中）

#### 问题5: 导航栏消失
**症状**: 登录后导航栏不显示，页面空白或只有部分内容

**原因**: 
- 前端无法获取用户 profile 信息（因为 JWT 验证失败）
- `/rest/v1/profiles` 请求返回 404 或 401

**排查步骤**:
```bash
# 1. 检查 Nginx 日志
docker-compose logs nginx --tail=20

# 2. 检查是否有 /rest/v1/profiles 404 错误

# 3. 测试 REST API
curl http://<服务器IP>/rest/v1/profiles \
  -H "apikey: <ANON_KEY>" \
  -H "Authorization: Bearer <ANON_KEY>"

# 4. 如果返回 JWSInvalidSignature，说明 JWT 有问题
```

**解决**: 参考问题4，修复 JWT Token 签名问题

### 6. 部署问题总结清单

| 问题 | 症状 | 根本原因 | 解决方案 |
|------|------|----------|----------|
| 前端一直加载 | 白屏、无法访问 | Kong 网关配置错误 | 绕过 Kong，Nginx 直接代理 |
| API 401 错误 | 创建用户失败 | Service Role Key 无效 | 重新生成与 JWT_SECRET 匹配的 Key |
| PostgREST 重启 | 服务不断重启 | 数据库密码包含特殊字符 | URL 编码密码（@→%40） |
| 导航栏消失 | 登录后无导航 | JWT 签名不匹配 | 重新生成 Anon Key 并重建前端 |
| REST 404 | API 返回 404 | Nginx 代理路径错误 | 检查 location 配置 |

### 7. 优势总结

- ✅ **部署更简单**: 移除 Kong 网关，减少一层配置
- ✅ **更稳定**: 避免 Kong 配置问题导致的部署失败
- ✅ **性能更好**: 减少网络跳转
- ✅ **更容易调试**: 直接访问后端服务

### 8. 注意事项

1. Kong 服务仍然保留（Supabase Studio 可能依赖它），但不再通过 Kong 代理 API 请求
2. 如果需要完全移除 Kong，需要检查 Studio 服务是否依赖 Kong
3. 部署前确保防火墙开放 80 端口（Nginx）
