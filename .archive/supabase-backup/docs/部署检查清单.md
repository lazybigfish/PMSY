# PMSY 部署检查清单

## 部署前检查

### 1. 配置文件检查

- [ ] `config/env/.env.supabase` 已更新
  - [ ] `API_EXTERNAL_URL` 设置为 `http://<服务器IP>`
  - [ ] `SITE_URL` 设置为 `http://<服务器IP>`
  - [ ] `POSTGRES_PASSWORD` 已修改为强密码
  - [ ] `JWT_SECRET` 已设置为强随机字符串
  - [ ] `DASHBOARD_PASSWORD` 已修改
  - [ ] `ROOT_USER_PASSWORD` 已修改

- [ ] `config/env/.env.production` 已更新
  - [ ] `VITE_SUPABASE_URL` 设置为 `http://<服务器IP>`（不含端口）
  - [ ] `VITE_SUPABASE_ANON_KEY` 与 `.env.supabase` 一致

### 2. Docker Compose 配置检查

- [ ] `config/docker/docker-compose.yml` 已更新
  - [ ] `auth` 服务添加了端口映射 `9999:9999`
  - [ ] `rest` 服务的 `PGRST_DB_URI` 使用了 URL 编码的密码
  - [ ] `api` 服务依赖 `db` 而不是 `kong`

### 3. Nginx 配置检查

- [ ] `nginx.conf` 已更新
  - [ ] `/auth/v1/` 代理到 `http://auth:9999/`
  - [ ] `/rest/` 代理到 `http://rest:3000/`
  - [ ] `/api/` 代理到 `http://api:3001/api/`

### 4. 服务器环境检查

- [ ] 服务器已安装 Docker
- [ ] 服务器已安装 Docker Compose
- [ ] 服务器防火墙已开放 80 端口
- [ ] 服务器防火墙已开放 443 端口（如使用 HTTPS）
- [ ] 服务器有足够的磁盘空间（建议 > 10GB）
- [ ] 服务器有足够的内存（建议 > 2GB）

## 部署中检查

### 1. 构建阶段

- [ ] 前端构建成功
- [ ] 构建文件包含正确的 `VITE_SUPABASE_URL`
- [ ] API 服务镜像构建成功

### 2. 上传阶段

- [ ] 所有文件上传到服务器
- [ ] `docker-compose.yml` 权限正确
- [ ] `.env` 文件权限正确（建议 600）

### 3. 启动阶段

- [ ] 数据库服务正常启动
- [ ] Auth 服务正常启动
- [ ] REST 服务正常启动
- [ ] API 服务正常启动
- [ ] Nginx 服务正常启动

## 部署后验证

### 1. 服务端点验证

```bash
# 在服务器上执行以下验证命令

# 验证 Auth 服务
curl -s http://localhost/auth/v1/settings | grep -q "external" && echo "✅ Auth 服务正常" || echo "❌ Auth 服务异常"

# 验证 REST 服务
curl -s http://localhost/rest/v1/ -H "apikey: <ANON_KEY>" && echo "✅ REST 服务正常" || echo "❌ REST 服务异常"

# 验证 API 服务
curl -s http://localhost/api/health | grep -q "success" && echo "✅ API 服务正常" || echo "❌ API 服务异常"
```

### 2. 用户创建验证

```bash
# 测试用户创建 API
curl -X POST http://localhost/api/auth/create-user \
  -H "Content-Type: application/json" \
  -d '{
    "username": "deploytest",
    "password": "Test@123456",
    "full_name": "部署测试用户",
    "email": "deploytest@pmsy.com",
    "role": "user"
  }'

# 预期返回: {"success":true,"message":"用户创建成功",...}
```

### 3. 登录验证

```bash
# 测试登录 API
curl -X POST http://localhost/auth/v1/token?grant_type=password \
  -H "apikey: <ANON_KEY>" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "deploytest@pmsy.com",
    "password": "Test@123456"
  }'

# 预期返回: {"access_token":"...",...}
```

### 4. 前端访问验证

- [ ] 浏览器能正常访问 `http://<服务器IP>`
- [ ] 登录页面能正常加载
- [ ] 能正常登录（使用创建的用户）
- [ ] 系统管理页面能正常访问
- [ ] 能正常创建用户

### 5. 数据库验证

```bash
# 检查数据库连接
docker-compose exec db pg_isready -U postgres

# 检查表是否存在
docker-compose exec db psql -U postgres -c "\dt"

# 检查管理员用户是否存在
docker-compose exec db psql -U postgres -c "SELECT email, role FROM public.profiles WHERE role = 'admin';"
```

## 常见问题排查

### 问题1: Auth 服务返回 404

**症状**: `curl http://localhost/auth/v1/settings` 返回 404

**排查步骤**:
1. 检查 auth 服务是否运行: `docker-compose ps auth`
2. 检查 Nginx 配置: `docker-compose exec nginx cat /etc/nginx/nginx.conf | grep -A 5 "auth/v1"`
3. 检查 Nginx 错误日志: `docker-compose logs nginx`

**解决**:
```bash
# 重启 Nginx
docker-compose restart nginx

# 检查 auth 服务
docker-compose restart auth
```

### 问题2: PostgREST 无法连接数据库

**症状**: REST 服务不断重启，日志显示 "password authentication failed"

**排查步骤**:
1. 检查 PostgREST 日志: `docker-compose logs rest`
2. 检查密码是否 URL 编码: `grep PGRST_DB_URI docker-compose.yml`
3. 检查数据库密码: `grep POSTGRES_PASSWORD .env`

**解决**:
```bash
# 对密码进行 URL 编码（例如 @ -> %40）
# 更新 docker-compose.yml 中的 PGRST_DB_URI
docker-compose up -d rest
```

### 问题3: 前端无法连接 Supabase

**症状**: 浏览器控制台显示 CORS 错误或连接失败

**排查步骤**:
1. 检查前端配置: `grep VITE_SUPABASE_URL config/env/.env.production`
2. 检查构建文件: `grep "43.136" dist/assets/*.js | head -1`
3. 检查 Nginx CORS 配置

**解决**:
```bash
# 重新构建前端
npm run build

# 重新上传
docker-compose restart nginx
```

### 问题4: API 服务无法创建用户

**症状**: 调用 `/api/auth/create-user` 返回 500 错误

**排查步骤**:
1. 检查 API 服务日志: `docker-compose logs api`
2. 检查 Service Role Key 是否有效
3. 检查 auth 服务是否可访问

**解决**:
```bash
# 检查 API 服务环境变量
docker-compose exec api env | grep SERVICE_ROLE

# 重启 API 服务
docker-compose restart api
```

## 部署完成确认

- [ ] 所有服务正常运行
- [ ] 能正常登录系统
- [ ] 能正常创建用户
- [ ] 能正常访问所有功能模块
- [ ] 已备份部署配置
- [ ] 已记录管理员账号密码

## 回滚准备

如需回滚到旧版本：

```bash
# 停止当前服务
docker-compose down

# 恢复到之前的 docker-compose.yml 和 nginx.conf
# 重新启动
docker-compose up -d
```

---

**部署日期**: ___________

**部署人员**: ___________

**服务器IP**: ___________

**备注**: ___________
