# 模块02：工作台模块需求文档

## 版本信息
- **版本**: 2.0
- **更新日期**: 2026-02-10
- **状态**: 已同步代码实现

---

## 一、模块概述

### 1.1 模块定位
工作台模块是用户登录后的默认首页，提供项目概览、关键指标统计、快捷操作入口、热点新闻和待办任务等功能，是用户日常工作的主要入口。

### 1.2 核心职责
- 展示项目关键指标统计
- 显示今日热点新闻
- 展示我的待办任务
- 提供快捷操作入口
- 支持新闻评论功能

---

## 二、用户角色与权限

### 2.1 角色定义

| 角色 | 说明 | 特殊权限 |
|------|------|----------|
| 系统管理员 | 拥有系统全部管理权限 | 可配置热点关键词 |
| 项目用户 | 普通项目成员 | 查看自己的统计数据 |

### 2.2 权限矩阵

| 功能 | 系统管理员 | 项目用户 |
|------|-----------|----------|
| 查看统计卡片 | ✓ | ✓ |
| 查看热点新闻 | ✓ | ✓ |
| 评论热点新闻 | ✓ | ✓ |
| 配置热点关键词 | ✓ | ✗ |
| 查看待办任务 | ✓ | ✓ |
| 快捷创建项目 | ✓ | ✓ |

---

## 三、功能需求

### 3.1 页面头部

#### 3.1.1 问候语
- 根据当前时间显示不同问候语：
  - 12点前："早安"
  - 12-18点："下午好"
  - 18点后："晚上好"
- 显示当前登录用户名称
- 显示当前日期（含星期）

#### 3.1.2 快捷操作按钮
| 按钮 | 功能 | 跳转目标 |
|------|------|----------|
| 我的任务 | 跳转到任务中心 | /tasks |
| 新建项目 | 跳转到项目创建 | /projects/create |

### 3.2 统计卡片区域

展示4个关键指标卡片，2x2网格布局（移动端1列，桌面端4列）：

#### 3.2.1 合同总金额卡片
- **图标**: Wallet（靛蓝色）
- **标题**: 合同总金额（作为项目经理）
- **数值**: 当前用户作为项目经理的所有项目金额总和
- **金额格式化**: 
  - ≥1亿：显示为"xx.xx亿"
  - ≥1万：显示为"xx.xx万"
  - 其他：显示为"¥xx.xx"
- **底部链接**: 财务概览（纯展示）

#### 3.2.2 风险提示卡片
- **图标**: AlertTriangle（红色）
- **标题**: 风险提示
- **数值**: 待处理风险数量（risks.status = 'open'）
- **底部链接**: 风险中心 → 跳转到项目列表

#### 3.2.3 任务总数卡片
- **图标**: CheckSquare（蓝色）
- **标题**: 任务总数
- **数值**: 系统中所有任务数量
- **底部链接**: 我的任务 → 跳转到任务中心

#### 3.2.4 超期未完成卡片
- **图标**: Clock（橙色）
- **标题**: 超期未完成
- **数值**: 已逾期且未完成的任务数量
- **判断逻辑**: due_date < 今天 且 status ≠ done/canceled
- **底部链接**: 去处理 → 跳转到任务中心

### 3.3 今日热点区域

#### 3.3.1 功能描述
展示系统配置的热点新闻列表，支持点击查看详情和评论。

#### 3.3.2 界面元素
- **标题栏**: "今日热点" + Flame图标（橙色）
- **配置入口**: 管理员显示"配置关注点"链接 → 系统设置
- **新闻列表**: 最多显示20条

#### 3.3.3 单条新闻展示
| 元素 | 说明 |
|------|------|
| 标题 | 新闻标题，点击打开详情弹窗 |
| 日期 | 发布日期 |
| 摘要 | 新闻摘要，最多显示4行 |
| 来源标签 | 新闻来源 |
| 评论数 | 显示评论数量，点击打开详情 |
| 阅读原文 | 外链到原始新闻 |

#### 3.3.4 新闻详情弹窗
点击新闻后弹出详情弹窗：

**弹窗头部**
- 新闻标题
- 来源和发布时间
- 关闭按钮

**弹窗内容**
- 新闻摘要全文
- 阅读原文链接（外链）

**评论区**
- 评论数量显示
- 评论列表（用户名称、时间、内容）
- 评论输入框
- 发布按钮

**评论交互**
- 支持多行文本输入
- 发布时显示加载状态
- 发布成功后实时刷新评论列表
- 评论按时间正序排列

#### 3.3.5 空状态
当没有热点新闻时显示：
- 提示文本："暂无今日热点，请前往系统设置配置关注关键词。"
- 管理员可点击配置链接

### 3.4 我的待办区域

#### 3.4.1 功能描述
展示当前用户的待办任务列表，按截止日期排序。

#### 3.4.2 界面元素
- **标题栏**: "今日待办" + 任务数量徽章
- **任务列表**: 最多显示6条

#### 3.4.3 单条任务展示
| 元素 | 说明 |
|------|------|
| 优先级指示器 | 高优先级(红色)、中优先级(黄色)、低优先级(蓝色) |
| 任务标题 | 点击跳转到任务中心 |
| 截止日期 | 显示日期 |
| 逾期标识 | 已逾期任务显示"已逾期"红色标签 |
| 跳转按钮 | 点击跳转到任务中心 |

#### 3.4.4 空状态
当没有待办任务时显示：
- 绿色勾选图标
- "太棒了！"
- "您已完成所有待办任务"

#### 3.4.5 底部链接
- "查看所有任务" → 跳转到任务中心

---

## 四、数据模型

### 4.1 核心数据表

#### hot_news（热点新闻表）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | uuid | 主键 |
| title | text | 新闻标题 |
| summary | text | 新闻摘要 |
| url | text | 原文链接 |
| source | text | 来源 |
| keywords | text | 匹配关键词 |
| published_at | timestamptz | 发布时间 |

#### news_comments（新闻评论表）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | uuid | 主键 |
| news_id | uuid | 新闻ID |
| user_id | uuid | 用户ID |
| content | text | 评论内容 |
| created_at | timestamptz | 创建时间 |

### 4.2 TypeScript类型定义

```typescript
interface DashboardStats {
  totalProjects: number;
  activeProjects: number;
  completedProjects: number;
  taskTotal: number;
  overdueTasks: number;
  highPriorityTasks: number;
  pendingRisks: number;
  totalBudget: number;
}

interface HotNews {
  id: string;
  title: string;
  summary: string;
  url: string;
  source: string;
  published_at: string;
}

interface NewsComment {
  id: string;
  content: string;
  created_at: string;
  user_id: string;
  user?: {
    id: string;
    full_name?: string;
    username?: string;
  } | null;
}
```

---

## 五、接口规范

### 5.1 获取仪表盘数据

```typescript
// 获取项目数据
const { data: projects } = await supabase.from('projects').select('*');

// 获取我的任务
const { data: tasks } = await supabase
  .from('tasks')
  .select('*')
  .eq('assigned_to', user?.id)
  .neq('status', 'done')
  .order('due_date', { ascending: true });

// 获取风险数量
const { count: riskCount } = await supabase
  .from('risks')
  .select('*', { count: 'exact', head: true })
  .eq('status', 'open');

// 获取热点新闻
const { data: newsData } = await supabase
  .from('hot_news')
  .select('*')
  .order('published_at', { ascending: false })
  .limit(20);
```

### 5.2 评论相关接口

```typescript
// 获取评论数量
const { data } = await supabase
  .from('news_comments')
  .select('news_id')
  .in('news_id', newsIds);

// 获取评论列表
const { data } = await supabase
  .from('news_comments')
  .select('id, content, created_at, user_id, user:profiles(id, full_name, username)')
  .eq('news_id', newsId)
  .order('created_at', { ascending: true });

// 发布评论
const { error } = await supabase.from('news_comments').insert({
  news_id: newsId,
  user_id: user.id,
  content
});
```

---

## 六、界面原型

### 6.1 整体布局

```
┌─────────────────────────────────────────────────────────────────────┐
│ 早安，用户名 👋                                        [我的任务][+新建项目]│
│ 今天是 2026年2月10日 星期二                                          │
├─────────────────────────────────────────────────────────────────────┤
│ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐                │
│ │ 合同总金额│ │ 风险提示 │ │ 任务总数 │ │ 超期未完成│                │
│ │  ¥xxx万  │ │    5     │ │   128    │ │    3     │                │
│ └──────────┘ └──────────┘ └──────────┘ └──────────┘                │
├──────────────────────────────────────────┬──────────────────────────┤
│                                          │                          │
│  🔥 今日热点                    [配置]   │  今日待办        [6]     │
│  ┌────────────────────────────────────┐  │  ┌────────────────────┐  │
│  │ 新闻标题1              2026-02-10  │  │  │ ● 任务1    02-10   │  │
│  │ 新闻摘要内容...                    │  │  │ ● 任务2    02-11   │  │
│  │ [来源] 评论 5    阅读原文 →        │  │  │ ● 任务3    02-12   │  │
│  ├────────────────────────────────────┤  │  │ ...                │  │
│  │ 新闻标题2              2026-02-09  │  │  └────────────────────┘  │
│  │ 新闻摘要内容...                    │  │  查看所有任务            │
│  │ [来源] 评论 3    阅读原文 →        │  │                          │
│  └────────────────────────────────────┘  │                          │
│                                          │                          │
└──────────────────────────────────────────┴──────────────────────────┘
```

### 6.2 新闻详情弹窗

```
┌─────────────────────────────────────────────────────────────┐
│ 新闻标题                                        [×]         │
│ 来源 · 2026-02-10 10:30                                     │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│ 新闻摘要全文内容...                                          │
│                                                             │
│ [阅读原文 →]                                                │
├─────────────────────────────────────────────────────────────┤
│ 评论                                    3 条                │
│ ┌───────────────────────────────────────────────────────┐  │
│ │ 用户A                          2026-02-10 11:00       │  │
│ │ 评论内容...                                           │  │
│ └───────────────────────────────────────────────────────┘  │
│ ┌───────────────────────────────────────────────────────┐  │
│ │ 用户B                          2026-02-10 11:30       │  │
│ │ 评论内容...                                           │  │
│ └───────────────────────────────────────────────────────┘  │
│                                                             │
│ ┌──────────────────────────────────┐  ┌──────────────┐     │
│ │ 写下你的评论...                   │  │ [发送图标] 发布│     │
│ └──────────────────────────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘
```

---

## 七、验收标准

### 7.1 功能验收

| 验收项 | 验收标准 | 状态 |
|--------|----------|------|
| 问候语 | 根据时间显示正确的问候语 | 已实现 |
| 统计卡片 | 4个卡片数据准确，格式化正确 | 已实现 |
| 热点新闻 | 显示最新20条，支持点击查看详情 | 已实现 |
| 新闻评论 | 可查看评论、发布评论 | 已实现 |
| 待办任务 | 显示当前用户的待办任务，按截止日期排序 | 已实现 |
| 快捷入口 | 按钮可正确跳转 | 已实现 |
| 管理员配置入口 | 管理员可见配置链接 | 已实现 |

### 7.2 性能验收

| 验收项 | 标准 | 状态 |
|--------|------|------|
| 页面加载 | < 3秒 | 已实现 |
| 数据刷新 | 实时计算统计数据 | 已实现 |
| 评论发布 | < 2秒响应 | 已实现 |

---

## 八、修订记录

| 版本 | 日期 | 修订内容 | 修订人 |
|------|------|----------|--------|
| 1.0 | 2025-02-09 | 初始版本 | AI Assistant |
| 2.0 | 2026-02-10 | 同步代码实现，更新统计卡片、热点新闻、评论功能、待办任务 | AI Assistant |
