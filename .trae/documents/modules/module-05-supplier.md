# 模块05：供应商管理模块需求文档

## 版本信息
- **版本**: 3.0
- **更新日期**: 2026-02-10
- **状态**: 已更新付款管理功能

---

## 一、模块概述

### 1.1 模块定位
供应商管理模块负责维护供应商信息库，支持供应商的增删改查，以及供应商与项目的关联管理。通过该模块可以跟踪供应商参与的项目情况、合同金额和付款进度。

### 1.2 核心职责
- 供应商信息管理
- 供应商与项目关联
- 供应商参与项目统计
- 供应商验收跟踪
- **供应商付款管理（新增）**

---

## 二、用户角色与权限

### 2.1 角色定义

| 角色 | 说明 | 权限范围 |
|------|------|----------|
| 项目用户 | 普通项目成员 | 可查看供应商，可关联供应商到项目，可管理付款计划 |
| 系统管理员 | 系统管理员 | 可管理所有供应商信息 |

### 2.2 权限矩阵

| 功能 | 项目用户 | 系统管理员 |
|------|----------|-----------|
| 查看供应商列表 | ✓ | ✓ |
| 查看供应商详情 | ✓ | ✓ |
| 创建供应商 | ✓ | ✓ |
| 编辑供应商 | ✓ | ✓ |
| 删除供应商 | ✗ | ✓ |
| 关联项目供应商 | ✓ | ✓ |
| **查看付款计划** | ✓ | ✓ |
| **创建付款计划** | ✓ | ✓ |
| **确认/撤回付款** | ✓ | ✓ |

---

## 三、功能需求

### 3.1 供应商列表页面

#### 3.1.1 页面头部
- **标题**: "供应商库"
- **新增供应商按钮**: 打开创建供应商弹窗

#### 3.1.2 搜索功能
- 支持按供应商名称搜索
- 支持按联系人搜索

#### 3.1.3 供应商卡片列表
卡片式布局展示供应商，每卡片显示：

| 元素 | 说明 |
|------|------|
| 供应商名称 | 供应商公司名称 |
| 状态标签 | 活跃/停用 |
| 联系人 | 联系人姓名 |
| 联系电话 | 联系电话 |
| 操作按钮 | 查看详情、编辑、删除 |

**状态颜色标识:**
| 状态 | 颜色 |
|------|------|
| 活跃 | 绿色 |
| 停用 | 灰色 |

### 3.2 供应商创建/编辑

#### 3.2.1 表单字段

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| 供应商名称 | 文本 | 是 | 公司名称 |
| 联系人 | 文本 | 否 | 联系人姓名 |
| 联系电话 | 文本 | 否 | 联系电话 |
| 电子邮箱 | 文本 | 否 | 联系邮箱 |
| 地址 | 文本 | 否 | 公司地址 |
| 描述 | 文本域 | 否 | 供应商描述 |
| 状态 | 单选 | 是 | 活跃/停用 |

### 3.3 供应商详情弹窗

#### 3.3.1 统计信息
- 参与项目总数
- 累计合同金额

#### 3.3.2 项目清单
显示该供应商参与的所有项目：
| 列名 | 说明 |
|------|------|
| 项目名称 | 关联的项目名称 |
| 合同金额 | 该项目的合同金额 |
| 验收状态 | 验收通过数/总验收数 |

### 3.4 项目供应商关联

在项目详情页的供应商Tab中：
- 显示已关联的供应商列表
- 支持添加新的供应商关联
- 支持设置合同金额
- 支持记录供应商进度
- 支持关联功能模块

### 3.5 供应商付款管理（新增）

#### 3.5.1 付款管理页面布局

**顶部统计指标区域：**

| 指标 | 说明 | 计算方式 |
|------|------|----------|
| 合同金额 | 供应商合同总金额 | project_suppliers.contract_amount |
| 已支付金额 | 已确认付款的总金额 | SUM(supplier_payments.amount where status='paid') |
| 未支付金额 | 待付款的总金额 | 合同金额 - 已支付金额 |
| 未支付比例 | 未支付金额占比 | (未支付金额 / 合同金额) × 100% |

**统计指标展示样式：**
```
┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
│  合同金额    │  │  已支付金额  │  │  未支付金额  │  │  未支付比例  │
│  ¥500,000   │  │  ¥200,000   │  │  ¥300,000   │  │    60%      │
└──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘
```

#### 3.5.2 新增付款计划功能

**按钮位置：** 统计指标下方
**按钮文本：** "+ 新增付款计划"

**批量新增付款计划弹窗：**

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| 付款时间 | 日期选择器 | 是 | 计划付款日期 |
| 付款比例 | 数字输入(%) | 是 | 占合同金额的比例，范围0-100 |
| 付款金额 | 数字输入 | 是 | 实际付款金额，根据比例自动计算 |
| 付款事由 | 文本域 | 是 | 付款原因说明 |

**付款金额自动计算逻辑：**
```
付款金额 = 合同金额 × (付款比例 / 100)
```

**支持批量添加：** 可一次性添加多条付款计划

#### 3.5.3 付款计划列表

**列表展示字段：**

| 字段 | 说明 |
|------|------|
| 序号 | 付款计划序号 |
| 付款时间 | 计划付款日期 |
| 付款金额 | 计划付款金额 |
| 付款比例 | 占合同金额比例 |
| 付款事由 | 付款原因 |
| 状态 | 待付款/已付款 |
| 实际付款时间 | 确认付款时的日期 |
| 付款凭证 | 上传的凭证文件 |
| 操作 | 确认付款/撤回付款按钮 |

**状态标识：**
| 状态 | 颜色 | 说明 |
|------|------|------|
| 待付款 | 橙色 | 计划待执行 |
| 已付款 | 绿色 | 已确认付款 |

#### 3.5.4 确认付款功能

**触发方式：** 点击付款记录后的"确认付款"按钮

**确认付款弹窗：**

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| 实际付款时间 | 日期选择器 | 是 | 默认为当天日期，可修改 |
| 付款凭证 | 文件上传 | 否 | 支持图片、PDF格式 |

**确认付款后操作：**
1. 更新付款记录状态为"已付款"
2. 记录实际付款时间
3. 保存付款凭证URL
4. 刷新顶部统计指标（已支付金额、未支付金额、未支付比例实时更新）
5. 按钮变为"撤回付款"

#### 3.5.5 撤回付款功能

**触发方式：** 点击已付款记录后的"撤回付款"按钮

**撤回确认：** 弹出确认对话框"确定要撤回此付款记录吗？"

**撤回后操作：**
1. 更新付款记录状态为"待付款"
2. 清空实际付款时间和付款凭证
3. 刷新顶部统计指标（数据同步更新）
4. 按钮变回"确认付款"

---

## 四、数据模型

### 4.1 核心数据表

#### suppliers（供应商表）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | uuid | 主键 |
| name | text | 供应商名称 |
| contact_person | text | 联系人 |
| phone | text | 电话 |
| email | text | 邮箱 |
| address | text | 地址 |
| description | text | 描述 |
| status | text | 状态：active/inactive |
| created_at | timestamptz | 创建时间 |

#### project_suppliers（项目供应商关联表）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | uuid | 主键 |
| project_id | uuid | 项目ID |
| supplier_id | uuid | 供应商ID |
| contract_amount | decimal | 合同金额 |
| progress | integer | 进度百分比 |
| module_ids | uuid[] | 关联模块ID数组 |

#### supplier_payments（供应商付款计划表 - 新增）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | uuid | 主键 |
| project_supplier_id | uuid | 项目供应商关联ID |
| planned_date | date | 计划付款日期 |
| amount | decimal | 付款金额 |
| percentage | decimal | 付款比例(%) |
| reason | text | 付款事由 |
| status | text | 状态：pending/paid |
| actual_payment_date | date | 实际付款日期 |
| voucher_url | text | 付款凭证URL |
| created_at | timestamptz | 创建时间 |
| updated_at | timestamptz | 更新时间 |

### 4.2 TypeScript类型定义

```typescript
interface Supplier {
  id: string;
  name: string;
  contact_person: string;
  phone: string;
  email: string;
  address: string;
  description: string;
  status: 'active' | 'inactive';
  created_at: string;
}

interface ProjectSupplier {
  id: string;
  project_id: string;
  supplier_id: string;
  contract_amount: number;
  progress: number;
  module_ids: string[];
}

// 新增付款计划类型
interface SupplierPayment {
  id: string;
  project_supplier_id: string;
  planned_date: string;
  amount: number;
  percentage: number;
  reason: string;
  status: 'pending' | 'paid';
  actual_payment_date?: string;
  voucher_url?: string;
  created_at: string;
  updated_at: string;
}

// 付款计划表单数据
interface PaymentPlanFormData {
  planned_date: string;
  percentage: number;
  amount: number;
  reason: string;
}

// 确认付款表单数据
interface ConfirmPaymentFormData {
  actual_payment_date: string;
  voucher_file?: File;
}
```

---

## 五、接口规范

### 5.1 获取供应商列表

```typescript
const { data, error } = await supabase
  .from('suppliers')
  .select('*')
  .order('created_at', { ascending: false });
```

### 5.2 创建/更新供应商

```typescript
const supplierData = {
  name,
  contact_person,
  phone,
  email,
  address,
  description,
  status: 'active'
};

// 创建
const { error } = await supabase
  .from('suppliers')
  .insert([supplierData]);

// 更新
const { error } = await supabase
  .from('suppliers')
  .update(supplierData)
  .eq('id', id);
```

### 5.3 删除供应商

```typescript
const { error } = await supabase
  .from('suppliers')
  .delete()
  .eq('id', id);
```

### 5.4 获取供应商详情统计

```typescript
const { data, error } = await supabase
  .from('project_suppliers')
  .select(`
    contract_amount,
    project:projects (name),
    acceptances:supplier_acceptances (result)
  `)
  .eq('supplier_id', supplierId);
```

### 5.5 获取付款计划列表（新增）

```typescript
const { data, error } = await supabase
  .from('supplier_payments')
  .select('*')
  .eq('project_supplier_id', projectSupplierId)
  .order('planned_date', { ascending: true });
```

### 5.6 批量创建付款计划（新增）

```typescript
const paymentPlans = [
  {
    project_supplier_id: 'uuid',
    planned_date: '2026-03-01',
    amount: 100000,
    percentage: 20,
    reason: '首付款',
    status: 'pending'
  },
  // ... 更多计划
];

const { error } = await supabase
  .from('supplier_payments')
  .insert(paymentPlans);
```

### 5.7 确认付款（新增）

```typescript
const { error } = await supabase
  .from('supplier_payments')
  .update({
    status: 'paid',
    actual_payment_date: '2026-02-10',
    voucher_url: 'https://...'
  })
  .eq('id', paymentId);
```

### 5.8 撤回付款（新增）

```typescript
const { error } = await supabase
  .from('supplier_payments')
  .update({
    status: 'pending',
    actual_payment_date: null,
    voucher_url: null
  })
  .eq('id', paymentId);
```

---

## 六、界面原型

### 6.1 供应商列表

```
┌─────────────────────────────────────────────────────────────────────┐
│ 供应商库                                            [+ 新增供应商]    │
├─────────────────────────────────────────────────────────────────────┤
│ [搜索供应商名称或联系人...]                                          │
├─────────────────────────────────────────────────────────────────────┤
│ ┌──────────────┐  ┌──────────────┐  ┌──────────────┐               │
│ │ 供应商A      │  │ 供应商B      │  │ 供应商C      │               │
│ │ [活跃]       │  │ [活跃]       │  │ [停用]       │               │
│ │              │  │              │  │              │               │
│ │ 联系人：张三 │  │ 联系人：李四 │  │ 联系人：王五 │               │
│ │ 电话：123... │  │ 电话：456... │  │ 电话：789... │               │
│ │              │  │              │  │              │               │
│ │ [详情][编辑] │  │ [详情][编辑] │  │ [详情][编辑] │               │
│ └──────────────┘  └──────────────┘  └──────────────┘               │
└─────────────────────────────────────────────────────────────────────┘
```

### 6.2 供应商详情弹窗

```
┌─────────────────────────────────────────┐
│ 供应商A详情                     [×]     │
├─────────────────────────────────────────┤
│                                         │
│ 统计信息                                │
│ ┌──────────────┐  ┌──────────────┐     │
│ │ 参与项目     │  │ 累计金额     │     │
│ │     5       │  │  ¥500,000   │     │
│ └──────────────┘  └──────────────┘     │
│                                         │
│ 项目清单                                │
│ ┌─────────────────────────────────────┐ │
│ │ 项目名称    │ 合同金额   │ 验收状态 │ │
│ ├─────────────────────────────────────┤ │
│ │ 项目A       │ ¥100,000  │ 2通过/3  │ │
│ │ 项目B       │ ¥200,000  │ 1通过/2  │ │
│ └─────────────────────────────────────┘ │
│                                         │
└─────────────────────────────────────────┘
```

### 6.3 付款管理页面（新增）

```
┌─────────────────────────────────────────────────────────────────────┐
│ 付款管理                                                    [×]     │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────┐ │
│  │  合同金额    │  │  已支付金额  │  │  未支付金额  │  │ 未支付比例│ │
│  │  ¥500,000   │  │  ¥200,000   │  │  ¥300,000   │  │   60%    │ │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────┘ │
│                                                                     │
│  [+ 新增付款计划]                                                    │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │ 序号 │ 付款时间  │ 付款金额  │ 比例 │ 事由  │ 状态  │ 操作    │ │
│  ├───────────────────────────────────────────────────────────────┤ │
│  │  1  │ 2026-03-01│ ¥100,000 │ 20%  │ 首付  │[待付款]│[确认]   │ │
│  │  2  │ 2026-04-01│ ¥100,000 │ 20%  │ 二期  │[已付款]│[撤回]   │ │
│  │  3  │ 2026-05-01│ ¥100,000 │ 20%  │ 三期  │[待付款]│[确认]   │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 6.4 新增付款计划弹窗（新增）

```
┌─────────────────────────────────────────┐
│ 新增付款计划                    [×]     │
├─────────────────────────────────────────┤
│                                         │
│  付款时间: [2026-03-01    ]            │
│                                         │
│  付款比例: [20%          ]              │
│            自动计算付款金额             │
│                                         │
│  付款金额: [¥100,000     ]              │
│                                         │
│  付款事由: [首付款...                 ] │
│                                         │
│  [+ 添加更多]  [删除]                   │
│                                         │
│  ─────────────────────────────────────  │
│                                         │
│  付款时间: [2026-04-01    ]            │
│  付款比例: [20%          ]              │
│  付款金额: [¥100,000     ]              │
│  付款事由: [二期款...                 ] │
│                                         │
│  [+ 添加更多]  [删除]                   │
│                                         │
│              [取消]  [确定]             │
│                                         │
└─────────────────────────────────────────┘
```

### 6.5 确认付款弹窗（新增）

```
┌─────────────────────────────────────────┐
│ 确认付款                        [×]     │
├─────────────────────────────────────────┤
│                                         │
│  计划付款金额: ¥100,000                │
│  计划付款时间: 2026-03-01              │
│                                         │
│  实际付款时间: [2026-02-10    ]        │
│                                         │
│  付款凭证:   [选择文件...]             │
│                                         │
│              [取消]  [确认付款]         │
│                                         │
└─────────────────────────────────────────┘
```

---

## 七、验收标准

### 7.1 功能验收

| 验收项 | 验收标准 | 状态 |
|--------|----------|------|
| 供应商列表 | 卡片式布局，支持搜索 | 已实现 |
| 供应商创建 | 表单验证，创建成功 | 已实现 |
| 供应商编辑 | 可编辑所有字段 | 已实现 |
| 供应商删除 | 管理员可删除 | 已实现 |
| 详情统计 | 显示项目数和金额统计 | 已实现 |
| 项目关联 | 可在项目中关联供应商 | 已实现 |
| **付款统计指标** | 四个指标实时计算显示 | 待实现 |
| **批量新增付款计划** | 支持多条计划批量添加 | 待实现 |
| **付款金额自动计算** | 根据比例自动计算金额 | 待实现 |
| **付款计划列表** | 列表展示，状态标识 | 待实现 |
| **确认付款** | 可确认付款，上传凭证 | 待实现 |
| **撤回付款** | 可撤回付款，数据回滚 | 待实现 |
| **统计指标同步** | 操作后指标实时更新 | 待实现 |

### 7.2 性能验收

| 验收项 | 标准 | 状态 |
|--------|------|------|
| 列表加载 | < 3秒 | 已实现 |
| 搜索响应 | < 1秒 | 已实现 |
| 统计计算 | < 1秒 | 待实现 |
| 付款操作 | < 2秒 | 待实现 |

---

## 八、修订记录

| 版本 | 日期 | 修订内容 | 修订人 |
|------|------|----------|--------|
| 1.0 | 2025-02-09 | 初始版本 | AI Assistant |
| 2.0 | 2026-02-10 | 同步代码实现，更新供应商卡片、详情统计、项目关联 | AI Assistant |
| 3.0 | 2026-02-10 | 新增供应商付款管理功能，包括付款计划、确认/撤回付款、统计指标 | AI Assistant |
