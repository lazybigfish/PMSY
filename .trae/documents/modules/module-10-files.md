# 模块10：文件管理模块需求文档

## 版本信息
- **版本**: 1.0
- **更新日期**: 2026-02-10
- **状态**: 已实现

---

## 一、模块概述

### 1.1 模块定位
文件管理模块是PMSY系统的文件存储与管理模块，为系统提供统一的文件上传、存储、下载、管理服务，支持多种文件类型和存储方式。

### 1.2 核心职责
- 文件上传与下载
- 文件存储管理
- 文件夹管理
- 存储配额控制
- 文件操作日志记录

---

## 二、用户角色与权限

### 2.1 角色定义

| 角色 | 说明 | 权限范围 |
|------|------|----------|
| 系统管理员 | 系统超级管理员 | 管理所有文件、配置存储 |
| 普通用户 | 普通项目成员 | 管理自己的文件 |

### 2.2 权限矩阵

| 功能 | 系统管理员 | 普通用户 |
|------|-----------|----------|
| 上传文件 | ✓ | ✓ |
| 下载文件 | ✓ | ✓(自己的) |
| 删除文件 | ✓ | ✓(自己的) |
| 重命名文件 | ✓ | ✓(自己的) |
| 移动文件 | ✓ | ✓(自己的) |
| 创建文件夹 | ✓ | ✓ |
| 查看所有文件 | ✓ | ✗ |
| 存储配置 | ✓ | ✗ |

---

## 三、功能需求

### 3.1 文件列表

#### 3.1.1 列表展示
- 支持列表视图和网格视图切换
- 显示文件名称、大小、类型、上传时间、上传者
- 支持文件搜索（按名称模糊搜索）
- 支持按文件类型筛选（文档/图片/视频/音频/压缩包/其他）
- 支持分页加载

#### 3.1.2 文件选择
- 支持单选和多选文件
- 支持全选/取消全选
- 选中文件高亮显示

### 3.2 文件上传

#### 3.2.1 上传方式
- 点击上传按钮选择文件
- 支持多文件同时上传
- 支持拖拽上传（预留）

#### 3.2.2 上传限制
- 单文件最大10MB
- 支持文件类型：jpg, jpeg, png, gif, webp, svg, pdf, doc, docx, xls, xlsx, ppt, pptx, txt, md, csv, mp4, webm, mov, avi, mp3, wav, ogg, m4a, zip, rar, 7z, gz

#### 3.2.3 上传进度
- 显示上传进度弹窗
- 每个文件显示独立进度条
- 上传完成/失败状态标识
- 显示错误信息

### 3.3 文件下载

- 点击下载按钮下载文件
- 右键菜单快速下载
- 支持批量下载（预留）

### 3.4 文件删除

- 支持单文件删除
- 支持批量删除（预留）
- 删除前确认提示
- 软删除机制（可恢复）

### 3.5 文件夹管理

#### 3.5.1 文件夹列表
- 显示当前文件夹下的子文件夹
- 文件夹图标标识
- 双击进入文件夹

#### 3.5.2 文件夹导航
- 面包屑路径导航
- 支持点击返回上级目录
- 支持快速返回首页

#### 3.5.3 创建文件夹
- 支持创建新文件夹
- 文件夹名称验证

### 3.6 存储配额

#### 3.6.1 配额显示
- 显示已用存储空间
- 显示总存储空间
- 显示剩余可用空间
- 进度条可视化展示

#### 3.6.2 配额控制
- 默认每个用户10GB配额
- 上传前检查剩余空间
- 空间不足时提示用户

### 3.7 文件分类

系统自动识别文件类型：
- **图片**: jpg, jpeg, png, gif, webp, svg, bmp
- **文档**: pdf, doc, docx, xls, xlsx, ppt, pptx, txt, md, csv
- **视频**: mp4, webm, mov, avi, mpg, mpeg
- **音频**: mp3, wav, ogg, m4a
- **压缩包**: zip, rar, 7z, gz
- **其他**: 其他格式

### 3.8 操作日志

记录以下操作：
- 文件上传
- 文件下载
- 文件删除
- 文件重命名
- 文件移动

日志内容：
- 操作类型
- 操作人
- 操作时间
- 文件信息

---

## 四、数据模型

### 4.1 核心数据表

#### files（文件表）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | uuid | 主键 |
| name | text | 存储文件名 |
| original_name | text | 原始文件名 |
| mime_type | text | MIME类型 |
| size | bigint | 文件大小（字节） |
| extension | text | 文件扩展名 |
| storage_type | text | 存储类型（local/oss/cos/s3） |
| storage_path | text | 存储路径 |
| storage_config_id | uuid | 存储配置ID |
| url | text | 访问URL |
| category | text | 文件分类 |
| uploader_id | uuid | 上传者ID |
| version | integer | 版本号 |
| status | text | 状态（active/deleted/archived） |
| created_at | timestamptz | 创建时间 |

#### folders（文件夹表）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | uuid | 主键 |
| name | text | 文件夹名称 |
| parent_id | uuid | 父文件夹ID |
| path | text | 完整路径 |
| owner_id | uuid | 所有者ID |
| created_at | timestamptz | 创建时间 |

#### storage_configs（存储配置表）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | uuid | 主键 |
| name | text | 配置名称 |
| type | text | 存储类型 |
| is_default | boolean | 是否默认 |
| config | jsonb | 配置详情 |
| status | text | 状态 |

#### file_operation_logs（文件操作日志表）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | uuid | 主键 |
| operation_type | text | 操作类型 |
| file_id | uuid | 文件ID |
| operator_id | uuid | 操作人ID |
| created_at | timestamptz | 操作时间 |

#### storage_quotas（存储配额表）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | uuid | 主键 |
| user_id | uuid | 用户ID |
| total_quota | bigint | 总配额（字节） |
| used_quota | bigint | 已用配额（字节） |
| file_count | integer | 文件数量 |

---

## 五、接口规范

### 5.1 文件服务接口

```typescript
// 获取文件列表
const { data } = await fileService.getFiles({
  folderId: null,
  category: null,
  search: '',
  page: 0,
  pageSize: 20
});

// 上传文件
const fileRecord = await fileService.uploadFile(file, folderId, onProgress);

// 上传多个文件
const results = await fileService.uploadMultipleFiles(files, folderId, onProgress);

// 删除文件
await fileService.deleteFile(fileId, permanent);

// 重命名文件
await fileService.renameFile(fileId, newName);

// 移动文件
await fileService.moveFile(fileId, targetFolderId);

// 获取存储配额
const quota = await fileService.getStorageQuota(userId);
```

### 5.2 Supabase Storage 接口

```typescript
// 上传文件到Storage
const { data, error } = await supabase.storage
  .from('files')
  .upload(path, file);

// 获取文件URL
const { data } = supabase.storage
  .from('files')
  .getPublicUrl(path);

// 删除文件
const { error } = await supabase.storage
  .from('files')
  .remove([path]);
```

---

## 六、界面原型

```
┌─────────────────────────────────────────────────────────────────────┐
│ 文件管理                                                    [上传按钮] │
├─────────────────────────────────────────────────────────────────────┤
│ [首页] > [文件夹1] > [文件夹2]                          [搜索框] [视图切换] │
├─────────────────────────────────────────────────────────────────────┤
│ [列表视图]                                                           │
│ ┌────┬──────────────┬────────┬────────┬────────────┬──────────────┐ │
│ │ 选择 │ 名称          │ 大小    │ 类型    │ 上传时间      │ 操作          │ │
│ ├────┼──────────────┼────────┼────────┼────────────┼──────────────┤ │
│ │ ☐  │ 📁 文件夹1    │ -      │ 文件夹  │ 2026-02-10 │              │ │
│ │ ☐  │ 📄 文档.pdf   │ 2.5MB  │ PDF    │ 2026-02-10 │ [下载][删除]  │ │
│ │ ☐  │ 🖼️ 图片.png   │ 1.2MB  │ PNG    │ 2026-02-10 │ [下载][删除]  │ │
│ └────┴──────────────┴────────┴────────┴────────────┴──────────────┘ │
│                                                                      │
│ [网格视图]                                                           │
│ ┌──────────┐ ┌──────────┐ ┌──────────┐                              │
│ │   📁     │ │   📄     │ │   🖼️     │                              │
│ │  文件夹1  │ │ 文档.pdf │ │ 图片.png │                              │
│ └──────────┘ └──────────┘ └──────────┘                              │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 七、验收标准

### 7.1 功能验收

| 验收项 | 验收标准 | 状态 |
|--------|----------|------|
| 文件上传 | 支持单文件/多文件上传，进度显示正常 | 已实现 |
| 文件下载 | 点击下载可正常获取文件 | 已实现 |
| 文件删除 | 删除后文件从列表移除，可软删除 | 已实现 |
| 文件夹管理 | 可创建文件夹，支持层级导航 | 已实现 |
| 存储配额 | 配额显示准确，超限上传被阻止 | 已实现 |
| 文件分类 | 自动识别文件类型，图标显示正确 | 已实现 |
| 操作日志 | 记录上传、下载、删除操作 | 已实现 |

### 7.2 性能验收

| 验收项 | 标准 | 状态 |
|--------|------|------|
| 文件列表加载 | < 2秒 | 已实现 |
| 文件上传速度 | 取决于网络，进度实时更新 | 已实现 |
| 大文件上传 | 10MB文件上传正常 | 已实现 |

---

## 八、修订记录

| 版本 | 日期 | 修订内容 | 修订人 |
|------|------|----------|--------|
| 1.0 | 2026-02-10 | 初始版本，文件管理模块需求 | AI Assistant |
