# 📦 PMSY 部署目录

## 目录结构

```
deploy/
├── README.md                 # 本文件 - 部署总览
├── fresh-install/           # 🆕 全新部署目录
│   ├── README.md           # 全新部署说明
│   └── deploy.sh           # 全新部署脚本
├── update/                 # 🔄 更新部署目录
│   ├── README.md          # 更新部署说明
│   └── deploy.sh          # 更新部署脚本
├── scripts/                # 📜 辅助脚本
│   ├── create-admin-user.sh
│   ├── generate-jwt-keys.sh
│   └── ...
├── config/                 # ⚙️ 部署配置
│   └── nginx.conf
└── docs/                   # 📚 部署文档
    ├── DEPLOY_GUIDE.md
    └── DEPLOY_TROUBLESHOOTING.md
```

## 快速选择

| 场景 | 使用目录 | 说明 |
|------|----------|------|
| 新服务器首次安装 | `fresh-install/` | 会清空所有数据，重新初始化 |
| 已有系统更新代码 | `update/` | 保留数据，仅更新代码 |

---

## 🆕 fresh-install（全新部署）

**用途**: 新服务器首次部署 PMSY

**特点**:
- ✅ 完整的部署流程
- ⚠️ **会清空所有现有数据**
- 🔄 重新初始化数据库
- 🆕 创建全新环境

**支持三种部署模式**:
1. **在线部署** - 服务器可连接 Docker Hub
2. **半离线部署** - 服务器无法连接 Docker Hub
3. **完全离线部署** - 生成离线部署包

**使用方法**:
```bash
# 在开发机执行
./deploy/fresh-install/deploy.sh
```

详见: [fresh-install/README.md](fresh-install/README.md)

---

## 🔄 update（更新部署）

**用途**: 已有 PMSY 系统的代码更新

**特点**:
- ✅ 保留所有现有数据
- ✅ 仅更新代码和配置
- 🔄 重启服务
- 💾 不删除数据库

**使用场景**:
- 前端代码更新
- API 代码更新
- 配置文件更新
- 日常维护升级

**使用方法**:
```bash
# 在开发机执行
./deploy/update/deploy.sh
```

详见: [update/README.md](update/README.md)

---

## 系统架构

PMSY 使用以下服务：

| 服务 | 说明 | 端口 |
|------|------|------|
| PostgreSQL | 数据库 | 5432 |
| Redis | 缓存 | 6379 |
| MinIO | 文件存储 | 9000/9001 |
| API | 后端服务 | 3001 |
| Nginx | 前端服务 | 80/443 |

---

## 对比表

| 特性 | fresh-install | update |
|------|---------------|--------|
| **数据保留** | ❌ 清空所有数据 | ✅ 保留所有数据 |
| **数据库** | 🔄 重新初始化 | 💾 保留现有 |
| **用户数据** | ❌ 删除 | ✅ 保留 |
| **执行位置** | 开发机 | 开发机 |
| **执行时间** | 5-15 分钟 | 1-2 分钟 |
| **风险等级** | 🔴 高 | 🟢 低 |
| **适用场景** | 新安装/重装 | 日常更新 |

---

## 部署流程图

```
┌─────────────────────────────────────────────────────────┐
│                    开始部署                              │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
              ┌────────────────────────┐
              │  是新服务器首次安装？   │
              └────────────────────────┘
                           │
              ┌────────────┴────────────┐
              │                         │
             是                        否
              │                         │
              ▼                         ▼
┌─────────────────────────┐  ┌─────────────────────────┐
│   fresh-install/        │  │       update/           │
│   🆕 全新部署           │  │   🔄 更新部署           │
│                         │  │                         │
│ 1. 清空现有数据         │  │ 1. 保留现有数据         │
│ 2. 初始化数据库         │  │ 2. 构建前端和后端       │
│ 3. 启动所有服务         │  │ 3. 复制到服务器         │
│                         │  │ 4. 重启服务             │
│ 风险: 🔴 高             │  │ 风险: 🟢 低             │
└─────────────────────────┘  └─────────────────────────┘
                           │
                           ▼
              ┌────────────────────────┐
              │     验证部署结果        │
              └────────────────────────┘
                           │
                           ▼
              ┌────────────────────────┐
              │     部署完成 ✓          │
              └────────────────────────┘
```

---

## 重要提醒

### ⚠️ 使用 fresh-install 前必须确认

- [ ] 这是新服务器或可以接受数据丢失
- [ ] 已备份重要数据（如有）
- [ ] 了解此操作会清空所有数据
- [ ] 已阅读 [fresh-install/README.md](fresh-install/README.md)

### ✅ 使用 update 前建议确认

- [ ] 代码已提交到版本控制
- [ ] `config/env/.env.production` 配置正确
- [ ] 已备份数据（建议）
- [ ] 了解更新内容
- [ ] 已阅读 [update/README.md](update/README.md)

---

## 常见问题

### Q: 我该如何选择使用哪个目录？

**A:** 
- 如果是**新服务器**或想**完全重新开始** → 使用 `fresh-install/`
- 如果是**已有系统**需要**更新代码** → 使用 `update/`

### Q: 使用 fresh-install 会删除我的数据吗？

**A:** 是的！`fresh-install` 会清空所有数据，包括：
- PostgreSQL 数据库
- Redis 缓存
- MinIO 文件存储
- 所有用户数据

### Q: 使用 update 会删除我的数据吗？

**A:** 不会！`update` 只更新代码，保留所有数据。

### Q: 部署失败了怎么办？

**A:** 
1. 查看错误信息
2. 检查配置文件
3. 查看对应目录的 README.md
4. 检查服务器日志：`sudo docker-compose logs`

---

## 相关文档

- [部署指南](docs/DEPLOY_GUIDE.md) - 详细部署指南
- [生产环境配置](../config/env/.env.production.example) - 生产环境配置示例
- [开发环境配置](../config/env/.env.example) - 开发环境配置示例
