# PMSY ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²å®Œæ•´æŒ‡å—

## ðŸ“‹ ç›®å½•

1. [éƒ¨ç½²å‰å‡†å¤‡](#éƒ¨ç½²å‰å‡†å¤‡)
2. [æž¶æž„é€‰æ‹©](#æž¶æž„é€‰æ‹©)
3. [éƒ¨ç½²æ­¥éª¤](#éƒ¨ç½²æ­¥éª¤)
4. [ç¼“å­˜ç®¡ç†](#ç¼“å­˜ç®¡ç†)
5. [å¸¸è§é—®é¢˜ä¸Žè§£å†³æ–¹æ¡ˆ](#å¸¸è§é—®é¢˜ä¸Žè§£å†³æ–¹æ¡ˆ)
6. [é—®é¢˜æŽ’æŸ¥æŒ‡å—](#é—®é¢˜æŽ’æŸ¥æŒ‡å—)
7. [åŽç»­æ›´æ–°](#åŽç»­æ›´æ–°)

---

## éƒ¨ç½²å‰å‡†å¤‡

### çŽ¯å¢ƒè¦æ±‚

| çŽ¯å¢ƒ | è¦æ±‚ |
|------|------|
| **å¼€å‘æœº** | macOS/Linux/Windows + Docker Desktop |
| **æœåŠ¡å™¨** | Linux (Ubuntu/CentOS) + Docker + Docker Compose |
| **ç½‘ç»œ** | å¼€å‘æœºéœ€è”ç½‘ï¼ŒæœåŠ¡å™¨å¯ç¦»çº¿ |
| **å­˜å‚¨** | æœåŠ¡å™¨è‡³å°‘ 10GB å¯ç”¨ç©ºé—´ |
| **å†…å­˜** | æœåŠ¡å™¨è‡³å°‘ 4GB å†…å­˜ |

### æ£€æŸ¥æ¸…å•

- [ ] å¼€å‘æœºå·²å®‰è£… Docker Desktop
- [ ] æœåŠ¡å™¨å·²å®‰è£… Docker å’Œ Docker Compose
- [ ] æœåŠ¡å™¨ SSH å¯è®¿é—®
- [ ] å·²çŸ¥æœåŠ¡å™¨æž¶æž„ï¼ˆAMD64/ARM64ï¼‰

---

## æž¶æž„é€‰æ‹©

### å¸¸è§æž¶æž„å¯¹ç…§è¡¨

| æœåŠ¡å™¨ç±»åž‹ | æž¶æž„ | Docker Platform |
|-----------|------|-----------------|
| Intel/AMD CPU | x86_64 / AMD64 | `linux/amd64` |
| ARM æœåŠ¡å™¨ | ARM64 / aarch64 | `linux/arm64` |
| Apple Silicon Mac | ARM64 | `linux/arm64` |
| æ ‘èŽ“æ´¾ 4 | ARM64 | `linux/arm64` |

### æ£€æµ‹æœåŠ¡å™¨æž¶æž„

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
uname -m
```

- è¾“å‡º `x86_64` â†’ ä½¿ç”¨ **AMD64** é•œåƒ
- è¾“å‡º `aarch64` â†’ ä½¿ç”¨ **ARM64** é•œåƒ

---

## éƒ¨ç½²æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡éƒ¨ç½²åŒ…

```bash
cd "/Users/liiiiins/Downloads/æ–‡ç¨¿ - liiiiinsçš„MacBook Pro/Mweb/PMSY"

# æ‰§è¡Œå‡†å¤‡è„šæœ¬ï¼ˆä¼šè¯¢é—®æž¶æž„ï¼‰
./prepare-deploy.sh
```

è„šæœ¬ä¼šï¼š
1. è¯¢é—®ç›®æ ‡æœåŠ¡å™¨æž¶æž„
2. æž„å»ºå‰ç«¯
3. ä¸‹è½½å¯¹åº”æž¶æž„çš„ Docker é•œåƒ
4. æ‰“åŒ…æ‰€æœ‰æ–‡ä»¶

### ç¬¬äºŒæ­¥ï¼šä¼ è¾“åˆ°æœåŠ¡å™¨

```bash
# è®¾ç½®æœåŠ¡å™¨ä¿¡æ¯
SERVER_IP="ä½ çš„æœåŠ¡å™¨IP"
SERVER_USER="ç”¨æˆ·å"

# æ‰§è¡Œä¼ è¾“è„šæœ¬
./transfer-to-server.sh
```

### ç¬¬ä¸‰æ­¥ï¼šæœåŠ¡å™¨éƒ¨ç½²

```bash
# SSH åˆ°æœåŠ¡å™¨æ‰§è¡Œ
ssh $SERVER_USER@$SERVER_IP "cd /opt/pmsy && ./deploy.sh"
```

---

## ç¼“å­˜ç®¡ç†

### è‡ªåŠ¨ç¼“å­˜æœºåˆ¶

`prepare-deploy.sh` è„šæœ¬ä¼šè‡ªåŠ¨ç®¡ç†æœ¬åœ°ç¼“å­˜ï¼š

- **é¦–æ¬¡è¿è¡Œ**ï¼šä¸‹è½½æ‰€æœ‰é•œåƒå¹¶ä¿å­˜åˆ°æœ¬åœ°ç¼“å­˜
- **åŽç»­è¿è¡Œ**ï¼šæ£€æŸ¥ç¼“å­˜å®Œæ•´æ€§ï¼Œå®Œæ•´åˆ™è·³è¿‡ä¸‹è½½
- **ç¼“å­˜ä½ç½®**ï¼š`docker-images-amd64/` æˆ– `docker-images-arm64/`

### ç¼“å­˜ç®¡ç†å‘½ä»¤

```bash
# æŸ¥çœ‹ç¼“å­˜çŠ¶æ€
./clean-cache.sh

# æ¸…ç†ç‰¹å®šæž¶æž„ç¼“å­˜
./clean-cache.sh  # é€‰æ‹©é€‰é¡¹ 2 æˆ– 3

# å¼ºåˆ¶é‡æ–°ä¸‹è½½ï¼ˆæ¸…ç†+å‡†å¤‡ï¼‰
./clean-cache.sh  # é€‰æ‹©é€‰é¡¹ 5
```

### ç¼“å­˜ä½¿ç”¨åœºæ™¯

| åœºæ™¯ | æ“ä½œ |
|------|------|
| é¦–æ¬¡éƒ¨ç½² | è‡ªåŠ¨ä¸‹è½½å¹¶ç¼“å­˜ |
| é‡å¤éƒ¨ç½²ï¼ˆåŒæž¶æž„ï¼‰ | ä½¿ç”¨ç¼“å­˜ï¼Œç§’çº§å‡†å¤‡ |
| éƒ¨ç½²åˆ°ä¸åŒæž¶æž„æœåŠ¡å™¨ | è‡ªåŠ¨ä¸‹è½½æ–°æž¶æž„é•œåƒ |
| é•œåƒç‰ˆæœ¬æ›´æ–° | æ¸…ç†ç¼“å­˜åŽé‡æ–°ä¸‹è½½ |
| ç£ç›˜ç©ºé—´ä¸è¶³ | æ¸…ç†ä¸éœ€è¦çš„æž¶æž„ç¼“å­˜ |

---

## å¸¸è§é—®é¢˜ä¸Žè§£å†³æ–¹æ¡ˆï¼ˆ10ä¸ªå¸¸è§é—®é¢˜ï¼‰

### é—®é¢˜ 1ï¼šæž¶æž„ä¸åŒ¹é…

**ç—‡çŠ¶**ï¼š
```
The requested image's platform (linux/arm64) does not match 
the detected host platform (linux/amd64)
```

**åŽŸå› **ï¼šä¸‹è½½çš„é•œåƒæž¶æž„ä¸ŽæœåŠ¡å™¨ä¸åŒ¹é…

**è§£å†³**ï¼š
1. ç¡®è®¤æœåŠ¡å™¨æž¶æž„ï¼š`uname -m`
2. é‡æ–°ä¸‹è½½å¯¹åº”æž¶æž„çš„é•œåƒ
3. ä½¿ç”¨ `--platform` å‚æ•°æŒ‡å®šæž¶æž„

**é¢„é˜²**ï¼š
- éƒ¨ç½²å‰åŠ¡å¿…ç¡®è®¤æœåŠ¡å™¨æž¶æž„
- ä½¿ç”¨ `prepare-deploy.sh` è„šæœ¬ï¼Œä¼šè‡ªåŠ¨è¯¢é—®æž¶æž„

---

### é—®é¢˜ 2ï¼šDocker æ— æ³•è¿žæŽ¥å¤–ç½‘

**ç—‡çŠ¶**ï¼š
```
Error response from daemon: Get "https://registry-1.docker.io/v2/": 
net/http: request canceled while waiting for connection
```

**åŽŸå› **ï¼šæœåŠ¡å™¨æ— æ³•è¿žæŽ¥ Docker Hub

**è§£å†³**ï¼š
1. å¼€å‘æœºä¸‹è½½é•œåƒ
2. é€šè¿‡ `docker save` ä¿å­˜ä¸º tar æ–‡ä»¶
3. ä¼ è¾“åˆ°æœåŠ¡å™¨
4. é€šè¿‡ `docker load` å¯¼å…¥

**é¢„é˜²**ï¼š
- ä½¿ç”¨ç¦»çº¿éƒ¨ç½²æ–¹æ¡ˆ
- æ‰€æœ‰é•œåƒåœ¨å¼€å‘æœºå‡†å¤‡å®ŒæˆåŽå†ä¼ è¾“

---

### é—®é¢˜ 3ï¼šDNS è§£æžå¤±è´¥

**ç—‡çŠ¶**ï¼š
```
dial tcp: lookup docker.mirrors.ustc.edu.cn on 8.8.8.8:53: no such host
```

**åŽŸå› **ï¼šæœåŠ¡å™¨ DNS é…ç½®é—®é¢˜

**è§£å†³**ï¼š
```bash
# ä¿®å¤ DNS
sudo rm -f /etc/docker/daemon.json
sudo systemctl restart docker
```

**é¢„é˜²**ï¼š
- éƒ¨ç½²è„šæœ¬ä¸­è‡ªåŠ¨æ¸…ç†é”™è¯¯çš„ DNS é…ç½®
- ä¸ä½¿ç”¨é•œåƒåŠ é€Ÿå™¨ï¼ˆç¦»çº¿çŽ¯å¢ƒä¸éœ€è¦ï¼‰

---

### é—®é¢˜ 4ï¼šNginx é…ç½®é”™è¯¯

**ç—‡çŠ¶**ï¼š
```
host not found in upstream "app" in /etc/nginx/nginx.conf:42
```

**åŽŸå› **ï¼šdocker-compose æœåŠ¡åä¸Ž nginx é…ç½®ä¸åŒ¹é…

**è§£å†³**ï¼š
- ç¡®ä¿ `nginx.conf` ä¸­çš„ upstream åç§°ä¸Ž `docker-compose.yml` ä¸­çš„æœåŠ¡åä¸€è‡´
- é»˜è®¤åº”ä½¿ç”¨ `api` è€Œä¸æ˜¯ `app`

**é¢„é˜²**ï¼š
- ä½¿ç”¨æä¾›çš„æ ‡å‡†é…ç½®æ–‡ä»¶
- ä¸è¦æ‰‹åŠ¨ä¿®æ”¹æœåŠ¡å

---

### é—®é¢˜ 5ï¼šSupabase Auth åˆå§‹åŒ–å¤±è´¥

**ç—‡çŠ¶**ï¼š
```
ERROR: schema "auth" does not exist
ERROR: type "auth.factor_type" does not exist
```

**åŽŸå› **ï¼šSupabase æ•°æ®åº“æœªæ­£ç¡®åˆå§‹åŒ–

**è§£å†³**ï¼š
1. ç­‰å¾…æ•°æ®åº“å®Œå…¨å¯åŠ¨
2. æ‰‹åŠ¨åˆ›å»º auth schema
3. é‡å¯ auth æœåŠ¡

**é¢„é˜²**ï¼š
- é¦–æ¬¡å¯åŠ¨æ—¶è€å¿ƒç­‰å¾…
- ä½¿ç”¨å®˜æ–¹æŽ¨èçš„ Supabase ç‰ˆæœ¬ç»„åˆ

---

### é—®é¢˜ 6ï¼šè„šæœ¬æ— æ‰§è¡Œæƒé™

**ç—‡çŠ¶**ï¼š
```
zsh: permission denied: ./transfer-to-server.sh
```

**åŽŸå› **ï¼šè„šæœ¬æ–‡ä»¶æ²¡æœ‰æ‰§è¡Œæƒé™

**è§£å†³**ï¼š
```bash
chmod +x *.sh
```

**é¢„é˜²**ï¼š
- é¦–æ¬¡ä½¿ç”¨å‰ç»™æ‰€æœ‰è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
- æˆ–åœ¨è„šæœ¬å‰åŠ  `bash` æ‰§è¡Œï¼š`bash transfer-to-server.sh`

---

### é—®é¢˜ 7ï¼šAPI å®¹å™¨å¯åŠ¨å¤±è´¥

**ç—‡çŠ¶**ï¼š
```
Error: Cannot find module '/app/api/server.js'
```

**åŽŸå› **ï¼šDockerfile é…ç½®é”™è¯¯ï¼Œä½¿ç”¨äº†é”™è¯¯çš„å¯åŠ¨å‘½ä»¤

**è§£å†³**ï¼š
- ä½¿ç”¨ `tsx` è¿è¡Œ TypeScript æ–‡ä»¶
- æˆ–å…ˆç¼–è¯‘ä¸º JavaScript

**é¢„é˜²**ï¼š
- ä½¿ç”¨æä¾›çš„æ ‡å‡† Dockerfile
- ç¡®ä¿ `package.json` ä¸­æœ‰ `tsx` ä¾èµ–

---

### é—®é¢˜ 8ï¼šsshpass å®‰è£…å¤±è´¥ï¼ˆMacï¼‰

**ç—‡çŠ¶**ï¼š
```
Error: sshpass: undefined method `no_autobump!'
```
æˆ–
```
Warning: You are using macOS 14. We do not provide support for this pre-release version.
```

**åŽŸå› **ï¼š
- Mac ç³»ç»Ÿç‰ˆæœ¬è¾ƒæ—§ï¼ŒHomebrew ä¸æ”¯æŒå®‰è£… sshpass
- sshpass æœ¬èº«åœ¨ Mac ä¸Šå®‰è£…å›°éš¾

**è§£å†³**ï¼š
ä½¿ç”¨ SSH Key è®¤è¯æ›¿ä»£å¯†ç è®¤è¯ï¼š
```bash
# 1. é…ç½® SSH Keyï¼ˆåªéœ€æ‰§è¡Œä¸€æ¬¡ï¼‰
./setup-ssh-key.sh

# 2. ä¿®æ”¹ deploy-config.sh
USE_SSH_KEY="yes"

# 3. ä¹‹åŽå³å¯å…å¯†ç éƒ¨ç½²
./transfer-to-server.sh
```

**é¢„é˜²**ï¼š
- é»˜è®¤ä½¿ç”¨ SSH Key è®¤è¯ï¼ˆæ›´å®‰å…¨ï¼‰
- é¿å…ä½¿ç”¨ sshpass

---

### é—®é¢˜ 9ï¼šå‰ç«¯ç™½å±

**ç—‡çŠ¶**ï¼šæµè§ˆå™¨æ‰“å¼€é¡µé¢ç™½å±ï¼Œæ²¡æœ‰æŠ¥é”™

**åŽŸå› **ï¼š
1. Nginx æœªæ­£ç¡®é…ç½®é™æ€æ–‡ä»¶è·¯å¾„
2. å‰ç«¯æž„å»ºæ–‡ä»¶ç¼ºå¤±
3. API æœåŠ¡æœªå¯åŠ¨

**è§£å†³**ï¼š
1. æ£€æŸ¥ `dist` ç›®å½•æ˜¯å¦å­˜åœ¨
2. æ£€æŸ¥ Nginx é…ç½®ä¸­çš„ root è·¯å¾„
3. æ£€æŸ¥ API æœåŠ¡çŠ¶æ€

**é¢„é˜²**ï¼š
- éƒ¨ç½²å‰éªŒè¯å‰ç«¯æž„å»ºæˆåŠŸ
- ç¡®ä¿æ‰€æœ‰æ–‡ä»¶å·²æ­£ç¡®ä¼ è¾“

---

### é—®é¢˜ 10ï¼šç™»å½•å¤±è´¥

**ç—‡çŠ¶**ï¼šæç¤º"ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"

**åŽŸå› **ï¼š
1. Supabase Auth æœåŠ¡æœªæ­£å¸¸è¿è¡Œ
2. æ•°æ®åº“ä¸­æœªåˆ›å»º root ç”¨æˆ·
3. å¯†ç åŠ å¯†æ–¹å¼ä¸åŒ¹é…

**è§£å†³**ï¼š
1. æ£€æŸ¥ auth æœåŠ¡æ—¥å¿—
2. æ‰‹åŠ¨åˆ›å»º root ç”¨æˆ·
3. ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„å¯†ç 

**é¢„é˜²**ï¼š
- é¦–æ¬¡éƒ¨ç½²æ—¶æ£€æŸ¥ auth æœåŠ¡çŠ¶æ€
- ä½¿ç”¨éƒ¨ç½²è„šæœ¬è‡ªåŠ¨åˆ›å»º root ç”¨æˆ·

---

## é—®é¢˜æŽ’æŸ¥æŒ‡å—

### æŸ¥çœ‹æœåŠ¡çŠ¶æ€

```bash
ssh $SERVER_USER@$SERVER_IP "cd /opt/pmsy && docker-compose ps"
```

### æŸ¥çœ‹æ—¥å¿—

```bash
# æ‰€æœ‰æœåŠ¡æ—¥å¿—
ssh $SERVER_USER@$SERVER_IP "cd /opt/pmsy && docker-compose logs -f"

# ç‰¹å®šæœåŠ¡æ—¥å¿—
ssh $SERVER_USER@$SERVER_IP "cd /opt/pmsy && docker-compose logs -f api"
ssh $SERVER_USER@$SERVER_IP "cd /opt/pmsy && docker-compose logs -f auth"
ssh $SERVER_USER@$SERVER_IP "cd /opt/pmsy && docker-compose logs -f db"
```

### é‡å¯æœåŠ¡

```bash
# é‡å¯æ‰€æœ‰æœåŠ¡
ssh $SERVER_USER@$SERVER_IP "cd /opt/pmsy && docker-compose restart"

# é‡å¯ç‰¹å®šæœåŠ¡
ssh $SERVER_USER@$SERVER_IP "cd /opt/pmsy && docker-compose restart api"
```

### æ£€æŸ¥æ•°æ®åº“

```bash
# è¿›å…¥æ•°æ®åº“å®¹å™¨
ssh $SERVER_USER@$SERVER_IP "cd /opt/pmsy && docker-compose exec db psql -U postgres -d postgres"

# æŸ¥çœ‹ç”¨æˆ·
\dt auth.*
SELECT * FROM auth.users;
```

---

## åŽç»­æ›´æ–°

### æ›´æ–°å‰ç«¯ä»£ç 

```bash
# 1. æœ¬åœ°é‡æ–°æž„å»º
npm run build

# 2. ä¼ è¾“åˆ°æœåŠ¡å™¨
scp -r dist/* $SERVER_USER@$SERVER_IP:/opt/pmsy/dist/

# 3. é‡å¯ nginx
ssh $SERVER_USER@$SERVER_IP "cd /opt/pmsy && docker-compose restart nginx"
```

### æ›´æ–°åŽç«¯ä»£ç 

```bash
# 1. ä¼ è¾“æ–°ä»£ç 
scp -r api/* $SERVER_USER@$SERVER_IP:/opt/pmsy/api/

# 2. é‡å¯ API æœåŠ¡
ssh $SERVER_USER@$SERVER_IP "cd /opt/pmsy && docker-compose restart api"
```

### å®Œæ•´é‡æ–°éƒ¨ç½²

```bash
# æ‰§è¡Œå®Œæ•´çš„å‡†å¤‡å’Œéƒ¨ç½²æµç¨‹
./prepare-deploy.sh
./transfer-to-server.sh
ssh $SERVER_USER@$SERVER_IP "cd /opt/pmsy && ./deploy.sh"
```

---

## æ–‡ä»¶è¯´æ˜Ž

| æ–‡ä»¶ | ç”¨é€” |
|------|------|
| `prepare-deploy.sh` | å‡†å¤‡éƒ¨ç½²åŒ…ï¼ˆå¸¦ç¼“å­˜æœºåˆ¶ï¼‰ |
| `transfer-to-server.sh` | ä¼ è¾“æ–‡ä»¶åˆ°æœåŠ¡å™¨ |
| `deploy.sh` | æœåŠ¡å™¨éƒ¨ç½²è„šæœ¬ |
| `deploy-config.sh` | éƒ¨ç½²é…ç½®æ–‡ä»¶ï¼ˆæœåŠ¡å™¨ä¿¡æ¯ã€è®¤è¯æ–¹å¼ï¼‰ |
| `setup-ssh-key.sh` | é…ç½® SSH å…å¯†ç ç™»å½• |
| `clean-cache.sh` | ç¼“å­˜ç®¡ç†å·¥å…· |
| `DEPLOY_GUIDE.md` | æœ¬éƒ¨ç½²æŒ‡å— |
| `TROUBLESHOOTING.md` | é—®é¢˜æŽ’æŸ¥æ‰‹å†Œ |

---

## ç‰ˆæœ¬åŽ†å²

| æ—¥æœŸ | ç‰ˆæœ¬ | æ›´æ–°å†…å®¹ |
|------|------|----------|
| 2026-02-11 | v1.0 | åˆå§‹ç‰ˆæœ¬ï¼Œæ”¯æŒ AMD64/ARM64 åŒæž¶æž„ |

---

## è”ç³»æ–¹å¼

é‡åˆ°é—®é¢˜ï¼Ÿè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤ï¼š

1. æŸ¥çœ‹æœ¬æŒ‡å—çš„ã€å¸¸è§é—®é¢˜ã€‘ç« èŠ‚
2. æŸ¥çœ‹ `TROUBLESHOOTING.md` è¯¦ç»†æŽ’æŸ¥æ‰‹å†Œ
3. æ”¶é›†æ—¥å¿—ä¿¡æ¯ï¼š`docker-compose logs > logs.txt`
