# PMSY 生产环境部署配置指南

## 配置文件位置

所有部署相关的配置文件都在 `config/` 目录下：

```
config/
├── docker/
│   └── docker-compose.yml    # Docker 编排配置
├── nginx/
│   └── nginx.conf            # Nginx 代理配置
└── env/
    ├── .env.example          # 环境变量示例
    └── .env.production       # ⚠️ 生产环境配置（部署前必须修改）
```

## 部署前必须修改的配置

### 1. 修改 `config/env/.env.production`

打开文件并修改以下 4 个关键配置：

```bash
# 使用你喜欢的编辑器打开
vim config/env/.env.production
# 或
code config/env/.env.production
```

#### 必须修改的配置项：

| 配置项 | 说明 | 示例值 |
|--------|------|--------|
| `DB_PASSWORD` | 数据库密码 | `YourStrongPassword123!` |
| `JWT_SECRET` | JWT签名密钥（至少32位） | `your_random_secret_key_here_at_least_32_chars` |
| `MINIO_SECRET_KEY` | MinIO存储密钥 | `minio_strong_secret_key_here` |
| `API_URL` | 服务器IP地址 | `http://43.136.69.250` |
| `VITE_API_URL` | 前端API地址 | `http://43.136.69.250/api` |

#### 配置文件示例：

```bash
# ==========================================
# 数据库配置（PostgreSQL）
# ==========================================
DB_HOST=postgres
DB_PORT=5432
DB_USER=pmsy
# ⚠️ 生产环境必须修改为强密码
DB_PASSWORD=YourStrongPassword123!  # ← 修改这里
DB_NAME=pmsy

# ==========================================
# MinIO 文件存储配置
# ==========================================
MINIO_ENDPOINT=minio:9000
MINIO_ACCESS_KEY=minioadmin
# ⚠️ 生产环境必须修改为强密码
MINIO_SECRET_KEY=YourMinIOSecretKey456!  # ← 修改这里
MINIO_USE_SSL=false
MINIO_BUCKET_NAME=files

# ==========================================
# JWT 配置
# ==========================================
# ⚠️ 生产环境必须使用强随机字符串（至少32位）
JWT_SECRET=YourRandomJWTSecretKeyHereAtLeast32Characters!  # ← 修改这里
JWT_EXPIRES_IN=7d
JWT_ISSUER=pmsy-api
JWT_AUDIENCE=pmsy-client

# ==========================================
# 服务器配置
# ==========================================
NODE_ENV=production
PORT=3001
# ⚠️ 修改为服务器实际IP地址
API_URL=http://43.136.69.250  # ← 修改这里

# ==========================================
# 前端配置
# ==========================================
# ⚠️ 修改为服务器实际IP地址
VITE_API_URL=http://43.136.69.250/api  # ← 修改这里
```

## 部署流程

### 方式一：使用新的 v2.0 部署脚本（推荐）

```bash
# 1. 先修改配置文件
vim config/env/.env.production

# 2. 运行部署脚本
./deploy/fresh-install/deploy-v2.sh
```

脚本会自动：
- 读取 `config/env/.env.production` 配置
- 上传到服务器
- 启动所有服务
- 初始化数据库
- 执行种子数据

### 方式二：手动部署

```bash
# 1. 修改配置文件
vim config/env/.env.production

# 2. 构建前端
npm run build

# 3. 构建后端
cd api-new && npm run build && cd ..

# 4. 上传文件到服务器
scp -r dist api-new config docker-compose.yml nginx.conf user@server:/opt/pmsy/

# 5. 在服务器上启动
cd /opt/pmsy
sudo docker-compose up -d

# 6. 初始化数据库
sudo docker-compose exec postgres psql -U pmsy -d pmsy -f /docker-entrypoint-initdb.d/999_complete_schema.sql

# 7. 执行种子数据
sudo docker-compose exec api sh -c "cd /app && npm run db:seed"
```

## 配置验证

部署完成后，验证配置是否正确：

```bash
# 1. 检查环境变量是否正确加载
ssh user@server 'cd /opt/pmsy && sudo docker-compose exec api env | grep -E "DB_|JWT_|MINIO_"'

# 2. 检查 API 服务是否正常
curl http://your-server-ip/api/health

# 3. 检查前端是否正常
open http://your-server-ip
```

## 常见问题

### Q: 部署脚本提示找不到配置文件？
A: 确保 `config/env/.env.production` 文件存在。如果不存在，可以从 `.env.example` 复制：
```bash
cp config/env/.env.example config/env/.env.production
```

### Q: 如何生成强密码？
A: 可以使用以下命令生成随机密码：
```bash
# 生成32位随机密码
openssl rand -base64 32

# 生成JWT密钥
openssl rand -base64 64
```

### Q: 修改配置后如何重新部署？
A: 修改 `config/env/.env.production` 后，重新运行部署脚本即可：
```bash
./deploy/fresh-install/deploy-v2.sh
```

### Q: 部署后数据库连接失败？
A: 检查以下几点：
1. `DB_PASSWORD` 是否正确设置
2. 数据库容器是否正常运行：`sudo docker-compose ps`
3. 查看数据库日志：`sudo docker-compose logs postgres`

## 安全建议

1. **生产环境必须使用强密码**
   - 数据库密码至少16位，包含大小写字母、数字和特殊字符
   - JWT密钥至少32位随机字符串
   - MinIO密钥同样使用强密码

2. **定期更换密钥**
   - 建议每3-6个月更换一次 JWT_SECRET
   - 更换后需要重新登录

3. **不要提交敏感配置到代码仓库**
   - `.env.production` 已在 `.gitignore` 中
   - 确保不会意外提交包含真实密码的配置文件
